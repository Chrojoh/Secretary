<!DOCTYPE html>
<html>
<head>
  <title>Trial Entry Form</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px 12px 0 0;
      text-align: center;
    }
    
    .header h1 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 1rem;
    }
    
    .trial-info {
      background: white;
      padding: 1.5rem;
      border-left: 4px solid #667eea;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .trial-info h3 {
      color: #333;
      margin-bottom: 1rem;
    }
    
    .trial-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .trial-detail {
      padding: 0.5rem;
    }
    
    .trial-detail strong {
      color: #667eea;
      display: block;
      font-size: 0.9rem;
    }
    
    .entry-form {
      background: white;
      border-radius: 0 0 12px 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .waiver-section {
      background: #fff9e6;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .waiver-section h3 {
      color: #e65100;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .waiver-content {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid #ffc107;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    .waiver-agreement {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .waiver-agreement input[type="checkbox"] {
      margin-top: 0.2rem;
      transform: scale(1.2);
    }
    
    .waiver-agreement label {
      font-weight: 500;
      color: #333;
      cursor: pointer;
    }
    
    .form-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }
    
    .form-section h3 {
      color: #28a745;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-group label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #333;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      padding: 0.8rem;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group.required label::after {
      content: " *";
      color: #e74c3c;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: white;
      border-radius: 4px;
      border: 1px solid #e1e5e9;
    }
    
    .checkbox-item input[type="checkbox"] {
      margin: 0;
    }
    
    .checkbox-item label {
      margin: 0;
      cursor: pointer;
    }
    
    .entry-summary {
      background: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .entry-summary h3 {
      color: #28a745;
      margin-bottom: 1rem;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .summary-item {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid #28a745;
    }
    
    .summary-item strong {
      display: block;
      color: #28a745;
      font-size: 0.9rem;
    }
    
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    .btn-link {
      background: transparent;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-link:hover {
      background: #667eea;
      color: white;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .success-message {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .success-message h3 {
      margin-bottom: 1rem;
    }
    
    .entry-link {
      background: #e7f3ff;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .entry-link h3 {
      color: #007bff;
      margin-bottom: 1rem;
    }
    
    .entry-link .btn {
      margin: 0.5rem;
    }
    
    .manual-entry-note {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .hidden {
      display: none;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Trial Header -->
    <div class="header">
      <h1 id="trialTitle">üèÜ Trial Entry Form</h1>
      <p id="trialSubtitle">Complete your entry for this C-WAGS trial</p>
    </div>

    <!-- Trial Information -->
    <div class="trial-info">
      <h3>üìã Trial Information</h3>
      <div class="trial-details" id="trialDetails">
        <div class="trial-detail">
          <strong>Club:</strong>
          <span id="clubName">Loading...</span>
        </div>
        <div class="trial-detail">
          <strong>Dates:</strong>
          <span id="trialDates">Loading...</span>
        </div>
        <div class="trial-detail">
          <strong>Location:</strong>
          <span id="trialLocation">Loading...</span>
        </div>
        <div class="trial-detail">
          <strong>Secretary:</strong>
          <span id="trialSecretary">Loading...</span>
        </div>
      </div>
    </div>

    <!-- Entry Link Section -->
    <div class="entry-link">
      <h3>üîó Share This Entry Form</h3>
      <p>Send this link to participants for online entries:</p>
      <div class="button-group">
        <button class="btn btn-link" onclick="copyEntryLink()">üìã Copy Entry Link</button>
        <button class="btn btn-link" onclick="emailEntryLink()">üìß Email Link</button>
      </div>
      <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
        <strong>Entry URL:</strong> <span id="entryUrl">Loading...</span>
      </div>
    </div>

    <!-- Manual Entry Note -->
    <div class="manual-entry-note">
      <strong>üìù Manual Entry Mode:</strong> Use this form to enter paper applications into the system.
    </div>

    <div class="entry-form">
      <!-- Success Message (hidden by default) -->
      <div id="successMessage" class="success-message hidden">
        <h3>‚úÖ Entry Submitted Successfully!</h3>
        <p>The entry has been recorded for this trial.</p>
        <button class="btn btn-primary" onclick="resetForm()">Enter Another Participant</button>
      </div>

      <!-- Waiver Section -->
      <div class="waiver-section">
        <h3>‚ö†Ô∏è Liability Waiver & Release</h3>
        <div class="waiver-content" id="waiverContent">
          <p><strong>WAIVER AND RELEASE OF LIABILITY</strong></p>
          <p>I understand that participation in dog training and scent work activities involves inherent risks including but not limited to: dogs working in close proximity to each other, off-leash activities, and interaction with other dogs and handlers.</p>
          <p>I acknowledge that I participate at my own risk and agree to:</p>
          <ul style="margin: 1rem 0; padding-left: 2rem;">
            <li>Hold harmless the hosting club, property owners, judges, and event organizers</li>
            <li>Take full responsibility for my dog's behavior and actions</li>
            <li>Follow all safety protocols and event rules</li>
            <li>Ensure my dog is properly vaccinated and healthy</li>
          </ul>
          <p>I agree to release, indemnify, and hold harmless all parties from any claims, damages, or injuries that may occur.</p>
        </div>
        <div class="waiver-agreement">
          <input type="checkbox" id="waiverAccepted" required>
          <label for="waiverAccepted">
            <strong>I have read, understood, and agree to the terms of this waiver and release of liability.</strong>
            This agreement is binding and acknowledges the risks involved in dog training activities.
          </label>
        </div>
      </div>

      <!-- Entry Form -->
      <form id="entryForm">
        <!-- Owner/Handler Information -->
        <div class="form-section">
          <h3>üë§ Owner/Handler Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Handler Name</label>
              <input type="text" id="handlerName" required placeholder="Enter handler's full name">
            </div>
            <div class="form-group required">
              <label>Phone Number</label>
              <input type="tel" id="handlerPhone" required placeholder="(xxx) xxx-xxxx">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group required">
              <label>Email Address</label>
              <input type="email" id="handlerEmail" required placeholder="handler@email.com">
            </div>
            <div class="form-group">
              <label>Emergency Contact</label>
              <input type="text" id="emergencyContact" placeholder="Name and phone number">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>Mailing Address</label>
              <textarea id="mailingAddress" rows="3" placeholder="Enter complete mailing address"></textarea>
            </div>
          </div>
        </div>

        <!-- Dog Information -->
        <div class="form-section">
          <h3>üêï Dog Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Dog's Call Name</label>
              <input type="text" id="dogCallName" required placeholder="Enter dog's call name">
            </div>
            <div class="form-group">
              <label>Registered Name</label>
              <input type="text" id="dogRegisteredName" placeholder="Full registered name (optional)">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>C-WAGS Registration #</label>
              <input type="text" id="cwagaNumber" placeholder="XX-XXXX-XX">
            </div>
            <div class="form-group">
              <label>Breed</label>
              <input type="text" id="dogBreed" placeholder="Enter breed">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" id="dogBirthdate">
            </div>
            <div class="form-group">
              <label>Sex</label>
              <select id="dogSex">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Male Neutered">Male Neutered</option>
                <option value="Female Spayed">Female Spayed</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Class Selection -->
        <div class="form-section">
          <h3>üéØ Class Entries</h3>
          <p style="margin-bottom: 1rem; color: #666;">Select the classes you wish to enter:</p>
          <div class="checkbox-group" id="classSelection">
            <!-- Classes will be populated by JavaScript -->
          </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
          <h3>üìù Additional Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Junior Handler (Under 18)</label>
              <select id="juniorHandler">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            <div class="form-group">
              <label>Entry Type</label>
              <select id="entryType">
                <option value="Regular">Regular Entry</option>
                <option value="Exhibition">Exhibition Only</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>Special Needs/Requests</label>
              <textarea id="specialNeeds" rows="3" placeholder="Any special accommodations needed..."></textarea>
            </div>
          </div>
        </div>

        <!-- Entry Summary -->
        <div class="entry-summary">
          <h3>üí∞ Entry Summary</h3>
          <div class="summary-grid" id="entrySummary">
            <div class="summary-item">
              <strong>Classes Selected:</strong>
              <span id="selectedClassCount">0</span>
            </div>
            <div class="summary-item">
              <strong>Entry Fee:</strong>
              <span id="calculatedFee">$0.00</span>
            </div>
            <div class="summary-item">
              <strong>Entry Type:</strong>
              <span id="summaryEntryType">Regular</span>
            </div>
            <div class="summary-item">
              <strong>Junior Handler:</strong>
              <span id="summaryJuniorHandler">No</span>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
            Submit Entry
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">
            Clear Form
          </button>
          <button type="button" class="btn btn-link" onclick="location.href='main-dashboard.html'">
            ‚Üê Back to Dashboard
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, addDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    console.log("üéØ Entry form loaded");

    let currentTrialData = null;
    let currentApplicationData = null;
    let selectedClasses = new Set();
    let registrationData = []; // Store data.json contents
    let isAutoFilling = false; // Prevent infinite loops during auto-fill

    // Fee structure
    const fees = {
      firstClass: 35.00,
      additionalClass: 25.00,
      juniorHandler: 20.00,
      exhibition: 15.00
    };

    // Load registration data from data.json
    async function loadRegistrationData() {
      try {
        const response = await fetch('./js/data.json');
        const data = await response.json();
        registrationData = data;
        console.log(`‚úÖ Loaded ${registrationData.length} registration records`);
      } catch (error) {
        console.error("‚ö†Ô∏è Could not load registration data:", error);
        registrationData = [];
      }
    }

    // Lookup registration in data.json
    function lookupInDataJson(registrationNumber) {
      if (!registrationNumber || !registrationData.length) return null;
      
      const normalizedReg = registrationNumber.trim().toLowerCase();
      return registrationData.find(record => 
        record.Registration && record.Registration.toLowerCase() === normalizedReg
      );
    }

    // Load saved data from Firebase for this registration
    async function loadSavedRegistrationData(registrationNumber) {
      try {
        if (!registrationNumber) return null;
        
        const docRef = doc(db, "registrations", registrationNumber);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          console.log("‚úÖ Found saved data for registration:", registrationNumber);
          return docSnap.data();
        }
        return null;
      } catch (error) {
        console.error("Error loading saved registration data:", error);
        return null;
      }
    }

    // Save registration data to Firebase for future use
    async function saveRegistrationData(registrationNumber, formData) {
      try {
        if (!registrationNumber) return;
        
        const registrationDoc = {
          cwagsNumber: registrationNumber,
          handlerName: formData.handlerName,
          handlerPhone: formData.handlerPhone,
          handlerEmail: formData.handlerEmail,
          emergencyContact: formData.emergencyContact,
          mailingAddress: formData.mailingAddress,
          dogCallName: formData.dogCallName,
          dogRegisteredName: formData.dogRegisteredName,
          dogBreed: formData.dogBreed,
          dogBirthdate: formData.dogBirthdate,
          dogSex: formData.dogSex,
          dogWeight: formData.dogWeight,
          lastUpdated: new Date(),
          lastTrialId: currentTrialData?.id
        };
        
        await setDoc(doc(db, "registrations", registrationNumber), registrationDoc);
        console.log("‚úÖ Saved registration data for:", registrationNumber);
      } catch (error) {
        console.error("Error saving registration data:", error);
      }
    }

    // Auto-fill form based on registration number
    async function autoFillFromRegistration(registrationNumber) {
      if (!registrationNumber || isAutoFilling) return;
      
      isAutoFilling = true;
      const statusDiv = document.getElementById('lookupStatus');
      
      try {
        // Show looking up status
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#fff3cd';
        statusDiv.style.color = '#856404';
        statusDiv.innerHTML = 'üîç Looking up registration...';
        
        // First, try to load from Firebase (most recent data)
        const savedData = await loadSavedRegistrationData(registrationNumber);
        
        if (savedData) {
          // Use saved Firebase data
          statusDiv.style.background = '#d4edda';
          statusDiv.style.color = '#155724';
          statusDiv.innerHTML = '‚úÖ Found saved data - auto-filling form';
          
          populateForm(savedData);
        } else {
          // Try data.json lookup
          const jsonData = lookupInDataJson(registrationNumber);
          
          if (jsonData) {
            statusDiv.style.background = '#d1ecf1';
            statusDiv.style.color = '#0c5460';
            statusDiv.innerHTML = 'üìã Found in database - auto-filling basic info';
            
            // Auto-fill from data.json (limited data)
            if (jsonData.Handler) {
              document.getElementById('handlerName').value = jsonData.Handler;
            }
            if (jsonData['Call Name']) {
              document.getElementById('dogCallName').value = jsonData['Call Name'];
            }
          } else {
            // Registration not found
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
            statusDiv.innerHTML = '‚ö†Ô∏è Registration not found - please fill manually';
          }
        }
        
        // Hide status after 3 seconds
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
        
      } catch (error) {
        console.error("Error in auto-fill:", error);
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = '‚ùå Error looking up registration';
        
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      } finally {
        isAutoFilling = false;
      }
    }

    // Populate form with saved data
    function populateForm(data) {
      if (!data || isAutoFilling) return;
      
      // Only fill if field is empty or user hasn't started typing
      const fillField = (fieldId, value) => {
        const field = document.getElementById(fieldId);
        if (field && value && (!field.value || field.value.trim() === '')) {
          field.value = value;
          // Add visual feedback that field was auto-filled
          field.style.background = '#e8f5e8';
          setTimeout(() => {
            field.style.background = '';
          }, 2000);
        }
      };
      
      fillField('handlerName', data.handlerName);
      fillField('handlerPhone', data.handlerPhone);
      fillField('handlerEmail', data.handlerEmail);
      fillField('emergencyContact', data.emergencyContact);
      fillField('mailingAddress', data.mailingAddress);
      fillField('dogCallName', data.dogCallName);
      fillField('dogRegisteredName', data.dogRegisteredName);
      fillField('dogBreed', data.dogBreed);
      fillField('dogBirthdate', data.dogBirthdate);
      fillField('dogSex', data.dogSex);
      fillField('dogWeight', data.dogWeight);
      
      // Trigger validation check
      checkFormValidity();
    }

    // Load trial data on page load
    async function loadTrialData() {
      try {
        // Load registration data first
        await loadRegistrationData();
        
        // Wait for auth
        await new Promise((resolve) => {
          if (auth.currentUser) {
            resolve();
          } else {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              unsubscribe();
              resolve();
            });
          }
        });

        if (!auth.currentUser) {
          alert("Please log in to access the entry form");
          window.location.href = 'index.html';
          return;
        }

        // Load most recent trial
        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", auth.currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        
        if (!trialsSnapshot.empty) {
          const trials = [];
          trialsSnapshot.forEach(doc => {
            trials.push({ id: doc.id, ...doc.data() });
          });
          
          trials.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
          currentTrialData = trials[0];
          
          console.log("‚úÖ Loaded trial data:", currentTrialData);
          populateTrialInfo();
        } else {
          alert("No trial found. Please create a trial first.");
          window.location.href = 'main-dashboard.html';
          return;
        }

        // Load application data if available
        if (currentTrialData) {
          const appQuery = query(
            collection(db, "applications"),
            where("trialId", "==", currentTrialData.id),
            where("createdBy", "==", auth.currentUser.uid)
          );
          
          const appSnapshot = await getDocs(appQuery);
          
          if (!appSnapshot.empty) {
            appSnapshot.forEach(doc => {
              currentApplicationData = { id: doc.id, ...doc.data() };
            });
            console.log("‚úÖ Loaded application data");
          }
        }

        populateClasses();
        setupEntryUrl();
        setupEventListeners();
        
        // Focus on registration number field
        document.getElementById('cwagsNumber').focus();
        
      } catch (error) {
        console.error("‚ùå Error loading trial data:", error);
        alert("Error loading trial data: " + error.message);
      }
    }

    function populateTrialInfo() {
      if (!currentTrialData) return;

      // Update header
      document.getElementById('trialTitle').textContent = 
        `üèÜ ${currentTrialData.clubName || 'Trial'} Entry Form`;
      
      // Update trial details
      document.getElementById('clubName').textContent = currentTrialData.clubName || 'TBD';
      document.getElementById('trialSecretary').textContent = currentTrialData.secretary || 'TBD';
      
      // Format dates
      if (currentTrialData.days && currentTrialData.days.length > 0) {
        const dates = currentTrialData.days
          .filter(day => day.date)
          .map(day => new Date(day.date).toLocaleDateString())
          .join(', ');
        document.getElementById('trialDates').textContent = dates || 'TBD';
      }

      // Location from application data
      if (currentApplicationData && currentApplicationData.trialLocation) {
        document.getElementById('trialLocation').textContent = currentApplicationData.trialLocation;
      }
    }

    function populateClasses() {
      if (!currentTrialData || !currentTrialData.days) return;

      const classSelection = document.getElementById('classSelection');
      const allClasses = new Set();

      // Extract all unique classes
      currentTrialData.days.forEach(day => {
        if (day.classes) {
          day.classes.forEach(cls => {
            if (cls.className && cls.className.trim()) {
              allClasses.add(cls.className.trim());
            }
          });
        }
      });

      // Create checkboxes for each class
      Array.from(allClasses).sort().forEach(className => {
        const checkboxItem = document.createElement('div');
        checkboxItem.className = 'checkbox-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `class_${className.replace(/\s+/g, '_')}`;
        checkbox.value = className;
        checkbox.addEventListener('change', updateClassSelection);
        
        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = className;
        
        checkboxItem.appendChild(checkbox);
        checkboxItem.appendChild(label);
        classSelection.appendChild(checkboxItem);
      });

      console.log(`‚úÖ Populated ${allClasses.size} classes`);
    }

    function setupEntryUrl() {
      const currentUrl = window.location.href;
      document.getElementById('entryUrl').textContent = currentUrl;
    }

    function updateClassSelection(event) {
      if (event.target.checked) {
        selectedClasses.add(event.target.value);
      } else {
        selectedClasses.delete(event.target.value);
      }
      
      updateEntrySummary();
      checkFormValidity();
    }

    function updateEntrySummary() {
      const classCount = selectedClasses.size;
      const isJunior = document.getElementById('juniorHandler').value === 'Yes';
      const isExhibition = document.getElementById('entryType').value === 'Exhibition';
      
      let totalFee = 0;
      
      if (isExhibition) {
        totalFee = fees.exhibition * classCount;
      } else if (isJunior) {
        totalFee = fees.juniorHandler * classCount;
      } else if (classCount > 0) {
        totalFee = fees.firstClass + (fees.additionalClass * (classCount - 1));
      }
      
      document.getElementById('selectedClassCount').textContent = classCount;
      document.getElementById('calculatedFee').textContent = `$${totalFee.toFixed(2)}`;
      document.getElementById('summaryEntryType').textContent = document.getElementById('entryType').value;
      document.getElementById('summaryJuniorHandler').textContent = document.getElementById('juniorHandler').value;
    }

    function checkFormValidity() {
      if (isAutoFilling) return; // Don't check during auto-fill
      
      const waiverAccepted = document.getElementById('waiverAccepted').checked;
      const cwagsNumber = document.getElementById('cwagsNumber').value.trim();
      const handlerName = document.getElementById('handlerName').value.trim();
      const handlerEmail = document.getElementById('handlerEmail').value.trim();
      const handlerPhone = document.getElementById('handlerPhone').value.trim();
      const dogCallName = document.getElementById('dogCallName').value.trim();
      const hasClasses = selectedClasses.size > 0;
      
      const isValid = waiverAccepted && cwagsNumber && handlerName && handlerEmail && handlerPhone && dogCallName && hasClasses;
      
      document.getElementById('submitBtn').disabled = !isValid;
    }

    // Setup all event listeners
    function setupEventListeners() {
      // Registration number lookup with debouncing
      let registrationTimeout;
      document.getElementById('cwagsNumber').addEventListener('input', function(e) {
        const registrationNumber = e.target.value.trim();
        
        // Clear previous timeout
        clearTimeout(registrationTimeout);
        
        // Only lookup if we have a reasonable registration number
        if (registrationNumber.length >= 3) {
          registrationTimeout = setTimeout(() => {
            autoFillFromRegistration(registrationNumber);
          }, 500); // Wait 500ms after user stops typing
        }
        
        checkFormValidity();
      });

      // Fee calculation listeners
      document.getElementById('juniorHandler').addEventListener('change', updateEntrySummary);
      document.getElementById('entryType').addEventListener('change', updateEntrySummary);
      
      // Form validation listeners - include cwagsNumber now
      ['waiverAccepted', 'cwagsNumber', 'handlerName', 'handlerEmail', 'handlerPhone', 'dogCallName'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', checkFormValidity);
          element.addEventListener('input', checkFormValidity);
        }
      });
    }

    // Form submission
    document.getElementById('entryForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!checkFormValidity()) {
        alert("Please complete all required fields and accept the waiver.");
        return;
      }
      
      try {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        const entryData = {
          trialId: currentTrialData.id,
          cwagsNumber: document.getElementById('cwagsNumber').value,
          handlerName: document.getElementById('handlerName').value,
          handlerPhone: document.getElementById('handlerPhone').value,
          handlerEmail: document.getElementById('handlerEmail').value,
          emergencyContact: document.getElementById('emergencyContact').value,
          mailingAddress: document.getElementById('mailingAddress').value,
          dogCallName: document.getElementById('dogCallName').value,
          dogRegisteredName: document.getElementById('dogRegisteredName').value,
          dogBreed: document.getElementById('dogBreed').value,
          dogBirthdate: document.getElementById('dogBirthdate').value,
          dogSex: document.getElementById('dogSex').value,
          dogWeight: document.getElementById('dogWeight').value,
          selectedClasses: Array.from(selectedClasses),
          juniorHandler: document.getElementById('juniorHandler').value === 'Yes',
          entryType: document.getElementById('entryType').value,
          specialNeeds: document.getElementById('specialNeeds').value,
          waiverAccepted: true,
          entryFee: document.getElementById('calculatedFee').textContent,
          submittedAt: new Date(),
          submittedBy: auth.currentUser ? auth.currentUser.uid : 'manual'
        };
        
        const docRef = await addDoc(collection(db, "entries"), entryData);
        console.log("‚úÖ Entry submitted with ID:", docRef.id);
        
        // Save registration data for future use
        await saveRegistrationData(entryData.cwagsNumber, entryData);
        
        // Show success message
        document.getElementById('entryForm').style.display = 'none';
        document.getElementById('successMessage').classList.remove('hidden');
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
      } catch (error) {
        console.error("‚ùå Error submitting entry:", error);
        alert("Error submitting entry: " + error.message);
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Entry';
      }
    });

    // Utility functions
    window.resetForm = function() {
      isAutoFilling = true; // Prevent auto-lookup during reset
      
      document.getElementById('entryForm').reset();
      selectedClasses.clear();
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      
      // Clear the lookup status
      document.getElementById('lookupStatus').style.display = 'none';
      
      updateEntrySummary();
      
      // Hide success message and show form
      document.getElementById('successMessage').classList.add('hidden');
      document.getElementById('entryForm').style.display = 'block';
      
      // Scroll to top and focus on registration number
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      setTimeout(() => {
        isAutoFilling = false; // Re-enable auto-lookup
        document.getElementById('cwagsNumber').focus();
        checkFormValidity();
      }, 500);
    };

    window.copyEntryLink = function() {
      const entryUrl = document.getElementById('entryUrl').textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(entryUrl).then(() => {
          alert('‚úÖ Entry form link copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy: ', err);
          fallbackCopyTextToClipboard(entryUrl);
        });
      } else {
        fallbackCopyTextToClipboard(entryUrl);
      }
    };

    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          alert('‚úÖ Entry form link copied to clipboard!');
        } else {
          alert('‚ùå Failed to copy link. Please copy manually: ' + text);
        }
      } catch (err) {
        alert('‚ùå Failed to copy link. Please copy manually: ' + text);
      }
      
      document.body.removeChild(textArea);
    }

    window.emailEntryLink = function() {
      const entryUrl = document.getElementById('entryUrl').textContent;
      const trialName = currentTrialData ? currentTrialData.clubName : 'Trial';
      const trialDates = document.getElementById('trialDates').textContent;
      
      const subject = encodeURIComponent(`Entry Form - ${trialName}`);
      const body = encodeURIComponent(`
Hello,

You're invited to enter the ${trialName} trial scheduled for ${trialDates}.

Please complete your entry using this secure online form:
${entryUrl}

The form includes:
‚Ä¢ Integrated liability waiver
‚Ä¢ Class selection for all available classes
‚Ä¢ Automatic fee calculation
‚Ä¢ Secure entry submission

For questions, please contact the trial secretary.

Thank you!
      `.trim());
      
      const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
      window.location.href = mailtoLink;
    };

    // Print functionality for paper entries
    window.printEntryForm = function() {
      const printWindow = window.open('', '_blank');
      const trialInfo = document.querySelector('.trial-info').innerHTML;
      const waiver = document.querySelector('.waiver-section').innerHTML;
      const form = document.querySelector('.entry-form').innerHTML;
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Entry Form - ${currentTrialData ? currentTrialData.clubName : 'Trial'}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
            .trial-info { border: 2px solid #333; padding: 15px; margin-bottom: 20px; }
            .waiver-section { border: 2px solid #ff9800; padding: 15px; margin-bottom: 20px; background: #fff9e6; }
            .form-section { margin-bottom: 20px; padding: 10px; border-left: 4px solid #28a745; }
            .form-row { display: flex; gap: 20px; margin-bottom: 10px; }
            .form-group { flex: 1; margin-bottom: 10px; }
            .form-group label { font-weight: bold; display: block; margin-bottom: 5px; }
            .form-group input, .form-group select, .form-group textarea { 
              border: 1px solid #ccc; padding: 5px; width: 100%; box-sizing: border-box; 
            }
            .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; }
            .checkbox-item { display: flex; align-items: center; gap: 5px; }
            h3 { color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
            @media print { body { margin: 0; } }
          </style>
        </head>
        <body>
          <h1>Trial Entry Form</h1>
          ${trialInfo}
          ${waiver}
          <div style="page-break-before: always;"></div>
          ${form}
          <br><br>
          <div style="border-top: 1px solid #ccc; padding-top: 10px; font-size: 12px; color: #666;">
            <p><strong>For Office Use Only:</strong></p>
            <p>Entry #: _______ | Received: _______ | Fee: _______ | Check #: _______</p>
          </div>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    };

    // Generate entry confirmation number
    function generateConfirmationNumber() {
      const timestamp = Date.now().toString(36);
      const random = Math.random().toString(36).substr(2, 5);
      return `ENT-${timestamp}-${random}`.toUpperCase();
    }

    // Export entries to CSV for trial secretary
    window.exportEntries = async function() {
      try {
        if (!currentTrialData) {
          alert("No trial data available");
          return;
        }

        const entriesQuery = query(
          collection(db, "entries"),
          where("trialId", "==", currentTrialData.id)
        );
        
        const entriesSnapshot = await getDocs(entriesQuery);
        
        if (entriesSnapshot.empty) {
          alert("No entries found for this trial");
          return;
        }

        let csvContent = "Handler Name,Email,Phone,Dog Call Name,C-WAGS #,Breed,Classes,Entry Type,Fee,Submitted Date\n";
        
        entriesSnapshot.forEach(doc => {
          const entry = doc.data();
          const classes = Array.isArray(entry.selectedClasses) ? entry.selectedClasses.join(';') : '';
          const submittedDate = entry.submittedAt ? entry.submittedAt.toDate().toLocaleDateString() : '';
          
          csvContent += `"${entry.handlerName}","${entry.handlerEmail}","${entry.handlerPhone}","${entry.dogCallName}","${entry.cwagsNumber || ''}","${entry.dogBreed || ''}","${classes}","${entry.entryType}","${entry.entryFee}","${submittedDate}"\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `${currentTrialData.clubName || 'Trial'}_Entries.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log("‚úÖ Entries exported to CSV");
        
      } catch (error) {
        console.error("‚ùå Error exporting entries:", error);
        alert("Error exporting entries: " + error.message);
      }
    };

    // Add print and export buttons to the entry link section
    function addManagementButtons() {
      const entryLink = document.querySelector('.entry-link .button-group');
      
      const printBtn = document.createElement('button');
      printBtn.className = 'btn btn-secondary';
      printBtn.onclick = printEntryForm;
      printBtn.innerHTML = 'üñ®Ô∏è Print Form';
      
      const exportBtn = document.createElement('button');
      exportBtn.className = 'btn btn-secondary';
      exportBtn.onclick = exportEntries;
      exportBtn.innerHTML = 'üìä Export Entries';
      
      entryLink.appendChild(printBtn);
      entryLink.appendChild(exportBtn);
    }

    // Initialize the form
    auth.onAuthStateChanged(user => {
      if (user) {
        loadTrialData();
        addManagementButtons();
      } else {
        window.location.href = 'index.html';
      }
    });

    console.log("‚úÖ Entry form system ready");
  </script>
</body>
</html>
