<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Entry Form</title>
    <style>
        /* Keep all existing styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .trial-info {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        /* New styles for shareable link section */
        .shareable-link-section {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .shareable-link-section h3 {
            color: #0066cc;
            margin-bottom: 15px;
        }

        .link-display {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .link-url {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
            color: #0066cc;
            margin-bottom: 10px;
        }

        .link-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-copy {
            background: #17a2b8;
            color: white;
        }

        .btn-copy:hover {
            background: #138496;
        }

        .btn-test {
            background: #28a745;
            color: white;
        }

        .btn-test:hover {
            background: #218838;
        }

        .btn-primary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 1rem 2rem;
            font-size: 1rem;
            min-width: 150px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 1rem 2rem;
            font-size: 1rem;
            min-width: 150px;
        }

        .form-container {
            padding: 30px;
            display: none;
        }

        .admin-only {
            display: none;
        }

        .trial-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .trial-detail {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .edit-link-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .edit-link-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .success-message {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .hidden {
            display: none;
        }

        /* Entry form styles */
        .waiver-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .waiver-content {
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
        }

        .waiver-agreement {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .waiver-agreement input[type="checkbox"] {
            margin-top: 4px;
            width: auto;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }

        .required label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        .class-selection {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .day-section {
            margin-bottom: 25px;
        }

        .day-header {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .class-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .entry-options {
            display: flex;
            gap: 10px;
        }

        .entry-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .entry-btn:hover {
            background: #667eea;
            color: white;
        }

        .entry-btn.selected {
            background: #667eea;
            color: white;
        }

        .entry-btn.feo {
            border-color: #ffc107;
            color: #ffc107;
        }

        .entry-btn.feo:hover,
        .entry-btn.feo.selected {
            background: #ffc107;
            color: #212529;
        }

        .entry-summary {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item strong {
            display: block;
            color: #495057;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0066cc;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .trial-details {
                grid-template-columns: 1fr;
            }

            .entry-options {
                flex-direction: column;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }

            .link-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 id="trialTitle">üèÜ Trial Entry Form</h1>
            <p id="trialSubtitle">Complete your entry for this C-WAGS trial</p>
        </div>

        <!-- Trial Selection (Always visible) -->
        <div class="trial-info">
            <h3>üéØ Select Trial</h3>
            <div class="form-row">
                <div class="form-group required full-width">
                    <label for="trialSelection">Choose which trial to enter:</label>
                    <select id="trialSelection" required style="font-size: 1.1rem; padding: 1rem;">
                        <option value="">Loading available trials...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Shareable Link Section (Shown after trial selection for secretary) -->
        <div class="shareable-link-section" id="shareableLinkSection">
            <h3>üîó Shareable Entry Link</h3>
            <p>Share this link with participants so they can enter from home:</p>
            <div class="link-display">
                <div class="link-url" id="shareableUrl">
                    <!-- Generated URL will appear here -->
                </div>
                <div class="link-actions">
                    <button class="btn btn-copy" onclick="copyShareableLink()">üìã Copy Link</button>
                    <button class="btn btn-test" onclick="testShareableLink()">üîó Test Link</button>
                </div>
            </div>
        </div>

        <!-- Trial Information -->
        <div class="trial-info" id="trialInfoSection" style="display: none;">
            <h3>üìã Trial Information</h3>
            <div class="trial-details" id="trialDetails">
                <!-- Trial details will be populated here -->
            </div>
        </div>

        <!-- Form Container (Entry form content) -->
        <div class="form-container" id="formContainer">
            <!-- Waiver Section -->
            <div class="waiver-section">
                <h3>‚ö†Ô∏è Liability Waiver & Release</h3>
                <div class="waiver-content">
                    <p><strong>WAIVER AND RELEASE OF LIABILITY</strong></p>
                    <p>I understand that participation in dog training and scent work activities involves inherent risks including but not limited to: dogs working in close proximity to each other, off-leash activities, and interaction with other dogs and handlers.</p>
                    <p>I acknowledge that I participate at my own risk and agree to hold harmless the hosting club, property owners, judges, and event organizers from any claims, damages, or injuries that may occur.</p>
                </div>
                <div class="waiver-agreement">
                    <input type="checkbox" id="waiverAccepted" required>
                    <label for="waiverAccepted">
                        <strong>I have read, understood, and agree to the terms of this waiver and release of liability.</strong>
                    </label>
                </div>
            </div>

            <!-- Entry Form -->
            <form id="entryForm">
                <!-- Handler Information -->
                <div class="form-section">
                    <h3>üë§ Handler Information</h3>
                    <div class="form-row">
                        <div class="form-group required">
                            <label>Handler Name</label>
                            <input type="text" id="handlerName" required>
                        </div>
                        <div class="form-group required">
                            <label>Phone Number</label>
                            <input type="tel" id="handlerPhone" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group required">
                            <label>Email Address</label>
                            <input type="email" id="handlerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Emergency Contact</label>
                            <input type="text" id="emergencyContact">
                        </div>
                    </div>
                </div>

                <!-- Dog Information -->
                <div class="form-section">
                    <h3>üêï Dog Information</h3>
                    <div class="form-row">
                        <div class="form-group required">
                            <label>Dog's Call Name</label>
                            <input type="text" id="dogCallName" required>
                        </div>
                        <div class="form-group">
                            <label>Breed</label>
                            <input type="text" id="dogBreed">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <input type="date" id="dogBirthdate">
                        </div>
                        <div class="form-group">
                            <label>Sex</label>
                            <select id="dogSex">
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Male Neutered">Male Neutered</option>
                                <option value="Female Spayed">Female Spayed</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>C-WAGS Registration Number (if applicable)</label>
                            <input type="text" id="cwagsNumber" placeholder="XX-XXXX-XX">
                        </div>
                        <div class="form-group">
                            <label>Junior Handler (Under 18)</label>
                            <select id="juniorHandler">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Class Selection -->
                <div class="form-section">
                    <h3>üéØ Class Entries</h3>
                    <p style="margin-bottom: 20px; color: #666;">Select the classes you wish to enter:</p>
                    <div id="classSelection" class="class-selection">
                        <!-- Classes will be populated here -->
                    </div>
                </div>

                <!-- Entry Summary -->
                <div class="entry-summary">
                    <h3>üí∞ Entry Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <strong>Classes Selected</strong>
                            <span class="summary-value" id="selectedClassCount">0</span>
                        </div>
                        <div class="summary-item">
                            <strong>Entry Fee</strong>
                            <span class="summary-value" id="calculatedFee">$0.00</span>
                        </div>
                        <div class="summary-item">
                            <strong>Junior Handler</strong>
                            <span class="summary-value" id="summaryJuniorHandler">No</span>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="button-group">
                    <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                        Submit Entry
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        Clear Form
                    </button>
                </div>
            </form>

            <!-- Edit Link Section (Shown after successful submission) -->
            <div class="edit-link-section hidden" id="editLinkSection">
                <h3>‚úÖ Entry Submitted Successfully!</h3>
                <p>Your entry has been recorded. Use this link to edit your entry in the future:</p>
                <div class="link-display">
                    <div class="link-url" id="editUrl">
                        <!-- Edit URL will appear here -->
                    </div>
                    <div class="link-actions">
                        <button class="btn btn-copy" onclick="copyEditLink()">üìã Copy Edit Link</button>
                        <button class="btn btn-test" onclick="testEditLink()">üîó Test Edit Link</button>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="resetForNewEntry()">Submit Another Entry</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { auth, db } from './js/firebase.js';
        import { collection, query, where, getDocs, doc, getDoc, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

        // Global variables
        let availableTrials = [];
        let currentTrialData = null;
        let selectedClasses = new Set();
        let isSecretary = false;

        // Initialize the application
        async function init() {
            // Check URL parameters for entry link
            const urlParams = new URLSearchParams(window.location.search);
            const entryId = urlParams.get('entry');
            const trialId = urlParams.get('trial');

            if (entryId) {
                // Load existing entry for editing
                await loadExistingEntry(entryId);
            } else if (trialId) {
                // Load specific trial for public entry
                await loadSpecificTrial(trialId);
            } else {
                // Normal secretary view
                isSecretary = true;
                await loadTrials();
            }
        }

        // Load trials for secretary
        async function loadTrials() {
            try {
                if (!auth.currentUser) {
                    alert("Please log in to access the entry form");
                    window.location.href = 'index.html';
                    return;
                }

                const q = query(
                    collection(db, "trials"),
                    where("createdBy", "==", auth.currentUser.uid)
                );
                
                const snapshot = await getDocs(q);
                availableTrials = [];
                
                snapshot.forEach(doc => {
                    availableTrials.push({ id: doc.id, ...doc.data() });
                });

                // Sort by creation date (most recent first)
                availableTrials.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                populateTrialSelector();
            } catch (error) {
                console.error('Error loading trials:', error);
                alert('Error loading trials: ' + error.message);
            }
        }

        // Load specific trial for public entry
        async function loadSpecificTrial(trialId) {
            try {
                const trialDoc = await getDoc(doc(db, 'trials', trialId));
                if (!trialDoc.exists()) {
                    alert('Trial not found');
                    return;
                }

                currentTrialData = { id: trialDoc.id, ...trialDoc.data() };
                populateTrialInfo();
                showEntryForm();
            } catch (error) {
                console.error('Error loading specific trial:', error);
                alert('Error loading trial: ' + error.message);
            }
        }

        // Load existing entry for editing
        async function loadExistingEntry(entryId) {
            try {
                const entryDoc = await getDoc(doc(db, 'entries', entryId));
                if (!entryDoc.exists()) {
                    alert('Entry not found');
                    return;
                }

                const entryData = entryDoc.data();
                
                // Load the trial
                const trialDoc = await getDoc(doc(db, 'trials', entryData.trialId));
                if (!trialDoc.exists()) {
                    alert('Associated trial not found');
                    return;
                }

                currentTrialData = { id: trialDoc.id, ...trialDoc.data() };
                
                // Populate trial info and form
                populateTrialInfo();
                showEntryForm();
                
                // Fill form with existing data
                populateFormWithEntryData(entryData);

            } catch (error) {
                console.error('Error loading existing entry:', error);
                alert('Error loading entry: ' + error.message);
            }
        }

        // Populate trial selector dropdown
        function populateTrialSelector() {
            const trialSelect = document.getElementById('trialSelection');
            trialSelect.innerHTML = '<option value="">Select a trial...</option>';

            availableTrials.forEach(trial => {
                const option = document.createElement('option');
                option.value = trial.id;
                
                let trialLabel = trial.clubName || 'Unnamed Trial';
                
                if (trial.days && trial.days.length > 0) {
                    const dates = trial.days
                        .filter(day => day.date)
                        .map(day => new Date(day.date).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        }))
                        .join(', ');
                    if (dates) {
                        trialLabel += ` (${dates})`;
                    }
                }
                
                option.textContent = trialLabel;
                trialSelect.appendChild(option);
            });

            // Handle trial selection change
            trialSelect.addEventListener('change', function() {
                const trialId = this.value;
                if (trialId) {
                    currentTrialData = availableTrials.find(t => t.id === trialId);
                    if (currentTrialData) {
                        populateTrialInfo();
                        generateShareableLink();
                        showEntryForm();
                    }
                } else {
                    hideTrialInfo();
                    hideShareableLink();
                    hideEntryForm();
                }
            });
        }

        // Generate shareable link
        function generateShareableLink() {
            if (!isSecretary || !currentTrialData) return;

            const baseUrl = window.location.origin + window.location.pathname;
            const shareableUrl = `${baseUrl}?trial=${currentTrialData.id}`;
            
            document.getElementById('shareableUrl').textContent = shareableUrl;
            document.getElementById('shareableLinkSection').style.display = 'block';
        }

        // Populate trial information
        function populateTrialInfo() {
            if (!currentTrialData) return;

            document.getElementById('trialTitle').textContent = `${currentTrialData.clubName || 'Trial'} Entry Form`;
            
            const dates = currentTrialData.days && currentTrialData.days.length > 0 
                ? currentTrialData.days.filter(day => day.date).map(day => new Date(day.date).toLocaleDateString()).join(', ')
                : 'No dates specified';

            document.getElementById('trialDetails').innerHTML = `
                <div class="trial-detail">
                    <div><strong>Club:</strong> ${currentTrialData.clubName || 'TBD'}</div>
                </div>
                <div class="trial-detail">
                    <div><strong>Dates:</strong> ${dates}</div>
                </div>
                <div class="trial-detail">
                    <div><strong>Secretary:</strong> ${currentTrialData.secretary || 'TBD'}</div>
                </div>
                <div class="trial-detail">
                    <div><strong>Location:</strong> TBD</div>
                </div>
            `;

            document.getElementById('trialInfoSection').style.display = 'block';
            populateClasses();
        }

        // Populate classes
        function populateClasses() {
            const classSelection = document.getElementById('classSelection');
            let html = '';

            if (!currentTrialData.days || currentTrialData.days.length === 0) {
                html = '<div style="text-align: center; padding: 20px; color: #666;">No classes available for this trial.</div>';
                classSelection.innerHTML = html;
                return;
            }

            // Group classes by day
            currentTrialData.days.forEach((day, dayIndex) => {
                if (!day.classes || day.classes.length === 0) return;

                const dayDate = day.date ? new Date(day.date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : `Day ${dayIndex + 1}`;

                html += `
                    <div class="day-section">
                        <div class="day-header">${dayDate}</div>
                `;

                // Group classes by name
                const classGroups = new Map();
                day.classes.forEach((cls, classIndex) => {
                    if (cls && cls.className && cls.className.trim()) {
                        const className = cls.className.trim();
                        if (!classGroups.has(className)) {
                            classGroups.set(className, []);
                        }
                        classGroups.get(className).push({...cls, dayIndex, classIndex});
                    }
                });

                classGroups.forEach((classInstances, className) => {
                    classInstances.forEach((classInstance, instanceIndex) => {
                        if (classInstance.rounds && Array.isArray(classInstance.rounds)) {
                            classInstance.rounds.forEach((round, roundIndex) => {
                                const judgeName = round.judge && round.judge.trim() ? round.judge : 'Judge TBD';
                                const roundNumber = round.roundNumber || (roundIndex + 1);
                                const regularId = `entry_${dayIndex}_${classInstance.classIndex}_${roundIndex}_regular`;
                                const feoId = `entry_${dayIndex}_${classInstance.classIndex}_${roundIndex}_feo`;
                                
                                const baseEntryValue = {
                                    dayIndex,
                                    classIndex: classInstance.classIndex,
                                    roundIndex,
                                    className,
                                    judge: judgeName,
                                    roundNumber,
                                    date: day.date || `Day ${dayIndex + 1}`
                                };
                                
                                const regularEntryValue = JSON.stringify({...baseEntryValue, entryType: 'regular'});
                                const feoEntryValue = JSON.stringify({...baseEntryValue, entryType: 'feo'});
                                
                                const showFeo = round.feo === true || round.FEO === true;

                                html += `
                                    <div class="class-item">
                                        <div class="class-header">
                                            <div class="class-name">${className} - Round ${roundNumber}</div>
                                            <div class="judge-name">Judge: ${judgeName}</div>
                                        </div>
                                        <div class="entry-options">
                                            <input type="checkbox" id="${regularId}" value='${regularEntryValue}' style="display: none;">
                                            <button type="button" class="entry-btn regular" data-entry-id="${regularId}">Regular Entry</button>
                                            ${showFeo ? `
                                                <input type="checkbox" id="${feoId}" value='${feoEntryValue}' style="display: none;">
                                                <button type="button" class="entry-btn feo" data-entry-id="${feoId}">FEO Entry</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    });
                });

                html += `</div>`;
            });

            classSelection.innerHTML = html;
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Entry button clicks
            document.querySelectorAll('.entry-btn').forEach(button => {
                button.addEventListener('click', handleEntryButtonClick);
            });

            // Form validation
            document.getElementById('entryForm').addEventListener('input', checkFormValidity);
            document.getElementById('waiverAccepted').addEventListener('change', checkFormValidity);
            document.getElementById('juniorHandler').addEventListener('change', updateEntrySummary);

            // Form submission
            document.getElementById('entryForm').addEventListener('submit', handleFormSubmit);
        }

        // Handle entry button clicks
        function handleEntryButtonClick(event) {
            event.preventDefault();
            
            const button = event.target;
            const entryId = button.dataset.entryId;
            const checkbox = document.getElementById(entryId);
            
            if (!checkbox) return;
            
            // Toggle selection
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                button.classList.add('selected');
                selectedClasses.add(checkbox.value);
            } else {
                button.classList.remove('selected');
                selectedClasses.delete(checkbox.value);
            }
            
            updateEntrySummary();
            checkFormValidity();
        }

        // Update entry summary
        function updateEntrySummary() {
            const entryCount = selectedClasses.size;
            const isJunior = document.getElementById('juniorHandler').value === 'Yes';
            
            let totalFee = 0;
            let regularEntries = 0;
            let feoEntries = 0;
            
            selectedClasses.forEach(entryJson => {
                try {
                    const entry = JSON.parse(entryJson);
                    if (entry.entryType === 'feo') {
                        feoEntries++;
                    } else {
                        regularEntries++;
                    }
                } catch (e) {
                    regularEntries++;
                }
            });
            
            // Fee calculation
            if (isJunior) {
                totalFee = 20.00 * regularEntries; // Junior handler fee
            } else if (regularEntries > 0) {
                totalFee = 35.00 + (25.00 * Math.max(0, regularEntries - 1)); // First class $35, additional $25
            }
            
            const uniqueClasses = new Set();
            selectedClasses.forEach(entryJson => {
                try {
                    const entry = JSON.parse(entryJson);
                    uniqueClasses.add(entry.className);
                } catch (e) {}
            });
            
            let entryBreakdown = `${entryCount} entries (${uniqueClasses.size} classes)`;
            if (feoEntries > 0) {
                entryBreakdown += ` - ${regularEntries} Regular, ${feoEntries} FEO`;
            }
            
            document.getElementById('selectedClassCount').textContent = entryBreakdown;
            document.getElementById('calculatedFee').textContent = `${totalFee.toFixed(2)}`;
            document.getElementById('summaryJuniorHandler').textContent = document.getElementById('juniorHandler').value;
        }

        // Check form validity
        function checkFormValidity() {
            const waiverAccepted = document.getElementById('waiverAccepted').checked;
            const handlerName = document.getElementById('handlerName').value.trim();
            const handlerEmail = document.getElementById('handlerEmail').value.trim();
            const handlerPhone = document.getElementById('handlerPhone').value.trim();
            const dogCallName = document.getElementById('dogCallName').value.trim();
            const hasClasses = selectedClasses.size > 0;
            
            const isValid = waiverAccepted && handlerName && handlerEmail && handlerPhone && dogCallName && hasClasses;
            
            document.getElementById('submitBtn').disabled = !isValid;
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                // Process selected classes
                const selectedEntries = Array.from(selectedClasses).map(entryJson => {
                    try {
                        return JSON.parse(entryJson);
                    } catch (e) {
                        return null;
                    }
                }).filter(entry => entry !== null);

                const entryData = {
                    trialId: currentTrialData.id,
                    handlerName: document.getElementById('handlerName').value.trim(),
                    handlerPhone: document.getElementById('handlerPhone').value.trim(),
                    handlerEmail: document.getElementById('handlerEmail').value.trim(),
                    emergencyContact: document.getElementById('emergencyContact').value.trim(),
                    dogCallName: document.getElementById('dogCallName').value.trim(),
                    dogBreed: document.getElementById('dogBreed').value.trim(),
                    dogBirthdate: document.getElementById('dogBirthdate').value,
                    dogSex: document.getElementById('dogSex').value,
                    cwagsNumber: document.getElementById('cwagsNumber').value.trim(),
                    selectedEntries: selectedEntries,
                    selectedClasses: selectedEntries.map(e => e.className),
                    entryCount: selectedEntries.length,
                    uniqueClassCount: new Set(selectedEntries.map(e => e.className)).size,
                    regularEntries: selectedEntries.filter(e => e.entryType === 'regular').length,
                    feoEntries: selectedEntries.filter(e => e.entryType === 'feo').length,
                    juniorHandler: document.getElementById('juniorHandler').value === 'Yes',
                    waiverAccepted: true,
                    entryFee: document.getElementById('calculatedFee').textContent,
                    submittedAt: new Date(),
                    submittedBy: auth.currentUser ? auth.currentUser.uid : 'public_entry'
                };

                // Save entry
                const docRef = await addDoc(collection(db, "entries"), entryData);
                
                // Generate edit link
                generateEditLink(docRef.id);
                
                // Show success section
                showSuccessSection();

            } catch (error) {
                console.error('Error submitting entry:', error);
                alert('Error submitting entry: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Entry';
            }
        }

        // Generate edit link after successful submission
        function generateEditLink(entryId) {
            const baseUrl = window.location.origin + window.location.pathname;
            const editUrl = `${baseUrl}?entry=${entryId}`;
            
            document.getElementById('editUrl').textContent = editUrl;
        }

        // Show success section
        function showSuccessSection() {
            document.getElementById('entryForm').style.display = 'none';
            document.getElementById('editLinkSection').classList.remove('hidden');
        }

        // Populate form with existing entry data
        function populateFormWithEntryData(entryData) {
            document.getElementById('handlerName').value = entryData.handlerName || '';
            document.getElementById('handlerPhone').value = entryData.handlerPhone || '';
            document.getElementById('handlerEmail').value = entryData.handlerEmail || '';
            document.getElementById('emergencyContact').value = entryData.emergencyContact || '';
            document.getElementById('dogCallName').value = entryData.dogCallName || '';
            document.getElementById('dogBreed').value = entryData.dogBreed || '';
            document.getElementById('dogBirthdate').value = entryData.dogBirthdate || '';
            document.getElementById('dogSex').value = entryData.dogSex || '';
            document.getElementById('cwagsNumber').value = entryData.cwagsNumber || '';
            document.getElementById('juniorHandler').value = entryData.juniorHandler ? 'Yes' : 'No';
            document.getElementById('waiverAccepted').checked = true;

            // Restore selected classes
            if (entryData.selectedEntries) {
                entryData.selectedEntries.forEach(entry => {
                    const entryJson = JSON.stringify(entry);
                    selectedClasses.add(entryJson);
                    
                    // Find and select the corresponding button
                    const entryId = `entry_${entry.dayIndex}_${entry.classIndex}_${entry.roundIndex}_${entry.entryType}`;
                    const button = document.querySelector(`[data-entry-id="${entryId}"]`);
                    const checkbox = document.getElementById(entryId);
                    
                    if (button && checkbox) {
                        button.classList.add('selected');
                        checkbox.checked = true;
                    }
                });
            }

            updateEntrySummary();
            checkFormValidity();
        }

        // Show/hide sections
        function showEntryForm() {
            document.getElementById('formContainer').style.display = 'block';
        }

        function hideEntryForm() {
            document.getElementById('formContainer').style.display = 'none';
        }

        function hideTrialInfo() {
            document.getElementById('trialInfoSection').style.display = 'none';
        }

        function hideShareableLink() {
            document.getElementById('shareableLinkSection').style.display = 'none';
        }

        // Copy shareable link to clipboard
        window.copyShareableLink = function() {
            const url = document.getElementById('shareableUrl').textContent;
            copyToClipboard(url, 'Shareable link copied to clipboard!');
        };

        // Test shareable link
        window.testShareableLink = function() {
            const url = document.getElementById('shareableUrl').textContent;
            window.open(url, '_blank');
        };

        // Copy edit link to clipboard
        window.copyEditLink = function() {
            const url = document.getElementById('editUrl').textContent;
            copyToClipboard(url, 'Edit link copied to clipboard!');
        };

        // Test edit link
        window.testEditLink = function() {
            const url = document.getElementById('editUrl').textContent;
            window.open(url, '_blank');
        };

        // Copy to clipboard utility
        function copyToClipboard(text, successMessage) {
            navigator.clipboard.writeText(text).then(() => {
                alert(successMessage);
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                // Fallback method
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(successMessage);
            });
        }

        // Reset form for new entry
        window.resetForNewEntry = function() {
            document.getElementById('editLinkSection').classList.add('hidden');
            document.getElementById('entryForm').style.display = 'block';
            resetForm();
        };

        // Reset form
        window.resetForm = function() {
            document.getElementById('entryForm').reset();
            selectedClasses.clear();
            
            document.querySelectorAll('.entry-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                if (cb.id !== 'waiverAccepted') cb.checked = false;
            });
            
            updateEntrySummary();
            checkFormValidity();
        };

        // Initialize when auth is ready (if secretary) or immediately (if public)
        auth.onAuthStateChanged(async (user) => {
            if (user || !isSecretary) {
                await init();
            } else if (isSecretary) {
                alert("Please log in to access the entry form");
                window.location.href = 'index.html';
            }
        });

        // For public access, initialize immediately
        if (window.location.search.includes('trial=') || window.location.search.includes('entry=')) {
            init();
        }
    </script>
</body>
</html>
