<!DOCTYPE html>
<html>
<head>
  <title>Trial Entry Form</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px 12px 0 0;
      text-align: center;
    }
    
    .trial-info {
      background: white;
      padding: 1.5rem;
      border-left: 4px solid #667eea;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .trial-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .entry-form {
      background: white;
      border-radius: 0 0 12px 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .waiver-section {
      background: #fff9e6;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .waiver-section h3 {
      color: #e65100;
      margin-bottom: 1rem;
    }
    
    .waiver-content {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    .waiver-agreement {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .waiver-agreement input[type="checkbox"] {
      margin-top: 0.2rem;
      transform: scale(1.2);
    }
    
    .form-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }
    
    .form-section.primary {
      border-left-color: #007bff;
      background: #f0f8ff;
    }
    
    .form-section h3 {
      color: #28a745;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-section.primary h3 {
      color: #007bff;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-group label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #333;
    }
    
    .form-group.required label::after {
      content: " *";
      color: #e74c3c;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      padding: 0.8rem;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .lookup-status {
      margin-top: 0.5rem;
      padding: 0.8rem;
      border-radius: 6px;
      font-size: 0.9rem;
      display: none;
    }
    
    .lookup-status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .lookup-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .lookup-status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .lookup-status.warning {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .auto-filled {
      background-color: #e8f5e8 !important;
      transition: background-color 2s ease;
    }
    
    .day-section {
      border: 2px solid #007bff;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .day-header {
      background: #007bff;
      color: white;
      padding: 1rem 1.5rem;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .day-content {
      background: white;
      padding: 1rem;
    }
    
    .class-section {
      border: 1px solid #28a745;
      border-radius: 6px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    
    .class-header {
      background: #28a745;
      color: white;
      padding: 0.8rem 1rem;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .class-content {
      background: #f8f9fa;
      padding: 0.8rem;
    }
    
    .round-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.6rem;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }
    
    .round-item:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }
    
    .round-item input[type="checkbox"] {
      transform: scale(1.2);
    }
    
    .round-item label {
      flex: 1;
      cursor: pointer;
      margin: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .round-info {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .round-number {
      background: #667eea;
      color: white;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .judge-name {
      font-weight: 500;
      color: #333;
    }
    
    .entry-options {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .entry-fee-tag {
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      color: white;
    }
    
    .entry-fee-tag.regular {
      background: #28a745;
    }
    
    .entry-fee-tag.feo {
      background: #ffc107;
      color: #333;
    }
    
    .round-item input[type="checkbox"]:checked + label {
      font-weight: 600;
    }
    
    .round-item input[type="checkbox"]:checked + label .judge-name {
      color: #667eea;
    }
    
    .no-classes-message {
      text-align: center;
      padding: 2rem;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      color: #856404;
    }
    
    .entry-summary {
      background: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .summary-item {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      text-align: center;
    }
    
    .summary-item strong {
      display: block;
      color: #28a745;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .success-message {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .hidden {
      display: none;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .form-row, .checkbox-group, .summary-grid {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .entry-options {
        flex-direction: column;
        gap: 0.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 id="trialTitle">üèÜ Trial Entry Form</h1>
      <p id="trialSubtitle">Complete your entry for this C-WAGS trial</p>
    </div>

    <!-- Trial Information -->
    <div class="trial-info">
      <h3>üìã Trial Information</h3>
      <div class="trial-details">
        <div><strong>Club:</strong> <span id="clubName">Loading...</span></div>
        <div><strong>Dates:</strong> <span id="trialDates">Loading...</span></div>
        <div><strong>Location:</strong> <span id="trialLocation">Loading...</span></div>
        <div><strong>Secretary:</strong> <span id="trialSecretary">Loading...</span></div>
      </div>
    </div>

    <div class="entry-form">
      <!-- Success Message -->
      <div id="successMessage" class="success-message hidden">
        <h3>‚úÖ Entry Submitted Successfully!</h3>
        <p>The entry has been recorded for this trial.</p>
        <button class="btn btn-primary" onclick="resetForm()">Enter Another Participant</button>
      </div>

      <!-- Waiver Section -->
      <div class="waiver-section">
        <h3>‚ö†Ô∏è Liability Waiver & Release</h3>
        <div class="waiver-content">
          <p><strong>WAIVER AND RELEASE OF LIABILITY</strong></p>
          <p>I understand that participation in dog training and scent work activities involves inherent risks including but not limited to: dogs working in close proximity to each other, off-leash activities, and interaction with other dogs and handlers.</p>
          <p>I acknowledge that I participate at my own risk and agree to hold harmless the hosting club, property owners, judges, and event organizers from any claims, damages, or injuries that may occur.</p>
        </div>
        <div class="waiver-agreement">
          <input type="checkbox" id="waiverAccepted" required>
          <label for="waiverAccepted">
            <strong>I have read, understood, and agree to the terms of this waiver and release of liability.</strong>
          </label>
        </div>
      </div>

      <!-- Entry Form -->
      <form id="entryForm">
        <!-- Registration Number - FIRST -->
        <div class="form-section primary">
          <h3>üîç Registration Lookup</h3>
          <div class="form-row">
            <div class="form-group required full-width">
              <label>C-WAGS Registration Number</label>
              <input type="text" id="cwagsNumber" required placeholder="XX-XXXX-XX" 
                     style="font-size: 1.2rem; font-weight: bold; background: #f0f8ff;">
              <small style="color: #666; margin-top: 0.5rem; display: block;">
                üí° Enter registration number first - handler and dog info will auto-fill
              </small>
            </div>
          </div>
          <div id="lookupStatus" class="lookup-status"></div>
        </div>

        <!-- Handler Information -->
        <div class="form-section">
          <h3>üë§ Handler Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Handler Name</label>
              <input type="text" id="handlerName" required placeholder="Will auto-fill from registration">
            </div>
            <div class="form-group required">
              <label>Phone Number</label>
              <input type="tel" id="handlerPhone" required placeholder="(xxx) xxx-xxxx">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group required">
              <label>Email Address</label>
              <input type="email" id="handlerEmail" required placeholder="handler@email.com">
            </div>
            <div class="form-group">
              <label>Emergency Contact</label>
              <input type="text" id="emergencyContact" placeholder="Name and phone number">
            </div>
          </div>
        </div>

        <!-- Dog Information -->
        <div class="form-section">
          <h3>üêï Dog Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Dog's Call Name</label>
              <input type="text" id="dogCallName" required placeholder="Will auto-fill from registration">
            </div>
            <div class="form-group">
              <label>Breed</label>
              <input type="text" id="dogBreed" placeholder="Enter breed">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" id="dogBirthdate">
            </div>
            <div class="form-group">
              <label>Sex</label>
              <select id="dogSex">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Male Neutered">Male Neutered</option>
                <option value="Female Spayed">Female Spayed</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Class Selection -->
        <div class="form-section">
          <h3>üéØ Class Entries</h3>
          <p style="margin-bottom: 1rem; color: #666;">Select the specific class/judge combinations you wish to enter:</p>
          <div id="classSelection">
            <div style="text-align: center; padding: 2rem; color: #666;">
              Loading available classes by day and judge...
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
          <h3>üìù Additional Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Junior Handler (Under 18)</label>
              <select id="juniorHandler">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            <div class="form-group">
              <label>Entry Type</label>
              <select id="entryType">
                <option value="Regular">Regular Entry</option>
                <option value="Exhibition">Exhibition Only</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Entry Summary -->
        <div class="entry-summary">
          <h3>üí∞ Entry Summary</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <strong>Classes Selected</strong>
              <span id="selectedClassCount">0</span>
            </div>
            <div class="summary-item">
              <strong>Entry Fee</strong>
              <span id="calculatedFee">$0.00</span>
            </div>
            <div class="summary-item">
              <strong>Entry Type</strong>
              <span id="summaryEntryType">Regular</span>
            </div>
            <div class="summary-item">
              <strong>Junior Handler</strong>
              <span id="summaryJuniorHandler">No</span>
            </div>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
            Submit Entry
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">
            Clear Form
          </button>
          <button type="button" class="btn btn-secondary" onclick="location.href='main-dashboard.html'">
            ‚Üê Back to Dashboard
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, addDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    console.log("üéØ Entry form loaded");

    // Global variables
    let currentTrialData = null;
    let currentApplicationData = null;
    let selectedClasses = new Set();
    let registrationData = [];
    let isAutoFilling = false;

    // Fee structure
    const fees = {
      firstClass: 35.00,
      additionalClass: 25.00,
      juniorHandler: 20.00,
      exhibition: 15.00
    };

    // Load registration data from data.json
    async function loadRegistrationData() {
      try {
        console.log("üìä Loading registration data...");
        const response = await fetch('./js/data.json');
        const data = await response.json();
        registrationData = data || [];
        console.log(`‚úÖ Loaded ${registrationData.length} registration records`);
      } catch (error) {
        console.warn("‚ö†Ô∏è Could not load registration data:", error);
        registrationData = [];
      }
    }

    // Show lookup status
    function showLookupStatus(message, type = 'loading') {
      const statusDiv = document.getElementById('lookupStatus');
      if (!statusDiv) return;
      
      statusDiv.className = `lookup-status ${type}`;
      statusDiv.innerHTML = message;
      statusDiv.style.display = 'block';
      
      if (type !== 'loading') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 4000);
      }
    }

    // Lookup registration in data.json
    function lookupInDataJson(registrationNumber) {
      if (!registrationNumber || !registrationData.length) return null;
      
      const normalizedReg = registrationNumber.trim().toLowerCase();
      return registrationData.find(record => 
        record.Registration && record.Registration.toLowerCase() === normalizedReg
      );
    }

    // Load saved data from Firebase
    async function loadSavedRegistrationData(registrationNumber) {
      try {
        if (!registrationNumber) return null;
        
        const docRef = doc(db, "registrations", registrationNumber);
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
          console.log("‚úÖ Found saved data for registration:", registrationNumber);
          return docSnap.data();
        }
        return null;
      } catch (error) {
        console.error("Error loading saved registration data:", error);
        return null;
      }
    }

    // Auto-fill from registration number
    async function autoFillFromRegistration(registrationNumber) {
      if (!registrationNumber || isAutoFilling) return;
      
      isAutoFilling = true;
      showLookupStatus('üîç Looking up registration...', 'loading');
      
      try {
        // First try Firebase (saved data)
        const savedData = await loadSavedRegistrationData(registrationNumber);
        
        if (savedData) {
          showLookupStatus('‚úÖ Found saved data - auto-filling form', 'success');
          populateForm(savedData);
        } else {
          // Try data.json
          const jsonData = lookupInDataJson(registrationNumber);
          
          if (jsonData) {
            showLookupStatus('üìã Found in database - auto-filling basic info', 'info');
            
            // Auto-fill from data.json
            if (jsonData.Handler) {
              fillField('handlerName', jsonData.Handler);
            }
            if (jsonData['Call Name']) {
              fillField('dogCallName', jsonData['Call Name']);
            }
          } else {
            showLookupStatus('‚ö†Ô∏è Registration not found - please fill manually', 'warning');
          }
        }
      } catch (error) {
        console.error("Error in auto-fill:", error);
        showLookupStatus('‚ùå Error looking up registration', 'warning');
      } finally {
        isAutoFilling = false;
      }
    }

    // Fill individual field with visual feedback
    function fillField(fieldId, value) {
      const field = document.getElementById(fieldId);
      if (field && value && (!field.value || field.value.trim() === '')) {
        field.value = value;
        field.classList.add('auto-filled');
        setTimeout(() => {
          field.classList.remove('auto-filled');
        }, 2000);
      }
    }

    // Populate form with saved data
    function populateForm(data) {
      if (!data || isAutoFilling) return;
      
      fillField('handlerName', data.handlerName);
      fillField('handlerPhone', data.handlerPhone);
      fillField('handlerEmail', data.handlerEmail);
      fillField('emergencyContact', data.emergencyContact);
      fillField('dogCallName', data.dogCallName);
      fillField('dogBreed', data.dogBreed);
      fillField('dogBirthdate', data.dogBirthdate);
      
      if (data.dogSex) {
        const sexField = document.getElementById('dogSex');
        if (sexField) sexField.value = data.dogSex;
      }
      
      checkFormValidity();
    }

    // Load trial data
    async function loadTrialData() {
      try {
        await loadRegistrationData();
        
        // Wait for auth
        await new Promise((resolve) => {
          if (auth.currentUser) {
            resolve();
          } else {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              unsubscribe();
              resolve();
            });
          }
        });

        if (!auth.currentUser) {
          alert("Please log in to access the entry form");
          window.location.href = 'index.html';
          return;
        }

        // Load most recent trial
        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", auth.currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        
        if (!trialsSnapshot.empty) {
          const trials = [];
          trialsSnapshot.forEach(doc => {
            trials.push({ id: doc.id, ...doc.data() });
          });
          
          trials.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
          currentTrialData = trials[0];
          
          console.log("‚úÖ Loaded trial data:", currentTrialData);
          populateTrialInfo();
          populateClasses();
        } else {
          alert("No trial found. Please create a trial first.");
          window.location.href = 'main-dashboard.html';
          return;
        }

        setupEventListeners();
        document.getElementById('cwagsNumber').focus();
        
      } catch (error) {
        console.error("‚ùå Error loading trial data:", error);
        alert("Error loading trial data: " + error.message);
      }
    }

    // Populate trial information
    function populateTrialInfo() {
      if (!currentTrialData) return;

      document.getElementById('trialTitle').textContent = 
        `üèÜ ${currentTrialData.clubName || 'Trial'} Entry Form`;
      
      document.getElementById('clubName').textContent = currentTrialData.clubName || 'TBD';
      document.getElementById('trialSecretary').textContent = currentTrialData.secretary || 'TBD';
      
      // Format dates
      if (currentTrialData.days && currentTrialData.days.length > 0) {
        const dates = currentTrialData.days
          .filter(day => day.date)
          .map(day => new Date(day.date).toLocaleDateString())
          .join(', ');
        document.getElementById('trialDates').textContent = dates || 'TBD';
      }

      document.getElementById('trialLocation').textContent = 'TBD';
    }

    // Check if FEO is available for a specific class
    function isFeoAvailable(classData) {
      return classData && classData.feoAvailable === true;
    }

    // Populate classes organized by day, class, and judge
    function populateClasses() {
      const classSelection = document.getElementById('classSelection');
      if (!classSelection) {
        console.error("‚ùå classSelection element not found");
        return;
      }

      if (!currentTrialData || !currentTrialData.days) {
        classSelection.innerHTML = `
          <div class="no-classes-message">
            ‚ö†Ô∏è No trial data available. Please check your trial setup.
          </div>
        `;
        return;
      }

      console.log("üìÖ Processing trial days and classes...", currentTrialData.days);
      
      let hasAnyClasses = false;
      let classSelectionHTML = '';

      // Process each day
      currentTrialData.days.forEach((day, dayIndex) => {
        if (!day || !day.classes || !Array.isArray(day.classes) || day.classes.length === 0) {
          return; // Skip days with no classes
        }

        hasAnyClasses = true;
        
        // Format the date
        const dayDate = day.date ? new Date(day.date).toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        }) : `Day ${dayIndex + 1}`;

        classSelectionHTML += `
          <div class="day-section">
            <div class="day-header">
              üìÖ ${dayDate}
            </div>
            <div class="day-content">
        `;

        // Group classes by name for this day
        const classGroups = new Map();
        
        day.classes.forEach((cls, classIndex) => {
          if (cls && cls.className && cls.className.trim()) {
            const className = cls.className.trim();
            if (!classGroups.has(className)) {
              classGroups.set(className, []);
            }
            classGroups.get(className).push({...cls, dayIndex, classIndex});
          }
        });

        // Process each class group
        classGroups.forEach((classInstances, className) => {
          classSelectionHTML += `
            <div class="class-section">
              <div class="class-header">
                <span>üéØ ${className}</span>
                <span>${classInstances.length} round${classInstances.length > 1 ? 's' : ''}</span>
              </div>
              <div class="class-content">
          `;

          // Process each round for this class
          classInstances.forEach((classInstance, instanceIndex) => {
            if (classInstance.rounds && Array.isArray(classInstance.rounds)) {
              classInstance.rounds.forEach((round, roundIndex) => {
                const judgeName = round.judge && round.judge.trim() ? round.judge : 'Judge TBD';
                const roundNumber = round.roundNumber || (roundIndex + 1);
                const regularId = `entry_${dayIndex}_${classInstance.classIndex}_${roundIndex}_regular`;
                const feoId = `entry_${dayIndex}_${classInstance.classIndex}_${roundIndex}_feo`;
                
                const baseEntryValue = {
                  dayIndex,
                  classIndex: classInstance.classIndex,
                  roundIndex,
                  className,
                  judge: judgeName,
                  roundNumber,
                  date: day.date || `Day ${dayIndex + 1}`
                };
                
                const regularEntryValue = JSON.stringify({...baseEntryValue, entryType: 'regular'});
                const feoEntryValue = JSON.stringify({...baseEntryValue, entryType: 'feo'});
                
                const showFeo = isFeoAvailable(classInstance);

                classSelectionHTML += `
                  <div class="round-item">
                    <input type="checkbox" id="${regularId}" value='${regularEntryValue}'>
                    <label for="${regularId}">
                      <div class="round-info">
                        <span class="round-number">Round ${roundNumber}</span>
                        <span class="judge-name">${judgeName}</span>
                      </div>
                      <div class="entry-options">
                        <span class="entry-fee-tag regular">Regular</span>
                        ${showFeo ? `
                          <input type="checkbox" id="${feoId}" value='${feoEntryValue}' style="margin-left: 0.5rem;">
                          <label for="${feoId}" style="margin: 0;">
                            <span class="entry-fee-tag feo">FEO</span>
                          </label>
                        ` : ''}
                      </div>
                    </label>
                  </div>
                `;
              });
            } else {
              // Class with no rounds defined - create a default entry
              const regularId = `entry_${dayIndex}_${classInstance.classIndex}_0_regular`;
              const feoId = `entry_${dayIndex}_${classInstance.classIndex}_0_feo`;
              
              const baseEntryValue = {
                dayIndex,
                classIndex: classInstance.classIndex,
                roundIndex: 0,
                className,
                judge: 'Judge TBD',
                roundNumber: 1,
                date: day.date || `Day ${dayIndex + 1}`
              };
              
              const regularEntryValue = JSON.stringify({...baseEntryValue, entryType: 'regular'});
              const feoEntryValue = JSON.stringify({...baseEntryValue, entryType: 'feo'});
              
              const showFeo = isFeoAvailable(classInstance);

              classSelectionHTML += `
                <div class="round-item">
                  <input type="checkbox" id="${regularId}" value='${regularEntryValue}'>
                  <label for="${regularId}">
                    <div class="round-info">
                      <span class="round-number">Round 1</span>
                      <span class="judge-name">Judge TBD</span>
                    </div>
                    <div class="entry-options">
                      <span class="entry-fee-tag regular">Regular</span>
                      ${showFeo ? `
                        <input type="checkbox" id="${feoId}" value='${feoEntryValue}' style="margin-left: 0.5rem;">
                        <label for="${feoId}" style="margin: 0;">
                          <span class="entry-fee-tag feo">FEO</span>
                        </label>
                      ` : ''}
                    </div>
                  </label>
                </div>
              `;
            }
          });

          classSelectionHTML += `
              </div>
            </div>
          `;
        });

        classSelectionHTML += `
            </div>
          </div>
        `;
      });

      if (!hasAnyClasses) {
        classSelection.innerHTML = `
          <div class="no-classes-message">
            ‚ö†Ô∏è No classes found in trial data. Please create classes in your trial setup.
          </div>
        `;
        return;
      }

      classSelection.innerHTML = classSelectionHTML;

      // Add event listeners to all checkboxes
      classSelection.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateClassSelection);
      });

      console.log(`‚úÖ Populated classes organized by day, class, and judge with FEO options`);
    }

    // Update class selection with detailed entry tracking
    function updateClassSelection(event) {
      const entryData = JSON.parse(event.target.value);
      
      if (event.target.checked) {
        selectedClasses.add(event.target.value);
        console.log(`‚úÖ Added entry: ${entryData.className} - Round ${entryData.roundNumber} (${entryData.judge}) - ${entryData.entryType.toUpperCase()}`);
      } else {
        selectedClasses.delete(event.target.value);
        console.log(`‚ùå Removed entry: ${entryData.className} - Round ${entryData.roundNumber} (${entryData.judge}) - ${entryData.entryType.toUpperCase()}`);
      }
      
      updateEntrySummary();
      checkFormValidity();
    }

    // Update entry summary with detailed breakdown
    function updateEntrySummary() {
      const entryCount = selectedClasses.size;
      const isJunior = document.getElementById('juniorHandler').value === 'Yes';
      const isExhibition = document.getElementById('entryType').value === 'Exhibition';
      
      let totalFee = 0;
      let regularEntries = 0;
      let feoEntries = 0;
      
      // Count regular vs FEO entries
      selectedClasses.forEach(entryJson => {
        try {
          const entry = JSON.parse(entryJson);
          if (entry.entryType === 'feo') {
            feoEntries++;
          } else {
            regularEntries++;
          }
        } catch (e) {
          console.warn("Error parsing entry data:", e);
          regularEntries++; // Default to regular if parsing fails
        }
      });
      
      if (isExhibition) {
        totalFee = fees.exhibition * entryCount;
      } else if (isJunior) {
        totalFee = fees.juniorHandler * entryCount;
      } else if (entryCount > 0) {
        // FEO entries are typically free or lower cost - keeping same pricing for now
        totalFee = fees.firstClass + (fees.additionalClass * (entryCount - 1));
      }
      
      // Count unique classes (for display purposes)
      const uniqueClasses = new Set();
      selectedClasses.forEach(entryJson => {
        try {
          const entry = JSON.parse(entryJson);
          uniqueClasses.add(entry.className);
        } catch (e) {
          console.warn("Error parsing entry data:", e);
        }
      });
      
      let entryBreakdown = `${entryCount} entries (${uniqueClasses.size} classes)`;
      if (feoEntries > 0) {
        entryBreakdown += ` - ${regularEntries} Regular, ${feoEntries} FEO`;
      }
      
      document.getElementById('selectedClassCount').textContent = entryBreakdown;
      document.getElementById('calculatedFee').textContent = `${totalFee.toFixed(2)}`;
      document.getElementById('summaryEntryType').textContent = document.getElementById('entryType').value;
      document.getElementById('summaryJuniorHandler').textContent = document.getElementById('juniorHandler').value;
    }

    // Check form validity
    function checkFormValidity() {
      if (isAutoFilling) return;
      
      const waiverAccepted = document.getElementById('waiverAccepted').checked;
      const cwagsNumber = document.getElementById('cwagsNumber').value.trim();
      const handlerName = document.getElementById('handlerName').value.trim();
      const handlerEmail = document.getElementById('handlerEmail').value.trim();
      const handlerPhone = document.getElementById('handlerPhone').value.trim();
      const dogCallName = document.getElementById('dogCallName').value.trim();
      const hasClasses = selectedClasses.size > 0;
      
      const isValid = waiverAccepted && cwagsNumber && handlerName && handlerEmail && handlerPhone && dogCallName && hasClasses;
      
      document.getElementById('submitBtn').disabled = !isValid;
    }

    // Setup event listeners
    function setupEventListeners() {
      // Registration number lookup with debouncing
      let registrationTimeout;
      const cwagsInput = document.getElementById('cwagsNumber');
      if (cwagsInput) {
        cwagsInput.addEventListener('input', function(e) {
          const registrationNumber = e.target.value.trim();
          
          clearTimeout(registrationTimeout);
          
          if (registrationNumber.length >= 3) {
            registrationTimeout = setTimeout(() => {
              autoFillFromRegistration(registrationNumber);
            }, 500);
          }
          
          checkFormValidity();
        });
      }

      // Fee calculation listeners
      const juniorHandler = document.getElementById('juniorHandler');
      const entryType = document.getElementById('entryType');
      
      if (juniorHandler) juniorHandler.addEventListener('change', updateEntrySummary);
      if (entryType) entryType.addEventListener('change', updateEntrySummary);
      
      // Form validation listeners
      const validationFields = ['waiverAccepted', 'cwagsNumber', 'handlerName', 'handlerEmail', 'handlerPhone', 'dogCallName'];
      validationFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', checkFormValidity);
          element.addEventListener('input', checkFormValidity);
        }
      });
    }

    // Save registration data for future use
    async function saveRegistrationData(registrationNumber, formData) {
      try {
        if (!registrationNumber || !auth.currentUser) return;
        
        const registrationDoc = {
          cwagsNumber: registrationNumber,
          handlerName: formData.handlerName,
          handlerPhone: formData.handlerPhone,
          handlerEmail: formData.handlerEmail,
          emergencyContact: formData.emergencyContact,
          dogCallName: formData.dogCallName,
          dogBreed: formData.dogBreed,
          dogBirthdate: formData.dogBirthdate,
          dogSex: formData.dogSex,
          lastUpdated: new Date(),
          lastTrialId: currentTrialData?.id
        };
        
        await setDoc(doc(db, "registrations", registrationNumber), registrationDoc);
        console.log("‚úÖ Saved registration data for:", registrationNumber);
      } catch (error) {
        console.error("Error saving registration data:", error);
      }
    }

    // Form submission
    document.getElementById('entryForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!checkFormValidity()) {
        alert("Please complete all required fields and accept the waiver.");
        return;
      }
      
      try {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        // Process selected classes for storage
        const selectedEntries = Array.from(selectedClasses).map(entryJson => {
          try {
            return JSON.parse(entryJson);
          } catch (e) {
            console.warn("Error parsing entry data:", e);
            return null;
          }
        }).filter(entry => entry !== null);

        const entryData = {
          trialId: currentTrialData.id,
          cwagsNumber: document.getElementById('cwagsNumber').value,
          handlerName: document.getElementById('handlerName').value,
          handlerPhone: document.getElementById('handlerPhone').value,
          handlerEmail: document.getElementById('handlerEmail').value,
          emergencyContact: document.getElementById('emergencyContact').value,
          dogCallName: document.getElementById('dogCallName').value,
          dogBreed: document.getElementById('dogBreed').value,
          dogBirthdate: document.getElementById('dogBirthdate').value,
          dogSex: document.getElementById('dogSex').value,
          selectedEntries: selectedEntries, // Detailed entry data with day/class/judge/round/type
          selectedClasses: selectedEntries.map(e => e.className), // Simple class names for compatibility
          entryCount: selectedEntries.length,
          uniqueClassCount: new Set(selectedEntries.map(e => e.className)).size,
          regularEntries: selectedEntries.filter(e => e.entryType === 'regular').length,
          feoEntries: selectedEntries.filter(e => e.entryType === 'feo').length,
          juniorHandler: document.getElementById('juniorHandler').value === 'Yes',
          entryType: document.getElementById('entryType').value,
          waiverAccepted: true,
          entryFee: document.getElementById('calculatedFee').textContent,
          submittedAt: new Date(),
          submittedBy: auth.currentUser ? auth.currentUser.uid : 'manual'
        };
        
        // Save entry
        const docRef = await addDoc(collection(db, "entries"), entryData);
        console.log("‚úÖ Entry submitted with ID:", docRef.id);
        
        // Save registration data for future use
        await saveRegistrationData(entryData.cwagsNumber, entryData);
        
        // Show success message
        document.getElementById('entryForm').style.display = 'none';
        document.getElementById('successMessage').classList.remove('hidden');
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
      } catch (error) {
        console.error("‚ùå Error submitting entry:", error);
        alert("Error submitting entry: " + error.message);
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Entry';
      }
    });

    // Reset form function
    window.resetForm = function() {
      isAutoFilling = true;
      
      document.getElementById('entryForm').reset();
      selectedClasses.clear();
      
      // Clear checkboxes
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb.id !== 'waiverAccepted') cb.checked = false;
      });
      
      // Clear lookup status
      const statusDiv = document.getElementById('lookupStatus');
      if (statusDiv) statusDiv.style.display = 'none';
      
      updateEntrySummary();
      
      // Hide success message and show form
      document.getElementById('successMessage').classList.add('hidden');
      document.getElementById('entryForm').style.display = 'block';
      
      // Scroll to top and focus on registration
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      setTimeout(() => {
        isAutoFilling = false;
        const cwagsInput = document.getElementById('cwagsNumber');
        if (cwagsInput) cwagsInput.focus();
        checkFormValidity();
      }, 500);
    };

    // Initialize the form when auth is ready
    auth.onAuthStateChanged(user => {
      if (user) {
        console.log("üë§ User authenticated, loading trial data...");
        loadTrialData();
      } else {
        console.log("‚ùå No user found, redirecting to login");
        window.location.href = 'index.html';
      }
    });

    console.log("‚úÖ Entry form system ready with FEO support");
  </script>
</body>
</html>
