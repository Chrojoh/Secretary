<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trial Entry Form</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    /* Back to Dashboard Button */
    .back-to-dashboard {
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      padding: 15px 20px;
    }
    
    .back-button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s ease;
    }
    
    .back-button:hover {
      background: #5a6268;
    }
    
    .trial-info {
      background: #f8f9fa;
      padding: 1.5rem;
      border-bottom: 1px solid #e9ecef;
    }
    
    .trial-info h3 {
      color: #495057;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    
    .trial-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .trial-details > div {
      font-size: 0.95rem;
    }
    
    .trial-details strong {
      color: #495057;
    }
    
    /* Shareable Link Section */
    .shareable-link-section {
      background: #e7f3ff;
      border: 2px solid #0066cc;
      border-radius: 8px;
      padding: 20px;
      margin: 20px;
      display: none;
    }
    
    .shareable-link-section h3 {
      color: #0066cc;
      margin-bottom: 15px;
    }
    
    .link-display {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .link-url {
      font-family: monospace;
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      word-break: break-all;
      color: #0066cc;
      margin-bottom: 10px;
    }
    
    .link-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-copy, .btn-test {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    
    .btn-copy {
      background: #17a2b8;
      color: white;
    }
    
    .btn-test {
      background: #28a745;
      color: white;
    }
    
    .entry-form {
      padding: 2rem;
    }
    
    .form-section {
      margin-bottom: 2rem;
    }
    
    .form-section h3 {
      color: #495057;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 0.5rem;
    }
    
    .form-section.primary {
      background: #f0f8ff;
      border: 2px solid #0066cc;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .form-section.primary h3 {
      color: #0066cc;
      border-bottom-color: #0066cc;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-group.required label::after {
      content: " *";
      color: #dc3545;
      font-weight: bold;
    }
    
    label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #495057;
    }
    
    input, select, textarea {
      padding: 0.75rem;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .auto-filled {
      background: #e7f3ff !important;
      border-color: #0066cc !important;
      animation: autoFillGlow 2s ease-in-out;
    }
    
    @keyframes autoFillGlow {
      0% { box-shadow: 0 0 5px rgba(0, 102, 204, 0.5); }
      50% { box-shadow: 0 0 20px rgba(0, 102, 204, 0.8); }
      100% { box-shadow: none; }
    }
    
    .lookup-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    
    .lookup-status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      display: block;
    }
    
    .lookup-status.warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      display: block;
    }
    
    .lookup-status.loading {
      background: #e7f3ff;
      border: 1px solid #bee5eb;
      color: #0c5460;
      display: block;
    }
    
    .waiver-section {
      background: #fff8e1;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .waiver-content {
      margin-bottom: 1rem;
      line-height: 1.6;
    }
    
    .waiver-agreement {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .waiver-agreement input[type="checkbox"] {
      margin-top: 0.2rem;
      width: auto;
    }
    
    /* Tabbed Class Entries Styles */
    .entry-summary {
      background: #e7f3ff;
      border: 2px solid #0066cc;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      display: none;
    }
    
    .summary-title {
      font-weight: 600;
      color: #0066cc;
      margin-bottom: 1rem;
    }
    
    .selected-entries {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .selected-entry {
      background: white;
      padding: 0.5rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      border-left: 4px solid #28a745;
    }
    
    .day-tabs-container {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .day-tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .day-tab {
      flex: 1;
      min-width: 150px;
      padding: 0.75rem 1rem;
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .day-tab:hover {
      border-color: #0066cc;
      color: #0066cc;
    }
    
    .day-tab.active {
      background: #0066cc;
      color: white;
      border-color: #0066cc;
    }
    
    .class-entries-container {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1rem;
    }
    
    .class-day-content {
      display: none;
    }
    
    .class-day-content.active {
      display: block;
    }
    
    .class-item {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      overflow: hidden;
      transition: box-shadow 0.3s ease;
    }
    
    .class-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .class-header {
      background: #28a745;
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .class-name {
      font-weight: 600;
      font-size: 1.1rem;
      text-align: center;
    }
    
    .class-fee {
      display: none;
    }
    
    .class-details {
      background: #f8f9fa;
      padding: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    .round-item {
      background: #f0f8ff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    
    .round-details {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 0.75rem;
    }
    
    .judge-name {
      font-weight: 600;
      color: #495057;
    }
    
    .entry-options {
      display: flex;
      gap: 0.5rem;
    }
    
    .rounds-container {
      padding: 1rem;
      background: #fff;
    }
    
    .entry-option {
      flex: 1;
      max-width: 200px;
    }
    
    .entry-checkbox {
      display: block;
      border-radius: 20px;
      padding: 0.4rem 0.8rem;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      font-size: 0.8rem;
      white-space: nowrap;
      border: 2px solid;
    }
    
    .entry-checkbox input[type="checkbox"] {
      display: none;
    }
    
    /* Round-based entry options styling */
    .round-entry-options {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    
    .round-entry-options .entry-option {
      flex: 1;
      min-width: 120px;
      max-width: 200px;
    }
    
    /* Regular entry styling - Green */
    .entry-checkbox.regular-entry {
      background: #d4edda !important;
      border: 2px solid #28a745 !important;
      color: #155724 !important;
    }
    
    .entry-checkbox.regular-entry:hover:not(.selected) {
      background: #28a745 !important;
      color: white !important;
    }
    
    .entry-checkbox.regular-entry.selected {
      background: #155724 !important;
      color: white !important;
      box-shadow: 0 0 0 3px rgba(21, 87, 36, 0.4) !important;
      transform: scale(1.02);
      font-weight: 700;
    }
    
    /* FEO entry styling - Yellow */
    .entry-checkbox.feo-entry {
      background: #fff3cd !important;
      border: 2px solid #ffc107 !important;
      color: #856404 !important;
    }
    
    .entry-checkbox.feo-entry:hover:not(.selected) {
      background: #ffc107 !important;
      color: #212529 !important;
    }
    
    .entry-checkbox.feo-entry.selected {
      background: #856404 !important;
      color: white !important;
      box-shadow: 0 0 0 3px rgba(133, 100, 4, 0.4) !important;
      transform: scale(1.02);
      font-weight: 700;
    }
    
    .submit-section {
      margin-top: 2rem;
      text-align: center;
      padding-top: 2rem;
      border-top: 2px solid #e9ecef;
    }
    
    .btn-submit {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 1rem 3rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
    }
    
    .btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }
    
    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .success-message {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .edit-link-section {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }
    
    .edit-link-section h3 {
      color: #856404;
      margin-bottom: 10px;
    }
    
    .hidden {
      display: none;
    }
    
    /* Day group headers in summary */
    .day-group-header {
      background: #0066cc !important;
      color: white !important;
      padding: 0.5rem 1rem !important;
      margin: 0.5rem 0 0.25rem 0 !important;
      border-radius: 6px !important;
      font-weight: 700 !important;
      font-size: 0.9rem !important;
      list-style: none !important;
      border-left: none !important;
    }
    
    .selected-entry {
      background: white;
      padding: 0.4rem 1rem;
      margin-bottom: 0.25rem;
      border-radius: 4px;
      border-left: 4px solid #28a745;
      font-size: 0.85rem;
      line-height: 1.3;
      margin-left: 1rem;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .day-tabs {
        flex-direction: column;
      }
      
      .day-tab {
        min-width: auto;
      }
      
      .class-details {
        grid-template-columns: 1fr;
      }
      
      .round-item {
        padding: 0.5rem;
      }
      
      .entry-checkbox {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
      }
      
      .round-entry-options {
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .round-entry-options .entry-option {
        min-width: auto;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 id="trialTitle">🏆 Trial Entry Form</h1>
      <p id="trialSubtitle">Complete your entry for this C-WAGS trial</p>
    </div>

    <!-- Trial Selection (Secretary Only) -->
    <div class="trial-info" id="trialSelectionSection">
      <!-- Back to Dashboard Button -->
      <div class="back-to-dashboard">
        <a href="main-dashboard.html" class="back-button">
          ← Back to Dashboard
        </a>
      </div>
      
      <h3>🎯 Select Trial</h3>
      <div class="form-row">
        <div class="form-group required full-width">
          <label for="trialSelection">Choose which trial to enter:</label>
          <select id="trialSelection" required style="font-size: 1.1rem; padding: 1rem;">
            <option value="">Loading available trials...</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Entry Fee Configuration (Secretary Only) -->
    <div class="trial-info" id="entryFeeSection" style="display: none;">
      <h3>💰 Entry Fee Configuration</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="regularFee">Regular Entry Fee ($)</label>
          <input type="number" id="regularFee" min="0" step="0.01" value="35.00" 
                 style="font-size: 1.1rem; padding: 0.75rem;">
        </div>
        <div class="form-group">
          <label for="feoFee">FEO Entry Fee ($)</label>
          <input type="number" id="feoFee" min="0" step="0.01" value="25.00" 
                 style="font-size: 1.1rem; padding: 0.75rem;">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="juniorFee">Junior Handler Fee ($)</label>
          <input type="number" id="juniorFee" min="0" step="0.01" value="20.00" 
                 style="font-size: 1.1rem; padding: 0.75rem;">
        </div>
        <div class="form-group">
          <label style="color: #666; font-weight: normal; font-size: 0.9rem; margin-top: 1rem;">
            💡 These fees will be applied to all entries for this trial. Junior Handler fee replaces regular/FEO fees when selected.
          </label>
        </div>
      </div>
    </div>

    <!-- Shareable Link Section (Secretary Only) -->
    <div class="shareable-link-section" id="shareableLinkSection">
      <h3>🔗 Shareable Entry Link</h3>
      <p>Share this link with participants so they can enter from home:</p>
      <div class="link-display">
        <div class="link-url" id="shareableUrl">
          <!-- Generated URL will appear here -->
        </div>
        <div class="link-actions">
          <button class="btn-copy" onclick="copyShareableLink()">📋 Copy Link</button>
          <button class="btn-test" onclick="testShareableLink()">🔗 Test Link</button>
        </div>
      </div>
    </div>

    <!-- Trial Information -->
    <div class="trial-info" id="trialInfoSection" style="display: none;">
      <h3>📋 Trial Information</h3>
      <div class="trial-details">
        <div><strong>Club:</strong> <span id="clubName">-</span></div>
        <div><strong>Dates:</strong> <span id="trialDates">-</span></div>
        <div><strong>Location:</strong> <span id="trialLocation">-</span></div>
        <div><strong>Secretary:</strong> <span id="trialSecretary">-</span></div>
      </div>
    </div>

    <div class="entry-form" id="entryFormContainer" style="display: none;">
      <!-- Success Message -->
      <div id="successMessage" class="success-message hidden">
        <h3>✅ Entry Submitted Successfully!</h3>
        <p>The entry has been recorded for this trial.</p>
        <button class="btn btn-primary" onclick="resetForm()">Enter Another Participant</button>
      </div>

      <!-- Edit Link Section -->
      <div class="edit-link-section hidden" id="editLinkSection">
        <h3>✅ Entry Submitted Successfully!</h3>
        <p>Your entry has been recorded. Use this link to edit your entry in the future:</p>
        <div class="link-display">
          <div class="link-url" id="editUrl">
            <!-- Edit URL will appear here -->
          </div>
          <div class="link-actions">
            <button class="btn-copy" onclick="copyEditLink()">📋 Copy Edit Link</button>
            <button class="btn-test" onclick="testEditLink()">🔗 Test Edit Link</button>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button class="btn btn-primary" onclick="resetForNewEntry()">Submit Another Entry</button>
        </div>
      </div>

      <!-- Waiver Section -->
      <div class="waiver-section">
        <h3>⚠️ C-WAGS Disclaimer & Liability Waiver</h3>
        <div class="waiver-content" style="font-size: 0.9rem; line-height: 1.4; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; background: white; border-radius: 6px;">
          <p><strong>DISCLAIMER -- MUST BE SENT WITH ENTRY</strong></p>
          <p>I/we acknowledge that I am/we are familiar with the current rules applying to Canine-Work And GameS Trials. I/we agree that the Host Club holding the Trial has the right to refuse entry for cause which the Host Club shall deem to be sufficient. Upon acceptance of this entry, I/we agree to hold Canine-Work And GameS, LLC, and its members and officers, this Host Club, its members, directors, officers, agents, show secretary, show chairperson, show committee and the owner or lessor of the premises and any employees of the aforementioned parties, any sponsors of this event, harmless from any claim or loss or injury which may be alleged to have been caused directly or indirectly to any person or thing by the act of this dog or handler while in or upon the show trial premises or grounds or near any entrance thereto, and I/we further agree to hold the fore mentioned parties harmless from any claim or loss of this dog by disappearance, theft, death or otherwise, and from any claim for damage or injury to the dog, whether any claim be caused or alleged to be caused by the negligence of the Host Club or any of the parties aforementioned, or by the negligence of any other person, or any other cause or causes.</p>
          <p>I/we hereby assume sole responsibility for and agree to indemnify and save the aforementioned parties harmless from any and all loss and expense (including legal fees) by reason of the liability imposed by law upon any of the aforementioned parties for damage because of bodily injuries, including death at any time resulting there from, sustained by any person or persons, including myself/ourselves or on account of damage to property, arising out of or in consequence of my/our participation in the Trial, howsoever such injuries, death or damage to property may be caused and whether or not the same may have been caused by negligence of the aforementioned parties or any of their employees or agents, or any other persons.</p>
          <p><strong>I/we agree to abide by the rules of C-WAGS currently in effect at the time of the trial. I/we testify that the dog entered is healthy and vaccinated or titered. I/we certify that the dog entered is not dangerous to any person or other dog.</strong></p>
          
          <p><strong>C-WAGS Notice to Exhibitors</strong></p>
          <p>Competitors, through submission of entry, acknowledge that they are knowledgeable of C-WAGS Obedience & Rally rules and regulations including but not limited to the following rules regarding entry:</p>
          <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
            <li>All exhibitors are expected to treat the judges, trial hosts, your canine partner and all other exhibitors with respect.</li>
            <li>All judges and trial hosts are expected to show respect to all exhibitors.</li>
            <li>This trial is open to all dogs registered with C-WAGS.</li>
            <li>Trial Hosts may elect to accept FOR EXHIBITION ONLY entries of non-registered dogs.</li>
            <li>Teams may be entered in multiple levels/classes at the same trial.</li>
            <li>Dogs must be shown by a member of the owner's immediate family.</li>
            <li>Collars: The dog must wear a flat type collar (buckle, snap or proper fit martingale) and/or body harness in the ring. Electronic training collars are not allowed on the show grounds.</li>
            <li>Owners with disabilities are encouraged to compete. Any necessary modifications to the exercises must be provided by the handler to the judge and approved by the judge.</li>
            <li>Safety shall always be of foremost consideration in actions and conduct by handlers at all times. Handlers, through entry at this event, accept full responsibility for themselves and the actions of their dogs.</li>
            <li>The organizing committee may refuse any entry for any reason.</li>
            <li>THERE SHALL BE NO REFUND for entries in the event a dog and/or handler are dismissed from competition, regardless of reason for such dismissal. There will be no refunds if the trial has to be cancelled for any reason.</li>
            <li>Refunds will be made for females in season upon written request accompanied by a statement from the exhibitor's veterinarian.</li>
            <li>Dogs must be on leash while on show grounds unless being shown.</li>
          </ul>
        </div>
        <div class="waiver-agreement" style="margin-top: 1rem;">
          <input type="checkbox" id="waiverAccepted" required>
          <label for="waiverAccepted">
            <strong>I have read, understood, and agree to the complete C-WAGS disclaimer and all terms above. By entering this trial, I agree to the disclaimer on this entry form.</strong>
          </label>
        </div>
      </div>

      <!-- Entry Form -->
      <form id="entryForm">
        <!-- Registration Number Lookup -->
        <div class="form-section primary">
          <h3>🔍 Registration Lookup</h3>
          <div class="form-row">
            <div class="form-group full-width">
              <label>C-WAGS Registration Number (optional)</label>
              <input type="text" id="cwagsNumber" placeholder="XX-XXXX-XX" 
                     style="font-size: 1.2rem; font-weight: bold; background: #f0f8ff;">
              <small style="color: #666; margin-top: 0.5rem; display: block;">
                💡 Enter registration number first - handler and dog info will auto-fill if found
              </small>
            </div>
          </div>
          <div id="lookupStatus" class="lookup-status"></div>
        </div>

        <!-- Handler Information -->
        <div class="form-section">
          <h3>👤 Handler Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Handler Name</label>
              <input type="text" id="handlerName" required placeholder="Will auto-fill from registration">
            </div>
            <div class="form-group">
              <label>Phone Number</label>
              <input type="tel" id="handlerPhone" placeholder="(xxx) xxx-xxxx">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email Address</label>
              <input type="email" id="handlerEmail" placeholder="handler@email.com">
            </div>
            <div class="form-group">
              <label>Emergency Contact</label>
              <input type="text" id="emergencyContact" placeholder="Name and phone number">
            </div>
          </div>
        </div>

        <!-- Dog Information -->
        <div class="form-section">
          <h3>🐕 Dog Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Dog's Call Name</label>
              <input type="text" id="dogCallName" required placeholder="Will auto-fill from registration">
            </div>
            <div class="form-group">
              <label>Breed</label>
              <input type="text" id="dogBreed" placeholder="Enter breed">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" id="dogBirthdate">
            </div>
            <div class="form-group">
              <label>Sex</label>
              <select id="dogSex">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Male Neutered">Male Neutered</option>
                <option value="Female Spayed">Female Spayed</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Junior Handler (Under 18)</label>
              <select id="juniorHandler">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tabbed Class Entries Section -->
        <div class="form-section">
          <h3>🎯 Class Entries</h3>
          
          <!-- Entry Summary -->
          <div class="entry-summary" id="entrySummary" style="display: none;">
            <div class="summary-title">Selected Entries:</div>
            <ul class="selected-entries" id="selectedEntriesList">
            </ul>
            <div style="margin-top: 1rem; font-weight: 600; color: #0066cc;">
              Total Fee: $<span id="totalFee">0.00</span>
            </div>
          </div>

          <!-- Day Tabs - Dynamically Generated -->
          <div class="day-tabs-container">
            <div class="day-tabs" id="dayTabs">
              <!-- Tabs will be generated from trial data -->
            </div>
          </div>

          <!-- Scrollable Class Entries - Dynamically Generated -->
          <div class="class-entries-container" id="classEntriesContainer">
            <!-- Content will be generated from trial data -->
            <div style="text-align: center; padding: 2rem; color: #666;">
              Loading available classes...
            </div>
          </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
          <button type="button" class="btn-submit" id="submitEntry" disabled>Submit Entry</button>
          <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
            Please review your selections before submitting. Entry fees are due upon submission.
          </p>
        </div>
      </form>
    </div>
  </div>

<script type="module">
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, addDoc, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // ========================================
    // GLOBAL DATE HANDLING
    // ========================================
    
    function createLocalDate(dateStr) {
      if (!dateStr) return null;
      
      if (typeof dateStr === 'string') {
        const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
        return new Date(dateWithTime);
      }
      
      return new Date(dateStr);
    }

    function formatLocalDate(date) {
      if (!date || !(date instanceof Date)) return '';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }

    function formatDateDisplay(dateInput, options = {}) {
      let date;
      
      if (typeof dateInput === 'string') {
        date = createLocalDate(dateInput);
      } else if (dateInput instanceof Date) {
        date = new Date(dateInput);
      } else {
        return 'Invalid Date';
      }
      
      if (!date || isNaN(date.getTime())) return 'Invalid Date';
      
      const defaultOptions = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
      };
      
      const formatOptions = { ...defaultOptions, ...options };
      return new Intl.DateTimeFormat('en-US', formatOptions).format(date);
    }

    function prepareDateForFirebase(dateStr) {
      if (!dateStr) return null;
      const localDate = createLocalDate(dateStr);
      return localDate;
    }

    function getDateFromFirebase(firebaseDate) {
      if (!firebaseDate) return '';
      
      let date;
      
      if (firebaseDate.toDate) {
        date = firebaseDate.toDate();
      } else if (firebaseDate instanceof Date) {
        date = firebaseDate;
      } else if (typeof firebaseDate === 'string') {
        date = createLocalDate(firebaseDate);
      } else {
        return '';
      }
      
      return formatLocalDate(date);
    }

    // ========================================
    // REGISTRATION NUMBER FORMATTER
    // ========================================

    function formatRegistrationNumber(input) {
      if (!input) return '';
      
      let cleaned = input.replace(/[^\d]/g, '');
      
      if (!cleaned) return '';
      
      if (cleaned.length < 6) {
        return cleaned;
      }
      
      if (cleaned.length > 8) {
        cleaned = cleaned.substring(0, 8);
      }
      
      if (cleaned.length === 6) {
        const part1 = cleaned.substring(0, 2);
        const part2 = cleaned.substring(2);
        return `${part1}-${part2}`;
      } else if (cleaned.length >= 7) {
        const part1 = cleaned.substring(0, 2);
        const part2 = cleaned.substring(2, 6);
        let part3 = cleaned.substring(6);
        
        if (part3.length === 1) {
          part3 = '0' + part3;
        }
        
        return `${part1}-${part2}-${part3}`;
      }
      
      return cleaned;
    }

    function handleRegistrationInput(event) {
      const input = event.target;
      const cursorPosition = input.selectionStart;
      const originalValue = input.value;
      const originalLength = originalValue.length;
      
      const cleanedDigits = originalValue.replace(/[^\d]/g, '');
      
      let formattedValue;
      if (cleanedDigits.length >= 6) {
        formattedValue = formatRegistrationNumber(originalValue);
      } else {
        formattedValue = cleanedDigits;
      }
      
      input.value = formattedValue;
      
      const lengthDifference = formattedValue.length - originalLength;
      const newCursorPosition = Math.max(0, cursorPosition + lengthDifference);
      
      setTimeout(() => {
        input.setSelectionRange(newCursorPosition, newCursorPosition);
      }, 0);
      
      const hasCompleteRegistration = 
        formattedValue.length >= 8 || 
        (formattedValue.includes('-') && cleanedDigits.length >= 6);
        
      if (hasCompleteRegistration) {
        enhancedAutoFillFromRegistration(formattedValue);
      }
    }

    function handleRegistrationBlur(event) {
      const input = event.target;
      const currentValue = input.value;
      
      if (currentValue) {
        const cleanedDigits = currentValue.replace(/[^\d]/g, '');
        
        let finalFormatted;
        if (cleanedDigits.length >= 6) {
          finalFormatted = formatRegistrationNumber(currentValue);
          
          if (finalFormatted !== currentValue) {
            input.classList.add('auto-filled');
            setTimeout(() => {
              input.classList.remove('auto-filled');
            }, 2000);
          }
          
          input.value = finalFormatted;
          enhancedAutoFillFromRegistration(finalFormatted);
        } else {
          finalFormatted = cleanedDigits;
          input.value = finalFormatted;
        }
      }
    }

    function handleRegistrationPaste(event) {
      event.preventDefault();
      
      const pastedText = (event.clipboardData || window.clipboardData).getData('text');
      
      const cleanedDigits = pastedText.replace(/[^\d]/g, '');
      let formattedValue;
      
      if (cleanedDigits.length >= 6) {
        formattedValue = formatRegistrationNumber(pastedText);
      } else {
        formattedValue = cleanedDigits;
      }
      
      event.target.value = formattedValue;
      
      if (formattedValue.length >= 8 || (formattedValue.includes('-') && cleanedDigits.length >= 6)) {
        enhancedAutoFillFromRegistration(formattedValue);
      }
    }

    function setupRegistrationFormatter() {
      const regInput = document.getElementById('cwagsNumber');
      
      if (regInput) {
        regInput.removeEventListener('input', handleRegistrationInput);
        regInput.removeEventListener('paste', handleRegistrationPaste);
        regInput.removeEventListener('blur', handleRegistrationBlur);
        
        regInput.addEventListener('input', handleRegistrationInput);
        regInput.addEventListener('paste', handleRegistrationPaste);
        regInput.addEventListener('blur', handleRegistrationBlur);
        
        regInput.setAttribute('inputmode', 'numeric');
        regInput.setAttribute('pattern', '[0-9\\-]*');
        regInput.setAttribute('maxlength', '10');
        regInput.setAttribute('placeholder', 'e.g., 22-4168-01');
      }
    }

    // ========================================
    // GLOBAL VARIABLES
    // ========================================
    
    let currentTrialData = null;
    let selectedClasses = new Set();
    let registrationData = [];
    let isAutoFilling = false;
    let availableTrials = [];
    let isSecretary = false;
    let isRegistrationDataLoaded = false;
    let formInitialized = false;

    let selectedEntries = [];
    let totalFee = 0;

    const prerequisites = {
        "Investigator 3": ["Patrol 1", "Detective 2"],
        "Super Sleuth 4": ["Investigator 3"],
        "Private Inv": ["Super Sleuth 4"],
        "Det Diversions": ["Super Sleuth 4"],
        "Ranger 2": ["Ranger 1"],
        "Ranger 3": ["Ranger 2"],
        "Ranger 4": ["Ranger 3"],
        "Ranger 5": ["Ranger 4"],
        "Dasher 4": ["Dasher 3"],
        "Dasher 5": ["Dasher 4"],
        "Dasher 6": ["Dasher 5"],
        "Obedience 4": ["Obedience 3"],
        "Obedience 5": ["Obedience 4"]
    };

    let fees = {
      regular: 35.00,
      feo: 25.00,
      juniorHandler: 20.00
    };

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================

    function getPrerequisitesText(className) {
        const prereqs = prerequisites[className];
        if (!prereqs || prereqs.length === 0) {
            return "Open to all levels";
        }
        
        if (className === "Investigator 3") {
            return "Patrol 1 OR Detective 2";
        }
        
        return prereqs.join(", ");
    }

    window.showDay = function(dayIndex) {
        document.querySelectorAll('.class-day-content').forEach(content => {
            content.classList.remove('active');
        });
        
        document.querySelectorAll('.day-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.getElementById(`day-${dayIndex}`).classList.add('active');
        document.querySelectorAll('.day-tab')[dayIndex].classList.add('active');
    };

    // ========================================
    // ENTRY SELECTION HANDLING
    // ========================================

    document.addEventListener('change', function(e) {
        if (e.target.type === 'checkbox' && e.target.dataset.class) {
            handleEntrySelection(e.target);
        }
    });

    function handleEntrySelection(checkbox) {
      const className = checkbox.dataset.class;
      const roundName = checkbox.dataset.round;
      const judgeName = checkbox.dataset.judge;
      const fee = parseFloat(checkbox.dataset.fee);
      const entryType = checkbox.dataset.type;
      const dayIndex = checkbox.dataset.day;
      const roundNumber = checkbox.dataset.roundNumber;
      
      const entryId = `${className}-${roundName}-${dayIndex}-${roundNumber}`;
      
      if (checkbox.checked) {
        const otherType = entryType === 'regular' ? 'feo' : 'regular';
        const otherCheckbox = document.querySelector(`input[data-class="${className}"][data-round="${roundName}"][data-type="${otherType}"][data-day="${dayIndex}"][data-round-number="${roundNumber}"]`);
        if (otherCheckbox) {
          otherCheckbox.checked = false;
          otherCheckbox.parentElement.classList.remove('selected');
          selectedEntries = selectedEntries.filter(entry => entry.entryId !== entryId || entry.type !== otherType);
        }
        
        selectedEntries.push({
          entryId: entryId,
          className: className,
          roundName: roundName,
          judgeName: judgeName,
          fee: fee,
          type: entryType,
          dayIndex: dayIndex,
          roundNumber: roundNumber
        });
        
        checkbox.parentElement.classList.add('selected');
      } else {
        selectedEntries = selectedEntries.filter(entry => 
          !(entry.entryId === entryId && entry.type === entryType)
        );
        
        checkbox.parentElement.classList.remove('selected');
      }
      
      updateEntrySummary();
      checkFormValidity();
    }

    function updateEntrySummary() {
      const summaryDiv = document.getElementById('entrySummary');
      const entriesList = document.getElementById('selectedEntriesList');
      const totalFeeSpan = document.getElementById('totalFee');
      
      if (selectedEntries.length === 0) {
        summaryDiv.style.display = 'none';
        return;
      }
      
      summaryDiv.style.display = 'block';
      
      const entriesByDay = {};
      selectedEntries.forEach(entry => {
        const dayKey = `Day ${parseInt(entry.dayIndex) + 1}`;
        if (!entriesByDay[dayKey]) {
          entriesByDay[dayKey] = [];
        }
        entriesByDay[dayKey].push(entry);
      });
      
      let html = '';
      Object.keys(entriesByDay)
        .sort((a, b) => {
          const dayA = parseInt(a.replace('Day ', ''));
          const dayB = parseInt(b.replace('Day ', ''));
          return dayA - dayB;
        })
        .forEach(dayKey => {
          html += `<li class="day-group-header">${dayKey}</li>`;
          
          entriesByDay[dayKey].forEach(entry => {
            html += `
              <li class="selected-entry">
                ${entry.className} - ${entry.roundName} 
                ${entry.type === 'feo' ? '(FEO)' : '(Regular)'} 
                - Judge: ${entry.judgeName} 
                - ${entry.fee.toFixed(2)}
              </li>
            `;
          });
        });
      
      entriesList.innerHTML = html;
      
      totalFee = selectedEntries.reduce((sum, entry) => sum + entry.fee, 0);
      totalFeeSpan.textContent = totalFee.toFixed(2);
      
      const submitBtn = document.getElementById('submitEntry');
      if (submitBtn) {
        submitBtn.disabled = selectedEntries.length === 0;
      }
    }

    // ========================================
    // FORM VALIDATION
    // ========================================

    function checkFormValidity() {
      const waiverAccepted = document.getElementById('waiverAccepted').checked;
      const handlerName = document.getElementById('handlerName').value.trim();
      const dogCallName = document.getElementById('dogCallName').value.trim();
      const hasClasses = selectedEntries && selectedEntries.length > 0;
      
      const isValid = waiverAccepted && handlerName && dogCallName && hasClasses;
      
      const submitBtn = document.getElementById('submitEntry');
      if (submitBtn) {
        submitBtn.disabled = !isValid;
      }
      
      return isValid;
    }

    // ========================================
    // REGISTRATION DATA LOADING
    // ========================================

    async function loadRegistrationData() {
      try {
        const possiblePaths = [
          '/js/data.json',
          '../js/data.json',
          './js/data.json',
          '/Secretary/js/data.json',
          'js/data.json'
        ];
        
        let response = null;
        let successfulPath = null;
        
        for (const path of possiblePaths) {
          try {
            response = await fetch(path);
            if (response.ok) {
              successfulPath = path;
              break;
            }
          } catch (pathError) {
            continue;
          }
        }
        
        if (!response || !response.ok) {
          throw new Error(`Could not find data.json at any of the expected locations`);
        }
        
        const data = await response.json();
        registrationData = data || [];
        isRegistrationDataLoaded = true;
        
      } catch (error) {
        registrationData = [];
        isRegistrationDataLoaded = true;
      }
    }

    function enhancedAutoFillFromRegistration(cwagsNumber) {
      if (!cwagsNumber || !isRegistrationDataLoaded || !registrationData) {
        return;
      }
      
      const cleanedInput = cwagsNumber.replace(/[^\d]/g, '');
      
      let data = registrationData.find(entry => {
        if (entry.Registration === cwagsNumber || entry.cwagsNumber === cwagsNumber) {
          return true;
        }
        
        const cleanedEntry = (entry.Registration || entry.cwagsNumber || '').replace(/[^\d]/g, '');
        if (cleanedEntry === cleanedInput) {
          return true;
        }
        
        if (cleanedInput.length >= 6) {
          const formattedInput = formatRegistrationNumber(cleanedInput);
          if (entry.Registration === formattedInput || entry.cwagsNumber === formattedInput) {
            return true;
          }
        }
        
        return false;
      });
      
      if (!data) {
        return;
      }
      
      function fillFieldEnhanced(fieldId, value) {
        if (!value) return;
        
        const field = document.getElementById(fieldId);
        if (field && (!field.value || field.value === '')) {
          field.value = value;
          field.classList.add('auto-filled');
          setTimeout(() => {
            field.classList.remove('auto-filled');
          }, 2000);
        }
      }
      
      fillFieldEnhanced('handlerName', data.handlerName || data.Handler);
      fillFieldEnhanced('handlerPhone', data.handlerPhone);
      fillFieldEnhanced('handlerEmail', data.handlerEmail);
      fillFieldEnhanced('emergencyContact', data.emergencyContact);
      fillFieldEnhanced('dogCallName', data.dogCallName || data['Call Name']);
      fillFieldEnhanced('dogBreed', data.dogBreed);
      fillFieldEnhanced('dogBirthdate', data.dogBirthdate);
      
      if (data.dogSex) {
        const sexField = document.getElementById('dogSex');
        if (sexField && (!sexField.value || sexField.value === '')) {
          sexField.value = data.dogSex;
          sexField.classList.add('auto-filled');
          setTimeout(() => {
            sexField.classList.remove('auto-filled');
          }, 2000);
        }
      }
      
      checkFormValidity();
    }

    // ========================================
    // FORM SETUP AND EVENT LISTENERS
    // ========================================

    function setupFormEventListeners() {
      const cwagsInput = document.getElementById('cwagsNumber');
      if (cwagsInput) {
        cwagsInput.removeEventListener('input', handleRegistrationInput);
        cwagsInput.addEventListener('input', handleRegistrationInput);
      }

      const entryForm = document.getElementById('entryForm');
      if (entryForm) {
        entryForm.removeEventListener('input', checkFormValidity);
        entryForm.addEventListener('input', checkFormValidity);
      }

      const waiverCheckbox = document.getElementById('waiverAccepted');
      if (waiverCheckbox) {
        waiverCheckbox.removeEventListener('change', checkFormValidity);
        waiverCheckbox.addEventListener('change', checkFormValidity);
      }

      const juniorHandlerSelect = document.getElementById('juniorHandler');
      if (juniorHandlerSelect) {
        juniorHandlerSelect.removeEventListener('change', updateEntrySummary);
        juniorHandlerSelect.addEventListener('change', updateEntrySummary);
      }

      formInitialized = true;
    }

    // ========================================
    // SECRETARY FUNCTIONS
    // ========================================

    async function setupSecretaryView() {
      try {
        await new Promise((resolve) => {
          if (auth.currentUser) {
            resolve();
          } else {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              unsubscribe();
              resolve();
            });
          }
        });

        if (!auth.currentUser) {
          alert("Please log in to access the entry form");
          window.location.href = 'index.html';
          return;
        }

        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", auth.currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        
        if (!trialsSnapshot.empty) {
          availableTrials = [];
          trialsSnapshot.forEach(doc => {
            const trialData = doc.data();
            
            if (trialData.days && Array.isArray(trialData.days)) {
              trialData.days = trialData.days.map(day => ({
                ...day,
                date: day.date ? getDateFromFirebase(day.date) : null
              }));
            }
            
            availableTrials.push({ id: doc.id, ...trialData });
          });
          
          availableTrials.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
          
          populateTrialSelector();
        } else {
          alert("No trials found. Please create a trial first.");
          window.location.href = 'main-dashboard.html';
        }
      } catch (error) {
        alert("Error loading trial data: " + error.message);
      }
    }

    function populateTrialSelector() {
      const trialSelect = document.getElementById('trialSelection');
      trialSelect.innerHTML = '<option value="">Select a trial...</option>';

      availableTrials.forEach(trial => {
        const option = document.createElement('option');
        option.value = trial.id;
        
        let trialLabel = trial.clubName || 'Unnamed Trial';
        
        if (trial.days && trial.days.length > 0) {
          const dates = trial.days
            .filter(day => day.date)
            .map(day => {
              const localDate = createLocalDate(day.date);
              return localDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
              });
            })
            .join(', ');
          if (dates) {
            trialLabel += ` (${dates})`;
          }
        }
        
        option.textContent = trialLabel;
        trialSelect.appendChild(option);
      });

      trialSelect.addEventListener('change', function(event) {
        const trialId = event.target.value;
        
        if (trialId) {
          currentTrialData = availableTrials.find(t => t.id === trialId);
          if (currentTrialData) {
            document.getElementById('entryFeeSection').style.display = 'block';
            setupFeeChangeListeners();
            generateShareableLink();
            populateTrialInfo();
            showEntryForm();
            
            setTimeout(() => {
              setupFormEventListeners();
            }, 100);
          }
        } else {
          hideShareableLink();
          hideTrialInfo();
          hideEntryForm();
          document.getElementById('entryFeeSection').style.display = 'none';
        }
      });
    }

    function setupFeeChangeListeners() {
      const regularFeeInput = document.getElementById('regularFee');
      const feoFeeInput = document.getElementById('feoFee');
      const juniorFeeInput = document.getElementById('juniorFee');
      
      if (!regularFeeInput || !feoFeeInput || !juniorFeeInput) {
        return;
      }
      
      loadTrialFees();
      
      function updateFees() {
        fees.regular = parseFloat(regularFeeInput.value) || 35.00;
        fees.feo = parseFloat(feoFeeInput.value) || 25.00;
        fees.juniorHandler = parseFloat(juniorFeeInput.value) || 20.00;
        
        saveTrialFees();
        
        if (currentTrialData) {
          generateTabbedClasses();
        }
        
        updateEntrySummary();
      }
      
      regularFeeInput.removeEventListener('input', updateFees);
      feoFeeInput.removeEventListener('input', updateFees);
      juniorFeeInput.removeEventListener('input', updateFees);
      
      regularFeeInput.addEventListener('input', updateFees);
      feoFeeInput.addEventListener('input', updateFees);
      juniorFeeInput.addEventListener('input', updateFees);
    }

    async function loadTrialFees() {
      if (!currentTrialData || !currentTrialData.id) return;
      
      try {
        if (currentTrialData.entryFees) {
          fees.regular = currentTrialData.entryFees.regular || fees.regular;
          fees.feo = currentTrialData.entryFees.feo || fees.feo;
          fees.juniorHandler = currentTrialData.entryFees.juniorHandler || fees.juniorHandler;
          
          document.getElementById('regularFee').value = fees.regular.toFixed(2);
          document.getElementById('feoFee').value = fees.feo.toFixed(2);
          document.getElementById('juniorFee').value = fees.juniorHandler.toFixed(2);
        }
      } catch (error) {
        console.warn("Could not load saved fees:", error);
      }
    }

    async function saveTrialFees() {
      if (!currentTrialData || !currentTrialData.id || !isSecretary) return;
      
      try {
        currentTrialData.entryFees = {
          regular: fees.regular,
          feo: fees.feo,
          juniorHandler: fees.juniorHandler,
          updatedAt: new
