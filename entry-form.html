<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trial Entry Form</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: #1a1a2e;
      color: white;
      padding: 2rem;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .trial-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    
    .form-container {
      padding: 2rem;
    }
    
    .form-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
    }
    
    .form-section h3 {
      color: #1a1a2e;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      border-bottom: 2px solid #667eea;
      padding-bottom: 0.5rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #333;
    }
    
    .form-group.required label::after {
      content: " *";
      color: #e74c3c;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 0.8rem;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .lookup-status {
      padding: 0.8rem;
      border-radius: 6px;
      margin: 1rem 0;
      font-weight: 500;
    }
    
    .lookup-status.loading {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }
    
    .lookup-status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }
    
    .lookup-status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }
    
    .waiver-section {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .waiver-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 0.8rem;
      margin-top: 1rem;
    }
    
    .waiver-checkbox input[type="checkbox"] {
      margin-top: 0.2rem;
    }
    
    .waiver-checkbox label {
      font-weight: 600;
      color: #856404;
    }
    
    /* Class Selection Styles */
    .day-section {
      margin-bottom: 2rem;
      border: 2px solid #667eea;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .day-header {
      background: #667eea;
      color: white;
      padding: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
    }
    
    .classes-container {
      background: white;
    }
    
    .class-group {
      border-bottom: 1px solid #e0e0e0;
    }
    
    .class-group:last-child {
      border-bottom: none;
    }
    
    .class-header {
      background: #f8f9ff;
      padding: 1rem;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .class-content {
      padding: 0;
    }
    
    .round-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s ease;
    }
    
    .round-item:hover {
      background: #f8f9ff;
      box-shadow: inset 0 0 8px rgba(102, 126, 234, 0.1);
    }
    
    .round-item:last-child {
      border-bottom: none;
    }
    
    .round-info {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex: 1;
    }
    
    .round-number {
      background: #667eea;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
      min-width: 70px;
      text-align: center;
    }
    
    .judge-name {
      font-weight: 500;
      color: #333;
      font-size: 1rem;
    }
    
    .entry-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .entry-button {
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .entry-button input[type="checkbox"] {
      display: none;
    }
    
    .entry-tag {
      display: inline-block;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: 6px;
      border: 2px solid;
      transition: all 0.3s ease;
      min-width: 100px;
      text-align: center;
    }
    
    .entry-tag.regular {
      background: white;
      color: #28a745;
      border-color: #28a745;
    }
    
    .entry-button.regular:hover .entry-tag.regular {
      background: #f8f9fa;
      transform: translateY(-1px);
    }
    
    .entry-button input[type="checkbox"]:checked + .entry-tag.regular {
      background: #28a745;
      color: white;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .entry-tag.feo {
      background: white;
      color: #ffc107;
      border-color: #ffc107;
    }
    
    .entry-button.feo:hover .entry-tag.feo {
      background: #fffbf0;
      transform: translateY(-1px);
    }
    
    .entry-button input[type="checkbox"]:checked + .entry-tag.feo {
      background: #ffc107;
      color: #333;
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    }
    
    .entry-tag.unavailable {
      background: #f8f9fa;
      color: #6c757d;
      border: 2px solid #dee2e6;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 6px;
      min-width: 100px;
      text-align: center;
    }

    .entry-status {
      font-size: 0.8rem;
      color: #6c757d;
      margin-left: 0.5rem;
    }
    
    .no-classes-message {
      text-align: center;
      padding: 2rem;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      color: #856404;
    }
    
    .entry-summary {
      background: #e8f5e8;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #c3e6cb;
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .summary-item strong {
      color: #155724;
    }
    
    .summary-item span {
      font-weight: 600;
      color: #28a745;
    }
    
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 2rem;
    }
    
    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: #28a745;
      color: white;
    }
    
    .btn-primary:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    .btn-primary:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    
    @media (max-width: 768px) {
      body {
        padding: 1rem 0.5rem;
      }
      
      .header h1 {
        font-size: 1.8rem;
      }
      
      .trial-info {
        grid-template-columns: 1fr;
        text-align: left;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .round-item {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }
      
      .round-info {
        justify-content: center;
      }
      
      .entry-buttons {
        justify-content: center;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .summary-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="trialTitle">üèÜ Trial Entry Form</h1>
      <div class="trial-info">
        <div><strong>Club:</strong> <span id="clubName">Loading...</span></div>
        <div><strong>Dates:</strong> <span id="trialDates">Loading...</span></div>
        <div><strong>Secretary:</strong> <span id="trialSecretary">Loading...</span></div>
        <div><strong>Location:</strong> <span id="trialLocation">Loading...</span></div>
      </div>
    </div>
    
    <div class="form-container">
      <form id="entryForm">
        <!-- Waiver Section -->
        <div class="waiver-section">
          <h3>‚öñÔ∏è Waiver and Release</h3>
          <p>By entering this trial, I agree that I am familiar with the rules and regulations of C-WAGS and agree to abide by them. I acknowledge that participation in this event is undertaken at my own risk and agree to hold harmless the trial-giving club, its officers, directors, agents, and the owners of the trial site from any loss, damage, or claim that may be alleged to have been caused directly or indirectly by any act of my dog or myself.</p>
          <div class="waiver-checkbox">
            <input type="checkbox" id="waiverAccepted" required>
            <label for="waiverAccepted">I accept the waiver and release terms above *</label>
          </div>
        </div>

        <!-- Registration Lookup -->
        <div class="form-section">
          <h3>üîç Registration Lookup</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>C-WAGS Registration Number</label>
              <input type="text" id="cwagsNumber" required placeholder="Enter C-WAGS number for auto-fill">
            </div>
          </div>
          <div id="lookupStatus" class="lookup-status" style="display: none;"></div>
        </div>

        <!-- Handler Information -->
        <div class="form-section">
          <h3>üë§ Handler Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Handler Name</label>
              <input type="text" id="handlerName" required placeholder="First and Last Name">
            </div>
            <div class="form-group required">
              <label>Phone Number</label>
              <input type="tel" id="handlerPhone" required placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group required">
              <label>Email Address</label>
              <input type="email" id="handlerEmail" required placeholder="handler@email.com">
            </div>
            <div class="form-group">
              <label>Emergency Contact</label>
              <input type="text" id="emergencyContact" placeholder="Name and phone number">
            </div>
          </div>
        </div>

        <!-- Dog Information -->
        <div class="form-section">
          <h3>üêï Dog Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Dog's Call Name</label>
              <input type="text" id="dogCallName" required placeholder="Will auto-fill from registration">
            </div>
            <div class="form-group">
              <label>Breed</label>
              <input type="text" id="dogBreed" placeholder="Enter breed">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" id="dogBirthdate">
            </div>
            <div class="form-group">
              <label>Sex</label>
              <select id="dogSex">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Male Neutered">Male Neutered</option>
                <option value="Female Spayed">Female Spayed</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Class Selection -->
        <div class="form-section">
          <h3>üéØ Class Entries</h3>
          <p style="margin-bottom: 1rem; color: #666;">Select Regular or FEO entries for specific class/judge combinations:</p>
          <div id="classSelection">
            <div style="text-align: center; padding: 2rem; color: #666;">
              Loading available classes by day and judge...
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
          <h3>üìù Additional Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Junior Handler (Under 18)</label>
              <select id="juniorHandler">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            <div class="form-group">
              <label>Special Needs/Requests</label>
              <input type="text" id="specialNeeds" placeholder="Any special accommodations needed">
            </div>
          </div>
        </div>

        <!-- Entry Summary -->
        <div class="entry-summary">
          <h3>üí∞ Entry Summary</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <strong>Regular Entries</strong>
              <span id="regularEntryCount">0</span>
            </div>
            <div class="summary-item">
              <strong>FEO Entries</strong>
              <span id="feoEntryCount">0</span>
            </div>
            <div class="summary-item">
              <strong>Total Entries</strong>
              <span id="totalEntryCount">0</span>
            </div>
            <div class="summary-item">
              <strong>Entry Fee</strong>
              <span id="calculatedFee">$0.00</span>
            </div>
            <div class="summary-item">
              <strong>Junior Handler</strong>
              <span id="summaryJuniorHandler">No</span>
            </div>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
            Submit Entry
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">
            Clear Form
          </button>
          <button type="button" class="btn btn-secondary" onclick="location.href='main-dashboard.html'">
            ‚Üê Back to Dashboard
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, addDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    console.log("üéØ Updated Entry form loaded with FEO/Regular buttons");

    // Global variables
    let currentTrialData = null;
    let currentApplicationData = null;
    let selectedClasses = new Set();
    let registrationData = [];
    let isAutoFilling = false;
    let trialFees = {
      fee1: 35.00,  // First dog, first class
      fee2: 25.00,  // Same dog, additional class  
      fee3: 30.00,  // Additional dog, same handler
      fee4: 20.00,  // Junior Handler
      fee5: 15.00   // Exhibition Only
    };

    // Load trial data and extract pricing
    async function loadTrialData() {
      try {
        console.log("üîÑ Loading trial data and pricing...");
        
        if (!auth.currentUser) {
          console.log("‚è≥ Waiting for authentication...");
          setTimeout(loadTrialData, 1000);
          return;
        }

        const q = query(
          collection(db, "trials"), 
          where("userId", "==", auth.currentUser.uid)
        );
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          throw new Error("No trial data found. Please create a trial first.");
        }

        const doc = querySnapshot.docs[0];
        currentTrialData = { id: doc.id, ...doc.data() };
        console.log("‚úÖ Trial data loaded:", currentTrialData);
        
        // Load application data to get pricing
        await loadApplicationData();
        
        populateTrialInfo();
        populateClasses();
        await loadRegistrationData();
        setupEventListeners();
        
      } catch (error) {
        console.error("‚ùå Error loading trial data:", error);
        alert("Error loading trial data: " + error.message);
      }
    }

    // Load application data to get fee structure
    async function loadApplicationData() {
      try {
        const appQuery = query(
          collection(db, "applications"), 
          where("userId", "==", auth.currentUser.uid)
        );
        const appSnapshot = await getDocs(appQuery);
        
        if (!appSnapshot.empty) {
          const appDoc = appSnapshot.docs[0];
          currentApplicationData = { id: appDoc.id, ...appDoc.data() };
          
          // Extract fee structure from application data
          if (currentApplicationData.fees) {
            const fees = currentApplicationData.fees;
            trialFees.fee1 = parseFloat(fees.fee1?.replace(/[$,]/g, '') || 35);
            trialFees.fee2 = parseFloat(fees.fee2?.replace(/[$,]/g, '') || 25);
            trialFees.fee3 = parseFloat(fees.fee3?.replace(/[$,]/g, '') || 30);
            trialFees.fee4 = parseFloat(fees.fee4?.replace(/[$,]/g, '') || 20);
            trialFees.fee5 = parseFloat(fees.fee5?.replace(/[$,]/g, '') || 15);
            
            console.log("‚úÖ Loaded fee structure from premium:", trialFees);
          }
        }
      } catch (error) {
        console.warn("‚ö†Ô∏è Could not load application data, using default fees:", error);
      }
    }

    // Load registration data from data.json
    async function loadRegistrationData() {
      try {
        console.log("üìä Loading registration data...");
        const response = await fetch('./js/data.json');
        const data = await response.json();
        registrationData = data || [];
        console.log(`‚úÖ Loaded ${registrationData.length} registration records`);
      } catch (error) {
        console.warn("‚ö†Ô∏è Could not load registration data:", error);
        registrationData = [];
      }
    }

    // Show lookup status
    function showLookupStatus(message, type = 'loading') {
      const statusDiv = document.getElementById('lookupStatus');
      if (!statusDiv) return;
      
      statusDiv.className = `lookup-status ${type}`;
      statusDiv.innerHTML = message;
      statusDiv.style.display = 'block';
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }

    // Auto-fill from registration data
    function lookupRegistration(cwagsNumber) {
      if (!cwagsNumber || cwagsNumber.length < 3) {
        showLookupStatus("Enter at least 3 characters to search", 'error');
        return;
      }
      
      showLookupStatus("üîç Searching registration database...", 'loading');
      
      const matches = registrationData.filter(record => 
        record.cwagsNumber && record.cwagsNumber.toLowerCase().includes(cwagsNumber.toLowerCase())
      );
      
      if (matches.length === 0) {
        showLookupStatus("‚ùå No registration found. Please enter details manually.", 'error');
        return;
      }
      
      if (matches.length > 1) {
        showLookupStatus(`‚ö†Ô∏è Multiple matches found (${matches.length}). Using first match.`, 'loading');
      }
      
      const record = matches[0];
      fillFormFromRecord(record);
      showLookupStatus(`‚úÖ Registration found and auto-filled: ${record.dogName}`, 'success');
    }

    // Fill form from registration record
    function fillFormFromRecord(record) {
      isAutoFilling = true;
      
      try {
        document.getElementById('handlerName').value = record.handlerName || '';
        document.getElementById('handlerPhone').value = record.handlerPhone || '';
        document.getElementById('handlerEmail').value = record.handlerEmail || '';
        document.getElementById('dogCallName').value = record.dogName || '';
        document.getElementById('dogBreed').value = record.breed || '';
        
        if (record.birthdate) {
          document.getElementById('dogBirthdate').value = record.birthdate;
        }
        
        if (record.sex) {
          document.getElementById('dogSex').value = record.sex;
        }
        
        console.log("‚úÖ Form auto-filled from registration data");
      } catch (error) {
        console.error("‚ùå Error auto-filling form:", error);
      } finally {
        isAutoFilling = false;
        checkFormValidity();
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // C-WAGS number lookup
      const cwagsInput = document.getElementById('cwagsNumber');
      let debounceTimer;
      
      cwagsInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          const value = e.target.value.trim();
          if (value.length >= 3) {
            lookupRegistration(value);
          }
        }, 500);
      });

      // Form validation on input changes
      document.querySelectorAll('input, select').forEach(element => {
        element.addEventListener('input', checkFormValidity);
        element.addEventListener('change', checkFormValidity);
      });

      // Junior handler and entry type changes
      document.getElementById('juniorHandler').addEventListener('change', updateEntrySummary);

      // Form submission
      document.getElementById('entryForm').addEventListener('submit', handleFormSubmission);
    }

    // Populate trial information
    function populateTrialInfo() {
      if (!currentTrialData) return;

      document.getElementById('trialTitle').textContent = 
        `üèÜ ${currentTrialData.clubName || 'Trial'} Entry Form`;
      
      document.getElementById('clubName').textContent = currentTrialData.clubName || 'TBD';
      document.getElementById('trialSecretary').textContent = currentTrialData.secretary || 'TBD';
      
      // Format dates
      if (currentTrialData.days && currentTrialData.days.length > 0) {
        const dates = currentTrialData.days
          .filter(day => day.date)
          .map(day => new Date(day.date).toLocaleDateString())
          .join(', ');
        document.getElementById('trialDates').textContent = dates || 'TBD';
      }

      document.getElementById('trialLocation').textContent = currentTrialData.location || 'TBD';
    }

    // Populate classes organized by day, class, and judge with FEO/Regular buttons
    function populateClasses() {
      const classSelection = document.getElementById('classSelection');
      if (!classSelection) {
        console.error("‚ùå classSelection element not found");
        return;
      }

      if (!currentTrialData || !currentTrialData.days) {
        classSelection.innerHTML = `
          <div class="no-classes-message">
            ‚ö†Ô∏è No trial data available. Please check your trial setup.
          </div>
        `;
        return;
      }

      console.log("üìÖ Processing trial days and classes with FEO/Regular options...", currentTrialData.days);
      
      let hasAnyClasses = false;
      let classSelectionHTML = '';

      // Process each day
      currentTrialData.days.forEach((day, dayIndex) => {
        if (!day || !day.classes || !Array.isArray(day.classes) || day.classes.length === 0) {
          return; // Skip days with no classes
        }

        hasAnyClasses = true;
        
        // Format the date
        const dayDate = day.date ? 
          new Date(day.date).toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          }) : 
          `Day ${dayIndex + 1}`;

        classSelectionHTML += `
          <div class="day-section">
            <div class="day-header">
              üìÖ ${dayDate}
            </div>
            <div class="classes-container">
        `;

        // Group classes by name for better organization
        const classMap = new Map();
        day.classes.forEach((cls, index) => {
          if (!cls || !cls.name) return;
          
          const className = cls.name;
          if (!classMap.has(className)) {
            classMap.set(className, []);
          }
          classMap.get(className).push({ ...cls, classIndex: index });
        });

        // Process each unique class
        classMap.forEach((classInstances, className) => {
          classSelectionHTML += `
            <div class="class-group">
              <div class="class-header">
                üèÜ ${className} <span style="font-weight: normal; color: #666;">(${classInstances.length} instance${classInstances.length > 1 ? 's' : ''})</span>
              </div>
              <div class="class-content">
          `;

          // Process each round for this class
          classInstances.forEach((classInstance, instanceIndex) => {
            if (classInstance.rounds && Array.isArray(classInstance.rounds)) {
              classInstance.rounds.forEach((round, roundIndex) => {
                const judgeName = round.judge && round.judge.trim() ? round.judge : 'Judge TBD';
                const roundNumber = round.roundNumber || (roundIndex + 1);
                const feoAvailable = round.feo !== false; // FEO available unless explicitly disabled
                const uniqueId = `entry_${dayIndex}_${classInstance.classIndex}_${roundIndex}`;
                
                const regularEntryValue = JSON.stringify({
                  dayIndex,
                  classIndex: classInstance.classIndex,
                  roundIndex,
                  className,
                  judge: judgeName,
                  roundNumber,
                  date: day.date || `Day ${dayIndex + 1}`,
                  entryType: 'Regular'
                });
                
                const feoEntryValue = JSON.stringify({
                  dayIndex,
                  classIndex: classInstance.classIndex,
                  roundIndex,
                  className,
                  judge: judgeName,
                  roundNumber,
                  date: day.date || `Day ${dayIndex + 1}`,
                  entryType: 'FEO'
                });

                classSelectionHTML += `
                  <div class="round-item">
                    <div class="round-info">
                      <span class="round-number">Round ${roundNumber}</span>
                      <span class="judge-name">${judgeName}</span>
                    </div>
                    <div class="entry-buttons">
                      <label class="entry-button regular" for="${uniqueId}_regular">
                        <input type="checkbox" id="${uniqueId}_regular" value='${regularEntryValue}'>
                        <span class="entry-tag regular">Regular</span>
                      </label>
                      ${feoAvailable ? `
                        <label class="entry-button feo" for="${uniqueId}_feo">
                          <input type="checkbox" id="${uniqueId}_feo" value='${feoEntryValue}'>
                          <span class="entry-tag feo">FEO</span>
                        </label>
                      ` : `
                        <span class="entry-tag unavailable">FEO N/A</span>
                      `}
                      <span class="entry-status" id="status_${uniqueId}"></span>
                    </div>
                  </div>
                `;
              });
            } else {
              // Class with no rounds defined - create a default entry
              const uniqueId = `entry_${dayIndex}_${classInstance.classIndex}_0`;
              const regularEntryValue = JSON.stringify({
                dayIndex,
                classIndex: classInstance.classIndex,
                roundIndex: 0,
                className,
                judge: 'Judge TBD',
                roundNumber: 1,
                date: day.date || `Day ${dayIndex + 1}`,
                entryType: 'Regular'
              });
              const feoEntryValue = JSON.stringify({
                dayIndex,
                classIndex: classInstance.classIndex,
                roundIndex: 0,
                className,
                judge: 'Judge TBD',
                roundNumber: 1,
                date: day.date || `Day ${dayIndex + 1}`,
                entryType: 'FEO'
              });

              classSelectionHTML += `
                <div class="round-item">
                  <div class="round-info">
                    <span class="round-number">Round 1</span>
                    <span class="judge-name">Judge TBD</span>
                  </div>
                  <div class="entry-buttons">
                    <label class="entry-button regular" for="${uniqueId}_regular">
                      <input type="checkbox" id="${uniqueId}_regular" value='${regularEntryValue}'>
                      <span class="entry-tag regular">Regular</span>
                    </label>
                    <label class="entry-button feo" for="${uniqueId}_feo">
                      <input type="checkbox" id="${uniqueId}_feo" value='${feoEntryValue}'>
                      <span class="entry-tag feo">FEO</span>
                    </label>
                    <span class="entry-status" id="status_${uniqueId}"></span>
                  </div>
                </div>
              `;
            }
          });

          classSelectionHTML += `
              </div>
            </div>
          `;
        });

        classSelectionHTML += `
            </div>
          </div>
        `;
      });

      if (!hasAnyClasses) {
        classSelection.innerHTML = `
          <div class="no-classes-message">
            ‚ö†Ô∏è No classes found in trial data. Please create classes in your trial setup.
          </div>
        `;
        return;
      }

      classSelection.innerHTML = classSelectionHTML;

      // Add event listeners to all checkboxes
      classSelection.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateClassSelection);
      });

      console.log(`‚úÖ Populated classes with FEO/Regular buttons organized by day, class, and judge`);
    }

    // Update class selection with detailed entry tracking
    function updateClassSelection(event) {
      const entryData = JSON.parse(event.target.value);
      const uniqueId = event.target.id.replace(/_regular|_feo$/, '');
      const statusElement = document.getElementById(`status_${uniqueId}`);
      
      if (event.target.checked) {
        selectedClasses.add(event.target.value);
        console.log(`‚úÖ Added entry: ${entryData.className} - Round ${entryData.roundNumber} (${entryData.judge}) - ${entryData.entryType}`);
        
        if (statusElement) {
          statusElement.textContent = '‚úì Entered';
          statusElement.style.color = '#28a745';
        }
      } else {
        selectedClasses.delete(event.target.value);
        console.log(`‚ùå Removed entry: ${entryData.className} - Round ${entryData.roundNumber} (${entryData.judge}) - ${entryData.entryType}`);
        
        // Check if any other entry for this round is still selected
        const otherEntryId = event.target.id.includes('_regular') ? 
          event.target.id.replace('_regular', '_feo') : 
          event.target.id.replace('_feo', '_regular');
        const otherEntry = document.getElementById(otherEntryId);
        
        if (statusElement && (!otherEntry || !otherEntry.checked)) {
          statusElement.textContent = '';
        }
      }
      
      updateEntrySummary();
      checkFormValidity();
    }

    // Update entry summary with detailed breakdown using premium pricing
    function updateEntrySummary() {
      const isJunior = document.getElementById('juniorHandler').value === 'Yes';
      
      // Count regular and FEO entries separately
      let regularEntries = 0;
      let feoEntries = 0;
      
      selectedClasses.forEach(entryJson => {
        try {
          const entry = JSON.parse(entryJson);
          if (entry.entryType === 'FEO') {
            feoEntries++;
          } else {
            regularEntries++;
          }
        } catch (e) {
          console.warn("Error parsing entry data:", e);
        }
      });
      
      const totalEntries = regularEntries + feoEntries;
      
      // Calculate fees using premium pricing structure
      let totalFee = 0;
      
      if (isJunior) {
        // Junior handler discount applies to all entries
        totalFee = trialFees.fee4 * totalEntries;
      } else {
        // Regular pricing: first class full price, additional classes discounted
        if (totalEntries > 0) {
          totalFee = trialFees.fee1; // First entry at full price
          if (totalEntries > 1) {
            totalFee += trialFees.fee2 * (totalEntries - 1); // Additional entries at reduced price
          }
        }
      }
      
      // Update display
      document.getElementById('regularEntryCount').textContent = regularEntries;
      document.getElementById('feoEntryCount').textContent = feoEntries;
      document.getElementById('totalEntryCount').textContent = totalEntries;
      document.getElementById('calculatedFee').textContent = `${totalFee.toFixed(2)}`;
      document.getElementById('summaryJuniorHandler').textContent = document.getElementById('juniorHandler').value;
    }

    // Check form validity
    function checkFormValidity() {
      if (isAutoFilling) return;
      
      const waiverAccepted = document.getElementById('waiverAccepted').checked;
      const cwagsNumber = document.getElementById('cwagsNumber').value.trim();
      const handlerName = document.getElementById('handlerName').value.trim();
      const handlerEmail = document.getElementById('handlerEmail').value.trim();
      const handlerPhone = document.getElementById('handlerPhone').value.trim();
      const dogCallName = document.getElementById('dogCallName').value.trim();
      const hasEntries = selectedClasses.size > 0;
      
      const isValid = waiverAccepted && cwagsNumber && handlerName && 
                     handlerEmail && handlerPhone && dogCallName && hasEntries;
      
      document.getElementById('submitBtn').disabled = !isValid;
    }

    // Handle form submission
    async function handleFormSubmission(event) {
      event.preventDefault();
      
      if (!auth.currentUser) {
        alert("Please log in to submit entries.");
        return;
      }
      
      try {
        // Prepare entry data
        const entryData = {
          userId: auth.currentUser.uid,
          trialId: currentTrialData.id,
          submissionDate: new Date().toISOString(),
          
          // Handler information
          cwagsNumber: document.getElementById('cwagsNumber').value.trim(),
          handlerName: document.getElementById('handlerName').value.trim(),
          handlerPhone: document.getElementById('handlerPhone').value.trim(),
          handlerEmail: document.getElementById('handlerEmail').value.trim(),
          emergencyContact: document.getElementById('emergencyContact').value.trim(),
          
          // Dog information
          dogCallName: document.getElementById('dogCallName').value.trim(),
          dogBreed: document.getElementById('dogBreed').value.trim(),
          dogBirthdate: document.getElementById('dogBirthdate').value,
          dogSex: document.getElementById('dogSex').value,
          
          // Entry details
          juniorHandler: document.getElementById('juniorHandler').value === 'Yes',
          specialNeeds: document.getElementById('specialNeeds').value.trim(),
          waiverAccepted: document.getElementById('waiverAccepted').checked,
          
          // Class entries
          entries: Array.from(selectedClasses).map(entryJson => JSON.parse(entryJson)),
          
          // Fee calculation
          totalFee: parseFloat(document.getElementById('calculatedFee').textContent.replace(', '')),
          
          // Entry summary
          regularEntries: parseInt(document.getElementById('regularEntryCount').textContent),
          feoEntries: parseInt(document.getElementById('feoEntryCount').textContent),
          totalEntries: parseInt(document.getElementById('totalEntryCount').textContent)
        };
        
        console.log("üìù Submitting entry:", entryData);
        
        // Submit to Firestore
        const docRef = await addDoc(collection(db, "entries"), entryData);
        
        console.log("‚úÖ Entry submitted successfully:", docRef.id);
        alert("Entry submitted successfully! Entry ID: " + docRef.id);
        
        // Reset form
        resetForm();
        
      } catch (error) {
        console.error("‚ùå Error submitting entry:", error);
        alert("Error submitting entry: " + error.message);
      }
    }

    // Reset form
    window.resetForm = function() {
      document.getElementById('entryForm').reset();
      selectedClasses.clear();
      updateEntrySummary();
      checkFormValidity();
      
      // Clear status indicators
      document.querySelectorAll('.entry-status').forEach(status => {
        status.textContent = '';
      });
      
      console.log("üîÑ Form reset");
    };

    // Initialize when page loads
    window.addEventListener('load', () => {
      console.log("üöÄ Page loaded, initializing entry form...");
      setTimeout(loadTrialData, 1000);
    });

    // Initialize auth state listener
    auth.onAuthStateChanged((user) => {
      if (user) {
        console.log("‚úÖ User authenticated, loading trial data...");
        if (!currentTrialData) {
          loadTrialData();
        }
      } else {
        console.log("‚ùå User not authenticated");
        window.location.href = 'index.html';
      }
    });

    console.log("Entry form with FEO/Regular buttons and premium pricing ready");
  </script>
</body>
</html>
