<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trial Entry Form</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    /* Back to Dashboard Button */
    .back-to-dashboard {
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      padding: 15px 20px;
    }
    
    .back-button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s ease;
    }
    
    .back-button:hover {
      background: #5a6268;
    }
    
    .trial-info {
      background: #f8f9fa;
      padding: 1.5rem;
      border-bottom: 1px solid #e9ecef;
    }
    
    .trial-info h3 {
      color: #495057;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    
    .trial-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .trial-details > div {
      font-size: 0.95rem;
    }
    
    .trial-details strong {
      color: #495057;
    }
    
    /* Shareable Link Section */
    .shareable-link-section {
      background: #e7f3ff;
      border: 2px solid #0066cc;
      border-radius: 8px;
      padding: 20px;
      margin: 20px;
      display: none;
    }
    
    .shareable-link-section h3 {
      color: #0066cc;
      margin-bottom: 15px;
    }
    
    .link-display {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .link-url {
      font-family: monospace;
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      word-break: break-all;
      color: #0066cc;
      margin-bottom: 10px;
    }
    
    .link-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-copy, .btn-test {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    
    .btn-copy {
      background: #17a2b8;
      color: white;
    }
    
    .btn-test {
      background: #28a745;
      color: white;
    }
    
    .entry-form {
      padding: 2rem;
    }
    
    .form-section {
      margin-bottom: 2rem;
    }
    
    .form-section h3 {
      color: #495057;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 0.5rem;
    }
    
    .form-section.primary {
      background: #f0f8ff;
      border: 2px solid #0066cc;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .form-section.primary h3 {
      color: #0066cc;
      border-bottom-color: #0066cc;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-group.required label::after {
      content: " *";
      color: #dc3545;
      font-weight: bold;
    }
    
    label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #495057;
    }
    
    input, select, textarea {
      padding: 0.75rem;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .auto-filled {
      background: #e7f3ff !important;
      border-color: #0066cc !important;
      animation: autoFillGlow 2s ease-in-out;
    }
    
    @keyframes autoFillGlow {
      0% { box-shadow: 0 0 5px rgba(0, 102, 204, 0.5); }
      50% { box-shadow: 0 0 20px rgba(0, 102, 204, 0.8); }
      100% { box-shadow: none; }
    }
    
    .lookup-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      display: none;
    }
    
    .lookup-status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      display: block;
    }
    
    .lookup-status.warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      display: block;
    }
    
    .lookup-status.loading {
      background: #e7f3ff;
      border: 1px solid #bee5eb;
      color: #0c5460;
      display: block;
    }
    
    .waiver-section {
      background: #fff8e1;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .waiver-content {
      margin-bottom: 1rem;
      line-height: 1.6;
    }
    
    .waiver-agreement {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .waiver-agreement input[type="checkbox"] {
      margin-top: 0.2rem;
      width: auto;
    }
    
    /* Class Selection - Match the screenshot style */
    .day-section {
      margin-bottom: 2rem;
    }
    
    .day-header {
      background: #007bff;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }
    
    .class-section {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    
    .class-header {
      background: #28a745;
      color: white;
      padding: 0.75rem 1rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .class-content {
      padding: 1rem;
    }
    
    .round-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      background: #f8f9fa;
    }
    
    .round-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .round-number {
      background: #007bff;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .judge-name {
      font-weight: 500;
      color: #495057;
    }
    
    .entry-options {
      display: flex;
      gap: 0.5rem;
    }
    
    .entry-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #28a745;
      background: white;
      color: #28a745;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    
    .entry-btn:hover {
      background: #28a745;
      color: white;
    }
    
    .entry-btn.selected {
      background: #28a745;
      color: white;
    }
    
    .entry-btn.feo {
      border-color: #ffc107;
      color: #ffc107;
    }
    
    .entry-btn.feo:hover,
    .entry-btn.feo.selected {
      background: #ffc107;
      color: #212529;
    }
    
    .entry-summary {
      background: #e7f3ff;
      border: 2px solid #0066cc;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }
    
    .summary-item {
      text-align: center;
    }
    
    .summary-item strong {
      display: block;
      color: #495057;
      margin-bottom: 0.5rem;
    }
    
    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .success-message {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .edit-link-section {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }
    
    .edit-link-section h3 {
      color: #856404;
      margin-bottom: 10px;
    }
    
    .hidden {
      display: none;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .form-row, .summary-grid {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .entry-options {
        flex-direction: column;
        gap: 0.3rem;
      }
      
      .round-item {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 id="trialTitle">üèÜ Trial Entry Form</h1>
      <p id="trialSubtitle">Complete your entry for this C-WAGS trial</p>
    </div>

    <!-- Back to Dashboard Button -->
    <div class="back-to-dashboard" id="backToDashboardSection">
      <a href="main-dashboard.html" class="back-button">
        ‚Üê Back to Dashboard
      </a>
    </div>

    <!-- Trial Selection (Secretary Only) -->
    <div class="trial-info" id="trialSelectionSection">
      <h3>üéØ Select Trial</h3>
      <div class="form-row">
        <div class="form-group required full-width">
          <label for="trialSelection">Choose which trial to enter:</label>
          <select id="trialSelection" required style="font-size: 1.1rem; padding: 1rem;">
            <option value="">Loading available trials...</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Shareable Link Section (Secretary Only) -->
    <div class="shareable-link-section" id="shareableLinkSection">
      <h3>üîó Shareable Entry Link</h3>
      <p>Share this link with participants so they can enter from home:</p>
      <div class="link-display">
        <div class="link-url" id="shareableUrl">
          <!-- Generated URL will appear here -->
        </div>
        <div class="link-actions">
          <button class="btn-copy" onclick="copyShareableLink()">üìã Copy Link</button>
          <button class="btn-test" onclick="testShareableLink()">üîó Test Link</button>
        </div>
      </div>
    </div>

    <!-- Trial Information -->
    <div class="trial-info" id="trialInfoSection" style="display: none;">
      <h3>üìã Trial Information</h3>
      <div class="trial-details">
        <div><strong>Club:</strong> <span id="clubName">-</span></div>
        <div><strong>Dates:</strong> <span id="trialDates">-</span></div>
        <div><strong>Location:</strong> <span id="trialLocation">-</span></div>
        <div><strong>Secretary:</strong> <span id="trialSecretary">-</span></div>
      </div>
    </div>

    <div class="entry-form" id="entryFormContainer" style="display: none;">
      <!-- Success Message -->
      <div id="successMessage" class="success-message hidden">
        <h3>‚úÖ Entry Submitted Successfully!</h3>
        <p>The entry has been recorded for this trial.</p>
        <button class="btn btn-primary" onclick="resetForm()">Enter Another Participant</button>
      </div>

      <!-- Edit Link Section -->
      <div class="edit-link-section hidden" id="editLinkSection">
        <h3>‚úÖ Entry Submitted Successfully!</h3>
        <p>Your entry has been recorded. Use this link to edit your entry in the future:</p>
        <div class="link-display">
          <div class="link-url" id="editUrl">
            <!-- Edit URL will appear here -->
          </div>
          <div class="link-actions">
            <button class="btn-copy" onclick="copyEditLink()">üìã Copy Edit Link</button>
            <button class="btn-test" onclick="testEditLink()">üîó Test Edit Link</button>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button class="btn btn-primary" onclick="resetForNewEntry()">Submit Another Entry</button>
        </div>
      </div>

      <!-- Waiver Section -->
      <div class="waiver-section">
        <h3>‚ö†Ô∏è Liability Waiver & Release</h3>
        <div class="waiver-content">
          <p><strong>WAIVER AND RELEASE OF LIABILITY</strong></p>
          <p>I understand that participation in dog training and scent work activities involves inherent risks including but not limited to: dogs working in close proximity to each other, off-leash activities, and interaction with other dogs and handlers.</p>
          <p>I acknowledge that I participate at my own risk and agree to hold harmless the hosting club, property owners, judges, and event organizers from any claims, damages, or injuries that may occur.</p>
        </div>
        <div class="waiver-agreement">
          <input type="checkbox" id="waiverAccepted" required>
          <label for="waiverAccepted">
            <strong>I have read, understood, and agree to the terms of this waiver and release of liability.</strong>
          </label>
        </div>
      </div>

      <!-- Entry Form -->
      <form id="entryForm">
        <!-- Registration Number Lookup -->
        <div class="form-section primary">
          <h3>üîç Registration Lookup</h3>
          <div class="form-row">
            <div class="form-group full-width">
              <label>C-WAGS Registration Number (optional)</label>
              <input type="text" id="cwagsNumber" placeholder="XX-XXXX-XX" 
                     style="font-size: 1.2rem; font-weight: bold; background: #f0f8ff;">
              <small style="color: #666; margin-top: 0.5rem; display: block;">
                üí° Enter registration number first - handler and dog info will auto-fill if found
              </small>
            </div>
          </div>
          <div id="lookupStatus" class="lookup-status"></div>
        </div>

        <!-- Handler Information -->
        <div class="form-section">
          <h3>üë§ Handler Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Handler Name</label>
              <input type="text" id="handlerName" required placeholder="Will auto-fill from registration">
            </div>
            <div class="form-group required">
              <label>Phone Number</label>
              <input type="tel" id="handlerPhone" required placeholder="(xxx) xxx-xxxx">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group required">
              <label>Email Address</label>
              <input type="email" id="handlerEmail" required placeholder="handler@email.com">
            </div>
            <div class="form-group">
              <label>Emergency Contact</label>
              <input type="text" id="emergencyContact" placeholder="Name and phone number">
            </div>
          </div>
        </div>

        <!-- Dog Information -->
        <div class="form-section">
          <h3>üêï Dog Information</h3>
          <div class="form-row">
            <div class="form-group required">
              <label>Dog's Call Name</label>
              <input type="text" id="dogCallName" required placeholder="Will auto-fill from registration">
            </div>
            <div class="form-group">
              <label>Breed</label>
              <input type="text" id="dogBreed" placeholder="Enter breed">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" id="dogBirthdate">
            </div>
            <div class="form-group">
              <label>Sex</label>
              <select id="dogSex">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Male Neutered">Male Neutered</option>
                <option value="Female Spayed">Female Spayed</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Junior Handler (Under 18)</label>
              <select id="juniorHandler">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Class Selection -->
        <div class="form-section">
          <h3>üéØ Class Entries</h3>
          <p style="margin-bottom: 1rem; color: #666;">Select the specific class/judge combinations you wish to enter:</p>
          <div id="classSelection">
            <div style="text-align: center; padding: 2rem; color: #666;">
              Loading available classes by day and judge...
            </div>
          </div>
        </div>

        <!-- Entry Summary -->
        <div class="entry-summary">
          <h3>üí∞ Entry Summary</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <strong>Classes Selected</strong>
              <span id="selectedClassCount">0</span>
            </div>
            <div class="summary-item">
              <strong>Entry Fee</strong>
              <span id="calculatedFee">$0.00</span>
            </div>
            <div class="summary-item">
              <strong>Junior Handler</strong>
              <span id="summaryJuniorHandler">No</span>
            </div>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
            Submit Entry
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetForm()">
            Clear Form
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // ========================================
    // GLOBAL DATE HANDLING FIX
    // ========================================
    
    // Creates a date object that stays in local timezone
    function createLocalDate(dateStr) {
      if (!dateStr) return null;
      
      // Always add noon time to prevent timezone shifts
      if (typeof dateStr === 'string') {
        const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
        return new Date(dateWithTime);
      }
      
      return new Date(dateStr);
    }

    // Formats a date to YYYY-MM-DD string in local timezone
    function formatLocalDate(date) {
      if (!date || !(date instanceof Date)) return '';
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }

    // Gets today's date in local timezone as YYYY-MM-DD string
    function getTodayLocal() {
      const now = new Date();
      return formatLocalDate(now);
    }

    // Formats date for display with timezone consideration
    function formatDateDisplay(dateInput, options = {}) {
      let date;
      
      if (typeof dateInput === 'string') {
        date = createLocalDate(dateInput);
      } else if (dateInput instanceof Date) {
        date = new Date(dateInput);
      } else {
        return 'Invalid Date';
      }
      
      if (!date || isNaN(date.getTime())) return 'Invalid Date';
      
      const defaultOptions = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
      };
      
      const formatOptions = { ...defaultOptions, ...options };
      return new Intl.DateTimeFormat('en-US', formatOptions).format(date);
    }

    // Prepares date data for Firebase storage (prevents timezone conversion)
    function prepareDateForFirebase(dateStr) {
      if (!dateStr) return null;
      
      // Create a date that represents the exact local date at noon
      const localDate = createLocalDate(dateStr);
      
      // Store as a Firestore Timestamp to maintain precision
      return localDate;
    }

    // Retrieves date data from Firebase (converts back to local date string)
    function getDateFromFirebase(firebaseDate) {
      if (!firebaseDate) return '';
      
      let date;
      
      // Handle Firestore Timestamps
      if (firebaseDate.toDate) {
        date = firebaseDate.toDate();
      } else if (firebaseDate instanceof Date) {
        date = firebaseDate;
      } else if (typeof firebaseDate === 'string') {
        date = createLocalDate(firebaseDate);
      } else {
        return '';
      }
      
      return formatLocalDate(date);
    }

    // Test date handling function
    function testDateHandling() {
      console.log('=== Date Handling Test ===');
      
      const testDate = '2024-03-15';
      console.log('1. Original date string:', testDate);
      
      const forFirebase = prepareDateForFirebase(testDate);
      console.log('2. Prepared for Firebase:', forFirebase);
      
      const fromFirebase = getDateFromFirebase(forFirebase);
      console.log('3. Retrieved from Firebase:', fromFirebase);
      
      const display = formatDateDisplay(fromFirebase);
      console.log('4. Formatted for display:', display);
      
      const matches = fromFirebase === testDate;
      console.log('5. Round-trip successful:', matches);
      
      if (!matches) {
        console.error('‚ùå Date handling is still broken!');
      } else {
        console.log('‚úÖ Date handling is working correctly!');
      }
    }

    console.log("üéØ Entry form loaded");

    // Global variables
    let currentTrialData = null;
    let selectedClasses = new Set();
    let registrationData = [];
    let isAutoFilling = false;
    let availableTrials = [];
    let isSecretary = false;

    // Fee structure
    const fees = {
      firstClass: 35.00,
      additionalClass: 25.00,
      juniorHandler: 20.00
    };

    // Initialize the application
    async function init() {
      await loadRegistrationData();

      // Check URL parameters for entry link
      const urlParams = new URLSearchParams(window.location.search);
      const entryId = urlParams.get('entry');
      const trialId = urlParams.get('trial');

      if (entryId) {
        // Load existing entry for editing
        await loadExistingEntry(entryId);
      } else if (trialId) {
        // Load specific trial for public entry
        await loadSpecificTrial(trialId);
      } else {
        // Normal secretary view
        isSecretary = true;
        setupSecretaryView();
      }

      // Test date handling (remove in production)
      testDateHandling();
    }

    // Load registration data from data.json
    async function loadRegistrationData() {
      try {
        console.log("üìä Loading registration data...");
        const response = await fetch('./js/data.json');
        const data = await response.json();
        registrationData = data || [];
        console.log(`‚úÖ Loaded ${registrationData.length} registration records`);
      } catch (error) {
        console.warn("‚ö†Ô∏è Could not load registration data:", error);
        registrationData = [];
      }
    }

    // Setup secretary view
    async function setupSecretaryView() {
      try {
        // Wait for auth
        await new Promise((resolve) => {
          if (auth.currentUser) {
            resolve();
          } else {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              unsubscribe();
              resolve();
            });
          }
        });

        if (!auth.currentUser) {
          alert("Please log in to access the entry form");
          window.location.href = 'index.html';
          return;
        }

        // Load trials for secretary - using timezone-safe date handling
        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", auth.currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        
        if (!trialsSnapshot.empty) {
          availableTrials = [];
          trialsSnapshot.forEach(doc => {
            const trialData = doc.data();
            
            // Fix date handling for trial days using global date fix
            if (trialData.days && Array.isArray(trialData.days)) {
              trialData.days = trialData.days.map(day => ({
                ...day,
                date: day.date ? getDateFromFirebase(day.date) : null
              }));
            }
            
            availableTrials.push({ id: doc.id, ...trialData });
          });
          
          availableTrials.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
          
          populateTrialSelector();
        } else {
          alert("No trials found. Please create a trial first.");
          window.location.href = 'main-dashboard.html';
        }
      } catch (error) {
        console.error("‚ùå Error loading trial data:", error);
        alert("Error loading trial data: " + error.message);
      }
    }

    // Load specific trial for public entry
    async function loadSpecificTrial(trialId) {
      try {
        const trialDoc = await getDoc(doc(db, 'trials', trialId));
        if (!trialDoc.exists()) {
          alert('Trial not found');
          return;
        }

        const trialData = trialDoc.data();
        
        // Fix date handling for trial days using global date fix
        if (trialData.days && Array.isArray(trialData.days)) {
          trialData.days = trialData.days.map(day => ({
            ...day,
            date: day.date ? getDateFromFirebase(day.date) : null
          }));
        }

        currentTrialData = { id: trialDoc.id, ...trialData };
        document.getElementById('trialSelectionSection').style.display = 'none';
        document.getElementById('backToDashboardSection').style.display = 'none'; // Hide back button for public entries
        populateTrialInfo();
        showEntryForm();
      } catch (error) {
        console.error('Error loading specific trial:', error);
        alert('Error loading trial: ' + error.message);
      }
    }

    // Load existing entry for editing
    async function loadExistingEntry(entryId) {
      try {
        const entryDoc = await getDoc(doc(db, 'entries', entryId));
        if (!entryDoc.exists()) {
          alert('Entry not found');
          return;
        }

        const entryData = entryDoc.data();
        
        // Fix selected entries dates using global date fix
        if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
          entryData.selectedEntries = entryData.selectedEntries.map(entry => ({
            ...entry,
            date: entry.date ? getDateFromFirebase(entry.date) : null
          }));
        }
        
        // Load the trial
        const trialDoc = await getDoc(doc(db, 'trials', entryData.trialId));
        if (!trialDoc.exists()) {
          alert('Associated trial not found');
          return;
        }

        const trialData = trialDoc.data();
        
        // Fix date handling for trial days
        if (trialData.days && Array.isArray(trialData.days)) {
          trialData.days = trialData.days.map(day => ({
            ...day,
            date: day.date ? getDateFromFirebase(day.date) : null
          }));
        }

        currentTrialData = { id: trialDoc.id, ...trialData };
        document.getElementById('trialSelectionSection').style.display = 'none';
        document.getElementById('backToDashboardSection').style.display = 'none'; // Hide back button for editing entries
        
        // Populate trial info and form
        populateTrialInfo();
        showEntryForm();
        
        // Fill form with existing data
        setTimeout(() => {
          populateFormWithEntryData(entryData);
        }, 500);

      } catch (error) {
        console.error('Error loading existing entry:', error);
        alert('Error loading entry: ' + error.message);
      }
    }

    // Populate trial selector dropdown
    function populateTrialSelector() {
      const trialSelect = document.getElementById('trialSelection');
      trialSelect.innerHTML = '<option value="">Select a trial...</option>';

      availableTrials.forEach(trial => {
        const option = document.createElement('option');
        option.value = trial.id;
        
        let trialLabel = trial.clubName || 'Unnamed Trial';
        
        if (trial.days && trial.days.length > 0) {
          const dates = trial.days
            .filter(day => day.date)
            .map(day => {
              // Use timezone-safe date formatting
              const localDate = createLocalDate(day.date);
              return localDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
              });
            })
            .join(', ');
          if (dates) {
            trialLabel += ` (${dates})`;
          }
        }
        
        option.textContent = trialLabel;
        trialSelect.appendChild(option);
      });

      // Handle trial selection change
      trialSelect.addEventListener('change', function() {
        const trialId = this.value;
        if (trialId) {
          currentTrialData = availableTrials.find(t => t.id === trialId);
          if (currentTrialData) {
            generateShareableLink();
            populateTrialInfo();
            showEntryForm();
          }
        } else {
          hideShareableLink();
          hideTrialInfo();
          hideEntryForm();
        }
      });
    }

    // Generate shareable link
    function generateShareableLink() {
      if (!isSecretary || !currentTrialData) return;

      const baseUrl = window.location.origin + window.location.pathname;
      const shareableUrl = `${baseUrl}?trial=${currentTrialData.id}`;
      
      document.getElementById('shareableUrl').textContent = shareableUrl;
      document.getElementById('shareableLinkSection').style.display = 'block';
    }

    // Populate trial information
    function populateTrialInfo() {
      if (!currentTrialData) return;

      document.getElementById('trialTitle').textContent = `${currentTrialData.clubName || 'Trial'} Entry Form`;
      
      // Use timezone-safe date formatting for trial dates
      const dates = currentTrialData.days && currentTrialData.days.length > 0 
        ? currentTrialData.days
            .filter(day => day.date)
            .map(day => formatDateDisplay(day.date, { 
              weekday: undefined, 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric' 
            }))
            .join(', ')
        : 'No dates specified';

      document.getElementById('clubName').textContent = currentTrialData.clubName || 'TBD';
      document.getElementById('trialDates').textContent = dates;
      document.getElementById('trialLocation').textContent = 'TBD';
      document.getElementById('trialSecretary').textContent = currentTrialData.secretary || 'TBD';

      document.getElementById('trialInfoSection').style.display = 'block';
      populateClasses();
    }

    // Populate classes with the exact style from screenshot and timezone-safe dates
    function populateClasses() {
      const classSelection = document.getElementById('classSelection');
      let html = '';

      if (!currentTrialData.days || currentTrialData.days.length === 0) {
        html = '<div style="text-align: center; padding: 2rem; color: #666;">No classes available for this trial.</div>';
        classSelection.innerHTML = html;
        return;
      }

      currentTrialData.days.forEach((day, dayIndex) => {
        if (!day.classes || day.classes.length === 0) return;

        // Use timezone-safe date formatting
        const dayDate = day.date ? formatDateDisplay(day.date) : `Day ${dayIndex + 1}`;

        html += `
          <div class="day-section">
            <div class="day-header">üìÖ ${dayDate}</div>
        `;

        // Group classes by name
        const classGroups = new Map();
        day.classes.forEach((cls, classIndex) => {
          if (cls && cls.className && cls.className.trim()) {
            const className = cls.className.trim();
            if (!classGroups.has(className)) {
              classGroups.set(className, []);
            }
            classGroups.get(className).push({...cls, dayIndex, classIndex});
          }
        });

        classGroups.forEach((classInstances, className) => {
          html += `
            <div class="class-section">
              <div class="class-header">
                <span>üéØ ${className}</span>
                <span>${classInstances.length} round${classInstances.length > 1 ? 's' : ''}</span>
              </div>
              <div class="class-content">
          `;

          classInstances.forEach((classInstance, instanceIndex) => {
            if (classInstance.rounds && Array.isArray(classInstance.rounds)) {
              classInstance.rounds.forEach((round, roundIndex) => {
                const judgeName = round.judge && round.judge.trim() ? round.judge : 'Judge TBD';
                const roundNumber = round.roundNumber || (roundIndex + 1);
                const regularId = `entry_${dayIndex}_${classInstance.classIndex}_${roundIndex}_regular`;
                const feoId = `entry_${dayIndex}_${classInstance.classIndex}_${roundIndex}_feo`;
                
                const baseEntryValue = {
                  dayIndex,
                  classIndex: classInstance.classIndex,
                  roundIndex,
                  className,
                  judge: judgeName,
                  roundNumber,
                  date: prepareDateForFirebase(day.date) || `Day ${dayIndex + 1}` // Use timezone-safe date preparation
                };
                
                const regularEntryValue = JSON.stringify({...baseEntryValue, entryType: 'regular'});
                const feoEntryValue = JSON.stringify({...baseEntryValue, entryType: 'feo'});
                
                const showFeo = round.feo === true || round.FEO === true;

                html += `
                  <div class="round-item">
                    <input type="checkbox" id="${regularId}" value='${regularEntryValue}' style="display: none;">
                    ${showFeo ? `<input type="checkbox" id="${feoId}" value='${feoEntryValue}' style="display: none;">` : ''}
                    
                    <div class="round-info">
                      <div class="round-number">Round ${roundNumber}</div>
                      <div class="judge-name">${judgeName}</div>
                    </div>
                    <div class="entry-options">
                      <button type="button" class="entry-btn regular" data-entry-id="${regularId}">Entry</button>
                      ${showFeo ? `<button type="button" class="entry-btn feo" data-entry-id="${feoId}">FEO</button>` : ''}
                    </div>
                  </div>
                `;
              });
            }
          });

          html += `
              </div>
            </div>
          `;
        });

        html += `</div>`;
      });

      classSelection.innerHTML = html;
      setupEventListeners();
    }

    // Setup event listeners
    function setupEventListeners() {
      // Entry button clicks
      document.querySelectorAll('.entry-btn').forEach(button => {
        button.addEventListener('click', handleEntryButtonClick);
      });

      // Registration number lookup with debouncing
      let registrationTimeout;
      const cwagsInput = document.getElementById('cwagsNumber');
      if (cwagsInput) {
        cwagsInput.addEventListener('input', function(e) {
          const registrationNumber = e.target.value.trim();
          
          clearTimeout(registrationTimeout);
          
          if (registrationNumber.length >= 3) {
            registrationTimeout = setTimeout(() => {
              autoFillFromRegistration(registrationNumber);
            }, 500);
          } else {
            hideLookupStatus();
          }
          
          checkFormValidity();
        });
      }

      // Form validation listeners
      document.getElementById('entryForm').addEventListener('input', checkFormValidity);
      document.getElementById('waiverAccepted').addEventListener('change', checkFormValidity);
      document.getElementById('juniorHandler').addEventListener('change', updateEntrySummary);

      // Form submission
      document.getElementById('entryForm').addEventListener('submit', handleFormSubmit);
    }

    // Auto-fill from registration data (search both data.json and Firebase)
    async function autoFillFromRegistration(registrationNumber) {
      if (isAutoFilling) return;
      
      showLookupStatus('üîç Looking up registration...', 'loading');
      
      try {
        isAutoFilling = true;
        
        const normalizedInput = registrationNumber.toUpperCase().replace(/[^A-Z0-9]/g, '');
        console.log("üîç Looking up registration:", normalizedInput);
        
        let matchingRegistration = null;

        // First search data.json
        matchingRegistration = registrationData.find(record => {
          const normalizedRecord = (record.cwagsNumber || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
          return normalizedRecord === normalizedInput;
        });

        // If not found in data.json, search Firebase entries
        if (!matchingRegistration) {
          try {
            const entriesQuery = query(
              collection(db, "entries"),
              where("cwagsNumber", "==", registrationNumber)
            );
            const entriesSnapshot = await getDocs(entriesQuery);
            
            if (!entriesSnapshot.empty) {
              // Use the most recent entry
              const entries = [];
              entriesSnapshot.forEach(doc => {
                const entryData = doc.data();
                
                // Fix date handling for entry data
                if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
                  entryData.selectedEntries = entryData.selectedEntries.map(entry => ({
                    ...entry,
                    date: entry.date ? getDateFromFirebase(entry.date) : null
                  }));
                }
                
                entries.push(entryData);
              });
              entries.sort((a, b) => b.submittedAt?.toDate() - a.submittedAt?.toDate());
              matchingRegistration = entries[0];
            }
          } catch (firebaseError) {
            console.warn("Could not search Firebase entries:", firebaseError);
          }
        }
        
        if (matchingRegistration) {
          console.log("‚úÖ Found matching registration:", matchingRegistration);
          showLookupStatus('‚úÖ Registration found! Auto-filling information...', 'success');
          populateForm(matchingRegistration);
        } else {
          console.log("‚ùå No matching registration found for:", normalizedInput);
          showLookupStatus('‚ÑπÔ∏è Registration number not found in our records. You can still continue with manual entry.', 'warning');
        }
        
      } catch (error) {
        console.error("‚ùå Error during registration lookup:", error);
        showLookupStatus('‚ùå Error looking up registration', 'warning');
      } finally {
        isAutoFilling = false;
      }
    }

    // Handle entry button clicks
    function handleEntryButtonClick(event) {
      event.preventDefault();
      
      const button = event.target;
      const entryId = button.dataset.entryId;
      const checkbox = document.getElementById(entryId);
      
      if (!checkbox) return;
      
      checkbox.checked = !checkbox.checked;
      
      if (checkbox.checked) {
        button.classList.add('selected');
        selectedClasses.add(checkbox.value);
      } else {
        button.classList.remove('selected');
        selectedClasses.delete(checkbox.value);
      }
      
      updateEntrySummary();
      checkFormValidity();
    }

    // Update entry summary
    function updateEntrySummary() {
      const entryCount = selectedClasses.size;
      const isJunior = document.getElementById('juniorHandler').value === 'Yes';
      
      let totalFee = 0;
      let regularEntries = 0;
      let feoEntries = 0;
      
      selectedClasses.forEach(entryJson => {
        try {
          const entry = JSON.parse(entryJson);
          if (entry.entryType === 'feo') {
            feoEntries++;
          } else {
            regularEntries++;
          }
        } catch (e) {
          regularEntries++;
        }
      });
      
      if (isJunior) {
        totalFee = fees.juniorHandler * regularEntries;
      } else if (regularEntries > 0) {
        totalFee = fees.firstClass + (fees.additionalClass * Math.max(0, regularEntries - 1));
      }
      
      const uniqueClasses = new Set();
      selectedClasses.forEach(entryJson => {
        try {
          const entry = JSON.parse(entryJson);
          uniqueClasses.add(entry.className);
        } catch (e) {}
      });
      
      let entryBreakdown = `${entryCount} entries (${uniqueClasses.size} classes)`;
      if (feoEntries > 0) {
        entryBreakdown += ` - ${regularEntries} Regular, ${feoEntries} FEO`;
      }
      
      document.getElementById('selectedClassCount').textContent = entryBreakdown;
      document.getElementById('calculatedFee').textContent = `${totalFee.toFixed(2)}`;
      document.getElementById('summaryJuniorHandler').textContent = document.getElementById('juniorHandler').value;
    }

    // Check form validity
    function checkFormValidity() {
      const waiverAccepted = document.getElementById('waiverAccepted').checked;
      const handlerName = document.getElementById('handlerName').value.trim();
      const handlerEmail = document.getElementById('handlerEmail').value.trim();
      const handlerPhone = document.getElementById('handlerPhone').value.trim();
      const dogCallName = document.getElementById('dogCallName').value.trim();
      const hasClasses = selectedClasses.size > 0;
      
      const isValid = waiverAccepted && handlerName && handlerEmail && handlerPhone && dogCallName && hasClasses;
      
      document.getElementById('submitBtn').disabled = !isValid;
    }

    // Handle form submission with timezone-safe date handling
    async function handleFormSubmit(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      try {
        const selectedEntries = Array.from(selectedClasses).map(entryJson => {
          try {
            return JSON.parse(entryJson);
          } catch (e) {
            return null;
          }
        }).filter(entry => entry !== null);

        const entryData = {
          trialId: currentTrialData.id,
          cwagsNumber: document.getElementById('cwagsNumber').value.trim(),
          handlerName: document.getElementById('handlerName').value.trim(),
          handlerPhone: document.getElementById('handlerPhone').value.trim(),
          handlerEmail: document.getElementById('handlerEmail').value.trim(),
          emergencyContact: document.getElementById('emergencyContact').value.trim(),
          dogCallName: document.getElementById('dogCallName').value.trim(),
          dogBreed: document.getElementById('dogBreed').value.trim(),
          dogBirthdate: document.getElementById('dogBirthdate').value,
          dogSex: document.getElementById('dogSex').value,
          selectedEntries: selectedEntries.map(entry => ({
            ...entry,
            date: entry.date // Already prepared with prepareDateForFirebase
          })),
          selectedClasses: selectedEntries.map(e => e.className),
          entryCount: selectedEntries.length,
          uniqueClassCount: new Set(selectedEntries.map(e => e.className)).size,
          regularEntries: selectedEntries.filter(e => e.entryType === 'regular').length,
          feoEntries: selectedEntries.filter(e => e.entryType === 'feo').length,
          juniorHandler: document.getElementById('juniorHandler').value === 'Yes',
          waiverAccepted: true,
          entryFee: document.getElementById('calculatedFee').textContent,
          submittedAt: new Date(),
          submittedBy: auth.currentUser ? auth.currentUser.uid : 'public_entry'
        };

        console.log("üíæ Submitting entry data:", entryData);

        // Save entry using timezone-safe date handling
        await saveEntryData(entryData);
        
        // Generate edit link
        generateEditLink(entryData);
        
        // Show success
        showSuccessSection();

      } catch (error) {
        console.error('Error submitting entry:', error);
        alert('Error submitting entry: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Entry';
      }
    }

    // Save entry data with timezone-safe date handling
    async function saveEntryData(entryData) {
      // Fix selected entries dates using the global date fix
      if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
        entryData.selectedEntries = entryData.selectedEntries.map(entry => ({
          ...entry,
          date: entry.date ? prepareDateForFirebase(entry.date) : null
        }));
      }
      
      // Save to Firebase
      const docRef = await addDoc(collection(db, "entries"), entryData);
      console.log("‚úÖ Entry submitted with ID:", docRef.id);
      
      return docRef;
    }

    // Generate edit link
    function generateEditLink(entryData) {
      const baseUrl = window.location.origin + window.location.pathname;
      const editUrl = `${baseUrl}?entry=${entryData.id || 'new'}`;
      
      document.getElementById('editUrl').textContent = editUrl;
    }

    // Show success section
    function showSuccessSection() {
      document.getElementById('entryForm').style.display = 'none';
      document.getElementById('editLinkSection').classList.remove('hidden');
    }

    // Populate form with existing entry data using timezone-safe dates
    function populateFormWithEntryData(entryData) {
      document.getElementById('cwagsNumber').value = entryData.cwagsNumber || '';
      document.getElementById('handlerName').value = entryData.handlerName || '';
      document.getElementById('handlerPhone').value = entryData.handlerPhone || '';
      document.getElementById('handlerEmail').value = entryData.handlerEmail || '';
      document.getElementById('emergencyContact').value = entryData.emergencyContact || '';
      document.getElementById('dogCallName').value = entryData.dogCallName || '';
      document.getElementById('dogBreed').value = entryData.dogBreed || '';
      document.getElementById('dogBirthdate').value = entryData.dogBirthdate || '';
      document.getElementById('dogSex').value = entryData.dogSex || '';
      document.getElementById('juniorHandler').value = entryData.juniorHandler ? 'Yes' : 'No';
      document.getElementById('waiverAccepted').checked = true;

      // Restore selected classes with timezone-safe date handling
      if (entryData.selectedEntries) {
        entryData.selectedEntries.forEach(entry => {
          // Ensure dates are properly handled
          const processedEntry = {
            ...entry,
            date: entry.date ? getDateFromFirebase(entry.date) : entry.date
          };
          
          const entryJson = JSON.stringify(processedEntry);
          selectedClasses.add(entryJson);
          
          const entryId = `entry_${entry.dayIndex}_${entry.classIndex}_${entry.roundIndex}_${entry.entryType}`;
          const button = document.querySelector(`[data-entry-id="${entryId}"]`);
          const checkbox = document.getElementById(entryId);
          
          if (button && checkbox) {
            button.classList.add('selected');
            checkbox.checked = true;
          }
        });
      }

      updateEntrySummary();
      checkFormValidity();
    }

    // Utility functions
    function showLookupStatus(message, type = 'loading') {
      const statusDiv = document.getElementById('lookupStatus');
      if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.className = `lookup-status ${type}`;
      }
    }

    function hideLookupStatus() {
      const statusDiv = document.getElementById('lookupStatus');
      if (statusDiv) {
        statusDiv.style.display = 'none';
      }
    }

    function fillField(fieldId, value) {
      const field = document.getElementById(fieldId);
      if (field && value && (!field.value || field.value.trim() === '')) {
        field.value = value;
        field.classList.add('auto-filled');
        setTimeout(() => {
          field.classList.remove('auto-filled');
        }, 2000);
      }
    }

    function populateForm(data) {
      if (!data || isAutoFilling === false) return;
      
      fillField('handlerName', data.handlerName);
      fillField('handlerPhone', data.handlerPhone);
      fillField('handlerEmail', data.handlerEmail);
      fillField('emergencyContact', data.emergencyContact);
      fillField('dogCallName', data.dogCallName);
      fillField('dogBreed', data.dogBreed);
      fillField('dogBirthdate', data.dogBirthdate);
      
      if (data.dogSex) {
        const sexField = document.getElementById('dogSex');
        if (sexField && (!sexField.value || sexField.value === '')) {
          sexField.value = data.dogSex;
          sexField.classList.add('auto-filled');
          setTimeout(() => {
            sexField.classList.remove('auto-filled');
          }, 2000);
        }
      }
      
      checkFormValidity();
    }

    function showEntryForm() {
      document.getElementById('entryFormContainer').style.display = 'block';
    }

    function hideEntryForm() {
      document.getElementById('entryFormContainer').style.display = 'none';
    }

    function hideTrialInfo() {
      document.getElementById('trialInfoSection').style.display = 'none';
    }

    function hideShareableLink() {
      document.getElementById('shareableLinkSection').style.display = 'none';
    }

    // Global functions for buttons
    window.copyShareableLink = function() {
      const url = document.getElementById('shareableUrl').textContent;
      copyToClipboard(url, 'Shareable link copied to clipboard!');
    };

    window.testShareableLink = function() {
      const url = document.getElementById('shareableUrl').textContent;
      window.open(url, '_blank');
    };

    window.copyEditLink = function() {
      const url = document.getElementById('editUrl').textContent;
      copyToClipboard(url, 'Edit link copied to clipboard!');
    };

    window.testEditLink = function() {
      const url = document.getElementById('editUrl').textContent;
      window.open(url, '_blank');
    };

    function copyToClipboard(text, successMessage) {
      navigator.clipboard.writeText(text).then(() => {
        alert(successMessage);
      }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert(successMessage);
      });
    }

    window.resetForNewEntry = function() {
      document.getElementById('editLinkSection').classList.add('hidden');
      document.getElementById('entryForm').style.display = 'block';
      resetForm();
    };

    window.resetForm = function() {
      document.getElementById('entryForm').reset();
      selectedClasses.clear();
      
      document.querySelectorAll('.entry-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (cb.id !== 'waiverAccepted') cb.checked = false;
      });
      
      hideLookupStatus();
      updateEntrySummary();
      checkFormValidity();
    };

    // Initialize when auth is ready (if secretary) or immediately (if public)
    auth.onAuthStateChanged(async (user) => {
      if (user || !isSecretary) {
        await init();
      } else if (isSecretary) {
        alert("Please log in to access the entry form");
        window.location.href = 'index.html';
      }
    });

    // For public access, initialize immediately
    if (window.location.search.includes('trial=') || window.location.search.includes('entry=')) {
      init();
    }
  </script>
</body>
</html>
