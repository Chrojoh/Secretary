<!DOCTYPE html>
<html>
<head>
  <title>Class Summary Generator</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      padding: 30px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #eee;
    }
    
    .header h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .back-button {
      background-color: #007cba;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
      text-decoration: none;
      display: inline-block;
    }
    
    .back-button:hover {
      background-color: #005a8b;
    }
    
    .form-section {
      background: #f8f9fa;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    
    .form-section h2 {
      margin-top: 0;
      color: #333;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .class-container {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .class-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .class-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .dates-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    
    .date-row {
      border-radius: 4px;
      margin: 10px 0;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
      margin: 2px;
    }
    
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-purple { background: #6f42c1; color: white; }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    
    .action-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
    }
    
    .preview-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
    }
    
    .preview-class {
      background: white;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }
    
    .loading, .error, .success {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    
    .loading { background: #e3f2fd; color: #1976d2; }
    .error { background: #ffebee; color: #c62828; }
    .success { background: #e8f5e8; color: #2e7d32; }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    
    th {
      background: #f5f5f5;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="main-dashboard.html" class="back-button">‚Üê Back to Dashboard</a>
    
    <div class="header">
      <h1>üêï C-WAGS Class Summary Generator</h1>
      <p>Create and manage class summary reports for trials</p>
    </div>

    <div id="loadingMessage" class="loading" style="display: none;">
      Loading summary data...
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <!-- Trial Information Section -->
    <div class="form-section">
      <h2>Trial Information</h2>
      <div class="form-row">
        <div class="form-group">
          <label for="hostName">Host Name:</label>
          <input type="text" id="hostName" placeholder="e.g., DOG GROUP">
        </div>
        <div class="form-group">
          <label for="dateRange">Date Range:</label>
          <input type="text" id="dateRange" placeholder="e.g., July 1 ‚Äì August 5, 2025">
        </div>
      </div>
    </div>

    <!-- Classes Section -->
    <div id="classesContainer"></div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="btn btn-purple" onclick="addClass()">+ Add Another Class</button>
      <div>
        <button class="btn btn-success" onclick="saveSummary()">üíæ Save Summary</button>
        <button class="btn btn-primary" onclick="generateReport()">üìÑ Generate Report</button>
      </div>
    </div>

    <!-- Preview Section -->
    <div class="preview-section">
      <h2>üìã Report Preview</h2>
      <div id="previewContainer">
        <p class="loading">Add classes to see preview...</p>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase imports
    import { auth, db } from './js/firebase.js';
    import { collection, addDoc, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // ========================================
    // STANDARDIZED FIELD NAMES (CRITICAL FIX)
    // ========================================

    // Use these EXACT field names everywhere:
    const STANDARD_FIELDS = {
      HANDLER_NAME: 'handlerName',      // NOT 'Handler' or 'handler'
      DOG_CALL_NAME: 'dogCallName',     // NOT 'Call Name' or 'dogName'
      JUDGE_NAME: 'judgeName',          // NOT 'judge' or 'judgeAssigned'
      CLASS_NAME: 'className',          // NOT 'Class' or 'class'
      CWAGS_NUMBER: 'cwagsNumber'       // NOT 'Registration'
    };

    // ========================================
    // GLOBAL STATE
    // ========================================

    let summaryData = {
      hostName: '',
      dateRange: '',
      classes: []
    };

    // ========================================
    // INITIALIZATION
    // ========================================

    document.addEventListener('DOMContentLoaded', function() {
      console.log("Class Summary Generator initializing with standardized fields...");
      
      // Bind event listeners
      document.getElementById('hostName').addEventListener('input', (e) => {
        summaryData.hostName = e.target.value;
        updatePreview();
      });
      
      document.getElementById('dateRange').addEventListener('input', (e) => {
        summaryData.dateRange = e.target.value;
        updatePreview();
      });
      
      // Initialize with one empty class
      addClass();
    });

    // ========================================
    // FIELD NORMALIZATION FUNCTIONS
    // ========================================

    function normalizeEntry(entry) {
      const normalized = {};
      
      // Handle different possible field names and normalize to standard
      normalized[STANDARD_FIELDS.HANDLER_NAME] = entry[STANDARD_FIELDS.HANDLER_NAME] || 
                                                  entry.Handler || 
                                                  entry.handler || 
                                                  entry.handlerName || '';
      
      normalized[STANDARD_FIELDS.DOG_CALL_NAME] = entry[STANDARD_FIELDS.DOG_CALL_NAME] || 
                                                   entry['Call Name'] || 
                                                   entry.callName || 
                                                   entry.dogName || 
                                                   entry.dogCallName || '';
      
      normalized[STANDARD_FIELDS.JUDGE_NAME] = entry[STANDARD_FIELDS.JUDGE_NAME] || 
                                               entry.judge || 
                                               entry.judgeAssigned || 
                                               entry.judgeName || '';
      
      normalized[STANDARD_FIELDS.CWAGS_NUMBER] = entry[STANDARD_FIELDS.CWAGS_NUMBER] || 
                                                 entry.Registration || 
                                                 entry.registration || 
                                                 entry.cwagsNumber || '';
      
      // Preserve other fields
      normalized.results = entry.results || [];
      
      return normalized;
    }

    // ========================================
    // CLASS RENDERING WITH STANDARDIZED FIELDS
    // ========================================

    function renderClasses() {
      const container = document.getElementById('classesContainer');
      
      container.innerHTML = summaryData.classes.map((classItem, classIndex) => `
        <div class="class-container">
          <div class="class-header">
            <div class="class-title">Class ${classItem.id}</div>
            <button onclick="removeClass(${classIndex})" class="btn btn-danger btn-sm">Remove Class</button>
          </div>
          
          <div class="form-group">
            <label for="className_${classIndex}">Class Name:</label>
            <input type="text" id="className_${classIndex}" value="${classItem.name || ''}" 
                   onchange="updateClassName(${classIndex}, this.value)"
                   placeholder="e.g., Level 1 Container Search">
          </div>
          
          ${renderDatesSection(classItem, classIndex)}
          ${renderEntriesSection(classItem, classIndex)}
        </div>
      `).join('');
    }

    function renderDatesSection(classItem, classIndex) {
      return `
        <div class="dates-section">
          <h4>Trial Dates & Judges</h4>
          ${(classItem.dates || []).map((dateItem, dateIndex) => `
            <div class="date-row">
              <div class="form-row">
                <div class="form-group">
                  <label>Date:</label>
                  <input type="date" value="${dateItem.date || ''}" 
                         onchange="updateDate(${classIndex}, ${dateIndex}, 'date', this.value)">
                </div>
                <div class="form-group">
                  <label>Judge:</label>
                  <input type="text" value="${dateItem[STANDARD_FIELDS.JUDGE_NAME] || dateItem.judge || ''}" 
                         onchange="updateDate(${classIndex}, ${dateIndex}, '${STANDARD_FIELDS.JUDGE_NAME}', this.value)"
                         placeholder="Judge name">
                </div>
              </div>
              <button onclick="removeDate(${classIndex}, ${dateIndex})" class="btn btn-danger btn-sm">Remove Date</button>
            </div>
          `).join('')}
          <button onclick="addDate(${classIndex})" class="btn btn-primary btn-sm">+ Add Date</button>
        </div>
      `;
    }

    function renderEntriesSection(classItem, classIndex) {
      if (!classItem.dates || classItem.dates.length === 0) {
        return `
          <div class="entries-section">
            <h4>Entries</h4>
            <p>Add at least one date to manage entries.</p>
          </div>
        `;
      }

      return `
        <div class="entries-section">
          <h4>Entries</h4>
          <button onclick="addEntry(${classIndex})" class="btn btn-primary btn-sm">+ Add Entry</button>
          
          <table>
            <thead>
              <tr>
                <th>Handler</th>
                <th>Dog Call Name</th>
                <th>C-WAGS #</th>
                ${(classItem.dates || []).map(dateItem => `
                  <th>${dateItem.date || 'Date'}<br><small>${dateItem[STANDARD_FIELDS.JUDGE_NAME] || dateItem.judge || 'Judge'}</small></th>
                `).join('')}
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${(classItem.entries || []).map((entry, entryIndex) => {
                const normalizedEntry = normalizeEntry(entry);
                return `
                  <tr>
                    <td>
                      <input type="text" value="${normalizedEntry[STANDARD_FIELDS.HANDLER_NAME]}" 
                             onchange="updateEntry(${classIndex}, ${entryIndex}, '${STANDARD_FIELDS.HANDLER_NAME}', this.value)"
                             placeholder="Handler name">
                    </td>
                    <td>
                      <input type="text" value="${normalizedEntry[STANDARD_FIELDS.DOG_CALL_NAME]}" 
                             onchange="updateEntry(${classIndex}, ${entryIndex}, '${STANDARD_FIELDS.DOG_CALL_NAME}', this.value)"
                             placeholder="Dog call name">
                    </td>
                    <td>
                      <input type="text" value="${normalizedEntry[STANDARD_FIELDS.CWAGS_NUMBER]}" 
                             onchange="updateEntry(${classIndex}, ${entryIndex}, '${STANDARD_FIELDS.CWAGS_NUMBER}', this.value)"
                             placeholder="C-WAGS #">
                    </td>
                    ${(classItem.dates || []).map((dateItem, dateIndex) => `
                      <td>
                        <select onchange="updateResult(${classIndex}, ${entryIndex}, ${dateIndex}, this.value)"
                                value="${normalizedEntry.results && normalizedEntry.results[dateIndex] ? normalizedEntry.results[dateIndex] : ''}">
                          <option value="">-</option>
                          <option value="Pass" ${normalizedEntry.results && normalizedEntry.results[dateIndex] === 'Pass' ? 'selected' : ''}>Pass</option>
                          <option value="Fail" ${normalizedEntry.results && normalizedEntry.results[dateIndex] === 'Fail' ? 'selected' : ''}>Fail</option>
                          <option value="XX" ${normalizedEntry.results && normalizedEntry.results[dateIndex] === 'XX' ? 'selected' : ''}>XX</option>
                        </select>
                      </td>
                    `).join('')}
                    <td>
                      <button onclick="removeEntry(${classIndex}, ${entryIndex})" class="btn btn-danger btn-sm">Remove</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // ========================================
    // CLASS MANAGEMENT
    // ========================================

    window.addClass = function() {
      const newClass = {
        id: summaryData.classes.length + 1,
        name: '',
        dates: [],
        entries: []
      };
      
      summaryData.classes.push(newClass);
      renderClasses();
      updatePreview();
    };

    window.removeClass = function(classIndex) {
      summaryData.classes.splice(classIndex, 1);
      // Re-number classes
      summaryData.classes.forEach((cls, index) => {
        cls.id = index + 1;
      });
      renderClasses();
      updatePreview();
    };

    window.updateClassName = function(classIndex, name) {
      summaryData.classes[classIndex].name = name;
      updatePreview();
    };

    // ========================================
    // DATE MANAGEMENT
    // ========================================

    window.addDate = function(classIndex) {
      if (!summaryData.classes[classIndex].dates) {
        summaryData.classes[classIndex].dates = [];
      }
      
      summaryData.classes[classIndex].dates.push({
        date: '',
        [STANDARD_FIELDS.JUDGE_NAME]: ''
      });
      
      // Update all existing entries to have results for the new date
      summaryData.classes[classIndex].entries.forEach(entry => {
        if (!entry.results) entry.results = [];
        entry.results.push('');
      });
      
      renderClasses();
      updatePreview();
    };

    window.removeDate = function(classIndex, dateIndex) {
      summaryData.classes[classIndex].dates.splice(dateIndex, 1);
      
      // Remove results for this date from all entries
      summaryData.classes[classIndex].entries.forEach(entry => {
        if (entry.results) {
          entry.results.splice(dateIndex, 1);
        }
      });
      
      renderClasses();
      updatePreview();
    };

    window.updateDate = function(classIndex, dateIndex, field, value) {
      summaryData.classes[classIndex].dates[dateIndex][field] = value;
      updatePreview();
    };

    // ========================================
    // ENTRY MANAGEMENT WITH STANDARDIZED FIELDS
    // ========================================

    window.addEntry = function(classIndex) {
      if (!summaryData.classes[classIndex].entries) {
        summaryData.classes[classIndex].entries = [];
      }
      
      const numDates = summaryData.classes[classIndex].dates ? summaryData.classes[classIndex].dates.length : 0;
      
      const newEntry = {
        [STANDARD_FIELDS.HANDLER_NAME]: '',
        [STANDARD_FIELDS.DOG_CALL_NAME]: '',
        [STANDARD_FIELDS.CWAGS_NUMBER]: '',
        results: new Array(numDates).fill('')
      };
      
      summaryData.classes[classIndex].entries.push(newEntry);
      renderClasses();
      updatePreview();
    };

    window.removeEntry = function(classIndex, entryIndex) {
      summaryData.classes[classIndex].entries.splice(entryIndex, 1);
      renderClasses();
      updatePreview();
    };

    window.updateEntry = function(classIndex, entryIndex, field, value) {
      summaryData.classes[classIndex].entries[entryIndex][field] = value;
      updatePreview();
    };

    window.updateResult = function(classIndex, entryIndex, dateIndex, value) {
      if (!summaryData.classes[classIndex].entries[entryIndex].results) {
        summaryData.classes[classIndex].entries[entryIndex].results = [];
      }
      summaryData.classes[classIndex].entries[entryIndex].results[dateIndex] = value;
      updatePreview();
    };

    // ========================================
    // PREVIEW GENERATION WITH STANDARDIZED FIELDS
    // ========================================

    function updatePreview() {
      const container = document.getElementById('previewContainer');
      
      if (!summaryData.hostName && !summaryData.dateRange && summaryData.classes.length === 0) {
        container.innerHTML = '<p class="loading">Add trial information and classes to see preview...</p>';
        return;
      }
      
      const previewHTML = `
        <div class="preview-header" style="text-align: center; margin-bottom: 30px;">
          <h2>C-WAGS Class Results</h2>
          <h3>${summaryData.hostName || '[Host Name]'}</h3>
          <p><strong>Trial Dates:</strong> ${summaryData.dateRange || '[Date Range]'}</p>
        </div>
        
        ${summaryData.classes.map(classItem => `
          <div class="preview-class">
            <h3>${classItem.name || '[Class Name]'}</h3>
            <p><strong>Total Entries:</strong> ${classItem.entries ? classItem.entries.length : 0}</p>
            
            ${classItem.entries && classItem.entries.length > 0 && classItem.dates && classItem.dates.length > 0 ? `
              <table>
                <thead>
                  <tr>
                    <th>Handler</th>
                    <th>Dog</th>
                    <th>C-WAGS #</th>
                    ${classItem.dates.map(dateItem => `
                      <th>${dateItem.date || 'Date'}<br><small>${dateItem[STANDARD_FIELDS.JUDGE_NAME] || 'Judge'}</small></th>
                    `).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${classItem.entries.map(entry => {
                    const normalizedEntry = normalizeEntry(entry);
                    return `
                      <tr>
                        <td>${normalizedEntry[STANDARD_FIELDS.HANDLER_NAME] || ''}</td>
                        <td>${normalizedEntry[STANDARD_FIELDS.DOG_CALL_NAME] || ''}</td>
                        <td>${normalizedEntry[STANDARD_FIELDS.CWAGS_NUMBER] || ''}</td>
                        ${(normalizedEntry.results || []).map(result => `
                          <td>${result || '-'}</td>
                        `).join('')}
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            ` : '<p>No entries added yet.</p>'}
          </div>
        `).join('')}
      `;
      
      container.innerHTML = previewHTML;
    }

    // ========================================
    // SAVE/LOAD FUNCTIONALITY
    // ========================================

    window.saveSummary = async function() {
      try {
        showLoading('Saving summary...');
        
        // Normalize all entries before saving
        const normalizedData = {
          ...summaryData,
          classes: summaryData.classes.map(classItem => ({
            ...classItem,
            entries: (classItem.entries || []).map(entry => normalizeEntry(entry))
          }))
        };
        
        // Save to Firebase (implement this function)
        // const docRef = await addDoc(collection(db, 'summaries'), normalizedData);
        
        showSuccess('Summary saved successfully!');
        hideLoading();
      } catch (error) {
        console.error('Error saving summary:', error);
        showError('Failed to save summary: ' + error.message);
        hideLoading();
      }
    };

    window.generateReport = function() {
      window.print();
    };

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================

    function showLoading(message) {
      const loadingEl = document.getElementById('loadingMessage');
      loadingEl.textContent = message;
      loadingEl.style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loadingMessage').style.display = 'none';
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      const successEl = document.getElementById('successMessage');
      successEl.textContent = message;
      successEl.style.display = 'block';
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 3000);
    }

    console.log("Class Summary Generator loaded successfully with standardized field names");
  </script>
</body>
</html>
