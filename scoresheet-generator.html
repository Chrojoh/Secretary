<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Sheets Generator & Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2rem;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .score-sheets-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .score-sheet-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-sheet-info {
            flex: 1;
        }

        .score-sheet-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .score-sheet-details {
            font-size: 14px;
            color: #6c757d;
        }

        .score-sheet-actions {
            display: flex;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-generated {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-printed {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #fff3cd;
            color: #856404;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Score Sheet Styles */
        .score-sheet {
            width: 8.5in;
            min-height: 11in;
            background: white;
            padding: 0.5in;
            margin: 0 auto 1in auto;
            border: 1px solid #000;
            font-family: Arial, sans-serif;
            font-size: 10px;
            page-break-after: always;
        }

        .score-sheet:last-child {
            page-break-after: auto;
        }

        .score-sheet-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        .cwags-logo {
            position: absolute;
            right: 0;
            top: 20px;
            width: 80px;
            height: 80px;
        }

        .cwags-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .score-sheet-title-text {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-sheet-date {
            font-size: 12px;
            margin-bottom: 10px;
        }

        .score-sheet-class {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .score-sheet-rounds {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .score-sheet-rounds label {
            font-weight: bold;
            margin-right: 10px;
        }

        .round-checkbox {
            margin-right: 5px;
        }

        .scent-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .scent-info-table th,
        .scent-info-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
        }

        .scent-info-table th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .faults-section {
            margin-bottom: 15px;
            font-size: 9px;
        }

        .scoring-table {
            width: 100%;
            border-collapse: collapse;
        }

        .scoring-table th,
        .scoring-table td {
            border: 1px solid #000;
            padding: 4px;
            text-align: center;
            font-size: 9px;
        }

        .scoring-table th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .team-name-cell {
            text-align: left;
            font-weight: bold;
            background: #f8f8f8;
        }

        .scent-cell {
            font-size: 8px;
            padding: 2px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container > *:not(#scoreSheetsContainer) {
                display: none !important;
            }

            #scoreSheetsContainer {
                display: block !important;
            }

            .score-sheet {
                margin: 0;
                border: none;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Score Sheets Generator & Manager</h1>

        <div class="controls">
            <div class="control-group">
                <label for="trialSelect">Select Trial:</label>
                <select id="trialSelect">
                    <option value="">Loading trials...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="dateSelect">Select Date:</label>
                <select id="dateSelect">
                    <option value="">Select trial first...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="judgeSelect">Select Judge (Optional):</label>
                <select id="judgeSelect">
                    <option value="">All Judges</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            <button class="btn" onclick="loadTrialData()" id="loadBtn">Load Trial Data</button>
            <button class="btn btn-success" onclick="generateAllScoreSheets()" id="generateBtn" style="display: none;">Generate Score Sheets</button>
            <button class="btn btn-warning" onclick="printScoreSheets()" id="printBtn" style="display: none;">Print Selected Sheets</button>
            <button class="btn btn-secondary" onclick="viewStoredSheets()" id="storedBtn">View Stored Sheets</button>
            <button class="btn btn-secondary" onclick="location.href='main-dashboard.html'">‚Üê Back to Dashboard</button>
        </div>

        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div>Loading trial data...</div>
        </div>

        <div id="stats" class="stats" style="display: none;"></div>

        <div id="scoreSheetsSection" class="score-sheets-list" style="display: none;">
            <h3>üìÑ Generated Score Sheets</h3>
            <div id="scoreSheetsList"></div>
        </div>

        <!-- Score Sheets Print Container -->
        <div id="scoreSheetsContainer" style="display: none;"></div>
    </div>

    <script type="module">
        // Firebase imports
        import { auth, db } from './js/firebase.js';
        import { collection, query, where, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

        // Global variables
        let trials = [];
        let currentTrial = null;
        let entries = [];
        let runningOrderData = {};
        let generatedSheets = [];

        // Initialize the application
        async function init() {
            try {
                await loadTrials();
            } catch (error) {
                console.error('Error initializing:', error);
                showError('Error loading trials: ' + error.message);
            }
        }

        // Load available trials
        async function loadTrials() {
            try {
                if (!auth.currentUser) {
                    showError('Please log in to access trials');
                    return;
                }

                const q = query(
                    collection(db, "trials"),
                    where("createdBy", "==", auth.currentUser.uid)
                );
                
                const snapshot = await getDocs(q);
                trials = [];
                
                snapshot.forEach(doc => {
                    trials.push({ id: doc.id, ...doc.data() });
                });

                // Sort by creation date (most recent first)
                trials.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                populateTrialSelector();
            } catch (error) {
                console.error('Error loading trials:', error);
                showError('Error loading trials: ' + error.message);
            }
        }

        // Populate trial selector dropdown
        function populateTrialSelector() {
            const trialSelect = document.getElementById('trialSelect');
            trialSelect.innerHTML = '<option value="">Select a trial...</option>';

            trials.forEach(trial => {
                const option = document.createElement('option');
                option.value = trial.id;
                
                let trialLabel = trial.clubName || 'Unnamed Trial';
                
                if (trial.days && trial.days.length > 0) {
                    const dates = trial.days
                        .filter(day => day.date)
                        .map(day => new Date(day.date).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        }))
                        .join(', ');
                    if (dates) {
                        trialLabel += ` (${dates})`;
                    }
                }
                
                option.textContent = trialLabel;
                trialSelect.appendChild(option);
            });

            // Handle trial selection change
            trialSelect.addEventListener('change', function() {
                const trialId = this.value;
                if (trialId) {
                    currentTrial = trials.find(t => t.id === trialId);
                    populateDateSelector();
                    populateJudgeSelector();
                } else {
                    currentTrial = null;
                    document.getElementById('dateSelect').innerHTML = '<option value="">Select trial first...</option>';
                    document.getElementById('judgeSelect').innerHTML = '<option value="">All Judges</option>';
                }
            });
        }

        // Populate date selector based on selected trial
        function populateDateSelector() {
            const dateSelect = document.getElementById('dateSelect');
            dateSelect.innerHTML = '<option value="">Select a date...</option>';

            if (currentTrial && currentTrial.days) {
                currentTrial.days.forEach(day => {
                    if (day.date) {
                        const option = document.createElement('option');
                        option.value = day.date;
                        option.textContent = new Date(day.date).toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        dateSelect.appendChild(option);
                    }
                });
            }
        }

        // Populate judge selector based on selected trial
        function populateJudgeSelector() {
            const judgeSelect = document.getElementById('judgeSelect');
            judgeSelect.innerHTML = '<option value="">All Judges</option>';

            if (currentTrial && currentTrial.days) {
                const judges = new Set();
                currentTrial.days.forEach(day => {
                    if (day.classes) {
                        day.classes.forEach(cls => {
                            if (cls.rounds) {
                                cls.rounds.forEach(round => {
                                    if (round.judge && round.judge.trim()) {
                                        judges.add(round.judge.trim());
                                    }
                                });
                            }
                        });
                    }
                });

                Array.from(judges).sort().forEach(judge => {
                    const option = document.createElement('option');
                    option.value = judge;
                    option.textContent = judge;
                    judgeSelect.appendChild(option);
                });
            }
        }

        // Load trial data and entries
        async function loadTrialData() {
            const trialId = document.getElementById('trialSelect').value;
            const selectedDate = document.getElementById('dateSelect').value;

            if (!trialId) {
                alert('Please select a trial');
                return;
            }

            if (!selectedDate) {
                alert('Please select a date');
                return;
            }

            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('loadBtn').disabled = true;

            try {
                // Load entries for this trial
                const q = query(
                    collection(db, "entries"),
                    where("trialId", "==", trialId)
                );
                
                const snapshot = await getDocs(q);
                entries = [];
                
                snapshot.forEach(doc => {
                    const entryData = doc.data();
                    if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
                        entryData.selectedEntries.forEach(selectedEntry => {
                            entries.push({
                                id: doc.id,
                                ...selectedEntry,
                                handlerName: entryData.handlerName,
                                dogCallName: entryData.dogCallName,
                                cwagsNumber: entryData.cwagsNumber,
                                submittedAt: entryData.submittedAt
                            });
                        });
                    }
                });

                // Filter entries for selected date
                entries = entries.filter(entry => entry.date === selectedDate);

                console.log('Loaded entries for date:', selectedDate, entries);

                if (entries.length === 0) {
                    showError('No entries found for the selected date');
                    return;
                }

                // Group entries and load any existing running order
                await loadRunningOrder();
                
                // Generate statistics
                generateStats();

                // Show controls
                document.getElementById('generateBtn').style.display = 'inline-block';
                document.getElementById('printBtn').style.display = 'inline-block';

            } catch (error) {
                console.error('Error loading trial data:', error);
                showError('Error loading trial data: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('loadBtn').disabled = false;
            }
        }

        // Load existing running order or create default grouping
        async function loadRunningOrder() {
            const selectedDate = document.getElementById('dateSelect').value;
            
            try {
                // Try to load confirmed running order first
                const q = query(
                    collection(db, "runningOrders"),
                    where("trialId", "==", currentTrial.id),
                    where("date", "==", selectedDate)
                );
                
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    // Use confirmed running order
                    snapshot.forEach(doc => {
                        const orderData = doc.data();
                        runningOrderData[selectedDate] = orderData.runningOrder;
                    });
                    console.log('Loaded confirmed running order');
                } else {
                    // Create default grouping from entries
                    runningOrderData = {};
                    runningOrderData[selectedDate] = {};
                    
                    entries.forEach(entry => {
                        const judge = entry.judge || 'Judge TBD';
                        const classRound = `${entry.className || 'Unknown Class'} - Round ${entry.roundNumber || 1}`;

                        if (!runningOrderData[selectedDate][judge]) {
                            runningOrderData[selectedDate][judge] = {};
                        }
                        if (!runningOrderData[selectedDate][judge][classRound]) {
                            runningOrderData[selectedDate][judge][classRound] = [];
                        }

                        const entrantName = `${entry.handlerName || 'Unknown Handler'} - ${entry.dogCallName || 'Unknown Dog'}`;
                        runningOrderData[selectedDate][judge][classRound].push({
                            id: `${entry.id || 'unknown'}_${Date.now()}_${Math.random()}`,
                            name: entrantName,
                            entryType: entry.entryType || 'regular',
                            handler: entry.handlerName || 'Unknown Handler',
                            dog: entry.dogCallName || 'Unknown Dog',
                            cwagsNumber: entry.cwagsNumber || '',
                            originalEntry: entry
                        });
                    });
                    
                    console.log('Created default running order grouping');
                }
            } catch (error) {
                console.error('Error loading running order:', error);
                // Fallback to default grouping
            }
        }

        // Generate all score sheets
        async function generateAllScoreSheets() {
            const selectedDate = document.getElementById('dateSelect').value;
            const selectedJudge = document.getElementById('judgeSelect').value;

            if (!runningOrderData[selectedDate]) {
                alert('No data available for the selected date');
                return;
            }

            generatedSheets = [];
            const judgeData = runningOrderData[selectedDate];

            // Filter by judge if selected
            const judgesToProcess = selectedJudge ? 
                { [selectedJudge]: judgeData[selectedJudge] } : 
                judgeData;

            Object.keys(judgesToProcess).forEach(judge => {
                Object.keys(judgesToProcess[judge]).forEach(classRound => {
                    const entrants = judgesToProcess[judge][classRound];
                    
                    const sheetData = {
                        id: `${currentTrial.id}_${selectedDate}_${judge}_${classRound}`.replace(/[^a-zA-Z0-9]/g, '_'),
                        trialId: currentTrial.id,
                        trialName: currentTrial.clubName || 'Unnamed Trial',
                        date: selectedDate,
                        judge: judge,
                        classRound: classRound,
                        className: classRound.split(' - Round')[0],
                        roundNumber: classRound.split('Round ')[1] || '1',
                        entrants: entrants,
                        status: 'generated',
                        createdAt: new Date(),
                        createdBy: auth.currentUser.uid
                    };

                    generatedSheets.push(sheetData);
                });
            });

            // Save to database
            await saveScoreSheetsToDatabase();

            // Display generated sheets
            displayGeneratedSheets();

            alert(`Generated ${generatedSheets.length} score sheets!`);
        }

        // Save score sheets to database
        async function saveScoreSheetsToDatabase() {
            try {
                for (const sheet of generatedSheets) {
                    await setDoc(doc(db, 'scoreSheets', sheet.id), sheet);
                }
                console.log('Score sheets saved to database');
            } catch (error) {
                console.error('Error saving score sheets:', error);
                alert('Error saving score sheets: ' + error.message);
            }
        }

        // Display generated sheets list
        function displayGeneratedSheets() {
            const section = document.getElementById('scoreSheetsSection');
            const list = document.getElementById('scoreSheetsList');
            
            let html = '';
            
            generatedSheets.forEach(sheet => {
                html += `
                    <div class="score-sheet-item">
                        <div class="score-sheet-info">
                            <div class="score-sheet-title">${sheet.judge} - ${sheet.classRound}</div>
                            <div class="score-sheet-details">
                                ${sheet.entrants.length} entrants ‚Ä¢ ${sheet.date}
                                <span class="status-badge status-${sheet.status}">${sheet.status.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="score-sheet-actions">
                            <button class="btn btn-secondary" onclick="previewSheet('${sheet.id}')">Preview</button>
                            <button class="btn btn-success" onclick="printSingleSheet('${sheet.id}')">Print</button>
                            <button class="btn btn-warning" onclick="markCompleted('${sheet.id}')">Mark Complete</button>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            section.style.display = 'block';
        }

        // Print score sheets
        function printScoreSheets() {
            if (generatedSheets.length === 0) {
                alert('No score sheets generated. Please generate sheets first.');
                return;
            }

            const container = document.getElementById('scoreSheetsContainer');
            let html = '';

            generatedSheets.forEach(sheet => {
                html += generateScoreSheetHTML(sheet);
            });

            container.innerHTML = html;
            
            // Print
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Generate score sheet HTML with dynamic sizing
        function generateScoreSheetHTML(sheetData) {
            const entrantCount = sheetData.entrants.length;
            
            // Calculate optimal font sizes and spacing based on entrant count
            let scoringTableFontSize = '9px';
            let cellPadding = '4px';
            let rowHeight = '40px';
            
            if (entrantCount > 12) {
                scoringTableFontSize = '7px';
                cellPadding = '2px';
                rowHeight = '30px';
            } else if (entrantCount > 8) {
                scoringTableFontSize = '8px';
                cellPadding = '3px';
                rowHeight = '35px';
            }

            let html = `
                <div class="score-sheet">
                    <div class="score-sheet-header">
                        <div style="text-align: right; font-size: 8px;">Copyright ¬© by Canine-Work And Games, LLC, 2024</div>
                        <div class="cwags-logo">
                            <img src="./images/cwags-logo.png" alt="C-WAGS Logo" />
                        </div>
                        <div class="score-sheet-title-text">${sheetData.className} Score Sheet</div>
                        <div class="score-sheet-date">Date: ${sheetData.date}</div>
                        <div class="score-sheet-class">CLASS: ${sheetData.className}</div>
                        <div class="score-sheet-class">JUDGE: ${sheetData.judge}</div>
                        
                        <div class="score-sheet-rounds">
                            <label>Round</label>
                            <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '1' ? 'checked' : ''}> 1
                            <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '2' ? 'checked' : ''}> 2
                            <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '3' ? 'checked' : ''}> 3
                            <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '4' ? 'checked' : ''}> 4
                        </div>
                    </div>

                    <table class="scent-info-table">
                        <tr>
                            <th>Scent 1</th>
                            <th>Scent 2</th>
                            <th>Scent 3</th>
                            <th>Scent 4</th>
                        </tr>
                        <tr>
                            <td>Located in/on:</td>
                            <td>Located in/on:</td>
                            <td>Located in/on:</td>
                            <td>Located in/on:</td>
                        </tr>
                        <tr>
                            <td style="height: 30px;"></td>
                            <td style="height: 30px;"></td>
                            <td style="height: 30px;"></td>
                            <td style="height: 30px;"></td>
                        </tr>
                    </table>

                    <div class="faults-section">
                        <strong>Faults:</strong> Dropped Food; Dog stops working; Handler guiding dog; Incorrect find; Destructive behavior; 
                        Disturbing search area by dog or handler; Verbally naming item; Continue search after "alert"; 
                        SR crossing line less than half.
                    </div>

                    <table class="scoring-table" style="font-size: ${scoringTableFontSize};">
                        <thead>
                            <tr>
                                <th rowspan="2">Team</th>
                                <th rowspan="2">Dog - Handler</th>
                                <th colspan="4">Scent Results</th>
                                <th rowspan="2">Fault</th>
                                <th rowspan="2">Fault</th>
                                <th rowspan="2">Time</th>
                                <th rowspan="2">Pass/Fail</th>
                            </tr>
                            <tr>
                                <th>Scent 1</th>
                                <th>Scent 2</th>
                                <th>Scent 3</th>
                                <th>Scent 4</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Generate fillable score sheet HTML (for editing)
function generateFillableScoreSheetHTML(sheetData) {
    const entrantCount = sheetData.entrants.length;
    
    // Calculate optimal font sizes and spacing based on entrant count
    let scoringTableFontSize = '9px';
    let cellPadding = '4px';
    let rowHeight = '40px';
    
    if (entrantCount > 12) {
        scoringTableFontSize = '7px';
        cellPadding = '2px';
        rowHeight = '30px';
    } else if (entrantCount > 8) {
        scoringTableFontSize = '8px';
        cellPadding = '3px';
        rowHeight = '35px';
    }

    // Load existing scores if they exist
    const scores = sheetData.scores || {};

    let html = `
        <div class="score-sheet" style="border: 2px solid #007bff; background: #f8f9fa;">
            <div style="background: #007bff; color: white; padding: 10px; margin: -20px -20px 20px -20px; text-align: center;">
                <h3 style="margin: 0;">‚úèÔ∏è FILLABLE SCORE SHEET - Enter scores from judge's physical sheet</h3>
                <p style="margin: 5px 0 0 0; font-size: 14px;">Fill in the 4 scent locations, mark scent results, enter faults, times, and Pass/Fail</p>
            </div>
            
            <div class="score-sheet-header">
                <div style="text-align: right; font-size: 8px;">Copyright ¬© by Canine-Work And Games, LLC, 2024</div>
                <div class="cwags-logo">
                    <img src="./images/cwags-logo.png" alt="C-WAGS Logo" />
                </div>
                <div class="score-sheet-title-text">${sheetData.className} Score Sheet</div>
                <div class="score-sheet-date">Date: ${sheetData.date}</div>
                <div class="score-sheet-class">CLASS: ${sheetData.className}</div>
                <div class="score-sheet-class">JUDGE: ${sheetData.judge}</div>
                
                <div class="score-sheet-rounds">
                    <label>Round</label>
                    <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '1' ? 'checked' : ''}> 1
                    <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '2' ? 'checked' : ''}> 2
                    <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '3' ? 'checked' : ''}> 3
                    <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '4' ? 'checked' : ''}> 4
                </div>
            </div>

            <table class="scent-info-table">
                <tr>
                    <th style="background: #fff3cd;">Scent 1</th>
                    <th style="background: #fff3cd;">Scent 2</th>
                    <th style="background: #fff3cd;">Scent 3</th>
                    <th style="background: #fff3cd;">Scent 4</th>
                </tr>
                <tr>
                    <td style="background: #fff3cd;">Located in/on:</td>
                    <td style="background: #fff3cd;">Located in/on:</td>
                    <td style="background: #fff3cd;">Located in/on:</td>
                    <td style="background: #fff3cd;">Located in/on:</td>
                </tr>
                <tr>
                    <td style="height: 30px; background: white;">
                        <input type="text" id="scent1Location" 
                               value="${scores.scent1Location || ''}" 
                               placeholder="Enter scent 1 location"
                               style="width: 100%; border: 1px solid #ccc; padding: 5px; font-size: 11px;">
                    </td>
                    <td style="height: 30px; background: white;">
                        <input type="text" id="scent2Location" 
                               value="${scores.scent2Location || ''}" 
                               placeholder="Enter scent 2 location"
                               style="width: 100%; border: 1px solid #ccc; padding: 5px; font-size: 11px;">
                    </td>
                    <td style="height: 30px; background: white;">
                        <input type="text" id="scent3Location" 
                               value="${scores.scent3Location || ''}" 
                               placeholder="Enter scent 3 location"
                               style="width: 100%; border: 1px solid #ccc; padding: 5px; font-size: 11px;">
                    </td>
                    <td style="height: 30px; background: white;">
                        <input type="text" id="scent4Location" 
                               value="${scores.scent4Location || ''}" 
                               placeholder="Enter scent 4 location"
                               style="width: 100%; border: 1px solid #ccc; padding: 5px; font-size: 11px;">
                    </td>
                </tr>
            </table>

            <div class="faults-section">
                <strong>Faults:</strong> Dropped Food; Dog stops working; Handler guiding dog; Incorrect find; Destructive behavior; 
                Disturbing search area by dog or handler; Verbally naming item; Continue search after "alert"; 
                SR crossing line less than half.
            </div>

            <table class="scoring-table" style="font-size: ${scoringTableFontSize};">
                <thead>
                    <tr>
                        <th rowspan="2">Team</th>
                        <th rowspan="2">Dog - Handler</th>
                        <th colspan="4">Scent Results</th>
                        <th rowspan="2">Fault</th>
                        <th rowspan="2">Fault</th>
                        <th rowspan="2">Time</th>
                        <th rowspan="2">Pass/Fail</th>
                    </tr>
                    <tr>
                        <th>Scent 1</th>
                        <th>Scent 2</th>
                        <th>Scent 3</th>
                        <th>Scent 4</th>
                    </tr>
                </thead>
                <tbody>
    `;

    // Add entrant rows - use actual count or minimum 8, whichever is larger
    const minRows = Math.max(8, entrantCount);
    for (let i = 0; i < minRows; i++) {
        const entrant = sheetData.entrants[i];
        const teamName = entrant ? `${entrant.name}` : `Team ${i + 1}`;
        const entrantScores = scores[i] || {};
        
        html += `
            <tr style="height: ${rowHeight}; ${entrant ? 'background: white;' : 'background: #f8f9fa;'}">
                <td style="font-weight: bold; padding: ${cellPadding}; text-align: center;">${i + 1}</td>
                <td style="font-weight: bold; padding: ${cellPadding}; font-size: 8px; ${!entrant ? 'color: #999;' : ''}">${teamName}</td>
                <td style="padding: 2px;">
                    <input type="text" 
                           value="${entrantScores.scent1 || ''}" 
                           onchange="updateEntrantScore(${i}, 'scent1', this.value)"
                           placeholder="‚úì or X"
                           style="width: 100%; text-align: center; border: 1px solid #ddd; padding: 2px; font-size: 10px;">
                </td>
                <td style="padding: 2px;">
                    <input type="text" 
                           value="${entrantScores.scent2 || ''}" 
                           onchange="updateEntrantScore(${i}, 'scent2', this.value)"
                           placeholder="‚úì or X"
                           style="width: 100%; text-align: center; border: 1px solid #ddd; padding: 2px; font-size: 10px;">
                </td>
                <td style="padding: 2px;">
                    <input type="text" 
                           value="${entrantScores.scent3 || ''}" 
                           onchange="updateEntrantScore(${i}, 'scent3', this.value)"
                           placeholder="‚úì or X"
                           style="width: 100%; text-align: center; border: 1px solid #ddd; padding: 2px; font-size: 10px;">
                </td>
                <td style="padding: 2px;">
                    <input type="text" 
                           value="${entrantScores.scent4 || ''}" 
                           onchange="updateEntrantScore(${i}, 'scent4', this.value)"
                           placeholder="‚úì or X"
                           style="width: 100%; text-align: center; border: 1px solid #ddd; padding: 2px; font-size: 10px;">
                </td>
                <td style="padding: 2px;">
                    <input type="text" 
                           value="${entrantScores.fault1 || ''}" 
                           onchange="updateEntrantScore(${i}, 'fault1', this.value)"
                           placeholder="Fault type"
                           style="width: 100%; text-align: center; border: 1px solid #ddd; padding: 2px; font-size: 9px;">
                </td>
                <td style="padding: 2px;">
                    <input type="text" 
                           value="${entrantScores.fault2 || ''}" 
                           onchange="updateEntrantScore(${i}, 'fault2', this.value)"
                           placeholder="Fault type"
                           style="width: 100%; text-align: center; border: 1px solid #ddd; padding: 2px; font-size: 9px;">
                </td>
                <td style="padding: 2px;">
                    <input type="text" 
                           value="${entrantScores.time || ''}" 
                           onchange="updateEntrantScore(${i}, 'time', this.value)"
                           placeholder="mm:ss"
                           style="width: 100%; text-align: center; border: 1px solid #ddd; padding: 2px; font-size: 10px;">
                </td>
                <td style="padding: 2px;">
                    <select onchange="updateEntrantScore(${i}, 'passFail', this.value)"
                            style="width: 100%; text-align: center; border: 1px solid #ddd; padding: 2px; font-size: 10px; font-weight: bold;">
                        <option value="">-</option>
                        <option value="Pass" ${entrantScores.passFail === 'Pass' ? 'selected' : ''} style="background: #d4edda;">Pass</option>
                        <option value="Fail" ${entrantScores.passFail === 'Fail' ? 'selected' : ''} style="background: #f8d7da;">Fail</option>
                    </select>
                </td>
            </tr>
        `;
    }

    html += `
                </tbody>
            </table>
            
            <div style="margin-top: 20px; text-align: center; padding: 20px; background: white; border: 2px solid #28a745; border-radius: 8px;">
                <button onclick="saveFillableScores('${sheetData.id}')" 
                        style="background: #28a745; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    üíæ Save All Scores
                </button>
                <button onclick="clearScores()" 
                        style="background: #6c757d; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 5px; cursor: pointer;">
                    üóëÔ∏è Clear Form
                </button>
            </div>
        </div>
    `;

    return html;
}

            // Add entrant rows - use actual count or minimum 8, whichever is larger
            const minRows = Math.max(8, entrantCount);
            for (let i = 0; i < minRows; i++) {
                const entrant = sheetData.entrants[i];
                const teamName = entrant ? `${entrant.handler} - ${entrant.dog}` : '';
                
                html += `
                    <tr>
                        <td class="team-name-cell" style="padding: ${cellPadding};">${i + 1}</td>
                        <td class="team-name-cell" style="padding: ${cellPadding};">${teamName}</td>
                        <td class="scent-cell" style="padding: ${cellPadding};">
                            <div>Scent 1</div>
                            <div style="height: 12px;"></div>
                        </td>
                        <td class="scent-cell" style="padding: ${cellPadding};">
                            <div>Scent 2</div>
                            <div style="height: 12px;"></div>
                        </td>
                        <td class="scent-cell" style="padding: ${cellPadding};">
                            <div>Scent 3</div>
                            <div style="height: 12px;"></div>
                        </td>
                        <td class="scent-cell" style="padding: ${cellPadding};">
                            <div>Scent 4</div>
                            <div style="height: 12px;"></div>
                        </td>
                        <td style="height: ${rowHeight}; padding: ${cellPadding};"></td>
                        <td style="height: ${rowHeight}; padding: ${cellPadding};"></td>
                        <td style="height: ${rowHeight}; padding: ${cellPadding};"></td>
                        <td style="height: ${rowHeight}; padding: ${cellPadding};"></td>
                    </tr>
                `;
            }

            html += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; text-align: center; font-size: 8px;">
                        Copyright ¬© by Canine-Work And Games, LLC, 2024
                    </div>
                </div>
            `;

            return html;
        }

        // Generate statistics
        function generateStats() {
            const totalEntries = entries.length;
            const uniqueHandlers = new Set(entries.map(e => e.handlerName)).size;
            const uniqueDogs = new Set(entries.map(e => e.dogCallName)).size;
            const regularEntries = entries.filter(e => e.entryType === 'regular').length;
            const feoEntries = entries.filter(e => e.entryType === 'feo').length;

            const statsContainer = document.getElementById('stats');
            statsContainer.style.display = 'grid';
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${totalEntries}</span>
                    <span class="stat-label">Total Entries</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${uniqueHandlers}</span>
                    <span class="stat-label">Handlers</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${uniqueDogs}</span>
                    <span class="stat-label">Dogs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${regularEntries}</span>
                    <span class="stat-label">Regular</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${feoEntries}</span>
                    <span class="stat-label">FEO</span>
                </div>
            `;
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('scoreSheetsSection');
            container.innerHTML = `
                <div class="no-data">
                    ‚ùå ${message}
                </div>
            `;
            container.style.display = 'block';
            document.getElementById('stats').style.display = 'none';
        }

        // Preview single sheet
        window.previewSheet = function(sheetId) {
            const sheet = generatedSheets.find(s => s.id === sheetId);
            if (!sheet) return;

            const container = document.getElementById('scoreSheetsContainer');
            container.innerHTML = generateScoreSheetHTML(sheet);
            container.style.display = 'block';
            
            // Scroll to preview
            container.scrollIntoView({ behavior: 'smooth' });
        };

        // Print single sheet
        window.printSingleSheet = function(sheetId) {
            const sheet = generatedSheets.find(s => s.id === sheetId);
            if (!sheet) return;

            const container = document.getElementById('scoreSheetsContainer');
            container.innerHTML = generateScoreSheetHTML(sheet);
            
            setTimeout(() => {
                window.print();
            }, 100);
        };

        // Mark sheet as completed
        window.markCompleted = async function(sheetId) {
            try {
                const sheet = generatedSheets.find(s => s.id === sheetId);
                if (!sheet) return;

                // Update status in memory
                sheet.status = 'completed';
                sheet.completedAt = new Date();

                // Update in database
                await updateDoc(doc(db, 'scoreSheets', sheetId), {
                    status: 'completed',
                    completedAt: new Date()
                });

                // Refresh display
                displayGeneratedSheets();
                
                alert('Score sheet marked as completed!');
            } catch (error) {
                console.error('Error updating sheet status:', error);
                alert('Error updating sheet status: ' + error.message);
            }
        };

        // View stored sheets
        window.viewStoredSheets = async function() {
            try {
                if (!auth.currentUser) {
                    alert('Please log in first');
                    return;
                }

                document.getElementById('loadingIndicator').style.display = 'block';

                // Load all stored score sheets for this user
                const q = query(
                    collection(db, "scoreSheets"),
                    where("createdBy", "==", auth.currentUser.uid)
                );
                
                const snapshot = await getDocs(q);
                const storedSheets = [];
                
                snapshot.forEach(doc => {
                    storedSheets.push({ id: doc.id, ...doc.data() });
                });

                // Sort by creation date (most recent first)
                storedSheets.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                // Display stored sheets
                displayStoredSheets(storedSheets);

            } catch (error) {
                console.error('Error loading stored sheets:', error);
                showError('Error loading stored sheets: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        };

        // Display stored sheets
        function displayStoredSheets(sheets) {
            const section = document.getElementById('scoreSheetsSection');
            const list = document.getElementById('scoreSheetsList');
            
            let html = '';
            
            if (sheets.length === 0) {
                html = '<div class="no-data">No stored score sheets found.</div>';
            } else {
                sheets.forEach(sheet => {
                    const createdDate = sheet.createdAt ? sheet.createdAt.toDate().toLocaleDateString() : 'Unknown';
                    html += `
                        <div class="score-sheet-item">
                            <div class="score-sheet-info">
                                <div class="score-sheet-title">${sheet.trialName} - ${sheet.judge} - ${sheet.classRound}</div>
                                <div class="score-sheet-details">
                                    ${sheet.entrants.length} entrants ‚Ä¢ ${sheet.date} ‚Ä¢ Created: ${createdDate}
                                    <span class="status-badge status-${sheet.status}">${sheet.status.toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="score-sheet-actions">
                                <button class="btn btn-secondary" onclick="previewStoredSheet('${sheet.id}')">Preview</button>
                                <button class="btn btn-success" onclick="printStoredSheet('${sheet.id}')">Print</button>
                                <button class="btn btn-warning" onclick="editScores('${sheet.id}')">Edit Scores</button>
                                <button class="btn btn-danger" onclick="deleteSheet('${sheet.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            list.innerHTML = html;
            section.style.display = 'block';
        }

        // Preview stored sheet
        window.previewStoredSheet = async function(sheetId) {
            try {
                const sheetDoc = await getDoc(doc(db, 'scoreSheets', sheetId));
                if (!sheetDoc.exists()) {
                    alert('Score sheet not found');
                    return;
                }

                const sheet = { id: sheetDoc.id, ...sheetDoc.data() };
                const container = document.getElementById('scoreSheetsContainer');
                container.innerHTML = generateScoreSheetHTML(sheet);
                container.style.display = 'block';
                
                // Scroll to preview
                container.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading sheet:', error);
                alert('Error loading sheet: ' + error.message);
            }
        };

        // Print stored sheet
        window.printStoredSheet = async function(sheetId) {
            try {
                const sheetDoc = await getDoc(doc(db, 'scoreSheets', sheetId));
                if (!sheetDoc.exists()) {
                    alert('Score sheet not found');
                    return;
                }

                const sheet = { id: sheetDoc.id, ...sheetDoc.data() };
                const container = document.getElementById('scoreSheetsContainer');
                container.innerHTML = generateScoreSheetHTML(sheet);
                
                setTimeout(() => {
                    window.print();
                }, 100);
            } catch (error) {
                console.error('Error printing sheet:', error);
                alert('Error printing sheet: ' + error.message);
            }
        };

       // Edit scores - Simple fillable form approach
window.editScores = async function(sheetId) {
    try {
        const sheetDoc = await getDoc(doc(db, 'scoreSheets', sheetId));
        if (!sheetDoc.exists()) {
            alert('Score sheet not found');
            return;
        }

        const sheet = { id: sheetDoc.id, ...sheetDoc.data() };
        const container = document.getElementById('scoreSheetsContainer');
        
        // Generate fillable score sheet HTML
        container.innerHTML = generateFillableScoreSheetHTML(sheet);
        container.style.display = 'block';
        
        // Scroll to the form
        container.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('Error loading sheet for editing:', error);
        alert('Error loading sheet: ' + error.message);
    }
};

        // Delete sheet
        window.deleteSheet = async function(sheetId) {
            if (!confirm('Are you sure you want to delete this score sheet? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'scoreSheets', sheetId));
                alert('Score sheet deleted successfully');
                
                // Refresh the stored sheets view
                viewStoredSheets();
            } catch (error) {
                console.error('Error deleting sheet:', error);
                alert('Error deleting sheet: ' + error.message);
            }
        };

        // Make main functions available globally
        window.loadTrialData = loadTrialData;
        window.generateAllScoreSheets = generateAllScoreSheets;
        window.printScoreSheets = printScoreSheets;

        // Initialize when auth is ready
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await init();
            } else {
                showError('Please log in to access score sheets');
            }
        });
    </script>
</body>
</html>>
