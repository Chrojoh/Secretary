<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Sheets Generator & Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2rem;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #444;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .score-sheets-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .score-sheet-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-sheet-info {
            flex: 1;
        }

        .score-sheet-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .score-sheet-details {
            font-size: 14px;
            color: #6c757d;
        }

        .score-sheet-actions {
            display: flex;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-generated {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-printed {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #fff3cd;
            color: #856404;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Score Sheet Styles */
        .score-sheet {
            width: 8.5in;
            min-height: 11in;
            background: white;
            padding: 0.5in;
            margin: 0 auto 1in auto;
            border: 1px solid #000;
            font-family: Arial, sans-serif;
            font-size: 10px;
            page-break-after: always;
        }

        .score-sheet:last-child {
            page-break-after: auto;
        }

        .score-sheet-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        .cwags-logo {
            position: absolute;
            right: 0;
            top: 20px;
            width: 80px;
            height: 80px;
        }

        .cwags-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .score-sheet-title-text {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .score-sheet-date {
            font-size: 12px;
            margin-bottom: 10px;
        }

        .score-sheet-class {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .score-sheet-rounds {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .score-sheet-rounds label {
            font-weight: bold;
            margin-right: 10px;
        }

        .round-checkbox {
            margin-right: 5px;
        }

        .scent-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .scent-info-table th,
        .scent-info-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
        }

        .scent-info-table th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .faults-section {
            margin-bottom: 15px;
            font-size: 9px;
        }

        .scoring-table {
            width: 100%;
            border-collapse: collapse;
        }

        .scoring-table th,
        .scoring-table td {
            border: 1px solid #000;
            padding: 4px;
            text-align: center;
            font-size: 9px;
        }

        .scoring-table th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .team-name-cell {
            text-align: left;
            font-weight: bold;
            background: #f8f8f8;
        }

        .scent-cell {
            font-size: 8px;
            padding: 2px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* PDF Editor Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
        }

        .score-entry-form {
            display: grid;
            gap: 20px;
        }

        .scent-locations {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .scent-location-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        .scent-location-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .scent-location-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .entrants-scoring {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .entrant-row {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .entrant-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .entrant-scoring-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr) 2fr 1fr 1fr;
            gap: 15px;
            align-items: center;
        }

        .scent-result-group {
            text-align: center;
        }

        .scent-result-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #6c757d;
        }

        .scent-checkboxes {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .checkbox-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .checkbox-option span {
            font-size: 12px;
            font-weight: 500;
        }

        .fault-input, .time-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .pass-fail-group {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .pass-fail-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pass-fail-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container > *:not(#scoreSheetsContainer) {
                display: none !important;
            }

            #scoreSheetsContainer {
                display: block !important;
            }

            .score-sheet {
                margin: 0;
                border: none;
                box-shadow: none;
            }

            .modal {
                display: none !important;
            }
        }
    </style>
    <!-- Add PDF-lib for PDF generation -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>📋 Score Sheets Generator & Manager</h1>

        <div class="controls">
            <div class="control-group">
                <label for="trialSelect">Select Trial:</label>
                <select id="trialSelect">
                    <option value="">Loading trials...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="dateSelect">Select Date:</label>
                <select id="dateSelect">
                    <option value="">Select trial first...</option>
                </select>
            </div>
            <div class="control-group">
                <label for="judgeSelect">Select Judge (Optional):</label>
                <select id="judgeSelect">
                    <option value="">All Judges</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            <button class="btn" onclick="loadTrialData()" id="loadBtn">Load Trial Data</button>
            <button class="btn btn-success" onclick="generateAllScoreSheets()" id="generateBtn" style="display: none;">Generate Score Sheets</button>
            <button class="btn btn-warning" onclick="printScoreSheets()" id="printBtn" style="display: none;">Print Selected Sheets</button>
            <button class="btn btn-secondary" onclick="viewStoredSheets()" id="storedBtn">View Stored Sheets</button>
            <button class="btn btn-secondary" onclick="location.href='main-dashboard.html'">← Back to Dashboard</button>
        </div>

        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div>Loading trial data...</div>
        </div>

        <div id="stats" class="stats" style="display: none;"></div>

        <div id="scoreSheetsSection" class="score-sheets-list" style="display: none;">
            <h3>📄 Generated Score Sheets</h3>
            <div id="scoreSheetsList"></div>
        </div>

        <!-- Score Sheets Print Container -->
        <div id="scoreSheetsContainer" style="display: none;"></div>
    </div>

    <!-- Score Entry Modal -->
    <div id="scoreEntryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ Edit Score Sheet</h2>
                <span class="close" onclick="closeScoreModal()">&times;</span>
            </div>
            
            <div id="scoreEntryForm" class="score-entry-form">
                <!-- Scent Locations Section -->
                <div>
                    <h3>🎯 Scent Locations</h3>
                    <div class="scent-locations">
                        <div class="scent-location-group">
                            <label for="scent1Location">Scent 1 Located in/on:</label>
                            <input type="text" id="scent1Location" placeholder="Enter location...">
                        </div>
                        <div class="scent-location-group">
                            <label for="scent2Location">Scent 2 Located in/on:</label>
                            <input type="text" id="scent2Location" placeholder="Enter location...">
                        </div>
                        <div class="scent-location-group">
                            <label for="scent3Location">Scent 3 Located in/on:</label>
                            <input type="text" id="scent3Location" placeholder="Enter location...">
                        </div>
                        <div class="scent-location-group">
                            <label for="scent4Location">Scent 4 Located in/on:</label>
                            <input type="text" id="scent4Location" placeholder="Enter location...">
                        </div>
                    </div>
                </div>

                <!-- Entrants Scoring Section -->
                <div>
                    <h3>📊 Team Scoring</h3>
                    <div id="entrantsScoring" class="entrants-scoring">
                        <!-- Dynamic entrant rows will be inserted here -->
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeScoreModal()">Cancel</button>
                    <div>
                        <button class="btn btn-warning" onclick="saveScores()">💾 Save Scores</button>
                        <button class="btn btn-success" onclick="generateFilledPDF()">📄 Download Filled PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { auth, db } from './js/firebase.js';
        import { collection, query, where, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

        // Global variables
        let trials = [];
        let currentTrial = null;
        let entries = [];
        let runningOrderData = {};
        let generatedSheets = [];
        let currentEditingSheet = null;
        let currentScoreData = {};

        // Initialize the application
        async function init() {
            try {
                await loadTrials();
            } catch (error) {
                console.error('Error initializing:', error);
                showError('Error loading trials: ' + error.message);
            }
        }

        // Load available trials
        async function loadTrials() {
            try {
                if (!auth.currentUser) {
                    showError('Please log in to access trials');
                    return;
                }

                const q = query(
                    collection(db, "trials"),
                    where("createdBy", "==", auth.currentUser.uid)
                );
                
                const snapshot = await getDocs(q);
                trials = [];
                
                snapshot.forEach(doc => {
                    trials.push({ id: doc.id, ...doc.data() });
                });

                // Sort by creation date (most recent first)
                trials.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                populateTrialSelector();
            } catch (error) {
                console.error('Error loading trials:', error);
                showError('Error loading trials: ' + error.message);
            }
        }

        // Populate trial selector dropdown
        function populateTrialSelector() {
            const trialSelect = document.getElementById('trialSelect');
            trialSelect.innerHTML = '<option value="">Select a trial...</option>';

            trials.forEach(trial => {
                const option = document.createElement('option');
                option.value = trial.id;
                
                let trialLabel = trial.clubName || 'Unnamed Trial';
                
                if (trial.days && trial.days.length > 0) {
                    const dates = trial.days
                        .filter(day => day.date)
                        .map(day => new Date(day.date).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric' 
                        }))
                        .join(', ');
                    if (dates) {
                        trialLabel += ` (${dates})`;
                    }
                }
                
                option.textContent = trialLabel;
                trialSelect.appendChild(option);
            });

            // Handle trial selection change
            trialSelect.addEventListener('change', function() {
                const trialId = this.value;
                if (trialId) {
                    currentTrial = trials.find(t => t.id === trialId);
                    populateDateSelector();
                    populateJudgeSelector();
                } else {
                    currentTrial = null;
                    document.getElementById('dateSelect').innerHTML = '<option value="">Select trial first...</option>';
                    document.getElementById('judgeSelect').innerHTML = '<option value="">All Judges</option>';
                }
            });
        }

        // Populate date selector based on selected trial
        function populateDateSelector() {
            const dateSelect = document.getElementById('dateSelect');
            dateSelect.innerHTML = '<option value="">Select a date...</option>';

            if (currentTrial && currentTrial.days) {
                currentTrial.days.forEach(day => {
                    if (day.date) {
                        const option = document.createElement('option');
                        option.value = day.date;
                        option.textContent = new Date(day.date).toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        dateSelect.appendChild(option);
                    }
                });
            }
        }

        // Populate judge selector based on selected trial
        function populateJudgeSelector() {
            const judgeSelect = document.getElementById('judgeSelect');
            judgeSelect.innerHTML = '<option value="">All Judges</option>';

            if (currentTrial && currentTrial.days) {
                const judges = new Set();
                currentTrial.days.forEach(day => {
                    if (day.classes) {
                        day.classes.forEach(cls => {
                            if (cls.rounds) {
                                cls.rounds.forEach(round => {
                                    if (round.judge && round.judge.trim()) {
                                        judges.add(round.judge.trim());
                                    }
                                });
                            }
                        });
                    }
                });

                Array.from(judges).sort().forEach(judge => {
                    const option = document.createElement('option');
                    option.value = judge;
                    option.textContent = judge;
                    judgeSelect.appendChild(option);
                });
            }
        }

        // Load trial data and entries
        async function loadTrialData() {
            const trialId = document.getElementById('trialSelect').value;
            const selectedDate = document.getElementById('dateSelect').value;

            if (!trialId) {
                alert('Please select a trial');
                return;
            }

            if (!selectedDate) {
                alert('Please select a date');
                return;
            }

            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('loadBtn').disabled = true;

            try {
                // Load entries for this trial
                const q = query(
                    collection(db, "entries"),
                    where("trialId", "==", trialId)
                );
                
                const snapshot = await getDocs(q);
                entries = [];
                
                snapshot.forEach(doc => {
                    const entryData = doc.data();
                    if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
                        entryData.selectedEntries.forEach(selectedEntry => {
                            entries.push({
                                id: doc.id,
                                ...selectedEntry,
                                handlerName: entryData.handlerName,
                                dogCallName: entryData.dogCallName,
                                cwagsNumber: entryData.cwagsNumber,
                                submittedAt: entryData.submittedAt
                            });
                        });
                    }
                });

                // Filter entries for selected date
                entries = entries.filter(entry => entry.date === selectedDate);

                console.log('Loaded entries for date:', selectedDate, entries);

                if (entries.length === 0) {
                    showError('No entries found for the selected date');
                    return;
                }

                // Group entries and load any existing running order
                await loadRunningOrder();
                
                // Generate statistics
                generateStats();

                // Show controls
                document.getElementById('generateBtn').style.display = 'inline-block';
                document.getElementById('printBtn').style.display = 'inline-block';

            } catch (error) {
                console.error('Error loading trial data:', error);
                showError('Error loading trial data: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('loadBtn').disabled = false;
            }
        }

        // Load existing running order or create default grouping
        async function loadRunningOrder() {
            const selectedDate = document.getElementById('dateSelect').value;
            
            try {
                // Try to load confirmed running order first
                const q = query(
                    collection(db, "runningOrders"),
                    where("trialId", "==", currentTrial.id),
                    where("date", "==", selectedDate)
                );
                
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    // Use confirmed running order
                    snapshot.forEach(doc => {
                        const orderData = doc.data();
                        runningOrderData[selectedDate] = orderData.runningOrder;
                    });
                    console.log('Loaded confirmed running order');
                } else {
                    // Create default grouping from entries
                    runningOrderData = {};
                    runningOrderData[selectedDate] = {};
                    
                    entries.forEach(entry => {
                        const judge = entry.judge || 'Judge TBD';
                        const classRound = `${entry.className || 'Unknown Class'} - Round ${entry.roundNumber || 1}`;

                        if (!runningOrderData[selectedDate][judge]) {
                            runningOrderData[selectedDate][judge] = {};
                        }
                        if (!runningOrderData[selectedDate][judge][classRound]) {
                            runningOrderData[selectedDate][judge][classRound] = [];
                        }

                        const entrantName = `${entry.handlerName || 'Unknown Handler'} - ${entry.dogCallName || 'Unknown Dog'}`;
                        runningOrderData[selectedDate][judge][classRound].push({
                            id: `${entry.id || 'unknown'}_${Date.now()}_${Math.random()}`,
                            name: entrantName,
                            entryType: entry.entryType || 'regular',
                            handler: entry.handlerName || 'Unknown Handler',
                            dog: entry.dogCallName || 'Unknown Dog',
                            cwagsNumber: entry.cwagsNumber || '',
                            originalEntry: entry
                        });
                    });
                    
                    console.log('Created default running order grouping');
                }
            } catch (error) {
                console.error('Error loading running order:', error);
                // Fallback to default grouping
            }
        }

        // Generate all score sheets
        async function generateAllScoreSheets() {
            const selectedDate = document.getElementById('dateSelect').value;
            const selectedJudge = document.getElementById('judgeSelect').value;

            if (!runningOrderData[selectedDate]) {
                alert('No data available for the selected date');
                return;
            }

            generatedSheets = [];
            const judgeData = runningOrderData[selectedDate];

            // Filter by judge if selected
            const judgesToProcess = selectedJudge ? 
                { [selectedJudge]: judgeData[selectedJudge] } : 
                judgeData;

            Object.keys(judgesToProcess).forEach(judge => {
                Object.keys(judgesToProcess[judge]).forEach(classRound => {
                    const entrants = judgesToProcess[judge][classRound];
                    
                    const sheetData = {
                        id: `${currentTrial.id}_${selectedDate}_${judge}_${classRound}`.replace(/[^a-zA-Z0-9]/g, '_'),
                        trialId: currentTrial.id,
                        trialName: currentTrial.clubName || 'Unnamed Trial',
                        date: selectedDate,
                        judge: judge,
                        classRound: classRound,
                        className: classRound.split(' - Round')[0],
                        roundNumber: classRound.split('Round ')[1] || '1',
                        entrants: entrants,
                        status: 'generated',
                        createdAt: new Date(),
                        createdBy: auth.currentUser.uid
                    };

                    generatedSheets.push(sheetData);
                });
            });

            // Save to database
            await saveScoreSheetsToDatabase();

            // Display generated sheets
            displayGeneratedSheets();

            alert(`Generated ${generatedSheets.length} score sheets!`);
        }

        // Save score sheets to database
        async function saveScoreSheetsToDatabase() {
            try {
                for (const sheet of generatedSheets) {
                    await setDoc(doc(db, 'scoreSheets', sheet.id), sheet);
                }
                console.log('Score sheets saved to database');
            } catch (error) {
                console.error('Error saving score sheets:', error);
                alert('Error saving score sheets: ' + error.message);
            }
        }

        // Display generated sheets list
        function displayGeneratedSheets() {
            const section = document.getElementById('scoreSheetsSection');
            const list = document.getElementById('scoreSheetsList');
            
            let html = '';
            
            generatedSheets.forEach(sheet => {
                html += `
                    <div class="score-sheet-item">
                        <div class="score-sheet-info">
                            <div class="score-sheet-title">${sheet.judge} - ${sheet.classRound}</div>
                            <div class="score-sheet-details">
                                ${sheet.entrants.length} entrants • ${sheet.date}
                                <span class="status-badge status-${sheet.status}">${sheet.status.toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="score-sheet-actions">
                            <button class="btn btn-secondary" onclick="previewSheet('${sheet.id}')">Preview</button>
                            <button class="btn btn-success" onclick="printSingleSheet('${sheet.id}')">Print</button>
                            <button class="btn btn-warning" onclick="markCompleted('${sheet.id}')">Mark Complete</button>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            section.style.display = 'block';
        }

        // Print score sheets
        function printScoreSheets() {
            if (generatedSheets.length === 0) {
                alert('No score sheets generated. Please generate sheets first.');
                return;
            }

            const container = document.getElementById('scoreSheetsContainer');
            let html = '';

            generatedSheets.forEach(sheet => {
                html += generateScoreSheetHTML(sheet);
            });

            container.innerHTML = html;
            
            // Print
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Generate score sheet HTML with dynamic sizing
        function generateScoreSheetHTML(sheetData) {
            const entrantCount = sheetData.entrants.length;
            
            // Calculate optimal font sizes and spacing based on entrant count
            let scoringTableFontSize = '9px';
            let cellPadding = '4px';
            let rowHeight = '40px';
            
            if (entrantCount > 12) {
                scoringTableFontSize = '7px';
                cellPadding = '2px';
                rowHeight = '30px';
            } else if (entrantCount > 8) {
                scoringTableFontSize = '8px';
                cellPadding = '3px';
                rowHeight = '35px';
            }

            let html = `
                <div class="score-sheet">
                    <div class="score-sheet-header">
                        <div style="text-align: right; font-size: 8px;">Copyright © by Canine-Work And Games, LLC, 2024</div>
                        <div class="cwags-logo">
                            <img src="./images/cwags-logo.png" alt="C-WAGS Logo" />
                        </div>
                        <div class="score-sheet-title-text">${sheetData.className} Score Sheet</div>
                        <div class="score-sheet-date">Date: ${sheetData.date}</div>
                        <div class="score-sheet-class">CLASS: ${sheetData.className}</div>
                        <div class="score-sheet-class">JUDGE: ${sheetData.judge}</div>
                        
                        <div class="score-sheet-rounds">
                            <label>Round</label>
                            <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '1' ? 'checked' : ''}> 1
                            <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '2' ? 'checked' : ''}> 2
                            <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '3' ? 'checked' : ''}> 3
                            <input type="checkbox" class="round-checkbox" ${sheetData.roundNumber === '4' ? 'checked' : ''}> 4
                        </div>
                    </div>

                    <table class="scent-info-table">
                        <tr>
                            <th>Scent 1</th>
                            <th>Scent 2</th>
                            <th>Scent 3</th>
                            <th>Scent 4</th>
                        </tr>
                        <tr>
                            <td>Located in/on:</td>
                            <td>Located in/on:</td>
                            <td>Located in/on:</td>
                            <td>Located in/on:</td>
                        </tr>
                        <tr>
                            <td style="height: 30px;"></td>
                            <td style="height: 30px;"></td>
                            <td style="height: 30px;"></td>
                            <td style="height: 30px;"></td>
                        </tr>
                    </table>

                    <div class="faults-section">
                        <strong>Faults:</strong> Dropped Food; Dog stops working; Handler guiding dog; Incorrect find; Destructive behavior; 
                        Disturbing search area by dog or handler; Verbally naming item; Continue search after "alert"; 
                        SR crossing line less than half.
                    </div>

                    <table class="scoring-table" style="font-size: ${scoringTableFontSize};">
                        <thead>
                            <tr>
                                <th rowspan="2">Team</th>
                                <th rowspan="2">Dog - Handler</th>
                                <th colspan="4">Scent Results</th>
                                <th rowspan="2">Fault</th>
                                <th rowspan="2">Fault</th>
                                <th rowspan="2">Time</th>
                                <th rowspan="2">Pass/Fail</th>
                            </tr>
                            <tr>
                                <th>Scent 1</th>
                                <th>Scent 2</th>
                                <th>Scent 3</th>
                                <th>Scent 4</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Add entrant rows - use actual count or minimum 8, whichever is larger
            const minRows = Math.max(8, entrantCount);
            for (let i = 0; i < minRows; i++) {
                const entrant = sheetData.entrants[i];
                const teamName = entrant ? `${entrant.handler} - ${entrant.dog}` : '';
                
                html += `
                    <tr>
                        <td class="team-name-cell" style="padding: ${cellPadding};">${i + 1}</td>
                        <td class="team-name-cell" style="padding: ${cellPadding};">${teamName}</td>
                        <td class="scent-cell" style="padding: ${cellPadding};">
                            <div>Scent 1</div>
                            <div style="height: 12px;"></div>
                        </td>
                        <td class="scent-cell" style="padding: ${cellPadding};">
                            <div>Scent 2</div>
                            <div style="height: 12px;"></div>
                        </td>
                        <td class="scent-cell" style="padding: ${cellPadding};">
                            <div>Scent 3</div>
                            <div style="height: 12px;"></div>
                        </td>
                        <td class="scent-cell" style="padding: ${cellPadding};">
                            <div>Scent 4</div>
                            <div style="height: 12px;"></div>
                        </td>
                        <td style="height: ${rowHeight}; padding: ${cellPadding};"></td>
                        <td style="height: ${rowHeight}; padding: ${cellPadding};"></td>
                        <td style="height: ${rowHeight}; padding: ${cellPadding};"></td>
                        <td style="height: ${rowHeight}; padding: ${cellPadding};"></td>
                    </tr>
                `;
            }

            html += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; text-align: center; font-size: 8px;">
                        Copyright © by Canine-Work And Games, LLC, 2024
                    </div>
                </div>
            `;

            return html;
        }

        // Generate statistics
        function generateStats() {
            const totalEntries = entries.length;
            const uniqueHandlers = new Set(entries.map(e => e.handlerName)).size;
            const uniqueDogs = new Set(entries.map(e => e.dogCallName)).size;
            const regularEntries = entries.filter(e => e.entryType === 'regular').length;
            const feoEntries = entries.filter(e => e.entryType === 'feo').length;

            const statsContainer = document.getElementById('stats');
            statsContainer.style.display = 'grid';
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${totalEntries}</span>
                    <span class="stat-label">Total Entries</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${uniqueHandlers}</span>
                    <span class="stat-label">Handlers</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${uniqueDogs}</span>
                    <span class="stat-label">Dogs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${regularEntries}</span>
                    <span class="stat-label">Regular</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${feoEntries}</span>
                    <span class="stat-label">FEO</span>
                </div>
            `;
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('scoreSheetsSection');
            container.innerHTML = `
                <div class="no-data">
                    ❌ ${message}
                </div>
            `;
            container.style.display = 'block';
            document.getElementById('stats').style.display = 'none';
        }

        // Preview single sheet
        window.previewSheet = function(sheetId) {
            const sheet = generatedSheets.find(s => s.id === sheetId);
            if (!sheet) return;

            const container = document.getElementById('scoreSheetsContainer');
            container.innerHTML = generateScoreSheetHTML(sheet);
            container.style.display = 'block';
            
            // Scroll to preview
            container.scrollIntoView({ behavior: 'smooth' });
        };

        // Print single sheet
        window.printSingleSheet = function(sheetId) {
            const sheet = generatedSheets.find(s => s.id === sheetId);
            if (!sheet) return;

            const container = document.getElementById('scoreSheetsContainer');
            container.innerHTML = generateScoreSheetHTML(sheet);
            
            setTimeout(() => {
                window.print();
            }, 100);
        };

        // Mark sheet as completed
        window.markCompleted = async function(sheetId) {
            try {
                const sheet = generatedSheets.find(s => s.id === sheetId);
                if (!sheet) return;

                // Update status in memory
                sheet.status = 'completed';
                sheet.completedAt = new Date();

                // Update in database
                await updateDoc(doc(db, 'scoreSheets', sheetId), {
                    status: 'completed',
                    completedAt: new Date()
                });

                // Refresh display
                displayGeneratedSheets();
                
                alert('Score sheet marked as completed!');
            } catch (error) {
                console.error('Error updating sheet status:', error);
                alert('Error updating sheet status: ' + error.message);
            }
        };

        // View stored sheets
        window.viewStoredSheets = async function() {
            try {
                if (!auth.currentUser) {
                    alert('Please log in first');
                    return;
                }

                document.getElementById('loadingIndicator').style.display = 'block';

                // Load all stored score sheets for this user
                const q = query(
                    collection(db, "scoreSheets"),
                    where("createdBy", "==", auth.currentUser.uid)
                );
                
                const snapshot = await getDocs(q);
                const storedSheets = [];
                
                snapshot.forEach(doc => {
                    storedSheets.push({ id: doc.id, ...doc.data() });
                });

                // Sort by creation date (most recent first)
                storedSheets.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                // Display stored sheets
                displayStoredSheets(storedSheets);

            } catch (error) {
                console.error('Error loading stored sheets:', error);
                showError('Error loading stored sheets: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        };

        // Display stored sheets
        function displayStoredSheets(sheets) {
            const section = document.getElementById('scoreSheetsSection');
            const list = document.getElementById('scoreSheetsList');
            
            let html = '';
            
            if (sheets.length === 0) {
                html = '<div class="no-data">No stored score sheets found.</div>';
            } else {
                sheets.forEach(sheet => {
                    const createdDate = sheet.createdAt ? sheet.createdAt.toDate().toLocaleDateString() : 'Unknown';
                    const hasScores = sheet.scoreData && Object.keys(sheet.scoreData).length > 0;
                    const statusClass = hasScores ? 'status-completed' : sheet.status;
                    const statusText = hasScores ? 'SCORED' : sheet.status.toUpperCase();
                    
                    html += `
                        <div class="score-sheet-item">
                            <div class="score-sheet-info">
                                <div class="score-sheet-title">${sheet.trialName} - ${sheet.judge} - ${sheet.classRound}</div>
                                <div class="score-sheet-details">
                                    ${sheet.entrants.length} entrants • ${sheet.date} • Created: ${createdDate}
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div class="score-sheet-actions">
                                <button class="btn btn-secondary" onclick="previewStoredSheet('${sheet.id}')">Preview</button>
                                <button class="btn btn-success" onclick="printStoredSheet('${sheet.id}')">Print</button>
                                <button class="btn btn-warning" onclick="editScores('${sheet.id}')">✏️ Edit Scores</button>
                                <button class="btn btn-danger" onclick="deleteSheet('${sheet.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            list.innerHTML = html;
            section.style.display = 'block';
        }

        // Preview stored sheet
        window.previewStoredSheet = async function(sheetId) {
            try {
                const sheetDoc = await getDoc(doc(db, 'scoreSheets', sheetId));
                if (!sheetDoc.exists()) {
                    alert('Score sheet not found');
                    return;
                }

                const sheet = { id: sheetDoc.id, ...sheetDoc.data() };
                const container = document.getElementById('scoreSheetsContainer');
                container.innerHTML = generateScoreSheetHTML(sheet);
                container.style.display = 'block';
                
                // Scroll to preview
                container.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading sheet:', error);
                alert('Error loading sheet: ' + error.message);
            }
        };

        // Print stored sheet
        window.printStoredSheet = async function(sheetId) {
            try {
                const sheetDoc = await getDoc(doc(db, 'scoreSheets', sheetId));
                if (!sheetDoc.exists()) {
                    alert('Score sheet not found');
                    return;
                }

                const sheet = { id: sheetDoc.id, ...sheetDoc.data() };
                const container = document.getElementById('scoreSheetsContainer');
                container.innerHTML = generateScoreSheetHTML(sheet);
                
                setTimeout(() => {
                    window.print();
                }, 100);
            } catch (error) {
                console.error('Error printing sheet:', error);
                alert('Error printing sheet: ' + error.message);
            }
        };

        // Edit scores - Open the scoring modal
        window.editScores = async function(sheetId) {
            try {
                const sheetDoc = await getDoc(doc(db, 'scoreSheets', sheetId));
                if (!sheetDoc.exists()) {
                    alert('Score sheet not found');
                    return;
                }

                currentEditingSheet = { id: sheetDoc.id, ...sheetDoc.data() };
                
                // Load existing score data if available
                currentScoreData = currentEditingSheet.scoreData || {};
                
                // Populate the scoring form
                populateScoringForm();
                
                // Show the modal
                document.getElementById('scoreEntryModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading sheet for editing:', error);
                alert('Error loading sheet: ' + error.message);
            }
        };

        // Populate the scoring form with sheet data
        function populateScoringForm() {
            if (!currentEditingSheet) return;

            // Set scent locations
            document.getElementById('scent1Location').value = currentScoreData.scent1Location || '';
            document.getElementById('scent2Location').value = currentScoreData.scent2Location || '';
            document.getElementById('scent3Location').value = currentScoreData.scent3Location || '';
            document.getElementById('scent4Location').value = currentScoreData.scent4Location || '';

            // Generate entrant scoring rows
            const entrantsContainer = document.getElementById('entrantsScoring');
            let html = '';

            currentEditingSheet.entrants.forEach((entrant, index) => {
                const entrantKey = `entrant_${index}`;
                const entrantScores = currentScoreData[entrantKey] || {};
                
                html += `
                    <div class="entrant-row">
                        <div class="entrant-header">
                            ${index + 1}. ${entrant.handler} - ${entrant.dog}
                        </div>
                        <div class="entrant-scoring-grid">
                            <!-- Scent 1 -->
                            <div class="scent-result-group">
                                <label>Scent 1</label>
                                <div class="scent-checkboxes">
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="${entrantKey}_scent1_found" ${entrantScores.scent1Found ? 'checked' : ''}>
                                        <span>✓</span>
                                    </div>
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="${entrantKey}_scent1_not_found" ${entrantScores.scent1NotFound ? 'checked' : ''}>
                                        <span>✗</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scent 2 -->
                            <div class="scent-result-group">
                                <label>Scent 2</label>
                                <div class="scent-checkboxes">
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="${entrantKey}_scent2_found" ${entrantScores.scent2Found ? 'checked' : ''}>
                                        <span>✓</span>
                                    </div>
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="${entrantKey}_scent2_not_found" ${entrantScores.scent2NotFound ? 'checked' : ''}>
                                        <span>✗</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scent 3 -->
                            <div class="scent-result-group">
                                <label>Scent 3</label>
                                <div class="scent-checkboxes">
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="${entrantKey}_scent3_found" ${entrantScores.scent3Found ? 'checked' : ''}>
                                        <span>✓</span>
                                    </div>
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="${entrantKey}_scent3_not_found" ${entrantScores.scent3NotFound ? 'checked' : ''}>
                                        <span>✗</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scent 4 -->
                            <div class="scent-result-group">
                                <label>Scent 4</label>
                                <div class="scent-checkboxes">
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="${entrantKey}_scent4_found" ${entrantScores.scent4Found ? 'checked' : ''}>
                                        <span>✓</span>
                                    </div>
                                    <div class="checkbox-option">
                                        <input type="checkbox" id="${entrantKey}_scent4_not_found" ${entrantScores.scent4NotFound ? 'checked' : ''}>
                                        <span>✗</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Faults -->
                            <div>
                                <label>Faults</label>
                                <input type="text" class="fault-input" id="${entrantKey}_faults" 
                                       value="${entrantScores.faults || ''}" placeholder="Enter faults...">
                            </div>
                            
                            <!-- Time -->
                            <div>
                                <label>Time</label>
                                <input type="text" class="time-input" id="${entrantKey}_time" 
                                       value="${entrantScores.time || ''}" placeholder="MM:SS">
                            </div>
                            
                            <!-- Pass/Fail -->
                            <div class="pass-fail-group">
                                <div class="pass-fail-option">
                                    <input type="radio" name="${entrantKey}_result" id="${entrantKey}_pass" 
                                           value="pass" ${entrantScores.result === 'pass' ? 'checked' : ''}>
                                    <label for="${entrantKey}_pass">Pass</label>
                                </div>
                                <div class="pass-fail-option">
                                    <input type="radio" name="${entrantKey}_result" id="${entrantKey}_fail" 
                                           value="fail" ${entrantScores.result === 'fail' ? 'checked' : ''}>
                                    <label for="${entrantKey}_fail">Fail</label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            entrantsContainer.innerHTML = html;

            // Add event listeners for mutual exclusivity of checkboxes
            currentEditingSheet.entrants.forEach((entrant, index) => {
                const entrantKey = `entrant_${index}`;
                
                // For each scent, make found/not found mutually exclusive
                for (let scent = 1; scent <= 4; scent++) {
                    const foundCheckbox = document.getElementById(`${entrantKey}_scent${scent}_found`);
                    const notFoundCheckbox = document.getElementById(`${entrantKey}_scent${scent}_not_found`);
                    
                    if (foundCheckbox && notFoundCheckbox) {
                        foundCheckbox.addEventListener('change', function() {
                            if (this.checked) {
                                notFoundCheckbox.checked = false;
                            }
                        });
                        
                        notFoundCheckbox.addEventListener('change', function() {
                            if (this.checked) {
                                foundCheckbox.checked = false;
                            }
                        });
                    }
                }
            });
        }

        // Close score modal
        window.closeScoreModal = function() {
            document.getElementById('scoreEntryModal').style.display = 'none';
            currentEditingSheet = null;
            currentScoreData = {};
        };

        // Save scores to database
        window.saveScores = async function() {
            if (!currentEditingSheet) {
                alert('No sheet selected for editing');
                return;
            }

            try {
                // Collect all score data
                const scoreData = {
                    scent1Location: document.getElementById('scent1Location').value,
                    scent2Location: document.getElementById('scent2Location').value,
                    scent3Location: document.getElementById('scent3Location').value,
                    scent4Location: document.getElementById('scent4Location').value
                };

                // Collect entrant scores
                currentEditingSheet.entrants.forEach((entrant, index) => {
                    const entrantKey = `entrant_${index}`;
                    
                    scoreData[entrantKey] = {
                        handler: entrant.handler,
                        dog: entrant.dog,
                        scent1Found: document.getElementById(`${entrantKey}_scent1_found`)?.checked || false,
                        scent1NotFound: document.getElementById(`${entrantKey}_scent1_not_found`)?.checked || false,
                        scent2Found: document.getElementById(`${entrantKey}_scent2_found`)?.checked || false,
                        scent2NotFound: document.getElementById(`${entrantKey}_scent2_not_found`)?.checked || false,
                        scent3Found: document.getElementById(`${entrantKey}_scent3_found`)?.checked || false,
                        scent3NotFound: document.getElementById(`${entrantKey}_scent3_not_found`)?.checked || false,
                        scent4Found: document.getElementById(`${entrantKey}_scent4_found`)?.checked || false,
                        scent4NotFound: document.getElementById(`${entrantKey}_scent4_not_found`)?.checked || false,
                        faults: document.getElementById(`${entrantKey}_faults`)?.value || '',
                        time: document.getElementById(`${entrantKey}_time`)?.value || '',
                        result: document.querySelector(`input[name="${entrantKey}_result"]:checked`)?.value || ''
                    };
                });

                // Update the sheet in Firebase
                await updateDoc(doc(db, 'scoreSheets', currentEditingSheet.id), {
                    scoreData: scoreData,
                    status: 'scored',
                    scoredAt: new Date(),
                    lastModified: new Date()
                });

                alert('Scores saved successfully!');
                closeScoreModal();
                
                // Refresh the stored sheets view
                viewStoredSheets();

            } catch (error) {
                console.error('Error saving scores:', error);
                alert('Error saving scores: ' + error.message);
            }
        };

        // Generate filled PDF that matches the printed score sheet exactly
        window.generateFilledPDF = async function() {
            if (!currentEditingSheet) {
                alert('No sheet selected');
                return;
            }

            try {
                // Create a new PDF document (8.5 x 11 inches)
                const pdfDoc = await PDFLib.PDFDocument.create();
                const page = pdfDoc.addPage([612, 792]);
                
                // Get fonts
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const boldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

                const { width, height } = page.getSize();
                let yPos = height - 40;

                // Draw border around entire page
                page.drawRectangle({
                    x: 30,
                    y: 30,
                    width: width - 60,
                    height: height - 60,
                    borderColor: PDFLib.rgb(0, 0, 0),
                    borderWidth: 1,
                });

                // Header section
                // Copyright notice (top right)
                page.drawText('Copyright © by Canine-Work And Games, LLC, 2024', {
                    x: width - 280,
                    y: yPos,
                    size: 8,
                    font: font,
                });
                yPos -= 25;

                // Title
                page.drawText(`${currentEditingSheet.className} Score Sheet`, {
                    x: width / 2 - 100,
                    y: yPos,
                    size: 16,
                    font: boldFont,
                });
                yPos -= 25;

                // Date
                page.drawText(`Date: ${currentEditingSheet.date}`, {
                    x: width / 2 - 80,
                    y: yPos,
                    size: 12,
                    font: font,
                });
                yPos -= 20;

                // Class
                page.drawText(`CLASS: ${currentEditingSheet.className}`, {
                    x: width / 2 - 60,
                    y: yPos,
                    size: 14,
                    font: boldFont,
                });
                yPos -= 20;

                // Judge
                page.drawText(`JUDGE: ${currentEditingSheet.judge}`, {
                    x: width / 2 - 60,
                    y: yPos,
                    size: 14,
                    font: boldFont,
                });
                yPos -= 30;

                // Round checkboxes
                page.drawText('Round', {
                    x: 50,
                    y: yPos,
                    size: 10,
                    font: boldFont,
                });

                const rounds = ['1', '2', '3', '4'];
                let roundX = 100;
                rounds.forEach((round, index) => {
                    // Draw checkbox
                    page.drawRectangle({
                        x: roundX,
                        y: yPos - 3,
                        width: 12,
                        height: 12,
                        borderColor: PDFLib.rgb(0, 0, 0),
                        borderWidth: 1,
                    });
                    
                    // Check the appropriate round
                    if (round === currentEditingSheet.roundNumber) {
                        page.drawText('X', {
                            x: roundX + 3,
                            y: yPos - 1,
                            size: 9,
                            font: boldFont,
                        });
                    }
                    
                    page.drawText(round, {
                        x: roundX + 20,
                        y: yPos,
                        size: 10,
                        font: font,
                    });
                    roundX += 60;
                });
                yPos -= 35;

                // Scent information table
                const scentTableY = yPos;
                const scentTableHeight = 60;
                const colWidth = (width - 100) / 4;

                // Draw scent table border
                page.drawRectangle({
                    x: 50,
                    y: scentTableY - scentTableHeight,
                    width: width - 100,
                    height: scentTableHeight,
                    borderColor: PDFLib.rgb(0, 0, 0),
                    borderWidth: 1,
                });

                // Scent table headers
                const scentHeaders = ['Scent 1', 'Scent 2', 'Scent 3', 'Scent 4'];
                scentHeaders.forEach((header, index) => {
                    const x = 50 + (index * colWidth);
                    
                    // Draw column separator
                    if (index > 0) {
                        page.drawLine({
                            start: { x: x, y: scentTableY },
                            end: { x: x, y: scentTableY - scentTableHeight },
                            thickness: 1,
                            color: PDFLib.rgb(0, 0, 0),
                        });
                    }
                    
                    // Header background
                    page.drawRectangle({
                        x: x,
                        y: scentTableY - 20,
                        width: colWidth,
                        height: 20,
                        color: PDFLib.rgb(0.94, 0.94, 0.94),
                    });
                    
                    page.drawText(header, {
                        x: x + colWidth/2 - 20,
                        y: scentTableY - 15,
                        size: 10,
                        font: boldFont,
                    });
                });

                // "Located in/on:" row
                page.drawLine({
                    start: { x: 50, y: scentTableY - 20 },
                    end: { x: width - 50, y: scentTableY - 20 },
                    thickness: 1,
                    color: PDFLib.rgb(0, 0, 0),
                });

                scentHeaders.forEach((header, index) => {
                    const x = 50 + (index * colWidth);
                    page.drawText('Located in/on:', {
                        x: x + 5,
                        y: scentTableY - 35,
                        size: 9,
                        font: font,
                    });
                });

                // Fill in scent locations
                const scentLocations = [
                    document.getElementById('scent1Location').value,
                    document.getElementById('scent2Location').value,
                    document.getElementById('scent3Location').value,
                    document.getElementById('scent4Location').value
                ];

                page.drawLine({
                    start: { x: 50, y: scentTableY - 40 },
                    end: { x: width - 50, y: scentTableY - 40 },
                    thickness: 1,
                    color: PDFLib.rgb(0, 0, 0),
                });

                scentLocations.forEach((location, index) => {
                    const x = 50 + (index * colWidth);
                    const text = location || '';
                    page.drawText(text.length > 12 ? text.substring(0, 12) + '...' : text, {
                        x: x + 5,
                        y: scentTableY - 55,
                        size: 8,
                        font: font,
                    });
                });

                yPos = scentTableY - scentTableHeight - 20;

                // Faults section
                page.drawText('Faults: Dropped Food; Dog stops working; Handler guiding dog; Incorrect find; Destructive behavior;', {
                    x: 50,
                    y: yPos,
                    size: 9,
                    font: boldFont,
                });
                yPos -= 12;
                page.drawText('Disturbing search area by dog or handler; Verbally naming item; Continue search after "alert";', {
                    x: 50,
                    y: yPos,
                    size: 9,
                    font: boldFont,
                });
                yPos -= 12;
                page.drawText('SR crossing line less than half.', {
                    x: 50,
                    y: yPos,
                    size: 9,
                    font: boldFont,
                });
                yPos -= 25;

                // Main scoring table
                const tableStartY = yPos;
                const tableWidth = width - 100;
                const teamColWidth = 40;
                const nameColWidth = 140;
                const scentColWidth = 45;
                const faultColWidth = 60;
                const timeColWidth = 50;
                const resultColWidth = 50;

                // Table header
                const headers = ['Team', 'Dog - Handler', 'Scent Results', '', '', '', 'Fault', 'Fault', 'Time', 'Pass/Fail'];
                const subHeaders = ['', '', 'Scent 1', 'Scent 2', 'Scent 3', 'Scent 4', '', '', '', ''];
                const columnWidths = [teamColWidth, nameColWidth, scentColWidth, scentColWidth, scentColWidth, scentColWidth, faultColWidth/2, faultColWidth/2, timeColWidth, resultColWidth];

                // Draw main table border
                const rowHeight = 25;
                const headerHeight = 40;
                const totalRows = Math.max(8, currentEditingSheet.entrants.length);
                const tableHeight = headerHeight + (totalRows * rowHeight);

                page.drawRectangle({
                    x: 50,
                    y: tableStartY - tableHeight,
                    width: tableWidth,
                    height: tableHeight,
                    borderColor: PDFLib.rgb(0, 0, 0),
                    borderWidth: 1,
                });

                // Draw header background
                page.drawRectangle({
                    x: 50,
                    y: tableStartY - headerHeight,
                    width: tableWidth,
                    height: headerHeight,
                    color: PDFLib.rgb(0.94, 0.94, 0.94),
                });

                // Draw column separators and headers
                let currentX = 50;
                headers.forEach((header, index) => {
                    if (index > 0) {
                        page.drawLine({
                            start: { x: currentX, y: tableStartY },
                            end: { x: currentX, y: tableStartY - tableHeight },
                            thickness: 1,
                            color: PDFLib.rgb(0, 0, 0),
                        });
                    }

                    // Main header
                    if (header) {
                        page.drawText(header, {
                            x: currentX + 2,
                            y: tableStartY - 15,
                            size: 8,
                            font: boldFont,
                        });
                    }

                    // Sub header
                    if (subHeaders[index]) {
                        page.drawText(subHeaders[index], {
                            x: currentX + 2,
                            y: tableStartY - 30,
                            size: 8,
                            font: boldFont,
                        });
                    }

                    currentX += columnWidths[index];
                });

                // Draw horizontal line separating headers from data
                page.drawLine({
                    start: { x: 50, y: tableStartY - headerHeight },
                    end: { x: width - 50, y: tableStartY - headerHeight },
                    thickness: 1,
                    color: PDFLib.rgb(0, 0, 0),
                });

                // Draw sub-header separator line
                page.drawLine({
                    start: { x: 50, y: tableStartY - 20 },
                    end: { x: width - 50, y: tableStartY - 20 },
                    thickness: 1,
                    color: PDFLib.rgb(0, 0, 0),
                });

                // Fill in entrant data
                for (let i = 0; i < totalRows; i++) {
                    const rowY = tableStartY - headerHeight - ((i + 1) * rowHeight);
                    
                    // Draw row separator
                    page.drawLine({
                        start: { x: 50, y: rowY },
                        end: { x: width - 50, y: rowY },
                        thickness: 1,
                        color: PDFLib.rgb(0, 0, 0),
                    });

                    if (i < currentEditingSheet.entrants.length) {
                        const entrant = currentEditingSheet.entrants[i];
                        const entrantKey = `entrant_${i}`;
                        
                        // Get the current form data
                        const scent1Result = document.getElementById(`${entrantKey}_scent1_found`)?.checked ? 'FOUND' : 
                                           document.getElementById(`${entrantKey}_scent1_not_found`)?.checked ? 'X' : '';
                        const scent2Result = document.getElementById(`${entrantKey}_scent2_found`)?.checked ? 'FOUND' : 
                                           document.getElementById(`${entrantKey}_scent2_not_found`)?.checked ? 'X' : '';
                        const scent3Result = document.getElementById(`${entrantKey}_scent3_found`)?.checked ? 'FOUND' : 
                                           document.getElementById(`${entrantKey}_scent3_not_found`)?.checked ? 'X' : '';
                        const scent4Result = document.getElementById(`${entrantKey}_scent4_found`)?.checked ? 'FOUND' : 
                                           document.getElementById(`${entrantKey}_scent4_not_found`)?.checked ? 'X' : '';
                        const faults = document.getElementById(`${entrantKey}_faults`)?.value || '';
                        const time = document.getElementById(`${entrantKey}_time`)?.value || '';
                        const result = document.querySelector(`input[name="${entrantKey}_result"]:checked`)?.value || '';

                        const rowData = [
                            (i + 1).toString(),
                            `${entrant.handler} - ${entrant.dog}`,
                            scent1Result,
                            scent2Result,
                            scent3Result,
                            scent4Result,
                            faults.length > 8 ? faults.substring(0, 6) + '..' : faults,
                            '', // Second fault column (empty for now)
                            time,
                            result.toUpperCase()
                        ];

                        currentX = 50;
                        rowData.forEach((data, colIndex) => {
                            let displayText = data;
                            if (colIndex === 1 && data.length > 20) { // Handler-Dog column
                                displayText = data.substring(0, 17) + '...';
                            }

                            // Background color for team name cells
                            if (colIndex === 0 || colIndex === 1) {
                                page.drawRectangle({
                                    x: currentX,
                                    y: rowY,
                                    width: columnWidths[colIndex],
                                    height: rowHeight,
                                    color: PDFLib.rgb(0.97, 0.97, 0.97),
                                });
                            }

                            page.drawText(displayText, {
                                x: currentX + 2,
                                y: rowY + rowHeight/2 - 4,
                                size: colIndex === 1 ? 7 : 8,
                                font: (colIndex === 0 || colIndex === 1) ? boldFont : font,
                            });
                            currentX += columnWidths[colIndex];
                        });
                    }
                }

                // Footer copyright
                page.drawText('Copyright © by Canine-Work And Games, LLC, 2024', {
                    x: width / 2 - 100,
                    y: 40,
                    size: 8,
                    font: font,
                });

                // Generate PDF bytes
                const pdfBytes = await pdfDoc.save();
                
                // Create download link
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${currentEditingSheet.trialName}_${currentEditingSheet.judge}_${currentEditingSheet.classRound}_Scored.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert('Filled PDF generated and downloaded successfully!');

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            }
        };

        // Delete sheet
        window.deleteSheet = async function(sheetId) {
            if (!confirm('Are you sure you want to delete this score sheet? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'scoreSheets', sheetId));
                alert('Score sheet deleted successfully');
                
                // Refresh the stored sheets view
                viewStoredSheets();
            } catch (error) {
                console.error('Error deleting sheet:', error);
                alert('Error deleting sheet: ' + error.message);
            }
        };

        // Make main functions available globally
        window.loadTrialData = loadTrialData;
        window.generateAllScoreSheets = generateAllScoreSheets;
        window.printScoreSheets = printScoreSheets;

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('scoreEntryModal');
            if (event.target === modal) {
                closeScoreModal();
            }
        };

        // Initialize when auth is ready
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await init();
            } else {
                showError('Please log in to access score sheets');
            }
        });
    </script>
</body>
</html>
