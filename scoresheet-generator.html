<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Score Sheet Generator</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .generator-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #007cba;
    }
    
    .header h1 {
      color: #007cba;
      margin: 0;
    }
    
    .controls-section {
      background-color: #f0f8ff;
      border: 2px solid #007cba;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .control-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      align-items: end;
    }
    
    .control-group {
      flex: 1;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .control-group select,
    .control-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      transition: background-color 0.3s;
    }
    
    .btn-primary {
      background-color: #007cba;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #005a8b;
    }
    
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }
    
    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }
    
    .btn-warning:hover {
      background-color: #e0a800;
    }
    
    .btn-info {
      background-color: #17a2b8;
      color: white;
    }
    
    .btn-info:hover {
      background-color: #138496;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .rounds-section {
      margin-bottom: 30px;
    }
    
    .round-group {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .round-header {
      background-color: #007cba;
      color: white;
      padding: 15px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .round-info {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .round-actions {
      display: flex;
      gap: 10px;
    }
    
    .round-content {
      padding: 15px;
      display: none;
    }
    
    .round-content.expanded {
      display: block;
    }
    
    .entries-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .entry-item {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      font-size: 14px;
    }
    
    .entry-item .handler {
      font-weight: bold;
      color: #007cba;
    }
    
    .entry-item .dog {
      color: #666;
    }
    
    .entry-item .details {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }
    
    .actions-section {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .debug-section {
      background-color: #f1f3f4;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }
    
    .debug-content {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    @media print {
      .controls-section,
      .actions-section,
      .debug-section,
      .btn {
        display: none !important;
      }
      
      .round-content {
        display: block !important;
        page-break-after: always;
      }
    }
  </style>
</head>
<body>
  <div class="generator-container">
    <div class="header">
      <h1>üìä Enhanced Score Sheet Generator</h1>
      <p>Generate individual score sheets for each round</p>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
      <h3>üéØ Trial Selection & Settings</h3>
      
      <div class="control-row">
        <div class="control-group">
          <label for="trialSelect">Select Trial:</label>
          <select id="trialSelect">
            <option value="">Select a trial...</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="dateSelect">Select Date (Optional):</label>
          <select id="dateSelect">
            <option value="">All dates</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="sortBy">Sort Entries By:</label>
          <select id="sortBy">
            <option value="entry">Entry Order</option>
            <option value="handler">Handler Name</option>
            <option value="dog">Dog Name</option>
            <option value="class">Class Name</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Actions Section -->
    <div class="actions-section">
      <h3>‚ö° Quick Actions</h3>
      <div class="actions-grid">
        <button class="btn btn-primary" onclick="loadTrialData()">üì• Load Trial Data</button>
        <button class="btn btn-success" onclick="generateAllScoreSheets()">üìã Generate All Score Sheets</button>
        <button class="btn btn-warning" onclick="exportToCSV()">üìä Export to CSV</button>
        <button class="btn btn-info" onclick="printAllSheets()">üñ®Ô∏è Print All Sheets</button>
        <button class="btn btn-secondary" onclick="showDebugInfo()">üîß Debug Info</button>
        <a href="main-dashboard.html" class="btn btn-secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <!-- Statistics Section -->
    <div id="statsSection" class="stats-section" style="display: none;">
      <!-- Stats will be populated here -->
    </div>

    <!-- Rounds Section -->
    <div id="roundsSection" class="rounds-section" style="display: none;">
      <!-- Round data will be populated here -->
    </div>

    <!-- Debug Section -->
    <div id="debugSection" class="debug-section" style="display: none;">
      <h3>üîß Debug Information</h3>
      <div id="debugContent" class="debug-content"></div>
    </div>

    <!-- Loading/Error Messages -->
    <div id="loadingMessage" class="loading" style="display: none;">
      <div>Loading trial data...</div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // ===========================================
    // STANDARD FIELD DEFINITIONS
    // ===========================================
    const STANDARD_FIELDS = {
      HANDLER_NAME: 'handlerName',
      DOG_CALL_NAME: 'dogCallName',
      JUDGE_NAME: 'judgeName',
      CLASS_NAME: 'className',
      CWAGS_NUMBER: 'cwagsNumber'
    };

    // ===========================================
    // GLOBAL VARIABLES
    // ===========================================
    let currentTrialData = null;
    let availableTrials = [];
    let allEntries = [];
    let roundsData = [];

    // ===========================================
    // DATE UTILITIES
    // ===========================================
    function createLocalDate(dateStr) {
      if (!dateStr) return null;
      const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
      return new Date(dateWithTime);
    }

    function formatLocalDate(date) {
      if (!date || !(date instanceof Date)) return null;
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit' 
      });
    }

    function getDateFromFirebase(timestamp) {
      if (!timestamp) return null;
      if (timestamp.toDate) return formatLocalDate(timestamp.toDate());
      if (typeof timestamp === 'string') return formatLocalDate(createLocalDate(timestamp));
      return null;
    }

    // ===========================================
    // DATA NORMALIZATION
    // ===========================================
    function normalizeEntryData(entry) {
      return {
        handlerName: entry.handlerName || entry.Handler || entry.handler || '',
        dogCallName: entry.dogCallName || entry['Call Name'] || entry.dogName || '',
        className: entry.className || entry.Class || entry.class || '',
        judgeName: entry.judgeName || entry.judge || entry.judgeAssigned || 'TBD',
        cwagsNumber: entry.cwagsNumber || entry.Registration || entry.registration || '',
        ...entry
      };
    }

    // ===========================================
    // TRIAL DATA LOADING
    // ===========================================
    async function loadAvailableTrials() {
      try {
        console.log("üîç Loading available trials...");
        
        const trialsQuery = query(
          collection(db, 'trials'),
          where('createdBy', '==', auth.currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        availableTrials = [];
        
        trialsSnapshot.forEach(doc => {
          const trialData = doc.data();
          availableTrials.push({
            id: doc.id,
            ...trialData
          });
        });
        
        populateTrialDropdown();
        console.log("‚úÖ Loaded trials:", availableTrials.length);
        
      } catch (error) {
        console.error("‚ùå Error loading trials:", error);
        showError("Error loading trials: " + error.message);
      }
    }

    function populateTrialDropdown() {
      const trialSelect = document.getElementById('trialSelect');
      trialSelect.innerHTML = '<option value="">Select a trial...</option>';

      availableTrials.forEach(trial => {
        const option = document.createElement('option');
        option.value = trial.id;
        
        let label = trial.clubName || 'Unnamed Trial';
        if (trial.days && trial.days.length > 0) {
          const firstDate = getDateFromFirebase(trial.days[0].date);
          if (firstDate) label += ` - ${firstDate}`;
        }
        
        option.textContent = label;
        trialSelect.appendChild(option);
      });

      // Auto-select if only one trial
      if (availableTrials.length === 1) {
        trialSelect.value = availableTrials[0].id;
      }
    }

    async function loadTrialData() {
      const trialId = document.getElementById('trialSelect').value;
      if (!trialId) {
        showError("Please select a trial first.");
        return;
      }

      try {
        showLoading(true);
        console.log("üì• Loading trial data for:", trialId);

        // Load trial structure
        currentTrialData = availableTrials.find(t => t.id === trialId);
        if (!currentTrialData) {
          const trialDoc = await getDoc(doc(db, 'trials', trialId));
          if (!trialDoc.exists()) {
            throw new Error('Trial not found');
          }
          currentTrialData = { id: trialDoc.id, ...trialDoc.data() };
        }

        // Process dates
        if (currentTrialData.days) {
          currentTrialData.days = currentTrialData.days.map(day => ({
            ...day,
            date: getDateFromFirebase(day.date)
          }));
        }

        // Load entries
        await loadTrialEntries(trialId);
        
        // Process rounds
        processRoundsData();
        
        // Update UI
        populateDateDropdown();
        updateStatistics();
        displayRounds();
        
        showSuccess(`Loaded ${allEntries.length} entries from ${currentTrialData.clubName}`);
        
      } catch (error) {
        console.error("‚ùå Error loading trial data:", error);
        showError("Error loading trial data: " + error.message);
      } finally {
        showLoading(false);
      }
    }

    async function loadTrialEntries(trialId) {
      try {
        const entriesQuery = query(
          collection(db, 'entries'),
          where('trialId', '==', trialId)
        );
        
        const entriesSnapshot = await getDocs(entriesQuery);
        allEntries = [];
        
        entriesSnapshot.forEach(doc => {
          const entryData = normalizeEntryData(doc.data());
          
          if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
            entryData.selectedEntries.forEach((selectedEntry, index) => {
              const normalizedEntry = {
                ...entryData,
                ...normalizeEntryData(selectedEntry),
                entryId: doc.id,
                entryIndex: index,
                date: selectedEntry.date ? getDateFromFirebase(selectedEntry.date) : null,
                roundNumber: selectedEntry.roundNumber || 1,
                type: selectedEntry.type || 'regular'
              };
              
              allEntries.push(normalizedEntry);
            });
          }
        });
        
        console.log("‚úÖ Loaded entries:", allEntries.length);
        
      } catch (error) {
        console.error("‚ùå Error loading entries:", error);
        throw error;
      }
    }

    function processRoundsData() {
      roundsData = [];
      const roundsMap = new Map();

      allEntries.forEach(entry => {
        const roundKey = `${entry.date}_${entry.className}_${entry.roundNumber}_${entry.judgeName}`;
        
        if (!roundsMap.has(roundKey)) {
          roundsMap.set(roundKey, {
            date: entry.date,
            className: entry.className,
            roundNumber: entry.roundNumber,
            judgeName: entry.judgeName,
            entries: []
          });
        }
        
        roundsMap.get(roundKey).entries.push(entry);
      });

      // Convert to array and sort
      roundsData = Array.from(roundsMap.values()).sort((a, b) => {
        if (a.date !== b.date) return new Date(a.date) - new Date(b.date);
        if (a.className !== b.className) return a.className.localeCompare(b.className);
        return a.roundNumber - b.roundNumber;
      });

      // Sort entries within each round
      roundsData.forEach(round => {
        const sortBy = document.getElementById('sortBy').value;
        round.entries.sort((a, b) => {
          switch (sortBy) {
            case 'handler': return a.handlerName.localeCompare(b.handlerName);
            case 'dog': return a.dogCallName.localeCompare(b.dogCallName);
            case 'class': return a.className.localeCompare(b.className);
            default: return 0; // entry order
          }
        });
      });

      console.log("‚úÖ Processed rounds:", roundsData.length);
    }

    function populateDateDropdown() {
      const dateSelect = document.getElementById('dateSelect');
      dateSelect.innerHTML = '<option value="">All dates</option>';

      if (currentTrialData && currentTrialData.days) {
        currentTrialData.days.forEach(day => {
          if (day.date) {
            const option = document.createElement('option');
            option.value = day.date;
            option.textContent = day.date;
            dateSelect.appendChild(option);
          }
        });
      }
    }

    function updateStatistics() {
      const totalEntries = allEntries.length;
      const uniqueHandlers = new Set(allEntries.map(e => e.handlerName)).size;
      const uniqueClasses = new Set(allEntries.map(e => e.className)).size;
      const uniqueJudges = new Set(allEntries.map(e => e.judgeName)).size;
      const totalRounds = roundsData.length;

      const statsHTML = `
        <div class="stat-card">
          <div class="stat-number">${totalEntries}</div>
          <div class="stat-label">Total Entries</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${uniqueHandlers}</div>
          <div class="stat-label">Handlers</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${uniqueClasses}</div>
          <div class="stat-label">Classes</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${uniqueJudges}</div>
          <div class="stat-label">Judges</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${totalRounds}</div>
          <div class="stat-label">Total Rounds</div>
        </div>
      `;

      document.getElementById('statsSection').innerHTML = statsHTML;
      document.getElementById('statsSection').style.display = 'grid';
    }

    function displayRounds() {
      const selectedDate = document.getElementById('dateSelect').value;
      const filteredRounds = selectedDate 
        ? roundsData.filter(round => round.date === selectedDate)
        : roundsData;

      let roundsHTML = '';
      
      filteredRounds.forEach((round, index) => {
        const entriesHTML = round.entries.map(entry => `
          <div class="entry-item">
            <div class="handler">${entry.handlerName}</div>
            <div class="dog">${entry.dogCallName}</div>
            <div class="details">
              ${entry.type === 'feo' ? 'FEO' : 'Regular'} | 
              ${entry.cwagsNumber || 'No Registration'}
            </div>
          </div>
        `).join('');

        roundsHTML += `
          <div class="round-group">
            <div class="round-header">
              <div class="round-info">
                <span>${round.className} - Round ${round.roundNumber}</span>
                <span>Judge: ${round.judgeName}</span>
                <span>Date: ${round.date}</span>
                <span>${round.entries.length} entries</span>
              </div>
              <div class="round-actions">
                <button class="btn btn-success btn-sm" onclick="generateScoreSheet(${index})">
                  üìã Generate Sheet
                </button>
                <button class="btn btn-info btn-sm" onclick="toggleRound(${index})">
                  üëÅÔ∏è View
                </button>
              </div>
            </div>
            <div class="round-content" id="round-${index}">
              <div class="entries-grid">
                ${entriesHTML}
              </div>
            </div>
          </div>
        `;
      });

      document.getElementById('roundsSection').innerHTML = roundsHTML;
      document.getElementById('roundsSection').style.display = 'block';
    }

    // ===========================================
    // SCORE SHEET GENERATION
    // ===========================================
    function generateScoreSheet(roundIndex) {
      const round = roundsData[roundIndex];
      const scoreSheetHTML = createScoreSheetHTML(round);
      
      // Open in new window for printing
      const printWindow = window.open('', '_blank');
      printWindow.document.write(scoreSheetHTML);
      printWindow.document.close();
      printWindow.focus();
    }

    function generateAllScoreSheets() {
      if (roundsData.length === 0) {
        showError("No rounds data available. Please load trial data first.");
        return;
      }

      let allSheetsHTML = '';
      
      roundsData.forEach(round => {
        allSheetsHTML += createScoreSheetHTML(round, true);
      });

      // Open in new window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>All Score Sheets - ${currentTrialData.clubName}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
            .page-break { page-break-after: always; }
            @media print { .page-break:last-child { page-break-after: avoid; } }
          </style>
        </head>
        <body>
          ${allSheetsHTML}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();

      showSuccess(`Generated ${roundsData.length} score sheets`);
    }

    function createScoreSheetHTML(round, addPageBreak = false) {
      const pageBreakClass = addPageBreak ? 'page-break' : '';
      
      return `
        <div class="${pageBreakClass}" style="margin-bottom: 40px;">
          <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px;">
            <h1 style="margin: 0; color: #000;">C-WAGS SCORE SHEET</h1>
            <h2 style="margin: 10px 0 0 0; color: #666;">${currentTrialData.clubName}</h2>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
            <div>
              <p><strong>Class:</strong> ${round.className}</p>
              <p><strong>Round:</strong> ${round.roundNumber}</p>
              <p><strong>Date:</strong> ${round.date}</p>
            </div>
            <div>
              <p><strong>Judge:</strong> ${round.judgeName}</p>
              <p><strong>Total Entries:</strong> ${round.entries.length}</p>
              <p><strong>Start Time:</strong> _____________</p>
            </div>
          </div>

          <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
            <thead>
              <tr style="background-color: #f0f0f0;">
                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 50px;">#</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Handler Name</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Dog Name</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 80px;">Type</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 100px;">Score</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: center; width: 80px;">Place</th>
                <th style="border: 1px solid #000; padding: 8px; text-align: left; width: 150px;">Notes</th>
              </tr>
            </thead>
            <tbody>
              ${round.entries.map((entry, index) => `
                <tr>
                  <td style="border: 1px solid #000; padding: 8px; text-align: center;">${index + 1}</td>
                  <td style="border: 1px solid #000; padding: 8px;">${entry.handlerName}</td>
                  <td style="border: 1px solid #000; padding: 8px;">${entry.dogCallName}</td>
                  <td style="border: 1px solid #000; padding: 8px; text-align: center;">${entry.type === 'feo' ? 'FEO' : 'REG'}</td>
                  <td style="border: 1px solid #000; padding: 8px; height: 40px;"></td>
                  <td style="border: 1px solid #000; padding: 8px; height: 40px;"></td>
                  <td style="border: 1px solid #000; padding: 8px; height: 40px;"></td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div style="margin-top: 40px;">
            <p><strong>Judge Signature:</strong> ___________________________________ <strong>Date:</strong> _______________</p>
          </div>
        </div>
      `;
    }

    // ===========================================
    // UTILITY FUNCTIONS
    // ===========================================
    function toggleRound(roundIndex) {
      const roundContent = document.getElementById(`round-${roundIndex}`);
      roundContent.classList.toggle('expanded');
    }

    function exportToCSV() {
      if (roundsData.length === 0) {
        showError("No data to export. Please load trial data first.");
        return;
      }

      let csvContent = "Date,Class,Round,Judge,Handler,Dog,Type,Registration\n";
      
      roundsData.forEach(round => {
        round.entries.forEach(entry => {
          csvContent += `"${round.date}","${round.className}",${round.roundNumber},"${round.judgeName}","${entry.handlerName}","${entry.dogCallName}","${entry.type}","${entry.cwagsNumber}"\n`;
        });
      });

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `score-sheets-${currentTrialData.clubName}-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);

      showSuccess("CSV exported successfully");
    }

    function printAllSheets() {
      generateAllScoreSheets();
    }

    function showDebugInfo() {
      const debugContent = document.getElementById('debugContent');
      const debugSection = document.getElementById('debugSection');
      
      const debugInfo = {
        currentTrialData: currentTrialData,
        totalTrials: availableTrials.length,
        totalEntries: allEntries.length,
        totalRounds: roundsData.length,
        standardFields: STANDARD_FIELDS,
        roundsSample: roundsData.slice(0, 3),
        entriesSample: allEntries.slice(0, 5)
      };
      
      debugContent.textContent = JSON.stringify(debugInfo, null, 2);
      debugSection.style.display = debugSection.style.display === 'none' ? 'block' : 'none';
    }

    function showLoading(show) {
      document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => errorDiv.style.display = 'none', 5000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      setTimeout(() => successDiv.style.display = 'none', 3000);
    }

    // ===========================================
    // EVENT LISTENERS
    // ===========================================
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listeners for dropdowns
      document.getElementById('dateSelect').addEventListener('change', function() {
        if (roundsData.length > 0) {
          displayRounds();
        }
      });

      document.getElementById('sortBy').addEventListener('change', function() {
        if (roundsData.length > 0) {
          processRoundsData();
          displayRounds();
        }
      });

      // Initial setup
      document.getElementById('debugSection').style.display = 'none';
    });

    // ===========================================
    // GLOBAL FUNCTIONS
    // ===========================================
    window.loadTrialData = loadTrialData;
    window.generateAllScoreSheets = generateAllScoreSheets;
    window.generateScoreSheet = generateScoreSheet;
    window.toggleRound = toggleRound;
    window.exportToCSV = exportToCSV;
    window.printAllSheets = printAllSheets;
    window.showDebugInfo = showDebugInfo;

    // ===========================================
    // AUTHENTICATION AND INITIALIZATION
    // ===========================================
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        console.log("‚úÖ User authenticated:", user.email);
        try {
          await loadAvailableTrials();
        } catch (error) {
          console.error("‚ùå Error during initialization:", error);
          showError("Error loading initial data: " + error.message);
        }
      } else {
        console.log("‚ùå No user authenticated, redirecting to login");
        window.location.href = 'index.html';
      }
    });

    console.log("‚úÖ Enhanced Score Sheet Generator loaded");
  </script>
</body>
</html>
