<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trial Secretary Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-msg {
      font-size: 1.2rem;
      color: #666;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .user-details {
      font-weight: 500;
      color: #444;
    }

    .logout-btn {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(238, 90, 36, 0.4);
    }

    .quick-stats {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .quick-stats h3 {
      margin-bottom: 15px;
      color: #444;
      font-size: 1.4rem;
    }

    .tab-navigation {
      display: flex;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 5px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .tab-button {
      flex: 1;
      padding: 15px 20px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      color: #666;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .tab-button:hover:not(.active) {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .nav-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .nav-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .nav-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }

    .nav-card h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 1.3rem;
    }

    .nav-card p {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .nav-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }

    .nav-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .nav-button.secondary {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .nav-button.tertiary {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }

    .nav-button.quaternary {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    }

    /* Entry Management Styles */
    .trial-selector {
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .form-group select, .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 1rem;
    }

    .entries-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .entries-table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 15px;
    }

    #entriesTable {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    #entriesTable th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
      position: sticky;
      top: 0;
    }

    #entriesTable td {
      padding: 10px 12px;
      border-bottom: 1px solid #dee2e6;
    }

    #entriesTable tr:hover {
      background: #f8f9fa;
    }

    .entry-actions {
      display: flex;
      gap: 10px;
    }

    .btn-edit, .btn-delete {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .btn-edit {
      background: #007bff;
      color: white;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    /* Summary Management Styles */
    .summary-list {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }

    .summary-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .summary-info h4 {
      margin-bottom: 5px;
      color: #333;
    }

    .summary-meta {
      color: #666;
      font-size: 0.9rem;
    }

    .summary-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .no-summaries {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
    }

    .entries-summary {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 10px;
      }

      .nav-grid {
        grid-template-columns: 1fr;
      }

      .tab-navigation {
        flex-direction: column;
      }

      .user-info {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .header h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="header">
      <h1>üêï Trial Secretary Dashboard</h1>
      <div class="welcome-msg">Welcome back, <span id="username">User</span>!</div>
    </div>

    <!-- User Info Section -->
    <div class="user-info">
      <div class="user-details">
        <div>Logged in as: <span id="userEmail">user@example.com</span></div>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Quick Stats Section -->
    <div class="quick-stats">
      <h3>üìä Quick Stats</h3>
      <div id="statsContent">Loading statistics...</div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" onclick="showTab('main')">Main Tools</button>
      <button class="tab-button" onclick="showTab('entries')">Entry Management</button>
      <button class="tab-button" onclick="showTab('summaries')">Class Summaries</button>
      <button class="tab-button" onclick="showTab('reports')">Generated Reports</button>
    </div>

    <!-- Main Tools Tab -->
    <div id="main-tab" class="tab-content active">
      <div class="nav-grid">
        <div class="nav-card" onclick="location.href='create-trial.html'">
          <h3>üèÅ Create Trial</h3>
          <p>Set up a new trial with classes, dates, and judges</p>
          <button class="nav-button">Create New Trial</button>
        </div>
        
        <div class="nav-card" onclick="location.href='view-trials.html'">
          <h3>üìã My Trials</h3>
          <p>View and manage your existing trials</p>
          <button class="nav-button secondary">View Trials</button>
        </div>
        
        <div class="nav-card" onclick="location.href='trial-application.html'">
          <h3>üìÑ Trial Application</h3>
          <p>Generate trial application forms for submission</p>
          <button class="nav-button">Create Application</button>
        </div>
        
        <div class="nav-card" onclick="location.href='entry-form.html'">
          <h3>üêï Entry Forms</h3>
          <p>Manage dog entries and participant information</p>
          <button class="nav-button tertiary">Manage Entries</button>
        </div>
        
        <div class="nav-card" onclick="location.href='scoresheet-generator.html'">
          <h3>üìã Score Sheets</h3>
          <p>Generate and manage score sheets for judges</p>
          <button class="nav-button quaternary">Generate Score Sheets</button>
        </div>
        
        <div class="nav-card" onclick="location.href='premium.html'">
          <h3>üìÑ Premium Lists</h3>
          <p>Create premium lists and trial information packets</p>
          <button class="nav-button">Generate Premium</button>
        </div>
        
        <div class="nav-card" onclick="location.href='waiver-generator.html'">
          <h3>üìã Waiver Forms</h3>
          <p>Generate and customize liability waivers</p>
          <button class="nav-button secondary">Create Waiver</button>
        </div>
        
        <div class="nav-card" onclick="location.href='running-order.html'">
          <h3>üìä Running Orders</h3>
          <p>Generate running orders for your trials</p>
          <button class="nav-button tertiary">Create Running Order</button>
        </div>
        
        <div class="nav-card" onclick="location.href='class-summary-generator.html'">
          <h3>üìà Class Summaries</h3>
          <p>Create detailed class summary reports</p>
          <button class="nav-button">Generate Summary</button>
        </div>
      </div>
    </div>

    <!-- Entry Management Tab -->
    <div id="entries-tab" class="tab-content">
      <div class="entries-container">
        <h3>üìù Entry Management</h3>
        <div class="trial-selector">
          <div class="form-group">
            <label for="entryManagementTrialSelect">Select Trial:</label>
            <select id="entryManagementTrialSelect">
              <option value="">Loading trials...</option>
            </select>
          </div>
          <button class="btn btn-success" onclick="loadEntryManagement()">Load Entries</button>
        </div>

        <div class="form-group">
          <label for="entrySearch">Search Entries:</label>
          <input type="text" id="entrySearch" placeholder="Search by handler name, dog name, or class...">
        </div>

        <div class="form-group">
          <label for="classFilter">Filter by Class:</label>
          <select id="classFilter">
            <option value="">All Classes</option>
          </select>
        </div>

        <div id="entryManagementResults">
          <p>Select a trial to view entries.</p>
        </div>
      </div>
    </div>

    <!-- Class Summaries Tab -->
    <div id="summaries-tab" class="tab-content">
      <div class="entries-container">
        <h3>üìä Class Summaries</h3>
        <div style="margin-bottom: 20px;">
          <button class="btn btn-success" onclick="location.href='class-summary-generator.html'">
            Create New Summary
          </button>
        </div>
        <div id="summariesList">
          <p>Loading summaries...</p>
        </div>
      </div>
    </div>

    <!-- Generated Reports Tab -->
    <div id="reports-tab" class="tab-content">
      <div class="entries-container">
        <h3>üìÑ Generated Reports</h3>
        <div id="reportsList">
          <div class="no-summaries">
            <h4>üìã Available Reports</h4>
            <p>Your generated reports will appear here. Use the tools above to create:</p>
            <ul style="text-align: left; display: inline-block; margin-top: 15px;">
              <li>Trial Applications</li>
              <li>Premium Lists</li>
              <li>Waiver Forms</li>
              <li>Running Orders</li>
              <li>Score Sheets</li>
              <li>Class Summaries</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase imports
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";

    // ========================================
    // STANDARDIZED FIELD NAMES (CRITICAL)
    // ========================================
    
    // Use these EXACT field names everywhere - NO EXCEPTIONS
    const STANDARD_FIELDS = {
      HANDLER_NAME: 'handlerName',      // NOT 'Handler' or 'handler'
      DOG_CALL_NAME: 'dogCallName',     // NOT 'Call Name' or 'dogName'
      JUDGE_NAME: 'judgeName',          // NOT 'judge' or 'judgeAssigned'
      CLASS_NAME: 'className',          // NOT 'Class' or 'class'
      CWAGS_NUMBER: 'cwagsNumber'       // NOT 'Registration'
    };

    // Data field mapping for backward compatibility
    const FIELD_MAPPING = {
      // Handler name variations
      'Handler': 'handlerName',
      'handler': 'handlerName',
      
      // Dog name variations  
      'Call Name': 'dogCallName',
      'dogName': 'dogCallName',
      'callName': 'dogCallName',
      
      // Judge name variations
      'judge': 'judgeName',
      'judgeAssigned': 'judgeName',
      'selectedJudge': 'judgeName',
      
      // Registration variations
      'Registration': 'cwagsNumber',
      'registration': 'cwagsNumber',
      
      // Class name variations
      'Class': 'className',
      'class': 'className'
    };

    // ========================================
    // GLOBAL DATE HANDLING FIX
    // ========================================
    
    function prepareDateForFirebase(dateStr) {
      if (!dateStr) return null;
      const localDate = new Date(dateStr + 'T12:00:00');
      return localDate.toISOString().split('T')[0];
    }

    function getDateFromFirebase(firebaseDate) {
      if (!firebaseDate) return null;
      if (typeof firebaseDate === 'string') {
        return firebaseDate;
      }
      if (firebaseDate.toDate) {
        return firebaseDate.toDate().toISOString().split('T')[0];
      }
      return firebaseDate.toString().split('T')[0];
    }

    function formatDateDisplay(dateStr, options = {}) {
      if (!dateStr) return 'No date';
      try {
        const date = new Date(dateStr + 'T12:00:00');
        const defaultOptions = {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        };
        return date.toLocaleDateString('en-US', {...defaultOptions, ...options});
      } catch (error) {
        console.error('Date formatting error:', error);
        return dateStr;
      }
    }

    // ========================================
    // DATA NORMALIZATION FUNCTIONS
    // ========================================
    
    function normalizeEntryData(entryData) {
      const normalized = { ...entryData };
      
      // Apply field mapping to normalize all field names
      Object.keys(FIELD_MAPPING).forEach(oldField => {
        if (entryData[oldField] && !entryData[FIELD_MAPPING[oldField]]) {
          normalized[FIELD_MAPPING[oldField]] = entryData[oldField];
          delete normalized[oldField]; // Remove old field
        }
      });
      
      return normalized;
    }

    function getStandardizedHandlerName(entry) {
      return entry.handlerName || 
             entry.Handler || 
             entry.handler || 
             'Unknown Handler';
    }

    function getStandardizedDogName(entry) {
      return entry.dogCallName || 
             entry['Call Name'] || 
             entry.dogName || 
             entry.callName || 
             'Unknown Dog';
    }

    function getStandardizedJudgeName(entry) {
      return entry.judgeName || 
             entry.judge || 
             entry.judgeAssigned || 
             entry.selectedJudge ||
             'TBD';
    }

    function getStandardizedClassName(entry) {
      return entry.className || 
             entry.Class || 
             entry.class || 
             'Unknown Class';
    }

    // ========================================
    // GLOBAL VARIABLES
    // ========================================
    
    let authCheckComplete = false;
    let currentUser = null;
    let availableTrials = [];
    let currentTrialEntries = [];
    let filteredEntries = [];

    // ========================================
    // TAB MANAGEMENT
    // ========================================
    
    window.showTab = function(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
      
      // Load content for specific tabs
      if (tabName === 'summaries') {
        loadSummaries();
      } else if (tabName === 'reports') {
        loadReports();
      } else if (tabName === 'entries') {
        loadTrialsForEntryManagement();
      }
    };

    // ========================================
    // ENTRY MANAGEMENT FUNCTIONS
    // ========================================
    
    async function loadTrialsForEntryManagement() {
      console.log("üìù Loading trials for entry management...");
      
      try {
        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        availableTrials = [];
        
        trialsSnapshot.forEach(doc => {
          const trialData = doc.data();
          
          // Fix date handling for trial days
          if (trialData.days && Array.isArray(trialData.days)) {
            trialData.days = trialData.days.map(day => ({
              ...day,
              date: day.date ? getDateFromFirebase(day.date) : null
            }));
          }
          
          availableTrials.push({ id: doc.id, ...trialData });
        });
        
        availableTrials.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
        
        // Populate trial selector
        const entryTrialSelect = document.getElementById('entryManagementTrialSelect');
        entryTrialSelect.innerHTML = '<option value="">Choose a trial...</option>';
        
        availableTrials.forEach(trial => {
          const option = document.createElement('option');
          option.value = trial.id;
          
          let trialLabel = trial.clubName || 'Unnamed Trial';
          if (trial.days && trial.days.length > 0) {
            const dates = trial.days
              .filter(day => day.date)
              .map(day => {
                const localDate = new Date(day.date + 'T12:00:00');
                return localDate.toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: 'numeric' 
                });
              })
              .join(', ');
            if (dates) {
              trialLabel += ` (${dates})`;
            }
          }
          
          option.textContent = trialLabel;
          entryTrialSelect.appendChild(option);
        });
        
        // Setup search and filter
        document.getElementById('entrySearch').addEventListener('input', filterEntries);
        document.getElementById('classFilter').addEventListener('change', filterEntries);
        
        console.log(`‚úÖ Loaded ${availableTrials.length} trials for entry management`);
        
      } catch (error) {
        console.error("‚ùå Error loading trials for entry management:", error);
      }
    }

    window.loadEntryManagement = async function() {
      const trialId = document.getElementById('entryManagementTrialSelect').value;
      
      if (!trialId) {
        alert('Please select a trial first');
        return;
      }
      
      console.log("üìù Loading entry management for trial:", trialId);
      await loadTrialEntries(trialId);
    };

    async function loadTrialEntries(trialId) {
      console.log("üìä Loading entries for trial:", trialId);
      
      try {
        const entriesQuery = query(
          collection(db, "entries"),
          where("trialId", "==", trialId)
        );
        
        const entriesSnapshot = await getDocs(entriesQuery);
        currentTrialEntries = [];
        
        entriesSnapshot.forEach(doc => {
          const entryData = doc.data();
          
          // Fix selected entries dates
          if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
            entryData.selectedEntries = entryData.selectedEntries.map(entry => ({
              ...entry,
              date: entry.date ? getDateFromFirebase(entry.date) : entry.date
            }));
          }
          
          // Process each selected entry as a separate row
          if (entryData.selectedEntries && entryData.selectedEntries.length > 0) {
            entryData.selectedEntries.forEach((selectedEntry, index) => {
              const processedEntry = {
                id: doc.id,
                entryIndex: index,
                handlerName: entryData.handlerName,
                handlerEmail: entryData.handlerEmail,
                handlerPhone: entryData.handlerPhone,
                dogCallName: entryData.dogCallName,
                dogBreed: entryData.dogBreed,
                cwagsNumber: entryData.cwagsNumber,
                className: selectedEntry.className,
                roundName: selectedEntry.roundName,
                roundNumber: selectedEntry.roundNumber,
                judgeName: selectedEntry.judgeName,
                entryType: selectedEntry.type,
                fee: selectedEntry.fee,
                submittedAt: entryData.submittedAt,
                date: selectedEntry.date
              };
              currentTrialEntries.push(processedEntry);
            });
          } else {
            // Fallback for entries without selectedEntries
            currentTrialEntries.push({
              id: doc.id,
              entryIndex: 0,
              ...entryData
            });
          }
        });

        console.log('Loaded entries:', currentTrialEntries);
        
        // Get trial data for context
        const trialDoc = await getDoc(doc(db, 'trials', trialId));
        const trialData = trialDoc.exists() ? trialDoc.data() : {};
        
        // Update class filter
        updateClassFilter();
        
        // Display entries
        displayEntries(currentTrialEntries, trialData);
        
      } catch (error) {
        console.error('Error loading entries:', error);
        document.getElementById('entryManagementResults').innerHTML = 
          '<div class="error">Error loading entries: ' + error.message + '</div>';
      }
    }

    function updateClassFilter() {
      const classFilter = document.getElementById('classFilter');
      const uniqueClasses = [...new Set(currentTrialEntries.map(entry => 
        getStandardizedClassName(normalizeEntryData(entry))
      ))].sort();
      
      classFilter.innerHTML = '<option value="">All Classes</option>';
      uniqueClasses.forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classFilter.appendChild(option);
      });
    }

    function displayEntries(entries, trialData) {
      const container = document.getElementById('entryManagementResults');
      
      if (entries.length === 0) {
        container.innerHTML = '<p>No entries found for this trial.</p>';
        return;
      }
      
      let html = `<h4>üìã Entries for ${trialData.clubName || 'Trial'}</h4>`;
      
      html += `
        <div class="entries-table-container">
          <table id="entriesTable">
            <thead>
              <tr>
                <th>Handler</th>
                <th>Dog</th>
                <th>Class</th>
                <th>Round</th>
                <th>Judge</th>
                <th>Type</th>
                <th>Fee</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      entries.forEach(entry => {
        const normalizedEntry = normalizeEntryData(entry);
        
        // Use standardized field resolution
        const handlerName = getStandardizedHandlerName(normalizedEntry);
        const dogCallName = getStandardizedDogName(normalizedEntry);
        const className = getStandardizedClassName(normalizedEntry);
        const judgeName = getStandardizedJudgeName(normalizedEntry);
        
        const judgeStyle = judgeName === 'TBD' || judgeName === 'Judge TBD' ?
          'background-color: #ffebee; color: #c62828;' : 
          'background-color: #e8f5e8; color: #2e7d32;';
        
        html += `
          <tr>
            <td>${handlerName}</td>
            <td>${dogCallName}</td>
            <td>${className}</td>
            <td>${normalizedEntry.roundName || normalizedEntry.roundNumber || '1'}</td>
            <td style="${judgeStyle}"><strong>${judgeName}</strong></td>
            <td>${normalizedEntry.entryType || 'Regular'}</td>
            <td>${(normalizedEntry.fee || 0).toFixed(2)}</td>
            <td>${formatDateDisplay(normalizedEntry.date) || 'No date'}</td>
            <td class="entry-actions">
              <button class="btn-edit" onclick="editEntry('${normalizedEntry.id}')">‚úèÔ∏è Edit</button>
              <button class="btn-delete" onclick="deleteEntry('${normalizedEntry.id}')">üóëÔ∏è Delete</button>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
        <div class="entries-summary">
          <strong>Summary:</strong> 
          Total entries: ${entries.length} | 
          Entries with judges assigned: <span style="color: #2e7d32; font-weight: bold;">${entries.filter(e => {
            const judge = getStandardizedJudgeName(normalizeEntryData(e));
            return judge !== 'TBD' && judge !== 'Judge TBD';
          }).length}</span> | 
          Entries with TBD judges: <span style="color: #c62828; font-weight: bold;">${entries.filter(e => {
            const judge = getStandardizedJudgeName(normalizeEntryData(e));
            return judge === 'TBD' || judge === 'Judge TBD';
          }).length}</span>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function filterEntries() {
      const searchTerm = document.getElementById('entrySearch').value.toLowerCase();
      const classFilter = document.getElementById('classFilter').value;
      
      filteredEntries = currentTrialEntries.filter(entry => {
        const normalizedEntry = normalizeEntryData(entry);
        
        const handlerName = getStandardizedHandlerName(normalizedEntry).toLowerCase();
        const dogCallName = getStandardizedDogName(normalizedEntry).toLowerCase();
        const className = getStandardizedClassName(normalizedEntry);
        
        const matchesSearch = !searchTerm || 
          handlerName.includes(searchTerm) || 
          dogCallName.includes(searchTerm) || 
          className.toLowerCase().includes(searchTerm);
        
        const matchesClass = !classFilter || className === classFilter;
        
        return matchesSearch && matchesClass;
      });
      
      // Get trial data for redisplay
      const trialSelect = document.getElementById('entryManagementTrialSelect');
      const selectedTrial = availableTrials.find(t => t.id === trialSelect.value);
      
      displayEntries(filteredEntries, selectedTrial || {});
    }

    // Global functions for entry actions
    window.editEntry = function(entryId) {
      window.location.href = `entry-form.html?entry=${entryId}`;
    };

    window.deleteEntry = async function(entryId) {
      if (confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
        try {
          await deleteDoc(doc(db, 'entries', entryId));
          alert('Entry deleted successfully');
          
          // Reload the current trial's entries
          const trialId = document.getElementById('entryManagementTrialSelect').value;
          if (trialId) {
            await loadTrialEntries(trialId);
          }
        } catch (error) {
          console.error('Error deleting entry:', error);
          alert('Error deleting entry: ' + error.message);
        }
      }
    };

    // ========================================
    // SUMMARY MANAGEMENT FUNCTIONS
    // ========================================
    
    async function loadSummaries() {
      console.log("üìä Loading summaries...");
      
      if (!currentUser) {
        console.log("No user found for summaries");
        return;
      }

      try {
        const summariesQuery = query(
          collection(db, "classSummaries"),
          where("createdBy", "==", currentUser.uid)
        );
        
        const summariesSnapshot = await getDocs(summariesQuery);
        const summariesList = document.getElementById('summariesList');
        
        if (summariesSnapshot.empty) {
          summariesList.innerHTML = `
            <div class="no-summaries">
              <h4>üìã No Class Summaries Yet</h4>
              <p>You haven't created any class summaries yet.</p>
              <button class="btn btn-success" onclick="location.href='class-summary-generator.html'">Create Your First Summary</button>
            </div>
          `;
          return;
        }

        let summariesHTML = '<div class="summary-list">';
        
        summariesSnapshot.forEach(doc => {
          const summary = doc.data();
          const createdDate = summary.createdAt ? 
            summary.createdAt.toDate().toLocaleDateString() : 'Unknown date';
          
          summariesHTML += `
            <div class="summary-item">
              <div class="summary-info">
                <h4>${summary.trialName || 'Unnamed Summary'}</h4>
                <div class="summary-meta">
                  Created: ${createdDate} | 
                  Classes: ${summary.classes ? summary.classes.length : 0}
                </div>
              </div>
              <div class="summary-actions">
                <button class="btn btn-secondary" onclick="viewSummary('${doc.id}')">View</button>
                <button class="btn btn-warning" onclick="editSummary('${doc.id}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteSummary('${doc.id}', '${summary.trialName || 'this summary'}')">Delete</button>
              </div>
            </div>
          `;
        });
        
        summariesHTML += '</div>';
        summariesList.innerHTML = summariesHTML;
        
      } catch (error) {
        console.error("Error loading summaries:", error);
        document.getElementById('summariesList').innerHTML = 
          '<div class="no-summaries">Error loading summaries: ' + error.message + '</div>';
      }
    }

    // Summary action functions
    window.viewSummary = function(summaryId) {
      window.location.href = `class-summary-generator.html?view=${summaryId}`;
    };

    window.editSummary = function(summaryId) {
      window.location.href = `class-summary-generator.html?edit=${summaryId}`;
    };

    window.deleteSummary = async function(summaryId, summaryName) {
      if (confirm(`Are you sure you want to delete "${summaryName}"? This cannot be undone.`)) {
        try {
          await deleteDoc(doc(db, 'classSummaries', summaryId));
          alert('Summary deleted successfully');
          loadSummaries(); // Reload the list
        } catch (error) {
          console.error('Error deleting summary:', error);
          alert('Error deleting summary: ' + error.message);
        }
      }
    };

    // ========================================
    // REPORTS MANAGEMENT
    // ========================================
    
    function loadReports() {
      console.log("üìÑ Loading reports...");
      const reportsList = document.getElementById('reportsList');
      reportsList.innerHTML = `
        <div class="no-summaries">
          <h4>üìã Available Reports</h4>
          <p>Your generated reports will appear here. Use the tools above to create:</p>
          <ul style="text-align: left; display: inline-block; margin-top: 15px;">
            <li>Trial Applications</li>
            <li>Premium Lists</li>
            <li>Waiver Forms</li>
            <li>Running Orders</li>
            <li>Score Sheets</li>
            <li>Class Summaries</li>
          </ul>
        </div>
      `;
    }

    // ========================================
    // USER STATS AND AUTHENTICATION
    // ========================================
    
    async function loadStats(user) {
      try {
        // Count trials
        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", user.uid)
        );
        const trialsSnapshot = await getDocs(trialsQuery);

        // Count applications
        const appsQuery = query(
          collection(db, "applications"),
          where("createdBy", "==", user.uid)
        );
        const appsSnapshot = await getDocs(appsQuery);

        // Count summaries
        const summariesQuery = query(
          collection(db, "classSummaries"),
          where("createdBy", "==", user.uid)
        );
        const summariesSnapshot = await getDocs(summariesQuery);

        // Count total entries across all trials
        let totalEntries = 0;
        const entriesQuery = query(collection(db, "entries"));
        const entriesSnapshot = await getDocs(entriesQuery);
        
        // Get trial IDs for this user
        const userTrialIds = trialsSnapshot.docs.map(doc => doc.id);
        
        entriesSnapshot.forEach(doc => {
          const entryData = doc.data();
          if (userTrialIds.includes(entryData.trialId)) {
            totalEntries++;
          }
        });

        const statsHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${trialsSnapshot.size}</div>
              <div style="font-size: 14px; color: #666;">Trials Created</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #e91e63;">${totalEntries}</div>
              <div style="font-size: 14px; color: #666;">Total Entries</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${appsSnapshot.size}</div>
              <div style="font-size: 14px; color: #666;">Applications</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">${summariesSnapshot.size}</div>
              <div style="font-size: 14px; color: #666;">Class Summaries</div>
            </div>
          </div>
        `;
        
        document.getElementById('statsContent').innerHTML = statsHTML;
        
      } catch (error) {
        console.error("Error loading stats:", error);
        document.getElementById('statsContent').innerHTML = 
          '<p style="color: #666;">Unable to load statistics</p>';
      }
    }

    // Logout function
    window.logout = async function() {
      if (confirm("Are you sure you want to logout?")) {
        try {
          console.log("Logging out...");
          await signOut(auth);
          window.location.href = 'index.html';
        } catch (error) {
          console.error("Logout error:", error);
          alert("Error logging out: " + error.message);
        }
      }
    };

    // ========================================
    // AUTHENTICATION AND INITIALIZATION
    // ========================================
    
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      currentUser = user;
      authCheckComplete = true;

      // Update UI with user info
      const username = user.email.split('@')[0];
      document.getElementById('username').textContent = username;
      document.getElementById('userEmail').textContent = user.email;

      // Load initial stats
      await loadStats(user);

      console.log("Dashboard initialized for user:", user.email);
    });

  </script>
</body>
</html>
