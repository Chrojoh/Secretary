<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trial Secretary Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-msg {
      font-size: 1.2rem;
      color: #666;
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .user-details {
      font-weight: 500;
      color: #444;
    }

    .logout-btn {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(238, 90, 36, 0.4);
    }

    .quick-stats {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .quick-stats h3 {
      margin-bottom: 15px;
      color: #444;
      font-size: 1.4rem;
    }

    .tab-navigation {
      display: flex;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px 12px 0 0;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .tab-button {
      flex: 1;
      padding: 15px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      color: #666;
    }

    .tab-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .tab-button:hover:not(.active) {
      background: rgba(102, 126, 234, 0.1);
    }

    .tab-content {
      display: none;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      min-height: 500px;
    }

    .tab-content.active {
      display: block;
    }

    .nav-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }

    .nav-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .nav-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }

    .nav-card h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 1.3rem;
    }

    .nav-card p {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .nav-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .nav-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .nav-button.secondary {
      background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
    }

    .nav-button.tertiary {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
      color: #212529;
    }

    .summary-list {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }

    .summary-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .summary-info h4 {
      margin-bottom: 5px;
      color: #333;
    }

    .summary-meta {
      color: #666;
      font-size: 0.9rem;
    }

    .summary-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .no-summaries {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
    }

    /* Entry Management Styles */
    .trial-selector {
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .entries-table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    #entriesTable {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    #entriesTable th {
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 1;
      padding: 1rem 0.75rem;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
    }

    #entriesTable td {
      padding: 0.75rem;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    #entriesTable tr:hover {
      background: #f8f9fa;
    }

    .entry-classes {
      font-size: 0.9rem;
      line-height: 1.3;
    }

    .entry-class-item {
      background: #e7f3ff;
      border: 1px solid #0066cc;
      border-radius: 12px;
      padding: 0.2rem 0.5rem;
      margin: 0.1rem;
      display: inline-block;
      font-size: 0.8rem;
    }

    .entry-class-item.feo {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    .entry-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }

    .btn-edit, .btn-delete {
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn-edit {
      background: #17a2b8;
      color: white;
    }

    .btn-edit:hover {
      background: #138496;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background: #c82333;
    }

    .entries-controls {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .entries-controls input, .entries-controls select {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .entries-controls input {
      flex: 1;
    }

    .entries-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .entries-summary {
      color: #666;
    }

    select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      font-size: 14px;
      width: 100%;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="header">
      <h1>üêï Trial Secretary Dashboard</h1>
      <div class="welcome-msg">Welcome back, <span id="username">User</span>!</div>
    </div>

    <!-- User Info Section -->
    <div class="user-info">
      <div class="user-details">
        <div>Logged in as: <span id="userEmail">user@example.com</span></div>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Quick Stats Section -->
    <div class="quick-stats">
      <h3>üìä Quick Stats</h3>
      <div id="statsContent">Loading statistics...</div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" onclick="showTab('main')">Main Tools</button>
      <button class="tab-button" onclick="showTab('entries')">Entry Management</button>
      <button class="tab-button" onclick="showTab('summaries')">Class Summaries</button>
      <button class="tab-button" onclick="showTab('reports')">Generated Reports</button>
    </div>

    <!-- Main Tools Tab -->
    <div id="main-tab" class="tab-content active">
      <div class="nav-grid">
        <div class="nav-card" onclick="location.href='create-trial.html'">
          <h3>üèÅ Create Trial</h3>
          <p>Set up a new trial with classes, dates, and judges</p>
          <button class="nav-button">Create New Trial</button>
        </div>
        
        <div class="nav-card" onclick="location.href='view-trials.html'">
          <h3>üìã My Trials</h3>
          <p>View and manage your existing trials</p>
          <button class="nav-button secondary">View Trials</button>
        </div>
        
        <div class="nav-card" onclick="location.href='trial-application.html'">
          <h3>üìÑ Trial Application</h3>
          <p>Generate trial application forms for submission</p>
          <button class="nav-button">Create Application</button>
        </div>
        
        <div class="nav-card" onclick="location.href='entry-form.html'">
          <h3>üêï Entry Forms</h3>
          <p>Manage dog entries and participant information</p>
          <button class="nav-button tertiary">Manage Entries</button>
        </div>
        
        <div class="nav-card" onclick="location.href='premium.html'">
          <h3>üèÜ Premium Generator</h3>
          <p>Generate professional premium lists for your trials</p>
          <button class="nav-button secondary">Generate Premium</button>
        </div>
        
        <div class="nav-card" onclick="location.href='waiver-generator.html'">
          <h3>üìù Waiver Generator</h3>
          <p>Create liability waivers for your events</p>
          <button class="nav-button tertiary">Generate Waivers</button>
        </div>

         <div class="nav-card" onclick="location.href='running-order.html'">
          <h3>üìù Running Order</h3>
          <p>Rearrange the running order of your event</p>
          <button class="nav-button tertiary">Running Order</button>
        </div>
        
        <div class="nav-card" onclick="location.href='scoresheet-generator.html'">
          <h3>üìã Score Sheets</h3>
          <p>Generate and manage official C-WAGS score sheets for judges</p>
          <button class="nav-button">Generate Score Sheets</button>
        </div>
      </div>
    </div>

    <!-- Entry Management Tab -->
    <div id="entries-tab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìù Entry Management</h2>
        <div style="color: #666; font-size: 14px;">View and edit entries for your trials</div>
      </div>

      <!-- Trial Selector for Entry Management -->
      <div class="trial-selector">
        <div class="form-group">
          <label for="entryManagementTrialSelect">Select Trial to Manage Entries:</label>
          <select id="entryManagementTrialSelect">
            <option value="">Loading trials...</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="loadEntryManagement()">Load Entries</button>
      </div>

      <!-- Entries List -->
      <div id="entriesContainer" style="display: none;">
        <div class="entries-header">
          <h3 id="entriesTitle">Entries for Trial</h3>
          <div class="entries-summary">
            <span id="entriesCount">0 entries</span> ‚Ä¢ 
            <span id="totalFees">$0.00 total</span>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="entries-controls">
          <input type="text" id="entrySearch" placeholder="üîç Search by handler name, dog name, or registration...">
          <select id="classFilter">
            <option value="">All Classes</option>
          </select>
          <button onclick="exportEntries()" class="btn-secondary" style="white-space: nowrap;">
            üìä Export CSV
          </button>
        </div>

        <!-- Entries Table -->
        <div class="entries-table-container">
          <table id="entriesTable">
            <thead>
              <tr>
                <th>Handler</th>
                <th>Dog</th>
                <th>Registration</th>
                <th>Classes</th>
                <th>Judge</th>
                <th>Fee</th>
                <th>Submitted</th>
                <th style="text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody id="entriesTableBody">
              <!-- Entries will be populated here -->
            </tbody>
          </table>
        </div>

        <!-- No entries message -->
        <div id="noEntriesMessage" style="text-align: center; padding: 3rem; color: #666; display: none;">
          <h4>No entries found for this trial</h4>
          <p>Entries will appear here once participants submit them.</p>
        </div>
      </div>
    </div>

    <!-- Class Summaries Tab -->
    <div id="summaries-tab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìä Class Summaries</h2>
        <button class="btn btn-success" onclick="location.href='class-summary-generator.html'">+ Create New Summary</button>
      </div>
      <div id="summariesList">Loading summaries...</div>
    </div>

    <!-- Generated Reports Tab -->
    <div id="reports-tab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìÑ Generated Reports</h2>
        <div style="color: #666; font-size: 14px;">Access your generated premium lists, applications, and other documents</div>
      </div>
      <div id="reportsList">
        <div class="no-summaries">
          <h4>üìã Available Reports</h4>
          <p>Your generated reports will appear here. Use the tools above to create:</p>
          <ul style="text-align: left; display: inline-block; margin-top: 15px;">
            <li>Trial Applications</li>
            <li>Premium Lists</li>
            <li>Waiver Forms</li>
            <li>Running Orders</li>
            <li>Score Sheets</li>
            <li>Class Summaries</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

 <script type="module">
    // Firebase imports
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
    // ========================================
    // TIMEZONE-SAFE DATE UTILITIES
    // ========================================
    
    function prepareDateForFirebase(dateStr) {
      if (!dateStr) return null;
      const localDate = new Date(dateStr + 'T12:00:00');
      return localDate.toISOString().split('T')[0];
    }

    function getDateFromFirebase(firebaseDate) {
      if (!firebaseDate) return null;
      if (typeof firebaseDate === 'string') {
        return firebaseDate;
      }
      if (firebaseDate.toDate) {
        return firebaseDate.toDate().toISOString().split('T')[0];
      }
      return firebaseDate.toString().split('T')[0];
    }

    function formatDateDisplay(dateStr, options = {}) {
      if (!dateStr) return 'No date';
      try {
        const date = new Date(dateStr + 'T12:00:00');
        const defaultOptions = {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        };
        return date.toLocaleDateString('en-US', {...defaultOptions, ...options});
      } catch (error) {
        console.error('Date formatting error:', error);
        return dateStr;
      }
    }

    function testDateHandling() {
      const testDate = '2025-07-15';
      console.log('1. Original date string:', testDate);
      
      const forFirebase = prepareDateForFirebase(testDate);
      console.log('2. Prepared for Firebase:', forFirebase);
      
      const fromFirebase = getDateFromFirebase(forFirebase);
      console.log('3. Retrieved from Firebase:', fromFirebase);
      
      const display = formatDateDisplay(fromFirebase);
      console.log('4. Formatted for display:', display);
      
      const matches = fromFirebase === testDate;
      console.log('5. Round-trip successful:', matches);
      
      if (!matches) {
        console.error('‚ùå Date handling is still broken!');
      } else {
        console.log('‚úÖ Date handling is working correctly!');
      }
    }

    let authCheckComplete = false;
    let currentUser = null;
    let availableTrials = [];
    let currentTrialEntries = [];
    let filteredEntries = [];

    // Tab Management
    window.showTab = function(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked button
      event.target.classList.add('active');
      
      // Load content for specific tabs
      if (tabName === 'summaries') {
        loadSummaries();
      } else if (tabName === 'reports') {
        loadReports();
      } else if (tabName === 'entries') {
        loadEntryManagement();
      }
    };

    // Entry Management Functions
    async function loadEntryManagement() {
      console.log("üìù Loading entry management...");
      
      if (!currentUser) {
        console.log("No user found for entry management");
        return;
      }

      // Load trials for entry management
      await loadTrialsForEntryManagement();
    }

    // JUDGE FIX FUNCTIONS - Added here for Entry Management
    async function loadTrialEntriesWithJudges(trialId) {
      console.log("üìù Loading entries with real judge names for trial:", trialId);
      
      try {
        // Load trial data
        const trialDoc = await getDoc(doc(db, 'trials', trialId));
        if (!trialDoc.exists()) {
          alert('Trial not found');
          return;
        }
        
        const trialData = trialDoc.data();
        
        // Load all entries for this trial
        const q = query(
          collection(db, "entries"),
          where("trialId", "==", trialId)
        );
        const snapshot = await getDocs(q);
        
        const entries = [];
        snapshot.forEach(doc => {
          const entry = { id: doc.id, ...doc.data() };
          
          // CRITICAL: Ensure judge name is visible (same as running order)
          if (!entry.judgeName && entry.judge) {
            entry.judgeName = entry.judge;
          }
          // Default to 'TBD' if no judge found
          if (!entry.judgeName) {
            entry.judgeName = 'TBD';
          }
          
          entries.push(entry);
        });
        
        console.log("‚úÖ Loaded entries with judge data:", entries);
        
        // Update the entry management display
        displayEntriesWithCorrectJudges(entries, trialData);
        
      } catch (error) {
        console.error("‚ùå Error loading entry management:", error);
        alert('Error loading entries: ' + error.message);
      }
    }

    function displayEntriesWithCorrectJudges(entries, trialData) {
      const container = document.getElementById('entryManagementResults');
      if (!container) {
        console.error("‚ùå Could not find entry management results container");
        return;
      }
      
      let html = `<h3>üìã Entries for ${trialData.clubName || 'Trial'}</h3>`;
      
      if (entries.length === 0) {
        html += '<p>No entries found for this trial.</p>';
      } else {
        html += `
          <div class="entries-table-container">
            <table id="entriesTable">
              <thead>
                <tr>
                  <th>Handler</th>
                  <th>Dog</th>
                  <th>Class</th>
                  <th>Round</th>
                  <th>Judge</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        entries.forEach(entry => {
          // Use the same judge resolution as running order
          const judgeName = entry.judgeName || 'TBD';
          const judgeStyle = judgeName === 'TBD' ? 'background-color: #ffebee; color: #c62828;' : 'background-color: #e8f5e8; color: #2e7d32;';
          
          html += `
            <tr>
              <td>${entry.handlerName || 'Unknown'}</td>
              <td>${entry.dogCallName || 'Unknown'}</td>
              <td>${entry.className || 'Unknown'}</td>
              <td>${entry.roundNumber || '1'}</td>
              <td style="${judgeStyle}"><strong>${judgeName}</strong></td>
              <td>${entry.date || 'Unknown'}</td>
              <td>${entry.status || 'Pending'}</td>
              <td class="entry-actions">
                <button class="btn-edit" onclick="editEntry('${entry.id}')">‚úèÔ∏è Edit</button>
                <button class="btn-delete" onclick="deleteEntry('${entry.id}')">üóëÔ∏è Delete</button>
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
          <div class="entries-summary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <strong>Summary:</strong> 
            Total entries: ${entries.length} | 
            Entries with judges assigned: <span style="color: #2e7d32; font-weight: bold;">${entries.filter(e => e.judgeName && e.judgeName !== 'TBD').length}</span> | 
            Entries with TBD judges: <span style="color: #c62828; font-weight: bold;">${entries.filter(e => !e.judgeName || e.judgeName === 'TBD').length}</span>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }

    // Enhanced entry management loading function with full functionality
    window.loadEntryManagement = async function() {
      const trialId = document.getElementById('entryManagementTrialSelect').value;
      
      if (!trialId) {
        alert('Please select a trial first');
        return;
      }
      
      console.log("üìù Loading entry management for trial:", trialId);
      await loadTrialEntries(trialId);
    };

    // Load entries for a specific trial (RESTORED ORIGINAL FUNCTIONALITY)
    async function loadTrialEntries(trialId) {
      console.log("üìä Loading entries for trial:", trialId);
      
      try {
        const entriesQuery = query(
          collection(db, "entries"),
          where("trialId", "==", trialId)
        );
        
        const entriesSnapshot = await getDocs(entriesQuery);
        currentTrialEntries = [];
        
        entriesSnapshot.forEach(doc => {
          const entryData = doc.data();
          
          // Fix selected entries dates using global date fix
          if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
            entryData.selectedEntries = entryData.selectedEntries.map(entry => ({
              ...entry,
              date: entry.date ? getDateFromFirebase(entry.date) : null,
              // CRITICAL: Ensure judge name is visible (same as running order)
              judgeName: entry.judgeName || entry.judge || 'TBD'
            }));
          }
          
          currentTrialEntries.push({ id: doc.id, ...entryData });
        });
        
        console.log(`‚úÖ Loaded ${currentTrialEntries.length} entries`);
        
        // Update UI
        displayEntries();
        populateClassFilter();
        document.getElementById('entriesContainer').style.display = 'block';
        
      } catch (error) {
        console.error("‚ùå Error loading entries:", error);
        alert('Error loading entries: ' + error.message);
      }
    }

    // Display entries in table (RESTORED ORIGINAL FUNCTIONALITY)
    function displayEntries(entriesToShow = null) {
      const entries = entriesToShow || currentTrialEntries;
      const tableBody = document.getElementById('entriesTableBody');
      const noEntriesMsg = document.getElementById('noEntriesMessage');
      
      if (entries.length === 0) {
        tableBody.innerHTML = '';
        noEntriesMsg.style.display = 'block';
        updateEntriesSummary(0, 0);
        return;
      }
      
      noEntriesMsg.style.display = 'none';
      
      // Calculate total fees
      let totalFees = 0;
      entries.forEach(entry => {
        totalFees += entry.totalFee || 0;
      });
      
      // Update summary
      updateEntriesSummary(entries.length, totalFees);
      
      // Generate table rows
      tableBody.innerHTML = entries.map(entry => {
        const submittedDate = entry.submittedAt ? entry.submittedAt.toDate() : new Date();
        
        // Handle both new selectedEntries format and legacy selectedClasses
        const classesHtml = entry.selectedEntries ? 
          entry.selectedEntries.map(selectedEntry => {
            const feoClass = selectedEntry.entryType === 'feo' ? ' feo' : '';
            const feoText = selectedEntry.entryType === 'feo' ? ' (FEO)' : '';
            const judgeName = selectedEntry.judgeName || selectedEntry.judge || 'TBD';
            return `<span class="entry-class-item${feoClass}">${selectedEntry.className}${feoText} - ${judgeName}</span>`;
          }).join(' ') : 
          (entry.selectedClasses || []).map(className => 
            `<span class="entry-class-item">${className}</span>`
          ).join(' ');

        // Get primary judge for this entry
        const primaryJudge = entry.selectedEntries && entry.selectedEntries.length > 0 ? 
          (entry.selectedEntries[0].judgeName || entry.selectedEntries[0].judge || 'TBD') : 'TBD';
        const judgeStyle = primaryJudge === 'TBD' ? 'color: #c62828; font-weight: bold;' : 'color: #2e7d32; font-weight: bold;';
        
        return `
          <tr>
            <td>
              <strong>${entry.handlerName || 'N/A'}</strong><br>
              <small style="color: #666;">${entry.handlerEmail || ''}</small>
            </td>
            <td>
              <strong>${entry.dogCallName || 'N/A'}</strong><br>
              <small style="color: #666;">${entry.dogBreed || ''}</small>
            </td>
            <td>${entry.cwagsNumber || 'Not provided'}</td>
            <td class="entry-classes">${classesHtml}</td>
            <td style="${judgeStyle}">${primaryJudge}</td>
            <td><strong>${(entry.totalFee || 0).toFixed(2)}</strong></td> 
            <td>
              <small>${submittedDate.toLocaleDateString()}<br>
              ${submittedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>
            </td>
            <td>
              <div class="entry-actions">
                <a href="entry-form.html?entry=${entry.id}" class="btn-edit" target="_blank">
                  ‚úèÔ∏è Edit
                </a>
                <button onclick="deleteEntry('${entry.id}')" class="btn-delete">
                  üóëÔ∏è Delete
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update entries summary
    function updateEntriesSummary(count, totalFees) {
      document.getElementById('entriesCount').textContent = `${count} entries`;
      document.getElementById('totalFees').textContent = `${totalFees.toFixed(2)} total`;
    }

    // Populate class filter dropdown (RESTORED)
    function populateClassFilter() {
      const classFilter = document.getElementById('classFilter');
      const allClasses = new Set();
      
      currentTrialEntries.forEach(entry => {
        if (entry.selectedEntries) {
          entry.selectedEntries.forEach(selectedEntry => {
            allClasses.add(selectedEntry.className);
          });
        } else if (entry.selectedClasses) {
          entry.selectedClasses.forEach(className => {
            allClasses.add(className);
          });
        }
      });
      
      classFilter.innerHTML = '<option value="">All Classes</option>';
      Array.from(allClasses).sort().forEach(className => {
        const option = document.createElement('option');
        option.value = className;
        option.textContent = className;
        classFilter.appendChild(option);
      });
    }

    // Filter entries based on search and class filter (RESTORED)
    function filterEntries() {
      const searchTerm = document.getElementById('entrySearch').value.toLowerCase();
      const classFilter = document.getElementById('classFilter').value;
      
      const filtered = currentTrialEntries.filter(entry => {
        // Search filter
        const matchesSearch = !searchTerm || 
          (entry.handlerName && entry.handlerName.toLowerCase().includes(searchTerm)) ||
          (entry.dogCallName && entry.dogCallName.toLowerCase().includes(searchTerm)) ||
          (entry.cwagsNumber && entry.cwagsNumber.toLowerCase().includes(searchTerm)) ||
          (entry.handlerEmail && entry.handlerEmail.toLowerCase().includes(searchTerm));
        
        // Class filter
        const matchesClass = !classFilter || 
          (entry.selectedEntries && entry.selectedEntries.some(se => se.className === classFilter)) ||
          (entry.selectedClasses && entry.selectedClasses.includes(classFilter));
        
        return matchesSearch && matchesClass;
      });
      
      displayEntries(filtered);
    }

    // Export entries to CSV (RESTORED)
    window.exportEntries = function() {
      if (currentTrialEntries.length === 0) {
        alert('No entries to export');
        return;
      }
      
      const headers = ['Handler Name', 'Handler Email', 'Dog Call Name', 'Dog Breed', 'CWAGS Number', 'Classes', 'Total Fee', 'Submitted Date'];
      const csvData = [headers];
      
      currentTrialEntries.forEach(entry => {
        const classes = entry.selectedEntries ? 
          entry.selectedEntries.map(se => `${se.className}${se.entryType === 'feo' ? ' (FEO)' : ''}`).join('; ') :
          (entry.selectedClasses || []).join('; ');
        
        const submittedDate = entry.submittedAt ? entry.submittedAt.toDate().toLocaleDateString() : '';
        
        csvData.push([
          entry.handlerName || '',
          entry.handlerEmail || '',
          entry.dogCallName || '',
          entry.dogBreed || '',
          entry.cwagsNumber || '',
          classes,
          (entry.totalFee || 0).toFixed(2),
          submittedDate
        ]);
      });
      
      const csvContent = csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `trial-entries-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    };

    async function loadTrialsForEntryManagement() {
      try {
        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        availableTrials = [];
        
        trialsSnapshot.forEach(doc => {
          const trialData = doc.data();
          
          // Fix date handling for trial days using global date fix
          if (trialData.days && Array.isArray(trialData.days)) {
            trialData.days = trialData.days.map(day => ({
              ...day,
              date: day.date ? getDateFromFirebase(day.date) : null
            }));
          }
          
          availableTrials.push({ id: doc.id, ...trialData });
        });
        
        availableTrials.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
        
        // Populate trial selector
        const entryTrialSelect = document.getElementById('entryManagementTrialSelect');
        entryTrialSelect.innerHTML = '<option value="">Choose a trial...</option>';
        
        availableTrials.forEach(trial => {
          const option = document.createElement('option');
          option.value = trial.id;
          
          let trialLabel = trial.clubName || 'Unnamed Trial';
          if (trial.days && trial.days.length > 0) {
            const dates = trial.days
              .filter(day => day.date)
              .map(day => {
                // Use timezone-safe date formatting
                const localDate = createLocalDate(day.date);
                return localDate.toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: 'numeric' 
                });
              })
              .join(', ');
            if (dates) {
              trialLabel += ` (${dates})`;
            }
          }
          
          option.textContent = trialLabel;
          entryTrialSelect.appendChild(option);
        });
        
        // Setup search and filter
        document.getElementById('entrySearch').addEventListener('input', filterEntries);
        document.getElementById('classFilter').addEventListener('change', filterEntries);
        
        console.log(`‚úÖ Loaded ${availableTrials.length} trials for entry management`);
        
      } catch (error) {
        console.error("‚ùå Error loading trials for entry management:", error);
      }
    }

    // Global functions for entry actions
    window.editEntry = function(entryId) {
      // Redirect to entry form with entry ID for editing
      window.location.href = `entry-form.html?entry=${entryId}`;
    };

    window.deleteEntry = async function(entryId) {
      if (confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
        try {
          await deleteDoc(doc(db, 'entries', entryId));
          alert('Entry deleted successfully');
          // Reload the current trial's entries
          const trialId = document.getElementById('entryManagementTrialSelect').value;
          if (trialId) {
            await loadTrialEntriesWithJudges(trialId);
          }
        } catch (error) {
          console.error('Error deleting entry:', error);
          alert('Error deleting entry: ' + error.message);
        }
      }
    };

    // Summary Management Functions
    async function loadSummaries() {
      console.log("üìä Loading summaries...");
      
      if (!currentUser) {
        console.log("No user found for summaries");
        return;
      }

      try {
        const summariesQuery = query(
          collection(db, "classSummaries"),
          where("createdBy", "==", currentUser.uid)
        );
        
        const summariesSnapshot = await getDocs(summariesQuery);
        const summariesList = document.getElementById('summariesList');
        
        if (summariesSnapshot.empty) {
          summariesList.innerHTML = `
            <div class="no-summaries">
              <h4>üìã No Class Summaries Yet</h4>
              <p>You haven't created any class summaries yet.</p>
              <button class="btn btn-success" onclick="location.href='class-summary-generator.html'">Create Your First Summary</button>
            </div>
          `;
          return;
        }

        let summariesHTML = '<div class="summary-list">';
        
        summariesSnapshot.forEach(doc => {
          const summary = doc.data();
          const createdDate = summary.createdAt ? summary.createdAt.toDate().toLocaleDateString() : 'Unknown date';
          
          summariesHTML += `
            <div class="summary-item">
              <div class="summary-info">
                <h4>${summary.trialName || 'Unnamed Summary'}</h4>
                <div class="summary-meta">
                  Created: ${createdDate} | 
                  Classes: ${summary.classes ? summary.classes.length : 0}
                </div>
              </div>
              <div class="summary-actions">
                <button class="btn btn-secondary" onclick="viewSummary('${doc.id}')">View</button>
                <button class="btn btn-warning" onclick="editSummary('${doc.id}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteSummary('${doc.id}', '${summary.trialName || 'this summary'}')">Delete</button>
              </div>
            </div>
          `;
        });
        
        summariesHTML += '</div>';
        summariesList.innerHTML = summariesHTML;
        
      } catch (error) {
        console.error("Error loading summaries:", error);
        document.getElementById('summariesList').innerHTML = 
          '<div class="no-summaries">Error loading summaries: ' + error.message + '</div>';
      }
    }

    // Summary action functions
    window.viewSummary = function(summaryId) {
      window.location.href = `class-summary-generator.html?view=${summaryId}`;
    };

    window.editSummary = function(summaryId) {
      window.location.href = `class-summary-generator.html?edit=${summaryId}`;
    };

    window.deleteSummary = async function(summaryId, summaryName) {
      if (confirm(`Are you sure you want to delete "${summaryName}"? This cannot be undone.`)) {
        try {
          await deleteDoc(doc(db, 'classSummaries', summaryId));
          alert('Summary deleted successfully');
          loadSummaries(); // Reload the list
        } catch (error) {
          console.error('Error deleting summary:', error);
          alert('Error deleting summary: ' + error.message);
        }
      }
    };

    // Reports loading function
    function loadReports() {
      console.log("üìÑ Loading reports...");
      // This is a placeholder - you can expand this based on your needs
      const reportsList = document.getElementById('reportsList');
      reportsList.innerHTML = `
        <div class="no-summaries">
          <h4>üìã Available Reports</h4>
          <p>Your generated reports will appear here. Use the tools above to create:</p>
          <ul style="text-align: left; display: inline-block; margin-top: 15px;">
            <li>Trial Applications</li>
            <li>Premium Lists</li>
            <li>Waiver Forms</li>
            <li>Running Orders</li>
            <li>Score Sheets</li>
            <li>Class Summaries</li>
          </ul>
        </div>
      `;
    }

    // Authentication and initialization
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      currentUser = user;
      authCheckComplete = true;

      // Update UI with user info
      const username = user.email.split('@')[0];
      document.getElementById('username').textContent = username;
      document.getElementById('userEmail').textContent = user.email;

      // Load initial stats
      await loadStats(user);

      console.log("Dashboard initialized for user:", user.email);
    });

    // Load user statistics
    async function loadStats(user) {
      try {
        // Count trials
        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", user.uid)
        );
        const trialsSnapshot = await getDocs(trialsQuery);

        // Count applications
        const appsQuery = query(
          collection(db, "applications"),
          where("createdBy", "==", user.uid)
        );
        const appsSnapshot = await getDocs(appsQuery);

        // Count summaries
        const summariesQuery = query(
          collection(db, "classSummaries"),
          where("createdBy", "==", user.uid)
        );
        const summariesSnapshot = await getDocs(summariesQuery);

        // Count total entries across all trials
        let totalEntries = 0;
        const entriesQuery = query(collection(db, "entries"));
        const entriesSnapshot = await getDocs(entriesQuery);
        
        // Get trial IDs for this user
        const userTrialIds = trialsSnapshot.docs.map(doc => doc.id);
        
        entriesSnapshot.forEach(doc => {
          const entryData = doc.data();
          if (userTrialIds.includes(entryData.trialId)) {
            totalEntries++;
          }
        });

        const statsHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${trialsSnapshot.size}</div>
              <div style="font-size: 14px; color: #666;">Trials Created</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #e91e63;">${totalEntries}</div>
              <div style="font-size: 14px; color: #666;">Total Entries</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${appsSnapshot.size}</div>
              <div style="font-size: 14px; color: #666;">Applications</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">${summariesSnapshot.size}</div>
              <div style="font-size: 14px; color: #666;">Class Summaries</div>
            </div>
          </div>
        `;
        
        document.getElementById('statsContent').innerHTML = statsHTML;
        
      } catch (error) {
        console.error("Error loading stats:", error);
        document.getElementById('statsContent').innerHTML = 
          '<p style="color: #666;">Unable to load statistics</p>';
      }
    }

    // Logout function
    window.logout = async function() {
      if (confirm("Are you sure you want to logout?")) {
        try {
          console.log("Logging out...");
          await signOut(auth);
          window.location.href = 'index.html';
        } catch (error) {
          console.error("Logout error:", error);
          alert("Error logging out: " + error.message);
        }
      }
    };

  </script>
</body>
</html>
