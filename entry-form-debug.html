<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Trial Entry Form - Debug Version</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .debug-info {
            background: #fffacd;
            border: 2px solid #ddd;
            padding: 1rem;
            margin: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .debug-info h3 {
            margin-top: 0;
            color: #d32f2f;
        }

        .form-container {
            padding: 2rem;
        }

        .trial-selection {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid #2196F3;
        }

        .trial-selection h3 {
            margin-top: 0;
            color: #333;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .classes-container {
            margin-top: 2rem;
        }

        .day-tab {
            display: inline-block;
            padding: 12px 24px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
            transition: all 0.3s;
        }

        .day-tab.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        .day-content {
            border: 1px solid #ddd;
            border-radius: 0 8px 8px 8px;
            padding: 2rem;
            background: white;
            min-height: 300px;
        }

        .class-group {
            margin-bottom: 2rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .class-header {
            background: #f5f5f5;
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            font-weight: bold;
            color: #333;
        }

        .rounds-container {
            padding: 1rem;
        }

        .round-entry {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            background: #fafafa;
        }

        .round-entry:last-child {
            margin-bottom: 0;
        }

        .round-label {
            flex: 1;
            font-weight: 500;
            color: #555;
        }

        .entry-button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .entry-button:hover {
            background: #45a049;
        }

        .entry-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
        }

        .round-info {
            font-size: 0.85rem;
            color: #666;
            margin-left: 1rem;
        }

        .debug-section {
            background: #f0f8ff;
            border: 2px solid #0066cc;
            margin: 1rem;
            padding: 1rem;
            border-radius: 8px;
        }

        .debug-section h4 {
            margin-top: 0;
            color: #0066cc;
        }

        .debug-data {
            background: #fff;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêï Dog Trial Entry Form - DEBUG VERSION</h1>
            <p>Enhanced with Per-Round Entry Support</p>
        </div>

        <div class="debug-info">
            <h3>üîç DEBUG MODE ACTIVE</h3>
            <p>This version includes detailed debugging to understand your trial data structure.</p>
            <p>Check the console (F12) for detailed logs when you select a trial.</p>
        </div>

        <div class="form-container">
            <div class="trial-selection">
                <h3>Select Trial</h3>
                <select id="trialSelect">
                    <option value="">Choose a trial...</option>
                </select>
            </div>

            <div id="debugSection" class="debug-section" style="display: none;">
                <h4>üîç Trial Data Structure</h4>
                <div id="debugData" class="debug-data"></div>
            </div>

            <div id="classEntriesContainer" class="classes-container" style="display: none;">
                <!-- Class entry tabs will be generated here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCbmbWZ2lH9ikUMFPpqH1nRB-czpXzYjDs",
            authDomain: "trial-secretary-cf449.firebaseapp.com",
            projectId: "trial-secretary-cf449",
            storageBucket: "trial-secretary-cf449.firebasestorage.app",
            messagingSenderId: "966447755244",
            appId: "1:966447755244:web:abe33b9bcf0143b5f0b7b6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        console.log("üéØ DEBUG Entry form loaded - VERSION 3.0 WITH FULL DEBUGGING");

        let currentTrialData = null;
        let trialsData = [];

        // Mock auth for testing
        function mockAuth() {
            console.log("üîß Setting up mock authentication");
            setTimeout(() => {
                console.log("‚úÖ Mock authentication successful");
                loadTrials();
            }, 1000);
        }

        // Load trials from Firestore
        async function loadTrials() {
            try {
                console.log("üìä Loading trials from Firestore...");
                const trialsCollection = collection(db, 'trials');
                const snapshot = await getDocs(trialsCollection);
                
                trialsData = [];
                snapshot.forEach(doc => {
                    trialsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`‚úÖ Loaded ${trialsData.length} trials`);
                populateTrialSelect();
            } catch (error) {
                console.error("‚ùå Error loading trials:", error);
                // Fallback: show debug message
                showDebugMessage("Error loading trials. Using debug mode.");
            }
        }

        function populateTrialSelect() {
            const select = document.getElementById('trialSelect');
            select.innerHTML = '<option value="">Choose a trial...</option>';
            
            trialsData.forEach(trial => {
                const option = document.createElement('option');
                option.value = trial.id;
                option.textContent = `${trial.name} - ${new Date(trial.startDate).toLocaleDateString()}`;
                select.appendChild(option);
            });

            select.addEventListener('change', handleTrialSelection);
        }

        async function handleTrialSelection(event) {
            const trialId = event.target.value;
            if (!trialId) {
                document.getElementById('classEntriesContainer').style.display = 'none';
                document.getElementById('debugSection').style.display = 'none';
                return;
            }

            console.log(`üéØ Trial selected: ${trialId}`);
            
            try {
                // Find trial in our data
                currentTrialData = trialsData.find(t => t.id === trialId);
                
                if (!currentTrialData) {
                    console.error("‚ùå Trial not found in loaded data");
                    return;
                }

                console.log("‚úÖ Found trial data:", currentTrialData.name);
                
                // Show debug information
                showDebugInformation();
                
                // Generate the class interface
                generateTabbedClasses();
                
            } catch (error) {
                console.error("‚ùå Error handling trial selection:", error);
                showDebugMessage(`Error: ${error.message}`);
            }
        }

        function showDebugInformation() {
            console.log("üîç DEBUGGING: Showing trial data structure");
            console.log("üîç DEBUGGING: Full trial data:", currentTrialData);
            
            const debugSection = document.getElementById('debugSection');
            const debugData = document.getElementById('debugData');
            
            // Make trial data available globally for console inspection
            window.debugTrialData = currentTrialData;
            
            let debugHtml = `
                <strong>Trial:</strong> ${currentTrialData.name}<br>
                <strong>Start Date:</strong> ${currentTrialData.startDate}<br>
                <strong>Has days property:</strong> ${!!(currentTrialData.days)}<br>
            `;

            if (currentTrialData.days) {
                debugHtml += `<strong>Number of days:</strong> ${currentTrialData.days.length}<br><br>`;
                
                currentTrialData.days.forEach((day, dayIndex) => {
                    debugHtml += `<strong>Day ${dayIndex + 1}:</strong><br>`;
                    debugHtml += `&nbsp;&nbsp;Date: ${day.date}<br>`;
                    debugHtml += `&nbsp;&nbsp;Classes: ${day.classes ? day.classes.length : 'NONE'}<br>`;
                    
                    if (day.classes && day.classes.length > 0) {
                        day.classes.forEach((cls, classIndex) => {
                            debugHtml += `&nbsp;&nbsp;&nbsp;&nbsp;Class ${classIndex + 1}: ${cls.name}<br>`;
                            debugHtml += `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Has rounds: ${!!(cls.rounds)}<br>`;
                            if (cls.rounds) {
                                debugHtml += `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rounds count: ${cls.rounds.length}<br>`;
                                cls.rounds.forEach((round, roundIndex) => {
                                    debugHtml += `&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Round ${roundIndex + 1}: ${round.name || 'Unnamed'}<br>`;
                                });
                            }
                        });
                    }
                    debugHtml += '<br>';
                });
            } else {
                debugHtml += '<strong style="color: red;">NO DAYS PROPERTY FOUND!</strong><br>';
            }

            debugData.innerHTML = debugHtml;
            debugSection.style.display = 'block';
        }

        function generateTabbedClasses() {
            console.log("üéØ Generating tabbed classes from trial data");
            console.log("üîç DEBUGGING: Trial data structure:", currentTrialData);
            console.log("üîç DEBUGGING: Has days?", !!(currentTrialData && currentTrialData.days));
            
            if (!currentTrialData.days || currentTrialData.days.length === 0) {
                console.log("‚ùå No days found in trial data");
                document.getElementById('classEntriesContainer').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #666;">No classes available for this trial.</div>';
                return;
            }

            console.log("üîç DEBUGGING: Number of days:", currentTrialData.days.length);
            console.log("üîç DEBUGGING: First day data:", currentTrialData.days[0]);
            
            if (currentTrialData.days[0] && currentTrialData.days[0].classes) {
                console.log("üîç DEBUGGING: First day has classes:", currentTrialData.days[0].classes.length);
                console.log("üîç DEBUGGING: First class data:", currentTrialData.days[0].classes[0]);
                
                if (currentTrialData.days[0].classes[0] && currentTrialData.days[0].classes[0].rounds) {
                    console.log("üîç DEBUGGING: First class has rounds:", currentTrialData.days[0].classes[0].rounds.length);
                    console.log("üîç DEBUGGING: First round data:", currentTrialData.days[0].classes[0].rounds[0]);
                } else {
                    console.log("‚ùå DEBUGGING: First class has NO rounds property!");
                }
            } else {
                console.log("‚ùå DEBUGGING: First day has NO classes!");
            }

            const container = document.getElementById('classEntriesContainer');
            let html = '';

            // Create day tabs
            if (currentTrialData.days.length > 1) {
                html += '<div class="day-tabs">';
                currentTrialData.days.forEach((day, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    html += `<div class="day-tab ${isActive}" onclick="showDay(${index})">
                        Day ${index + 1} - ${new Date(day.date).toLocaleDateString()}
                    </div>`;
                });
                html += '</div>';
            }

            // Create day content
            currentTrialData.days.forEach((day, dayIndex) => {
                const isActive = dayIndex === 0 ? 'block' : 'none';
                html += `<div class="day-content" id="day-${dayIndex}" style="display: ${isActive};">`;
                
                if (day.classes && day.classes.length > 0) {
                    console.log(`üîç DEBUGGING: Processing day ${dayIndex + 1} with ${day.classes.length} classes`);
                    
                    day.classes.forEach((cls, classIndex) => {
                        console.log(`üîç DEBUGGING: Processing class ${classIndex + 1}: ${cls.name}`);
                        console.log(`üîç DEBUGGING: Class has rounds?`, !!(cls.rounds));
                        
                        html += `<div class="class-group">
                            <div class="class-header">${cls.name}</div>
                            <div class="rounds-container">`;
                        
                        if (cls.rounds && cls.rounds.length > 0) {
                            console.log(`üîç DEBUGGING: Class ${cls.name} has ${cls.rounds.length} rounds`);
                            
                            cls.rounds.forEach((round, roundIndex) => {
                                console.log(`üîç DEBUGGING: Processing round ${roundIndex + 1}: ${round.name || 'Unnamed'}`);
                                
                                html += `<div class="round-entry">
                                    <div class="round-label">
                                        ${round.name || `Round ${roundIndex + 1}`}
                                        <div class="round-info">
                                            ${round.time ? `Time: ${round.time}` : ''}
                                            ${round.maxDogs ? ` | Max Dogs: ${round.maxDogs}` : ''}
                                        </div>
                                    </div>
                                    <button class="entry-button" onclick="enterRound('${dayIndex}', '${classIndex}', '${roundIndex}')">
                                        Enter This Round
                                    </button>
                                </div>`;
                            });
                        } else {
                            console.log(`‚ùå DEBUGGING: Class ${cls.name} has NO rounds - creating fallback`);
                            html += `<div class="round-entry">
                                <div class="round-label">
                                    ${cls.name}
                                    <div class="round-info">No specific rounds defined</div>
                                </div>
                                <button class="entry-button" onclick="enterClass('${dayIndex}', '${classIndex}')">
                                    Enter This Class
                                </button>
                            </div>`;
                        }
                        
                        html += '</div></div>';
                    });
                } else {
                    console.log(`‚ùå DEBUGGING: Day ${dayIndex + 1} has NO classes`);
                    html += '<div style="text-align: center; padding: 2rem; color: #666;">No classes scheduled for this day.</div>';
                }
                
                html += '</div>';
            });

            container.innerHTML = html;
            container.style.display = 'block';
            console.log("‚úÖ Tabbed classes generated successfully");
        }

        function showDebugMessage(message) {
            const container = document.getElementById('classEntriesContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
            container.style.display = 'block';
        }

        // Global functions for buttons
        window.showDay = function(dayIndex) {
            // Hide all day contents
            document.querySelectorAll('.day-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.day-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected day and activate tab
            document.getElementById(`day-${dayIndex}`).style.display = 'block';
            document.querySelectorAll('.day-tab')[dayIndex].classList.add('active');
        };

        window.enterRound = function(dayIndex, classIndex, roundIndex) {
            const day = currentTrialData.days[dayIndex];
            const cls = day.classes[classIndex];
            const round = cls.rounds[roundIndex];
            
            console.log(`üéØ Entering round: Day ${parseInt(dayIndex) + 1}, Class ${cls.name}, Round ${round.name || roundIndex + 1}`);
            alert(`Entry for:\nClass: ${cls.name}\nRound: ${round.name || `Round ${parseInt(roundIndex) + 1}`}\n\nThis would open the entry form for this specific round.`);
        };

        window.enterClass = function(dayIndex, classIndex) {
            const day = currentTrialData.days[dayIndex];
            const cls = day.classes[classIndex];
            
            console.log(`üéØ Entering class: Day ${parseInt(dayIndex) + 1}, Class ${cls.name}`);
            alert(`Entry for:\nClass: ${cls.name}\n\nThis would open the entry form for this class.`);
        };

        // Initialize the application
        console.log("üöÄ Initializing DEBUG application...");
        mockAuth();
    </script>
</body>
</html>
