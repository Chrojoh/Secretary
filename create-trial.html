<!DOCTYPE html>
<html>
<head>
  <title>Create Trial</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .back-button {
      background-color: #007cba;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .back-button:hover {
      background-color: #005a8b;
    }
    
    .day-container {
      border: 1px solid #ccc;
      padding: 15px;
      margin: 10px 0;
      background-color: #f9f9f9;
    }
    
    .class-container {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 5px 0;
      background-color: #fff;
    }
    
    .round-container {
      padding: 5px;
      margin: 2px 0;
      background-color: #f0f0f0;
    }
    
    .form-section {
      margin-bottom: 15px;
    }
    
    .form-section label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-section input {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .days-input-section {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #dee2e6;
      margin: 20px 0;
    }
    
    .create-days-btn {
      background-color: #17a2b8;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .create-days-btn:hover {
      background-color: #138496;
    }
    
    .save-trial-btn {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      cursor: pointer;
      margin-top: 20px;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
    }
    
    .save-trial-btn:hover {
      background-color: #45a049;
    }
    
    .save-trial-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <button class="back-button" onclick="location.href='main-dashboard.html'">‚Üê Back to Dashboard</button>
  <h1>Create Trial</h1>
  
  <!-- Basic Trial Information -->
  <div class="form-section">
    <label>Club Name:</label>
    <input type="text" name="clubName" placeholder="Enter Club Name" style="width: 300px;">
  </div>
  
  <div class="form-section">
    <label>Trial Secretary:</label>
    <input type="text" name="secretary" placeholder="Enter Trial Secretary Name" style="width: 300px;">
  </div>
  
  <!-- Days Section - Separate from main form -->
  <div class="days-input-section">
    <label>How many days?</label>
    <input type="number" id="numDays" min="1" max="10" style="width: 100px;" placeholder="1-10">
    <button type="button" class="create-days-btn" onclick="generateDays()">Create Days</button>
    <p style="margin-top: 10px; color: #666; font-size: 14px;">
      <strong>Note:</strong> Enter the number of days and click "Create Days" to set up your trial schedule.
    </p>
  </div>
  
  <!-- Days Container -->
  <div id="daysContainer"></div>
  
  <!-- Save Button - Outside of form to prevent accidental submission -->
  <div style="text-align: center; margin: 30px 0;">
    <button type="button" class="save-trial-btn" onclick="saveTrialData()">Save Trial</button>
  </div>

  <script type="module">
    import { db, auth } from './js/firebase.js';
    import { addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    console.log("Fixed Create Trial script loading...");

    // Simple predefined lists to avoid JSON loading issues
    const DEFAULT_CLASSES = [
      "Scent Work Novice Birch", "Scent Work Novice Anise", "Scent Work Novice Clove",
      "Scent Work Open Birch", "Scent Work Open Anise", "Scent Work Open Clove",
      "Scent Work Advanced Birch", "Scent Work Advanced Anise", "Scent Work Advanced Clove",
      "Scent Work Expert Birch", "Scent Work Expert Anise", "Scent Work Expert Clove",
      "Scent Work Master Birch", "Scent Work Master Anise", "Scent Work Master Clove"
    ];

    const DEFAULT_JUDGES = [
      "Judge 1", "Judge 2", "Judge 3", "Judge 4", "Judge 5"
    ];

    let globalClasses = DEFAULT_CLASSES;
    let globalJudges = DEFAULT_JUDGES;

    // Prevent Enter key from triggering unwanted actions
    document.addEventListener('keydown', function(event) {
      // If Enter is pressed in the numDays input, trigger Create Days instead of form submission
      if (event.key === 'Enter' && event.target.id === 'numDays') {
        event.preventDefault();
        generateDays();
        return;
      }
      
      // Prevent Enter key from submitting anywhere else in the form
      if (event.key === 'Enter' && event.target.tagName !== 'BUTTON') {
        // Allow Enter in textareas for line breaks
        if (event.target.tagName !== 'TEXTAREA') {
          event.preventDefault();
        }
      }
    });

    // Generate days function
    window.generateDays = function() {
      const numDays = parseInt(document.getElementById('numDays').value);
      
      if (!numDays || numDays < 1 || numDays > 10) {
        alert("Please enter a valid number of days (1-10)");
        return;
      }
      
      const daysContainer = document.getElementById('daysContainer');
      daysContainer.innerHTML = '';
      
      console.log(`Generating ${numDays} days...`);
      
      for (let i = 0; i < numDays; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day-container';
        dayDiv.innerHTML = `
          <h3>Day ${i + 1}</h3>
          <label>Date:</label>
          <input type="date" name="date${i}" style="margin-bottom: 10px;">
          
          <label>Number of classes for Day ${i + 1}:</label>
          <input type="number" id="numClasses${i}" min="1" max="20" style="width: 80px; margin-right: 10px;">
          <button type="button" onclick="generateClasses(${i})">Create Classes</button>
          
          <div class="classes-container-${i}" style="margin-top: 15px;"></div>
        `;
        daysContainer.appendChild(dayDiv);
      }
    };

    // Generate classes function
    window.generateClasses = function(dayIndex) {
      const numClasses = parseInt(document.getElementById(`numClasses${dayIndex}`).value);
      
      if (!numClasses || numClasses < 1 || numClasses > 20) {
        alert("Please enter a valid number of classes (1-20)");
        return;
      }
      
      const classesContainer = document.querySelector(`.classes-container-${dayIndex}`);
      classesContainer.innerHTML = '';
      
      console.log(`Generating ${numClasses} classes for day ${dayIndex + 1}...`);
      
      for (let j = 0; j < numClasses; j++) {
        const classDiv = document.createElement('div');
        classDiv.className = 'class-container';
        classDiv.innerHTML = `
          <h4>Class ${j + 1}</h4>
          <label>Class Name:</label>
          <select data-day="${dayIndex}" data-class="${j}" style="width: 250px; margin-right: 10px;">
            <option value="">Select a class...</option>
            ${globalClasses.map(cls => `<option value="${cls}">${cls}</option>`).join('')}
          </select>
          
          <label>Number of rounds:</label>
          <input type="number" id="numRounds${dayIndex}-${j}" min="1" max="5" style="width: 60px; margin-right: 10px;" value="1">
          <button type="button" onclick="generateRounds(${dayIndex}, ${j})">Create Rounds</button>
          
          <div class="rounds-container-${dayIndex}-${j}" style="margin-top: 10px;"></div>
        `;
        classesContainer.appendChild(classDiv);
        
        // Auto-generate 1 round by default
        setTimeout(() => generateRounds(dayIndex, j), 100);
      }
    };

    // Generate rounds function
    window.generateRounds = function(dayIndex, classIndex) {
      const numRounds = parseInt(document.getElementById(`numRounds${dayIndex}-${classIndex}`).value) || 1;
      
      const roundsContainer = document.querySelector(`.rounds-container-${dayIndex}-${classIndex}`);
      roundsContainer.innerHTML = '';
      
      console.log(`Generating ${numRounds} rounds for day ${dayIndex + 1}, class ${classIndex + 1}...`);
      
      for (let k = 0; k < numRounds; k++) {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'round-container';
        roundDiv.innerHTML = `
          <strong>Round ${k + 1}:</strong>
          <label>Judge:</label>
          <select data-day="${dayIndex}" data-class="${classIndex}" data-round="${k}" style="width: 150px; margin-left: 10px;">
            <option value="">Select judge...</option>
            ${globalJudges.map(judge => `<option value="${judge}">${judge}</option>`).join('')}
          </select>
        `;
        roundsContainer.appendChild(roundDiv);
      }
    };

    // Save trial data function
    window.saveTrialData = async function() {
      try {
        console.log("Save Trial button clicked");
        
        // Wait for auth state to be ready
        if (!auth.currentUser) {
          console.log("No current user, waiting for auth...");
          await new Promise((resolve) => {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              unsubscribe();
              resolve();
            });
          });
        }
        
        if (!auth.currentUser) {
          alert("You must be logged in to save a trial");
          window.location.href = "index.html";
          return;
        }
        
        console.log("User confirmed:", auth.currentUser.email);
        
        const clubName = document.querySelector('input[name="clubName"]').value;
        const secretary = document.querySelector('input[name="secretary"]').value;
        
        if (!clubName.trim()) {
          alert("Please enter a club name");
          return;
        }
        
        if (!secretary.trim()) {
          alert("Please enter a trial secretary name");
          return;
        }
        
        // Show saving status
        const saveButton = document.querySelector('.save-trial-btn');
        const originalText = saveButton.textContent;
        saveButton.textContent = "Saving...";
        saveButton.disabled = true;
        
        // Collect ALL the trial data
        const trialData = collectAllTrialData();
        
        console.log("Saving complete trial data:", trialData);
        
        const docRef = await addDoc(collection(db, "trials"), trialData);
        console.log("Trial saved with ID:", docRef.id);
        
        // Reset button
        saveButton.textContent = originalText;
        saveButton.disabled = false;
        
        // Show success message
        alert("Trial saved successfully!");
        
        // Go back to dashboard
        console.log("Redirecting to dashboard...");
        window.location.href = "dashboard.html";
        
      } catch (error) {
        console.error("Error saving trial:", error);
        alert("Error saving trial: " + error.message);
        
        // Reset button on error
        const saveButton = document.querySelector('.save-trial-btn');
        if (saveButton) {
          saveButton.textContent = "Save Trial";
          saveButton.disabled = false;
        }
      }
    };

    // Collect all trial data function
    function collectAllTrialData() {
      const clubName = document.querySelector('input[name="clubName"]').value;
      const secretary = document.querySelector('input[name="secretary"]').value;
      const numDays = parseInt(document.getElementById('numDays').value) || 0;
      
      const days = [];
      const daysContainer = document.getElementById('daysContainer');
      
      if (daysContainer) {
        const dayContainers = daysContainer.querySelectorAll('.day-container');
        
        dayContainers.forEach((dayContainer, dayIndex) => {
          const dateInput = dayContainer.querySelector(`input[name="date${dayIndex}"]`);
          const classesContainer = dayContainer.querySelector(`.classes-container-${dayIndex}`);
          
          const dayData = {
            dayNumber: dayIndex + 1,
            date: dateInput ? dateInput.value : '',
            classes: []
          };
          
          if (classesContainer) {
            const classContainers = classesContainer.querySelectorAll('.class-container');
            
            classContainers.forEach((classContainer, classIndex) => {
              const classSelect = classContainer.querySelector(`select[data-day="${dayIndex}"][data-class="${classIndex}"]`);
              const roundsContainer = classContainer.querySelector(`.rounds-container-${dayIndex}-${classIndex}`);
              
              const classData = {
                classNumber: classIndex + 1,
                className: classSelect ? classSelect.value : '',
                rounds: []
              };
              
              if (roundsContainer) {
                const roundSelects = roundsContainer.querySelectorAll(`select[data-day="${dayIndex}"][data-class="${classIndex}"]`);
                
                roundSelects.forEach((roundSelect, roundIndex) => {
                  const roundData = {
                    roundNumber: roundIndex + 1,
                    judge: roundSelect.value || ''
                  };
                  classData.rounds.push(roundData);
                });
              }
              
              dayData.classes.push(classData);
            });
          }
          
          days.push(dayData);
        });
      }
      
      return {
        clubName: clubName,
        secretary: secretary,
        numDays: numDays,
        days: days,
        createdAt: new Date(),
        createdBy: auth.currentUser.uid
      };
    }

    console.log("Fixed Create Trial script loaded successfully");
  </script>
</body>
</html>
