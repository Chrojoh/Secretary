<!DOCTYPE html>
<html>
<head>
  <title>Create Trial</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .back-button {
      background-color: #007cba;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-ra<!DOCTYPE html>
<html>
<head>
  <title>Create Trial</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .back-button {
      background-color: #007cba;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .back-button:hover {
      background-color: #005a8b;
    }
    
    .day-container {
      border: 1px solid #ccc;
      padding: 15px;
      margin: 10px 0;
      background-color: #f9f9f9;
    }
    
    .class-container {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 5px 0;
      background-color: #fff;
    }
    
    .round-container {
      padding: 5px;
      margin: 2px 0;
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <button class="back-button" onclick="location.href='dashboard.html'">← Back to Dashboard</button>
  <h1>Create Trial</h1>
  <form id="trialForm">
    <div style="margin-bottom: 15px;">
      <label>Club Name:</label><br>
      <input type="text" name="clubName" placeholder="Club Name" style="width: 300px; padding: 5px;">
    </div>
    
    <div style="margin-bottom: 15px;">
      <label>Trial Secretary:</label><br>
      <input type="text" name="secretary" placeholder="Trial Secretary" style="width: 300px; padding: 5px;">
    </div>
    
    <div style="margin-bottom: 15px;">
      <label>How many days?</label><br>
      <input type="number" id="numDays" min="1" max="10" style="width: 100px; padding: 5px;">
      <button type="button" onclick="generateDays()">Create Days</button>
    </div>
    
    <div id="daysContainer"></div>
    
    <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-top: 20px;">Save Trial</button>
  </form>

  <script type="module">
    import { db, auth } from './js/firebase.js';
    import { addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // Simple predefined lists to avoid JSON loading issues
    const DEFAULT_CLASSES = [
      "Patrol 1", "Detective 2", "Investigator 3", "Super Sleuth 4", "Private Inv",
      "Novice A", "Novice B", "Open A", "Open B", "Utility A", "Utility B"
    ];

    const DEFAULT_JUDGES = [
      "Linda Alberta", "Ginger Alpine", "Paige Alpine-Malone", "Anita Amemnt", "Denise Ames",
      "Judge 1", "Judge 2", "Judge 3", "Judge 4", "Judge 5"
    ];

    let globalClasses = [...DEFAULT_CLASSES];
    let globalJudges = [...DEFAULT_JUDGES];

    // Try to load data but don't depend on it
    try {
      fetch('./js/data.json')
        .then(res => res.json())
        .then(data => {
          console.log("Data loaded, extracting classes and judges");
          
          const extractedClasses = [];
          const extractedJudges = [];
          
          if (Array.isArray(data)) {
            data.forEach(record => {
              if (record.Class && record.Class.trim() && !extractedClasses.includes(record.Class.trim())) {
                extractedClasses.push(record.Class.trim());
              }
              if (record.Judges && record.Judges.trim() && !extractedJudges.includes(record.Judges.trim())) {
                extractedJudges.push(record.Judges.trim());
              }
            });
          }
          
          if (extractedClasses.length > 0) {
            globalClasses = extractedClasses;
            console.log("Using extracted classes:", globalClasses.length);
          }
          if (extractedJudges.length > 0) {
            globalJudges = extractedJudges;
            console.log("Using extracted judges:", globalJudges.length);
          }
        })
        .catch(err => {
          console.log("Using default classes and judges due to error:", err);
        });
    } catch (e) {
      console.log("Using default classes and judges");
    }

    console.log("Create trial page script loaded successfully");

    // Make functions globally accessible
    window.generateDays = generateDays;
    window.generateClasses = generateClasses;
    window.generateRounds = generateRounds;

    // Event listeners setup
    document.addEventListener('DOMContentLoaded', function() {
      // Delegate event listeners for dynamically created elements
      document.addEventListener('change', function(e) {
        if (e.target.classList.contains('classes-input')) {
          generateClasses(e.target);
        } else if (e.target.classList.contains('rounds-select')) {
          generateRounds(e.target);
        }
      });
    });

    function generateDays() {
      try {
        console.log("generateDays function called");
        
        const numDaysInput = document.getElementById("numDays");
        const numDays = parseInt(numDaysInput.value);
        
        if (isNaN(numDays) || numDays < 1) {
          alert("Please enter a valid number of days (1 or more)");
          return;
        }
        
        const container = document.getElementById("daysContainer");
        container.innerHTML = "";

        for (let d = 0; d < numDays; d++) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "day-container";
          dayDiv.innerHTML = `
            <h3>Day ${d + 1}</h3>
            <div style="margin-bottom: 10px;">
              <label>Date:</label>
              <input type="date" name="date${d}" style="margin-left: 10px;">
            </div>
            <div style="margin-bottom: 10px;">
              <label>How many classes?</label>
              <input type="number" min="1" max="20" class="classes-input" data-day="${d}" onchange="generateClasses(this)" style="margin-left: 10px; width: 60px;">
            </div>
            <div class="classes-container-${d}"></div>
          `;
          container.appendChild(dayDiv);
        }
        
        console.log(`Generated ${numDays} day containers successfully`);
        
      } catch (error) {
        console.error("Error in generateDays:", error);
        alert("Error creating days: " + error.message);
      }
    }

    function generateClasses(input) {
      try {
        console.log("generateClasses function called");
        
        const dayIndex = input.getAttribute('data-day');
        const num = parseInt(input.value);
        
        if (isNaN(num) || num < 1) {
          return;
        }
        
        const container = document.querySelector(`.classes-container-${dayIndex}`);
        if (!container) {
          console.error("Could not find container for day", dayIndex);
          return;
        }
        
        container.innerHTML = "";
        
        console.log(`Creating ${num} classes for day ${dayIndex}`);
        
        for (let i = 0; i < num; i++) {
          const classDiv = document.createElement("div");
          classDiv.className = "class-container";
          
          const classOptions = globalClasses.map(c => `<option value="${c}">${c}</option>`).join("");
          
          classDiv.innerHTML = `
            <h4>Class ${i + 1}</h4>
            <div style="margin-bottom: 10px;">
              <label>Class Type:</label>
              <select data-day="${dayIndex}" data-class="${i}" style="margin-left: 10px; width: 200px;">
                <option value="">Select Class</option>
                ${classOptions}
              </select>
            </div>
            <div style="margin-bottom: 10px;">
              <label>Number of Rounds:</label>
              <select class="rounds-select" data-day="${dayIndex}" data-class="${i}" onchange="generateRounds(this)" style="margin-left: 10px;">
                <option value="">Select rounds</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="rounds-container-${dayIndex}-${i}"></div>
          `;
          
          container.appendChild(classDiv);
        }
        
        console.log(`Successfully created ${num} classes`);
        
      } catch (error) {
        console.error("Error in generateClasses:", error);
        alert("Error creating classes: " + error.message);
      }
    }

    function generateRounds(select) {
      try {
        console.log("generateRounds function called");
        
        const dayIndex = select.getAttribute('data-day');
        const classIndex = select.getAttribute('data-class');
        const num = parseInt(select.value);
        
        if (isNaN(num) || num < 1) {
          return;
        }
        
        const container = document.querySelector(`.rounds-container-${dayIndex}-${classIndex}`);
        if (!container) {
          console.error("Could not find rounds container");
          return;
        }
        
        container.innerHTML = "";
        
        const judgeOptions = globalJudges.map(j => `<option value="${j}">${j}</option>`).join("");
        
        for (let i = 0; i < num; i++) {
          const roundDiv = document.createElement("div");
          roundDiv.className = "round-container";
          roundDiv.innerHTML = `
            <strong>Round ${i + 1}:</strong>
            <select style="margin-left: 10px; width: 150px;">
              <option value="">Select Judge</option>
              ${judgeOptions}
            </select>
            <label style="margin-left: 15px;">
              <input type="checkbox"> FEO
            </label>
          `;
          container.appendChild(roundDiv);
        }
        
        console.log(`Successfully created ${num} rounds`);
        
      } catch (error) {
        console.error("Error in generateRounds:", error);
        alert("Error creating rounds: " + error.message);
      }
    }

    // Simple form submission
    document.getElementById('trialForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        if (!auth.currentUser) {
          alert("You must be logged in");
          return;
        }
        
        const clubName = document.querySelector('input[name="clubName"]').value;
        const secretary = document.querySelector('input[name="secretary"]').value;
        
        if (!clubName.trim()) {
          alert("Please enter a club name");
          return;
        }
        
        // Simple data collection
        const trialData = {
          clubName: clubName,
          secretary: secretary,
          numDays: parseInt(document.getElementById('numDays').value) || 0,
          createdAt: new Date(),
          createdBy: auth.currentUser.uid,
          days: [] // We'll keep this simple for now
        };
        
        console.log("Saving trial data:", trialData);
        
        const docRef = await addDoc(collection(db, "trials"), trialData);
        console.log("Trial saved with ID:", docRef.id);
        
        alert("Trial saved successfully!");
        window.location.href = "dashboard.html";
        
      } catch (error) {
        console.error("Error saving trial:", error);
        alert("Error saving trial: " + error.message);
      }
    });

    console.log("Create trial page script loaded successfully");
  </script>
</body>
</html>dius: 5px;
      margin-bottom: 20px;
    }
    
    .back-button:hover {
      background-color: #005a8b;
    }
  </style>
</head>
<body>
  <button class="back-button" onclick="location.href='dashboard.html'">← Back to Dashboard</button>
  <h1>Create Trial</h1>
  <form id="trialForm">
    <input type="text" name="clubName" placeholder="Club Name">
    <input type="text" name="secretary" placeholder="Trial Secretary">
    <label>How many days?</label>
    <input type="number" id="numDays" min="1">
    <button type="button" onclick="generateDays()">Create Days</button>
    <div id="daysContainer"></div>
    <button type="submit">Save Trial</button>
  </form>
  <script type="module" src="js/create-trial.js"></script>
</body>
</html>
