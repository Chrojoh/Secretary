<!DOCTYPE html>
<html>
<head>
  <title>Create Trial</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .back-button {
      background-color: #007cba;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .back-button:hover {
      background-color: #005a8b;
    }
    
    .day-container {
      border: 1px solid #ccc;
      padding: 15px;
      margin: 10px 0;
      background-color: #f9f9f9;
    }
    
    .class-container {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 5px 0;
      background-color: #fff;
    }
    
    .round-container {
      padding: 5px;
      margin: 2px 0;
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <button class="back-button" onclick="location.href='dashboard.html'">‚Üê Back to Dashboard</button>
  <h1>Create Trial</h1>
  <form id="trialForm">
    <div style="margin-bottom: 15px;">
      <label>Club Name:</label><br>
      <input type="text" name="clubName" placeholder="Club Name" style="width: 300px; padding: 5px;">
    </div>
    
    <div style="margin-bottom: 15px;">
      <label>Trial Secretary:</label><br>
      <input type="text" name="secretary" placeholder="Trial Secretary" style="width: 300px; padding: 5px;">
    </div>
    
    <div style="margin-bottom: 15px;">
      <label>How many days?</label><br>
      <input type="number" id="numDays" min="1" max="10" style="width: 100px; padding: 5px;">
      <button type="button" onclick="generateDays()">Create Days</button>
    </div>
    
    <div id="daysContainer"></div>
    
    <button type="submit" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-top: 20px;">Save Trial</button>
  </form>

  <script type="module">
    import { db, auth } from './js/firebase.js';
    import { addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    console.log("Script starting to load...");

    // Simple predefined lists to avoid JSON loading issues
    const DEFAULT_CLASSES = [
      "Patrol 1", "Detective 2", "Investigator 3", "Super Sleuth 4", "Private Inv",
      "Novice A", "Novice B", "Open A", "Open B", "Utility A", "Utility B"
    ];

    const DEFAULT_JUDGES = [
      "Linda Alberta", "Ginger Alpine", "Paige Alpine-Malone", "Anita Amemnt", "Denise Ames",
      "Judge 1", "Judge 2", "Judge 3", "Judge 4", "Judge 5"
    ];

    let globalClasses = [...DEFAULT_CLASSES];
    let globalJudges = [...DEFAULT_JUDGES];

    console.log("Default classes and judges loaded");

    // Define functions that will be called by onclick
    function generateDays() {
      try {
        console.log("generateDays function called");
        
        const numDaysInput = document.getElementById("numDays");
        const numDays = parseInt(numDaysInput.value);
        
        if (isNaN(numDays) || numDays < 1) {
          alert("Please enter a valid number of days (1 or more)");
          return;
        }
        
        const container = document.getElementById("daysContainer");
        container.innerHTML = "";

        for (let d = 0; d < numDays; d++) {
          const dayDiv = document.createElement("div");
          dayDiv.className = "day-container";
          dayDiv.innerHTML = `
            <h3>Day ${d + 1}</h3>
            <div style="margin-bottom: 10px;">
              <label>Date:</label>
              <input type="date" name="date${d}" style="margin-left: 10px;">
            </div>
            <div style="margin-bottom: 10px;">
              <label>How many classes?</label>
              <input type="number" min="1" max="20" data-day="${d}" onchange="generateClasses(this)" style="margin-left: 10px; width: 60px;">
            </div>
            <div class="classes-container-${d}"></div>
          `;
          container.appendChild(dayDiv);
        }
        
        console.log(`Generated ${numDays} day containers successfully`);
        
      } catch (error) {
        console.error("Error in generateDays:", error);
        alert("Error creating days: " + error.message);
      }
    }

    function generateClasses(input) {
      try {
        console.log("generateClasses function called");
        
        const dayIndex = input.getAttribute('data-day');
        const num = parseInt(input.value);
        
        if (isNaN(num) || num < 1) {
          return;
        }
        
        const container = document.querySelector(`.classes-container-${dayIndex}`);
        if (!container) {
          console.error("Could not find container for day", dayIndex);
          return;
        }
        
        container.innerHTML = "";
        
        console.log(`Creating ${num} classes for day ${dayIndex}`);
        console.log("Using classes:", globalClasses);
        
        for (let i = 0; i < num; i++) {
          const classDiv = document.createElement("div");
          classDiv.className = "class-container";
          
          const classOptions = globalClasses.map(c => `<option value="${c}">${c}</option>`).join("");
          
          classDiv.innerHTML = `
            <h4>Class ${i + 1}</h4>
            <div style="margin-bottom: 10px;">
              <label>Class Type:</label>
              <select data-day="${dayIndex}" data-class="${i}" style="margin-left: 10px; width: 200px;">
                <option value="">Select Class</option>
                ${classOptions}
              </select>
            </div>
            <div style="margin-bottom: 10px;">
              <label>Number of Rounds:</label>
              <select onchange="generateRounds(this)" data-day="${dayIndex}" data-class="${i}" style="margin-left: 10px;">
                <option value="">Select rounds</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="rounds-container-${dayIndex}-${i}"></div>
          `;
          
          container.appendChild(classDiv);
        }
        
        console.log(`Successfully created ${num} classes`);
        
      } catch (error) {
        console.error("Error in generateClasses:", error);
        alert("Error creating classes: " + error.message);
      }
    }

    function generateRounds(select) {
      try {
        console.log("generateRounds function called");
        
        const dayIndex = select.getAttribute('data-day');
        const classIndex = select.getAttribute('data-class');
        const num = parseInt(select.value);
        
        if (isNaN(num) || num < 1) {
          return;
        }
        
        const container = document.querySelector(`.rounds-container-${dayIndex}-${classIndex}`);
        if (!container) {
          console.error("Could not find rounds container");
          return;
        }
        
        container.innerHTML = "";
        
        const judgeOptions = globalJudges.map(j => `<option value="${j}">${j}</option>`).join("");
        
        for (let i = 0; i < num; i++) {
          const roundDiv = document.createElement("div");
          roundDiv.className = "round-container";
          roundDiv.innerHTML = `
            <strong>Round ${i + 1}:</strong>
            <select style="margin-left: 10px; width: 150px;">
              <option value="">Select Judge</option>
              ${judgeOptions}
            </select>
            <label style="margin-left: 15px;">
              <input type="checkbox"> FEO
            </label>
          `;
          container.appendChild(roundDiv);
        }
        
        console.log(`Successfully created ${num} rounds`);
        
      } catch (error) {
        console.error("Error in generateRounds:", error);
        alert("Error creating rounds: " + error.message);
      }
    }

    // Make functions globally available for onclick handlers
    window.generateDays = generateDays;
    window.generateClasses = generateClasses;
    window.generateRounds = generateRounds;

    console.log("Functions attached to window object");

    // Try to load data but don't depend on it
    fetch('./js/data.json')
      .then(res => res.json())
      .then(data => {
        console.log("JSON data loaded, extracting classes and judges");
        
        const extractedClasses = [];
        const extractedJudges = [];
        
        if (Array.isArray(data)) {
          data.forEach(record => {
            if (record.Class && record.Class.trim() && !extractedClasses.includes(record.Class.trim())) {
              extractedClasses.push(record.Class.trim());
            }
            if (record.Judges && record.Judges.trim() && !extractedJudges.includes(record.Judges.trim())) {
              extractedJudges.push(record.Judges.trim());
            }
          });
        }
        
        if (extractedClasses.length > 0) {
          globalClasses = extractedClasses;
          console.log("Using extracted classes:", globalClasses.length);
        }
        if (extractedJudges.length > 0) {
          globalJudges = extractedJudges;
          console.log("Using extracted judges:", globalJudges.length);
        }
      })
      .catch(err => {
        console.log("Using default classes and judges due to error:", err);
      });

    // Form submission - only save when user clicks Save Trial button
    document.getElementById('trialForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        console.log("Save Trial button clicked");
        
        // Wait for auth state to be properly loaded
        if (!auth.currentUser) {
          console.log("No current user, waiting for auth...");
          await new Promise((resolve) => {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              unsubscribe();
              resolve();
            });
          });
        }
        
        if (!auth.currentUser) {
          alert("You must be logged in to save a trial");
          window.location.href = "index.html";
          return;
        }
        
        console.log("User confirmed:", auth.currentUser.email);
        
        const clubName = document.querySelector('input[name="clubName"]').value;
        const secretary = document.querySelector('input[name="secretary"]').value;
        
        if (!clubName.trim()) {
          alert("Please enter a club name");
          return;
        }
        
        if (!secretary.trim()) {
          alert("Please enter a trial secretary name");
          return;
        }
        
        // Show saving status
        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.textContent = "Saving...";
        submitButton.disabled = true;
        
        // Collect ALL the trial data including classes, rounds, and judges
        const trialData = collectAllTrialData();
        
        console.log("Saving complete trial data:", trialData);
        
        const docRef = await addDoc(collection(db, "trials"), trialData);
        console.log("Trial saved with ID:", docRef.id);
        
        // Reset button
        submitButton.textContent = originalText;
        submitButton.disabled = false;
        
        // Go directly back to dashboard
        console.log("Redirecting to dashboard...");
        window.location.href = "dashboard.html";
        
      } catch (error) {
        console.error("Error saving trial:", error);
        alert("Error saving trial: " + error.message);
        
        // Reset button on error
        const submitButton = e.target.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.textContent = "Save Trial";
          submitButton.disabled = false;
        }
      }
    });

    // Function to collect ALL trial data - classes, rounds, judges, everything
    function collectAllTrialData() {
      const clubName = document.querySelector('input[name="clubName"]').value;
      const secretary = document.querySelector('input[name="secretary"]').value;
      const numDays = parseInt(document.getElementById('numDays').value) || 0;
      
      const days = [];
      const daysContainer = document.getElementById('daysContainer');
      
      if (daysContainer) {
        const dayContainers = daysContainer.querySelectorAll('.day-container');
        
        dayContainers.forEach((dayContainer, dayIndex) => {
          const dateInput = dayContainer.querySelector(`input[name="date${dayIndex}"]`);
          const classesContainer = dayContainer.querySelector(`.classes-container-${dayIndex}`);
          
          const dayData = {
            dayNumber: dayIndex + 1,
            date: dateInput ? dateInput.value : '',
            classes: []
          };
          
          if (classesContainer) {
            const classContainers = classesContainer.querySelectorAll('.class-container');
            
            classContainers.forEach((classContainer, classIndex) => {
              const classSelect = classContainer.querySelector(`select[data-day="${dayIndex}"][data-class="${classIndex}"]`);
              const roundsSelect = classContainer.querySelector(`select[data-day="${dayIndex}"][data-class="${classIndex}"]`);
              const roundsContainer = classContainer.querySelector(`.rounds-container-${dayIndex}-${classIndex}`);
              
              const classData = {
                classNumber: classIndex + 1,
                className: classSelect ? classSelect.value : '',
                rounds: []
              };
              
              if (roundsContainer) {
                const roundContainers = roundsContainer.querySelectorAll('.round-container');
                
                roundContainers.forEach((roundContainer, roundIndex) => {
                  const judgeSelect = roundContainer.querySelector('select');
                  const feoCheckbox = roundContainer.querySelector('input[type="checkbox"]');
                  
                  const roundData = {
                    roundNumber: roundIndex + 1,
                    judge: judgeSelect ? judgeSelect.value : '',
                    feo: feoCheckbox ? feoCheckbox.checked : false
                  };
                  
                  classData.rounds.push(roundData);
                });
              }
              
              dayData.classes.push(classData);
            });
          }
          
          days.push(dayData);
        });
      }
      
      return {
        clubName: clubName,
        secretary: secretary,
        numDays: numDays,
        days: days,
        createdAt: new Date(),
        createdBy: auth.currentUser.uid
      };
    }

    console.log("Create trial page script loaded successfully");
  </script>
</body>
</html>
