<!DOCTYPE html>
<html>
<head>
  <title>My Trials</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .trial-list {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    .trial-item {
      border: 1px solid #ddd;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .trial-item h3 {
      margin: 10px 0 10px 0;
      color: #333;
    }
    .trial-details {
      color: #666;
      font-size: 14px;
    }
    .trial-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .trial-actions button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .view-btn { background: #17a2b8; color: white; }
    .edit-btn { background: #28a745; color: white; }
    .delete-btn { background: #dc3545; color: white; }
    .no-trials {
      text-align: center;
      color: #666;
      margin: 50px 0;
    }
    .back-button {
      background-color: #007cba;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="trial-list">
    <button class="back-button" onclick="location.href='main-dashboard.html'">‚Üê Back to Dashboard</button>
    <h1>My Trials</h1>
    <div id="trialList">Loading trials...</div>
  </div>

<script type="module">
import { auth, db } from './js/firebase.js';
import { collection, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

console.log("Script loading...");

const trialList = document.getElementById("trialList");

window.editTrial = function(trialId) {
  console.log("Edit clicked:", trialId);
  window.location.href = `edit-trial.html?id=${trialId}&mode=edit`;
};

window.viewTrial = function(trialId) {
  console.log("View clicked:", trialId);
  window.location.href = `edit-trial.html?id=${trialId}&mode=view`;
};

window.deleteTrial = async function(trialId, trialName) {
  if (confirm(`Delete "${trialName}"?`)) {
    try {
      await deleteDoc(doc(db, "trials", trialId));
      alert("Trial deleted!");
      location.reload();
    } catch (error) {
      alert("Error: " + error.message);
    }
  }
};

async function loadTrials(user) {
  try {
    console.log("Loading trials for:", user.email);
    
    const q = query(collection(db, "trials"), where("createdBy", "==", user.uid));
    const snapshot = await getDocs(q);
    
    if (snapshot.empty) {
      trialList.innerHTML = '<div class="no-trials">No trials found. <a href="create-trial.html">Create your first trial</a></div>';
      return;
    }
    
    trialList.innerHTML = '';
    
    const trials = [];
    snapshot.forEach(doc => {
      trials.push({ id: doc.id, ...doc.data() });
    });
    
    trials.sort((a, b) => {
      const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
      const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
      return dateB - dateA;
    });
    
    trials.forEach(trial => {
      const trialItem = document.createElement("div");
      trialItem.className = "trial-item";
      
      const createdDate = trial.createdAt ? trial.createdAt.toDate().toLocaleDateString() : "Unknown";
      
      let trialDates = "No dates";
      if (trial.days && trial.days.length > 0) {
        const dates = trial.days.filter(day => day.date).map(day => day.date).join(', ');
        if (dates) trialDates = dates;
      }
      
      let totalClasses = 0;
      if (trial.days) {
        trial.days.forEach(day => {
          if (day.classes) totalClasses += day.classes.length;
        });
      }
      
      trialItem.innerHTML = `
        <div class="trial-actions">
          <button class="view-btn" onclick="viewTrial('${trial.id}')">üëÅÔ∏è View</button>
          <button class="edit-btn" onclick="editTrial('${trial.id}')">‚úèÔ∏è Edit</button>
          <button class="delete-btn" onclick="deleteTrial('${trial.id}', '${(trial.clubName || 'Trial').replace(/'/g, '')}')"">üóëÔ∏è Delete</button>
        </div>
        <h3>${trial.clubName || 'Unnamed Trial'}</h3>
        <div class="trial-details">
          <strong>Secretary:</strong> ${trial.secretary || 'Not specified'}<br>
          <strong>Trial Dates:</strong> ${trialDates}<br>
          <strong>Total Classes:</strong> ${totalClasses}<br>
          <strong>Created:</strong> ${createdDate}
        </div>
      `;
      
      trialList.appendChild(trialItem);
    });
    
    console.log(`Loaded ${trials.length} trials`);
    
  } catch (error) {
    console.error("Error loading trials:", error);
    trialList.innerHTML = '<div class="no-trials">Error: ' + error.message + '</div>';
  }
}

auth.onAuthStateChanged(async user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  
  console.log("User authenticated");
  await loadTrials(user);
});
</script>
</body>
</html>
