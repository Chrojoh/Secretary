// ========================================
// CORE TIMEZONE-SAFE DATE UTILITIES
// ========================================

// Creates a date object that stays in local timezone
function createLocalDate(dateStr) {
    if (!dateStr) return null;
    
    // Always add noon time to prevent timezone shifts
    if (typeof dateStr === 'string') {
        const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
        return new Date(dateWithTime);
    }
    
    return new Date(dateStr);
}

// Formats a date to YYYY-MM-DD string in local timezone
function formatLocalDate(date) {
    if (!date || !(date instanceof Date)) return '';
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}

// Gets today's date in local timezone as YYYY-MM-DD string
function getTodayLocal() {
    const now = new Date();
    return formatLocalDate(now);
}

// Formats date for display with timezone consideration
function formatDateDisplay(dateInput, options = {}) {
    let date;
    
    if (typeof dateInput === 'string') {
        date = createLocalDate(dateInput);
    } else if (dateInput instanceof Date) {
        date = new Date(dateInput);
    } else {
        return 'Invalid Date';
    }
    
    if (!date || isNaN(date.getTime())) return 'Invalid Date';
    
    const defaultOptions = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
    
    const formatOptions = { ...defaultOptions, ...options };
    return new Intl.DateTimeFormat('en-US', formatOptions).format(date);
}

// Prepares date data for Firebase storage
function prepareDateForFirebase(dateStr) {
    if (!dateStr) return null;
    
    // Create a date that represents the exact local date at noon
    const localDate = createLocalDate(dateStr);
    
    // Store as a Firestore Timestamp to maintain precision
    return localDate;
}

// Retrieves date data from Firebase
function getDateFromFirebase(firebaseDate) {
    if (!firebaseDate) return '';
    
    let date;
    
    // Handle Firestore Timestamps
    if (firebaseDate.toDate) {
        date = firebaseDate.toDate();
    } else if (firebaseDate instanceof Date) {
        date = firebaseDate;
    } else if (typeof firebaseDate === 'string') {
        date = createLocalDate(firebaseDate);
    } else {
        return '';
    }
    
    return formatLocalDate(date);
}

// Entry Form specific save function
function saveEntryData(entryData) {
    // Fix selected entries dates
    if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
        entryData.selectedEntries = entryData.selectedEntries.map(entry => ({
            ...entry,
            date: entry.date ? prepareDateForFirebase(entry.date) : null
        }));
    }
    
    // Save to Firebase...
    return addDoc(collection(db, 'entries'), entryData);
}

// Entry Form specific load function
function loadEntryData(entryDoc) {
    const entryData = entryDoc.data();
    
    // Fix selected entries dates
    if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
        entryData.selectedEntries = entryData.selectedEntries.map(entry => ({
            ...entry,
            date: entry.date ? getDateFromFirebase(entry.date) : null
        }));
    }
    
    return entryData;
}

// Filter entries by date with timezone consideration
function filterEntriesByDate(entries, targetDate) {
    return entries.filter(entry => {
        // Use timezone-safe comparison
        const entryDate = getDateFromFirebase(entry.date);
        const filterDate = formatLocalDate(createLocalDate(targetDate));
        return entryDate === filterDate;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Add the "Back to Dashboard" button at the top
    const backButtonContainer = document.createElement('div');
    backButtonContainer.style.marginBottom = '20px';
    
    const backButton = document.createElement('button');
    backButton.textContent = 'Back to Dashboard';
    backButton.classList.add('btn', 'btn-secondary');
    backButton.addEventListener('click', function() {
        window.location.href = '/dashboard';
    });
    
    backButtonContainer.appendChild(backButton);
    
    // Get the main container and insert the back button at the top
    const mainContainer = document.querySelector('.container') || document.body;
    mainContainer.insertBefore(backButtonContainer, mainContainer.firstChild);
    
    // Rest of your entry form initialization code here
    initializeEntryForm();
});

function initializeEntryForm() {
    // Load trials from Firebase
    loadTrials().then(trials => {
        populateTrialDropdown(trials);
        
        // Event listener for trial selection
        const trialSelect = document.getElementById('trialSelect');
        trialSelect.addEventListener('change', function() {
            const selectedTrialId = trialSelect.value;
            if (selectedTrialId) {
                const selectedTrial = trials.find(trial => trial.id === selectedTrialId);
                if (selectedTrial) {
                    populateDaysDropdown(selectedTrial.days);
                }
            }
        });
        
        // Event listener for day selection
        const daySelect = document.getElementById('daySelect');
        daySelect.addEventListener('change', function() {
            const selectedDay = daySelect.value;
            if (selectedDay) {
                loadClassesForDay(selectedDay);
            }
        });
        
        // Other initialization code...
    });
    
    // Form submission handling
    const entryForm = document.getElementById('entryForm');
    entryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Collect form data
        const entryData = collectFormData();
        
        // Apply date fix before saving
        if (entryData.selectedEntries && Array.isArray(entryData.selectedEntries)) {
            entryData.selectedEntries = entryData.selectedEntries.map(entry => ({
                ...entry,
                date: entry.date ? prepareDateForFirebase(entry.date) : null
            }));
        }
        
        // Save to Firebase
        saveEntryData(entryData).then(() => {
            showSuccessMessage('Entry submitted successfully!');
            entryForm.reset();
        }).catch(error => {
            showErrorMessage('Error submitting entry: ' + error.message);
        });
    });
}

function loadTrials() {
    // Fetch trials from Firebase
    return getDocs(collection(db, 'trials')).then(snapshot => {
        return snapshot.docs.map(doc => {
            const data = doc.data();
            
            // Fix date handling for trial days
            if (data.days && Array.isArray(data.days)) {
                data.days = data.days.map(day => ({
                    ...day,
                    date: day.date ? getDateFromFirebase(day.date) : null
                }));
            }
            
            return {
                id: doc.id,
                ...data
            };
        });
    });
}

function populateTrialDropdown(trials) {
    const trialSelect = document.getElementById('trialSelect');
    trialSelect.innerHTML = '<option value="">Select a Trial</option>';
    
    trials.forEach(trial => {
        const option = document.createElement('option');
        option.value = trial.id;
        option.textContent = trial.name;
        trialSelect.appendChild(option);
    });
}

function populateDaysDropdown(days) {
    const daySelect = document.getElementById('daySelect');
    daySelect.innerHTML = '<option value="">Select a Day</option>';
    
    days.forEach(day => {
        const option = document.createElement('option');
        option.value = day.date;
        // Use the date fix for display
        option.textContent = formatDateDisplay(day.date);
        daySelect.appendChild(option);
    });
}

function loadClassesForDay(dayDate) {
    // Clear previous class selections
    const classesContainer = document.getElementById('classesContainer');
    classesContainer.innerHTML = '';
    
    // Load classes for the selected day from Firebase
    getDoc(doc(db, 'classes', dayDate)).then(doc => {
        if (doc.exists()) {
            const classes = doc.data().classes || [];
            
            // Display classes as checkboxes
            classes.forEach(classItem => {
                const classDiv = createClassCheckbox(classItem, dayDate);
                classesContainer.appendChild(classDiv);
            });
        } else {
            classesContainer.innerHTML = '<p>No classes available for this day.</p>';
        }
    }).catch(error => {
        console.error("Error loading classes:", error);
        classesContainer.innerHTML = '<p>Error loading classes. Please try again.</p>';
    });
}

function createClassCheckbox(classItem, dayDate) {
    const div = document.createElement('div');
    div.className = 'form-check mb-3';
    
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.className = 'form-check-input class-checkbox';
    input.id = `class_${classItem.id}`;
    input.dataset.classId = classItem.id;
    input.dataset.className = classItem.name;
    input.dataset.classPrice = classItem.price;
    input.dataset.classDate = dayDate;
    
    const label = document.createElement('label');
    label.className = 'form-check-label';
    label.htmlFor = `class_${classItem.id}`;
    label.textContent = `${classItem.name} - $${classItem.price}`;
    
    div.appendChild(input);
    div.appendChild(label);
    
    return div;
}

function collectFormData() {
    const formData = {
        handler: document.getElementById('handlerName').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        dogs: [],
        selectedEntries: [],
        submittedAt: new Date()
    };
    
    // Collect dog information
    const dogInputs = document.querySelectorAll('.dog-info');
    dogInputs.forEach(dogDiv => {
        const dogName = dogDiv.querySelector('.dog-name').value;
        const dogBreed = dogDiv.querySelector('.dog-breed').value;
        
        if (dogName && dogBreed) {
            formData.dogs.push({
                name: dogName,
                breed: dogBreed
            });
        }
    });
    
    // Collect selected classes
    const selectedClasses = document.querySelectorAll('.class-checkbox:checked');
    selectedClasses.forEach(checkbox => {
        formData.selectedEntries.push({
            classId: checkbox.dataset.classId,
            className: checkbox.dataset.className,
            price: parseFloat(checkbox.dataset.classPrice),
            date: checkbox.dataset.classDate,
            dogName: document.getElementById('dogForClass_' + checkbox.dataset.classId).value
        });
    });
    
    return formData;
}

function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success mt-3';
    alertDiv.textContent = message;
    
    const formContainer = document.querySelector('.container');
    formContainer.insertBefore(alertDiv, formContainer.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger mt-3';
    alertDiv.textContent = message;
    
    const formContainer = document.querySelector('.container');
    formContainer.insertBefore(alertDiv, formContainer.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Add dog button handler
document.getElementById('addDogBtn').addEventListener('click', function() {
    const dogsContainer = document.getElementById('dogsContainer');
    const dogCount = dogsContainer.children.length;
    
    const dogDiv = document.createElement('div');
    dogDiv.className = 'dog-info card mb-3 p-3';
    
    dogDiv.innerHTML = `
        <h5>Dog #${dogCount + 1}</h5>
        <div class="mb-3">
            <label for="dogName_${dogCount}" class="form-label">Dog's Name</label>
            <input type="text" class="form-control dog-name" id="dogName_${dogCount}" required>
        </div>
        <div class="mb-3">
            <label for="dogBreed_${dogCount}" class="form-label">Breed</label>
            <input type="text" class="form-control dog-breed" id="dogBreed_${dogCount}" required>
        </div>
        <button type="button" class="btn btn-danger remove-dog-btn">Remove Dog</button>
    `;
    
    dogsContainer.appendChild(dogDiv);
    
    // Add event listener to remove button
    dogDiv.querySelector('.remove-dog-btn').addEventListener('click', function() {
        dogDiv.remove();
    });
});

// Initialize Firebase
const firebaseConfig = {
    // Your Firebase config here
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
