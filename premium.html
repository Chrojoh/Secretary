<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 30px;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2.2rem;
    }
    
    .controls {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 2px solid #dee2e6;
    }
    
    .controls h2 {
      margin: 0 0 20px 0;
      color: #495057;
      font-size: 1.5rem;
    }
    
    .form-group {
      margin: 15px 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
    }

    .form-control, input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-control:focus, input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
      color: #212529;
    }

    .btn-primary {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .form-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .form-section h3 {
      margin-bottom: 15px;
      color: #495057;
    }

    .auto-filled {
      background: #e8f5e8 !important;
      border-color: #28a745 !important;
      transition: all 0.3s ease;
    }

    .loading-indicator {
      text-align: center;
      padding: 20px;
      color: #666;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 10px 0;
      display: none;
    }
    
    .premium-document {
      background: white;
      border: 2px solid #dee2e6;
      padding: 40px;
      margin: 30px 0;
      border-radius: 8px;
      display: none;
      font-family: 'Times New Roman', serif;
    }
    
    .premium-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 3px solid #000;
      padding-bottom: 20px;
    }
    
    .premium-header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: bold;
      text-transform: uppercase;
      color: #000;
    }
    
    .premium-header .subtitle {
      font-size: 18px;
      margin: 8px 0;
      font-weight: 600;
      color: #333;
    }
    
    .premium-section {
      margin: 25px 0;
      page-break-inside: avoid;
    }
    
    .premium-section h2 {
      background: #f0f0f0;
      padding: 12px;
      margin: 15px 0 10px 0;
      border: 2px solid #000;
      font-size: 16px;
      font-weight: bold;
      text-transform: uppercase;
      color: #000;
    }
    
    .judges-table, .classes-table, .fees-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    .judges-table th, .judges-table td,
    .classes-table th, .classes-table td,
    .fees-table th, .fees-table td {
      border: 1px solid #000;
      padding: 10px;
      text-align: left;
    }
    
    .judges-table th, .classes-table th, .fees-table th {
      background: #f0f0f0;
      font-weight: bold;
    }
    
    .contact-box {
      border: 3px solid #000;
      padding: 20px;
      background: #f9f9f9;
      margin: 20px 0;
      font-weight: 600;
    }

    .contact-box h2 {
      background: none;
      border: none;
      margin: 0 0 10px 0;
      padding: 0;
      font-size: 18px;
    }
    
    .maps-link {
      display: inline-block;
      background: #4285f4;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 5px;
      margin-top: 15px;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    
    .maps-link:hover {
      background: #3367d6;
    }

    .premium-list {
      list-style: none;
      padding: 0;
    }

    .premium-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .premium-list li:last-child {
      border-bottom: none;
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }

      .container {
        box-shadow: none;
        border: none;
        max-width: none;
        padding: 20px;
      }

      .controls, .loading-indicator, .button-group {
        display: none !important;
      }

      .premium-document {
        border: none;
        margin: 0;
        padding: 0;
        display: block !important;
      }

      .maps-link {
        display: none;
      }

      .premium-section {
        page-break-inside: avoid;
      }
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .button-group {
        flex-direction: column;
      }

      .premium-document {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèÜ Premium Generator</h1>
    
    <div class="controls">
      <h2>Trial Selection</h2>
      
      <div class="form-group">
        <label for="trialSelect">Select Trial:</label>
        <select id="trialSelect" class="form-control">
          <option value="">Select a trial...</option>
        </select>
      </div>
      
      <div class="loading-indicator" id="loadingIndicator">
        üîÑ Loading trials...
      </div>
      
      <div class="button-group">
        <button class="btn btn-warning" onclick="loadTrials()">üîÑ Load Trials</button>
        <button class="btn btn-success" onclick="generatePremium()" id="generateBtn" disabled>Generate Premium</button>
        <button class="btn btn-primary" onclick="window.print()">Print Premium</button>
        <button class="btn btn-secondary" onclick="location.href='main-dashboard.html'">‚Üê Back to Dashboard</button>
      </div>
    </div>

    <!-- Form fields for premium generation -->
    <div class="form-grid">
      <div>
        <div class="form-group">
          <label for="clubName">Club Name:</label>
          <input type="text" id="clubName" placeholder="Enter club name" onkeydown="handleEnterKey(event)">
        </div>
        
        <div class="form-group">
          <label for="secretary">Trial Secretary:</label>
          <input type="text" id="secretary" placeholder="Enter secretary name" onkeydown="handleEnterKey(event)">
        </div>
        
        <div class="form-group">
          <label for="trialDates">Trial Dates:</label>
          <input type="text" id="trialDates" placeholder="e.g., July 15-16, 2025" onkeydown="handleEnterKey(event)">
        </div>
        
        <div class="form-group">
          <label for="startTime">Start Time:</label>
          <input type="text" id="startTime" placeholder="e.g., 8:00 AM" onkeydown="handleEnterKey(event)">
        </div>
        
        <div class="form-group">
          <label for="endTime">End Time:</label>
          <input type="text" id="endTime" placeholder="e.g., 5:00 PM" onkeydown="handleEnterKey(event)">
        </div>
      </div>
      
      <div>
        <div class="form-group">
          <label for="location">Trial Location:</label>
          <input type="text" id="location" placeholder="Enter trial location" onkeydown="handleEnterKey(event)">
        </div>
        
        <div class="form-group">
          <label for="entryLimit">Entry Limit:</label>
          <input type="text" id="entryLimit" placeholder="e.g., 100 entries" onkeydown="handleEnterKey(event)">
        </div>
        
        <div class="form-group">
          <label for="deadline">Entry Deadline:</label>
          <input type="text" id="deadline" placeholder="e.g., July 1, 2025" onkeydown="handleEnterKey(event)">
        </div>
        
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="trial@example.com" onkeydown="handleEnterKey(event)">
        </div>
        
        <div class="form-group">
          <label for="phone">Phone:</label>
          <input type="text" id="phone" placeholder="(555) 123-4567" onkeydown="handleEnterKey(event)">
        </div>
      </div>
    </div>

    <!-- Entry Fees Section -->
    <div class="form-section">
      <h3>Entry Fees</h3>
      <div class="form-grid">
        <div>
          <div class="form-group">
            <label for="fee1">First dog, first class:</label>
            <input type="text" id="fee1" placeholder="$35.00" onkeydown="handleEnterKey(event)">
          </div>
          
          <div class="form-group">
            <label for="fee2">Same dog, additional class:</label>
            <input type="text" id="fee2" placeholder="$25.00" onkeydown="handleEnterKey(event)">
          </div>

          <div class="form-group">
            <label for="fee3">Additional dog, same handler:</label>
            <input type="text" id="fee3" placeholder="$30.00" onkeydown="handleEnterKey(event)">
          </div>
        </div>
        <div>
          <div class="form-group">
            <label for="fee4">Junior Handler (under 18):</label>
            <input type="text" id="fee4" placeholder="$20.00" onkeydown="handleEnterKey(event)">
          </div>
          
          <div class="form-group">
            <label for="fee5">Exhibition Only:</label>
            <input type="text" id="fee5" placeholder="$15.00" onkeydown="handleEnterKey(event)">
          </div>

          <div class="form-group">
            <label for="address">Address (for directions):</label>
            <input type="text" id="address" placeholder="123 Main St, City, State ZIP" onkeydown="handleEnterKey(event)">
          </div>
        </div>
      </div>
    </div>

    <!-- Generated Premium Document -->
    <div id="premiumDocument" class="premium-document"></div>
  </div>

  <script type="module">
    // Firebase imports
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // ========================================
    // STANDARDIZED FIELD NAMES (CRITICAL FIX)
    // ========================================

    const STANDARD_FIELDS = {
      HANDLER_NAME: 'handlerName',      // NOT 'Handler' or 'handler'
      DOG_CALL_NAME: 'dogCallName',     // NOT 'Call Name' or 'dogName'
      JUDGE_NAME: 'judgeName',          // NOT 'judge' or 'judgeAssigned'
      CLASS_NAME: 'className',          // NOT 'Class' or 'class'
      CWAGS_NUMBER: 'cwagsNumber'       // NOT 'Registration'
    };

    // ========================================
    // ENTER KEY HANDLING FIX
    // ========================================

    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission
        
        // Find the next input field
        const inputs = Array.from(document.querySelectorAll('input[type="text"], input[type="email"], input[type="number"]'));
        const currentIndex = inputs.indexOf(event.target);
        
        if (currentIndex !== -1 && currentIndex < inputs.length - 1) {
          inputs[currentIndex + 1].focus();
        }
      }
    }

    // Make handleEnterKey globally available
    window.handleEnterKey = handleEnterKey;

    // ========================================
    // TIMEZONE-SAFE DATE UTILITIES
    // ========================================

    function createLocalDate(dateStr) {
      if (!dateStr) return new Date();
      
      if (typeof dateStr === 'string') {
        const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
        return new Date(dateWithTime);
      }
      
      return new Date(dateStr);
    }

    function formatLocalDate(date) {
      if (!date || !(date instanceof Date)) return null;
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getDateFromFirebase(timestamp) {
      if (!timestamp) return null;
      if (timestamp.toDate) {
        return formatLocalDate(timestamp.toDate());
      }
      return null;
    }

    function formatDateDisplay(dateStr) {
      if (!dateStr) return 'Unknown Date';
      const date = createLocalDate(dateStr);
      return date ? date.toLocaleDateString() : 'Unknown Date';
    }

    // ========================================
    // GLOBAL VARIABLES
    // ========================================

    let availableTrials = [];
    let selectedTrial = null;
    let currentTrialData = null;
    let currentApplicationData = null;
    let judges = [];
    let classes = [];

    // ========================================
    // FIELD NORMALIZATION
    // ========================================

    function normalizeTrialData(trialData) {
      const normalized = { ...trialData };
      
      // Normalize judge names from trial structure
      if (normalized.days && Array.isArray(normalized.days)) {
        normalized.days.forEach(day => {
          if (day.classes && Array.isArray(day.classes)) {
            day.classes.forEach(cls => {
              if (cls.rounds && Array.isArray(cls.rounds)) {
                cls.rounds.forEach(round => {
                  // Standardize judge field name
                  if (round.judge && !round[STANDARD_FIELDS.JUDGE_NAME]) {
                    round[STANDARD_FIELDS.JUDGE_NAME] = round.judge;
                  }
                  if (round.judgeAssigned && !round[STANDARD_FIELDS.JUDGE_NAME]) {
                    round[STANDARD_FIELDS.JUDGE_NAME] = round.judgeAssigned;
                  }
                });
              }
            });
          }
        });
      }
      
      return normalized;
    }

    function extractJudgesFromTrial(trialData) {
      const judgeSet = new Set();
      const normalizedTrial = normalizeTrialData(trialData);
      
      if (normalizedTrial.days && Array.isArray(normalizedTrial.days)) {
        normalizedTrial.days.forEach(day => {
          if (day.classes && Array.isArray(day.classes)) {
            day.classes.forEach(cls => {
              if (cls.rounds && Array.isArray(cls.rounds)) {
                cls.rounds.forEach(round => {
                  const judgeName = round[STANDARD_FIELDS.JUDGE_NAME] || 
                                   round.judge || 
                                   round.judgeAssigned;
                  if (judgeName && judgeName.trim() && judgeName !== 'TBD') {
                    judgeSet.add(judgeName.trim());
                  }
                });
              }
            });
          }
        });
      }
      
      return Array.from(judgeSet).sort();
    }

    function extractClassesFromTrial(trialData) {
      const classSet = new Set();
      const normalizedTrial = normalizeTrialData(trialData);
      
      if (normalizedTrial.days && Array.isArray(normalizedTrial.days)) {
        normalizedTrial.days.forEach(day => {
          if (day.classes && Array.isArray(day.classes)) {
            day.classes.forEach(cls => {
              const className = cls[STANDARD_FIELDS.CLASS_NAME] || 
                               cls.className || 
                               cls.name;
              if (className && className.trim()) {
                classSet.add(className.trim());
              }
            });
          }
        });
      }
      
      return Array.from(classSet).sort();
    }

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================

    function highlightAutoFilledField(fieldId) {
      const field = document.getElementById(fieldId);
      if (field) {
        field.classList.add('auto-filled');
        setTimeout(() => {
          field.classList.remove('auto-filled');
        }, 3000);
      }
    }

    function formatTrialDates(trialData) {
      if (!trialData.days || !Array.isArray(trialData.days)) return '';
      
      const dates = trialData.days
        .filter(day => day.date)
        .map(day => formatDateDisplay(getDateFromFirebase(day.date)))
        .filter(date => date !== 'Unknown Date');
      
      if (dates.length === 0) return '';
      if (dates.length === 1) return dates[0];
      
      // Format date range
      const firstDate = new Date(trialData.days[0].date + 'T12:00:00');
      const lastDate = new Date(trialData.days[trialData.days.length - 1].date + 'T12:00:00');
      
      const options = { month: 'long', day: 'numeric', year: 'numeric' };
      
      if (firstDate.getMonth() === lastDate.getMonth() && firstDate.getFullYear() === lastDate.getFullYear()) {
        // Same month: "July 15-16, 2025"
        return `${firstDate.toLocaleDateString('en-US', { month: 'long' })} ${firstDate.getDate()}-${lastDate.getDate()}, ${firstDate.getFullYear()}`;
      } else {
        // Different months: "July 31 - August 1, 2025"
        return `${firstDate.toLocaleDateString('en-US', options)} - ${lastDate.toLocaleDateString('en-US', options)}`;
      }
    }

    // ========================================
    // TRIAL LOADING
    // ========================================

    async function loadTrials() {
      console.log("üèÜ Loading trials for premium generation...");
      
      try {
        if (!auth.currentUser) {
          console.log("No authenticated user");
          return;
        }

        document.getElementById('loadingIndicator').style.display = 'block';

        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", auth.currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        availableTrials = [];
        
        trialsSnapshot.forEach(doc => {
          const trialData = doc.data();
          
          // Fix date handling for trial days
          if (trialData.days && Array.isArray(trialData.days)) {
            trialData.days = trialData.days.map(day => ({
              ...day,
              date: day.date ? getDateFromFirebase(day.date) : null
            }));
          }
          
          availableTrials.push({ id: doc.id, ...trialData });
        });
        
        availableTrials.sort((a, b) => {
          const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
          const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
          return dateB - dateA;
        });

        // Populate trial selector
        const trialSelect = document.getElementById('trialSelect');
        trialSelect.innerHTML = '<option value="">Select a trial...</option>';
        
        availableTrials.forEach(trial => {
          const option = document.createElement('option');
          option.value = trial.id;
          
          let trialLabel = trial.clubName || 'Unnamed Trial';
          if (trial.days && trial.days.length > 0) {
            const dateRange = formatTrialDates(trial);
            if (dateRange) {
              trialLabel += ` (${dateRange})`;
            }
          }
          
          option.textContent = trialLabel;
          trialSelect.appendChild(option);
        });

        // Setup change handler
        trialSelect.addEventListener('change', function() {
          const trialId = this.value;
          if (trialId) {
            loadTrialData(trialId);
          } else {
            clearPremiumForm();
            document.getElementById('generateBtn').disabled = true;
          }
        });

        console.log(`‚úÖ Loaded ${availableTrials.length} trials`);
        
      } catch (error) {
        console.error("‚ùå Error loading trials:", error);
        alert("Error loading trials: " + error.message);
      } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    }

    async function loadTrialData(trialId) {
      console.log("üìã Loading trial data for premium generation:", trialId);
      
      try {
        selectedTrial = availableTrials.find(trial => trial.id === trialId);
        if (!selectedTrial) {
          console.error("Trial not found in available trials");
          return;
        }

        currentTrialData = selectedTrial;

        // Auto-fill form fields with trial data
        populateFormFromTrial();

        // Try to load application data for additional details
        await loadApplicationData(trialId);

        document.getElementById('generateBtn').disabled = false;
        
      } catch (error) {
        console.error("Error loading trial data:", error);
        alert("Error loading trial data: " + error.message);
      }
    }

    async function loadApplicationData(trialId) {
      try {
        const applicationsQuery = query(
          collection(db, "applications"),
          where("trialId", "==", trialId)
        );
        
        const appsSnapshot = await getDocs(applicationsQuery);
        
        if (!appsSnapshot.empty) {
          const appDoc = appsSnapshot.docs[0];
          currentApplicationData = appDoc.data();
          
          console.log("üìÑ Found application data for trial");
          populateFormFromApplication();
        } else {
          console.log("üìÑ No application data found for trial");
          currentApplicationData = null;
        }
        
      } catch (error) {
        console.error("Error loading application data:", error);
        // Don't throw - application data is optional
      }
    }

    function populateFormFromTrial() {
      if (!currentTrialData) return;

      console.log("üéØ Populating form with trial data...");

      // Basic trial information
      if (currentTrialData.clubName) {
        document.getElementById('clubName').value = currentTrialData.clubName;
        highlightAutoFilledField('clubName');
      }
      
      if (currentTrialData.secretary) {
        document.getElementById('secretary').value = currentTrialData.secretary;
        highlightAutoFilledField('secretary');
      }

      // Format and populate trial dates
      const formattedDates = formatTrialDates(currentTrialData);
      if (formattedDates) {
        document.getElementById('trialDates').value = formattedDates;
        highlightAutoFilledField('trialDates');
      }

      // Extract judges and classes using standardized field names
      judges = extractJudgesFromTrial(currentTrialData);
      classes = extractClassesFromTrial(currentTrialData);

      console.log("üìã Extracted judges:", judges);
      console.log("üìã Extracted classes:", classes);
    }

    function populateFormFromApplication() {
      if (!currentApplicationData) return;

      console.log("üìÑ Populating form with application data...");

      const applicationFields = [
        'entryLimit', 'deadline', 'email', 'phone', 'address',
        'fee1', 'fee2', 'fee3', 'fee4', 'fee5', 'location',
        'startTime', 'endTime'
      ];

      applicationFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const value = currentApplicationData[fieldId];
        if (field && value && value.trim()) {
          field.value = value;
          highlightAutoFilledField(fieldId);
        }
      });
    }

    function clearPremiumForm() {
      const allFields = [
        'clubName', 'secretary', 'trialDates', 'location', 'startTime', 'endTime',
        'entryLimit', 'deadline', 'email', 'phone', 'address',
        'fee1', 'fee2', 'fee3', 'fee4', 'fee5'
      ];
      
      allFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.value = '';
          field.classList.remove('auto-filled');
        }
      });
      
      const premiumDoc = document.getElementById('premiumDocument');
      if (premiumDoc) {
        premiumDoc.innerHTML = '';
        premiumDoc.style.display = 'none';
      }
      
      judges = [];
      classes = [];
      currentTrialData = null;
      currentApplicationData = null;
    }

    // ========================================
    // PREMIUM GENERATION
    // ========================================

    window.generatePremium = function() {
      console.log("üèÜ Generating premium...");

      const data = {
        clubName: document.getElementById('clubName').value.trim(),
        secretary: document.getElementById('secretary').value.trim(),
        trialDates: document.getElementById('trialDates').value.trim(),
        startTime: document.getElementById('startTime').value.trim(),
        endTime: document.getElementById('endTime').value.trim(),
        location: document.getElementById('location').value.trim(),
        entryLimit: document.getElementById('entryLimit').value.trim(),
        deadline: document.getElementById('deadline').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone:
