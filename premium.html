<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .controls {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
    }
    
    .controls h2 {
      margin: 0 0 20px 0;
      color: #333;
    }
    
    .form-group {
      margin: 15px 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }

    .form-control {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      background-color: white;
    }

    .form-control:focus {
      border-color: #4CAF50;
      outline: none;
    }
    
    .reload-btn, .generate-btn, .print-btn {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      font-weight: bold;
    }
    
    .reload-btn {
      background-color: #ff9800;
    }
    
    .print-btn {
      background-color: #2196F3;
    }
    
    .reload-btn:hover, .generate-btn:hover, .print-btn:hover {
      opacity: 0.8;
    }

    .generate-btn:disabled {
      background-color: #ccc !important;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .loading-indicator {
      color: #666;
      font-style: italic;
      margin: 10px 0;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
      display: none;
    }
    
    .premium-document {
      background-color: white;
      border: 1px solid #ccc;
      padding: 30px;
      margin: 20px 0;
      display: none;
    }
    
    .premium-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #000;
      padding-bottom: 20px;
    }
    
    .premium-header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .premium-header .subtitle {
      font-size: 16px;
      margin: 8px 0;
      font-weight: bold;
    }
    
    .premium-section {
      margin: 20px 0;
    }
    
    .premium-section h2 {
      background-color: #f0f0f0;
      padding: 8px;
      margin: 15px 0 10px 0;
      border: 1px solid #ccc;
      font-size: 16px;
      text-transform: uppercase;
    }
    
    .judges-table, .classes-table, .fees-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    
    .judges-table th, .judges-table td,
    .classes-table th, .classes-table td,
    .fees-table th, .fees-table td {
      border: 1px solid #000;
      padding: 8px;
      text-align: left;
    }
    
    .judges-table th, .classes-table th, .fees-table th {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    
    .contact-box {
      border: 2px solid #000;
      padding: 15px;
      background-color: #f9f9f9;
      margin: 15px 0;
    }
    
    .maps-link {
      display: inline-block;
      background-color: #4285f4;
      color: white;
      padding: 8px 15px;
      text-decoration: none;
      border-radius: 5px;
      margin-top: 10px;
      font-weight: bold;
    }
    
    .maps-link:hover {
      background-color: #3367d6;
    }
    
    .auto-filled {
      background-color: #e8f5e8 !important;
      border-color: #4CAF50 !important;
      transition: all 0.3s ease;
    }
    
    @media print {
      .controls, .loading-indicator {
        display: none;
      }
      .premium-document {
        border: none;
        margin: 0;
        padding: 0;
      }
      body {
        background: white;
      }
      .maps-link {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls">
      <h2>üèÜ Premium Generator</h2>
      
      <!-- Trial Selection Dropdown -->
      <div class="form-group">
        <label for="trialSelect">Select Trial:</label>
        <select id="trialSelect" class="form-control">
          <option value="">Select a trial...</option>
        </select>
      </div>
      
      <div class="loading-indicator" id="loadingIndicator">
        üîÑ Loading trials...
      </div>
      
      <button class="reload-btn" onclick="loadTrials()">üîÑ Load Trials</button>
      <button class="generate-btn" onclick="generatePremium()" id="generateBtn" disabled>Generate Premium</button>
      <button class="print-btn" onclick="window.print()">Print Premium</button>
      <button onclick="location.href='main-dashboard.html'" style="background-color: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚Üê Back to Dashboard</button>
    </div>

    <!-- Form fields for premium generation -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
      <div>
        <label>Club Name:</label>
        <input type="text" id="clubName" style="width: 100%; padding: 8px; margin: 5px 0;">
        
        <label>Trial Secretary:</label>
        <input type="text" id="secretary" style="width: 100%; padding: 8px; margin: 5px 0;">
        
        <label>Trial Dates:</label>
        <input type="text" id="trialDates" style="width: 100%; padding: 8px; margin: 5px 0;">
        
        <label>Start Time:</label>
        <input type="text" id="startTime" style="width: 100%; padding: 8px; margin: 5px 0;">
        
        <label>End Time:</label>
        <input type="text" id="endTime" style="width: 100%; padding: 8px; margin: 5px 0;">
      </div>
      
      <div>
        <label>Trial Location:</label>
        <input type="text" id="location" style="width: 100%; padding: 8px; margin: 5px 0;">
        
        <label>Entry Limit:</label>
        <input type="text" id="entryLimit" style="width: 100%; padding: 8px; margin: 5px 0;">
        
        <label>Entry Deadline:</label>
        <input type="text" id="deadline" style="width: 100%; padding: 8px; margin: 5px 0;">
        
        <label>Email:</label>
        <input type="email" id="email" style="width: 100%; padding: 8px; margin: 5px 0;">
        
        <label>Phone:</label>
        <input type="text" id="phone" style="width: 100%; padding: 8px; margin: 5px 0;">
      </div>
    </div>

    <!-- Fees section -->
    <div style="margin: 20px 0;">
      <h3>Entry Fees</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label>First dog, first class:</label>
          <input type="text" id="fee1" style="width: 100%; padding: 8px; margin: 5px 0;" placeholder="$35.00">
          
          <label>Same dog, additional class:</label>
          <input type="text" id="fee2" style="width: 100%; padding: 8px; margin: 5px 0;" placeholder="$25.00">
        </div>
        <div>
          <label>Additional dog, same handler:</label>
          <input type="text" id="fee3" style="width: 100%; padding: 8px; margin: 5px 0;" placeholder="$30.00">
          
          <label>Junior Handler (under 18):</label>
          <input type="text" id="fee4" style="width: 100%; padding: 8px; margin: 5px 0;" placeholder="$20.00">
          
          <label>Exhibition Only:</label>
          <input type="text" id="fee5" style="width: 100%; padding: 8px; margin: 5px 0;" placeholder="$15.00">
        </div>
      </div>
    </div>

    <div style="margin: 20px 0;">
      <label>Address (for directions):</label>
      <input type="text" id="address" style="width: 100%; padding: 8px; margin: 5px 0;">
    </div>

    <!-- Generated Premium Document -->
    <div id="premiumDocument" class="premium-document"></div>
  </div>

  <!-- Firebase Configuration -->
  <script type="module">
    import { auth, db } from './js/firebase.js';
    import { collection, query, where, getDocs, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";

    // Global variables
    let availableTrials = [];
    let selectedTrial = null;
    let currentTrialData = null;
    let currentApplicationData = null;
    let judges = [];
    let classes = [];

    // DATE HANDLING FUNCTIONS
    function createLocalDate(dateStr) {
      if (!dateStr) return new Date();
      
      if (typeof dateStr === 'string') {
        const dateWithTime = dateStr.includes('T') ? dateStr : dateStr + 'T12:00:00';
        return new Date(dateWithTime);
      }
      
      return new Date(dateStr);
    }

    function formatLocalDate(date) {
      if (!date || !(date instanceof Date)) return '';
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getDateFromFirebase(firebaseDate) {
      if (!firebaseDate) return '';
      
      let date;
      
      if (firebaseDate.toDate) {
        date = firebaseDate.toDate();
      } else if (firebaseDate instanceof Date) {
        date = firebaseDate;
      } else if (typeof firebaseDate === 'string') {
        date = createLocalDate(firebaseDate);
      } else {
        return '';
      }
      
      return formatLocalDate(date);
    }

    function convertDateSafely(dateInput) {
      if (!dateInput) return "Date TBD";
      
      try {
        let processedDate;
        
        if (dateInput instanceof Date) {
          processedDate = dateInput;
        } else if (dateInput && typeof dateInput.toDate === 'function') {
          processedDate = dateInput.toDate();
        } else if (typeof dateInput === 'string') {
          const trimmedDate = dateInput.trim();
          if (trimmedDate.includes('/')) {
            const [month, day, year] = trimmedDate.split('/');
            processedDate = new Date(year, month - 1, day);
          } else if (trimmedDate.includes('-')) {
            processedDate = new Date(trimmedDate + 'T12:00:00');
          } else {
            processedDate = new Date(trimmedDate);
          }
        } else {
          processedDate = new Date(dateInput);
        }
        
        if (!processedDate || isNaN(processedDate.getTime())) {
          return dateInput.toString ? dateInput.toString() : "Date TBD";
        }
        
        const options = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        
        return processedDate.toLocaleDateString('en-US', options);
        
      } catch (error) {
        console.error("Date conversion error:", error);
        return dateInput.toString ? dateInput.toString() : "Date TBD";
      }
    }

    // UTILITY FUNCTIONS
    function showLoadingIndicator() {
      const indicator = document.getElementById('loadingIndicator');
      if (indicator) {
        indicator.style.display = 'block';
      }
    }

    function hideLoadingIndicator() {
      const indicator = document.getElementById('loadingIndicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
    }

    function highlightAutoFilledField(fieldId) {
      const field = document.getElementById(fieldId);
      if (field && field.value && field.value.trim()) {
        field.classList.add('auto-filled');
        setTimeout(() => {
          field.classList.remove('auto-filled');
        }, 3000);
      }
    }

    // MAIN FUNCTIONS
    async function loadTrials() {
      try {
        console.log("üîÑ Loading trials for selection...");
        showLoadingIndicator();

        await new Promise((resolve) => {
          if (auth.currentUser) {
            resolve();
          } else {
            const unsubscribe = auth.onAuthStateChanged((user) => {
              unsubscribe();
              resolve();
            });
          }
        });

        if (!auth.currentUser) {
          console.log("‚ùå No authenticated user");
          hideLoadingIndicator();
          return;
        }

        console.log("üë§ Authenticated user:", auth.currentUser.email);

        const trialsQuery = query(
          collection(db, "trials"),
          where("createdBy", "==", auth.currentUser.uid)
        );
        
        const trialsSnapshot = await getDocs(trialsQuery);
        
        if (!trialsSnapshot.empty) {
          availableTrials = [];
          trialsSnapshot.forEach(doc => {
            const trialData = doc.data();
            
            if (trialData.days && Array.isArray(trialData.days)) {
              trialData.days = trialData.days.map(day => ({
                ...day,
                date: day.date ? getDateFromFirebase(day.date) : null
              }));
            }
            
            availableTrials.push({ id: doc.id, ...trialData });
          });
          
          availableTrials.sort((a, b) => {
            const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
            const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
            return dateB - dateA;
          });
          
          populateTrialSelector();
          console.log(`‚úÖ Loaded ${availableTrials.length} trials`);
        } else {
          console.log("‚ùå No trials found");
          alert("No trials found. Please create a trial first.");
        }
        
        hideLoadingIndicator();
        
      } catch (error) {
        console.error("üí• Error loading trials:", error);
        hideLoadingIndicator();
        alert("Error loading trials: " + error.message);
      }
    }

    function populateTrialSelector() {
      const trialSelect = document.getElementById('trialSelect');
      trialSelect.innerHTML = '<option value="">Select a trial...</option>';

      availableTrials.forEach(trial => {
        const option = document.createElement('option');
        option.value = trial.id;
        
        let trialLabel = trial.clubName || 'Unnamed Trial';
        
        if (trial.days && trial.days.length > 0) {
          const dates = trial.days
            .filter(day => day.date)
            .map(day => {
              const localDate = createLocalDate(day.date);
              return localDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
              });
            })
            .join(', ');
          if (dates) {
            trialLabel += ` (${dates})`;
          }
        }
        
        option.textContent = trialLabel;
        trialSelect.appendChild(option);
      });

      trialSelect.addEventListener('change', function() {
        const trialId = this.value;
        if (trialId) {
          selectedTrial = availableTrials.find(t => t.id === trialId);
          if (selectedTrial) {
            console.log("‚úÖ Selected trial:", selectedTrial.clubName);
            loadTrialData(selectedTrial);
            
            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) generateBtn.disabled = false;
          }
        } else {
          selectedTrial = null;
          currentTrialData = null;
          
          const generateBtn = document.getElementById('generateBtn');
          if (generateBtn) generateBtn.disabled = true;
          
          clearPremiumForm();
        }
      });
    }

    async function loadTrialData(trial = null) {
      try {
        if (trial) {
          currentTrialData = trial;
        } else if (selectedTrial) {
          currentTrialData = selectedTrial;
        } else {
          console.log("‚ùå No trial selected");
          return;
        }

        console.log("üéØ Loading data for trial:", currentTrialData.clubName);

        if (currentTrialData && auth.currentUser) {
          const appQuery = query(
            collection(db, "applications"),
            where("trialId", "==", currentTrialData.id),
            where("createdBy", "==", auth.currentUser.uid)
          );
          
          const appSnapshot = await getDocs(appQuery);
          
          if (!appSnapshot.empty) {
            appSnapshot.forEach(doc => {
              currentApplicationData = { id: doc.id, ...doc.data() };
            });
            console.log("üìã Loaded application:", currentApplicationData);
          }
        }

        fillFormFromTrialData();
        
      } catch (error) {
        console.error("üí• Error loading trial data:", error);
      }
    }

    function fillFormFromTrialData() {
      if (!currentTrialData) {
        console.log("‚ùå No trial data to fill form");
        return;
      }

      console.log("üéØ Filling form from trial data...");
      
      if (currentTrialData.clubName) {
        const clubNameField = document.getElementById('clubName');
        if (clubNameField) {
          clubNameField.value = currentTrialData.clubName;
          highlightAutoFilledField('clubName');
        }
      }
      
      if (currentTrialData.secretary) {
        const secretaryField = document.getElementById('secretary');
        if (secretaryField) {
          secretaryField.value = currentTrialData.secretary;
          highlightAutoFilledField('secretary');
        }
      }

      let processedDates = [];
      
      if (currentTrialData.days && currentTrialData.days.length > 0) {
        console.log("üìÖ Processing trial dates...");
        
        currentTrialData.days.forEach((day, index) => {
          if (day.date) {
            const converted = convertDateSafely(day.date);
            processedDates.push(converted);
            console.log(`Day ${index + 1}: ${day.date} ‚Üí ${converted}`);
          }
        });
        
        if (processedDates.length > 0) {
          const finalDateString = processedDates.join(' & ');
          const trialDatesField = document.getElementById('trialDates');
          if (trialDatesField) {
            trialDatesField.value = finalDateString;
            highlightAutoFilledField('trialDates');
          }
        }
      }

      if (currentTrialData.location) {
        const locationField = document.getElementById('location');
        if (locationField) {
          locationField.value = currentTrialData.location;
          highlightAutoFilledField('location');
        }
      }

      if (currentTrialData.startTime) {
        const startTimeField = document.getElementById('startTime');
        if (startTimeField) {
          startTimeField.value = currentTrialData.startTime;
          highlightAutoFilledField('startTime');
        }
      }

      if (currentTrialData.endTime) {
        const endTimeField = document.getElementById('endTime');
        if (endTimeField) {
          endTimeField.value = currentTrialData.endTime;
          highlightAutoFilledField('endTime');
        }
      }

      let allJudges = new Set();
      let allClasses = new Set();

      if (currentTrialData.days) {
        currentTrialData.days.forEach(day => {
          if (day.classes) {
            day.classes.forEach(cls => {
              if (cls.className) {
                allClasses.add(cls.className);
              }
              if (cls.rounds) {
                cls.rounds.forEach(round => {
                  if (round.judge) {
                    allJudges.add(round.judge);
                  }
                });
              }
            });
          }
        });
      }

      judges = Array.from(allJudges);
      classes = Array.from(allClasses);

      console.log("‚úÖ Extracted judges:", judges);
      console.log("‚úÖ Extracted classes:", classes);

      if (currentApplicationData) {
        fillFormFromApplicationData();
      }
    }

    function fillFormFromApplicationData() {
      if (!currentApplicationData) return;

      const fields = [
        'entryLimit', 'deadline', 'email', 'phone', 'address',
        'fee1', 'fee2', 'fee3', 'fee4', 'fee5'
      ];

      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const value = currentApplicationData[fieldId];
        if (field && value) {
          field.value = value;
          highlightAutoFilledField(fieldId);
        }
      });
    }

    function clearPremiumForm() {
      const fields = ['clubName', 'secretary', 'trialDates', 'location', 'startTime', 'endTime'];
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.value = '';
        }
      });
      
      const premiumDoc = document.getElementById('premiumDocument');
      if (premiumDoc) {
        premiumDoc.innerHTML = '';
        premiumDoc.style.display = 'none';
      }
      
      judges = [];
      classes = [];
    }

    // PREMIUM GENERATION
    window.generatePremium = function() {
      const data = {
        clubName: document.getElementById('clubName').value,
        secretary: document.getElementById('secretary').value,
        trialDates: document.getElementById('trialDates').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        location: document.getElementById('location').value,
        entryLimit: document.getElementById('entryLimit').value,
        deadline: document.getElementById('deadline').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        address: document.getElementById('address').value,
        judges: judges,
        classes: classes,
        fees: {
          fee1: document.getElementById('fee1').value,
          fee2: document.getElementById('fee2').value,
          fee3: document.getElementById('fee3').value,
          fee4: document.getElementById('fee4').value,
          fee5: document.getElementById('fee5').value
        }
      };

      const judgesTableHTML = data.judges.length > 0 ?
        `<table class="judges-table">
          <thead>
            <tr><th>Judge</th></tr>
          </thead>
          <tbody>
            ${data.judges.map(judge => `<tr><td>${judge}</td></tr>`).join('')}
          </tbody>
        </table>` : '<p>Judges to be announced</p>';

      const classesTableHTML = data.classes.length > 0 ?
        `<table class="classes-table">
          <thead>
            <tr><th>Class</th></tr>
          </thead>
          <tbody>
            ${data.classes.map(cls => `<tr><td>${cls}</td></tr>`).join('')}
          </tbody>
        </table>` : '<p>Classes to be announced</p>';

      const directionsSection = () => {
        if (data.address && data.address.trim()) {
          const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.address)}`;
          return `
            <div class="premium-section">
              <h2>Directions</h2>
              <p><strong>Address:</strong> ${data.address}</p>
              <a href="${mapsUrl}" target="_blank" class="maps-link">Get Directions on Google Maps</a>
            </div>
          `;
        }
        return '';
      };

      const premiumHTML = `
        <div class="premium-header">
          <h1>${data.clubName}</h1>
          <div class="subtitle">C-WAGS Scent Work Trial</div>
          <div class="subtitle">${data.trialDates}</div>
          <div class="subtitle">${data.startTime} - ${data.endTime}</div>
          <div class="subtitle">${data.location}</div>
        </div>

        <div class="premium-section">
          <h2>Trial Information</h2>
          <p><strong>Trial Secretary:</strong> ${data.secretary}</p>
          <p><strong>Entry Limit:</strong> ${data.entryLimit}</p>
          <p><strong>Entry Deadline:</strong> ${data.deadline}</p>
        </div>

        <div class="premium-section">
          <h2>Judges</h2>
          ${judgesTableHTML}
        </div>

        <div class="premium-section">
          <h2>Classes Offered</h2>
          ${classesTableHTML}
        </div>

        <div class="premium-section">
          <h2>Entry Fees</h2>
          <table class="fees-table">
            <thead>
              <tr><th>Entry Type</th><th>Fee</th></tr>
            </thead>
            <tbody>
              ${data.fees.fee1 && !data.fees.fee1.match(/^\$?0+\.?0*$/) ? `<tr><td>First dog, first class</td><td>${data.fees.fee1}</td></tr>` : ''}
              ${data.fees.fee2 && !data.fees.fee2.match(/^\$?0+\.?0*$/) ? `<tr><td>Same dog, additional class</td><td>${data.fees.fee2}</td></tr>` : ''}
              ${data.fees.fee3 && !data.fees.fee3.match(/^\$?0+\.?0*$/) ? `<tr><td>Additional dog, same handler</td><td>${data.fees.fee3}</td></tr>` : ''}
              ${data.fees.fee4 && !data.fees.fee4.match(/^\$?0+\.?0*$/) ? `<tr><td>Junior Handler (under 18)</td><td>${data.fees.fee4}</td></tr>` : ''}
              ${data.fees.fee5 && !data.fees.fee5.match(/^\$?0+\.?0*$/) ? `<tr><td>Exhibition Only</td><td>${data.fees.fee5}</td></tr>` : ''}
            </tbody>
          </table>
          <p><strong>Make cheques payable to:</strong> ${data.clubName}</p>
          <p><strong>E-transfer accepted:</strong> ${data.email}</p>
        </div>

        <div class="premium-section">
          <h2>Entry Requirements</h2>
          <ul>
            <li>All dogs must be registered with C-WAGS or eligible for registration</li>
            <li>Dogs must be at least 6 months of age on the day of the trial</li>
            <li>Current vaccinations required (rabies, DHPP)</li>
            <li>Bitches in season may compete but must be crated separately</li>
            <li>All dogs must be on leash when not in the search area</li>
          </ul>
        </div>

        <div class="contact-box">
          <h2>Trial Secretary Contact</h2>
          <strong>${data.secretary}</strong><br>
          ${data.clubName}<br>
          Email: ${data.email}<br>
          Phone: ${data.phone}
        </div>

        ${directionsSection()}
      `;

      document.getElementById('premiumDocument').innerHTML = premiumHTML;
      document.getElementById('premiumDocument').style.display = 'block';
      document.getElementById('premiumDocument').scrollIntoView({ behavior: 'smooth' });
    };

    // Make functions globally accessible
    window.loadTrials = loadTrials;
    window.loadTrialData = loadTrialData;

    // Auto-load trials when page loads
    window.addEventListener('load', () => {
      console.log("üöÄ Page loaded, loading trials...");
      setTimeout(loadTrials, 1000);
    });

    console.log("Premium generator ready with complete date handling and trial selection");
  </script>
</body>
</html>
